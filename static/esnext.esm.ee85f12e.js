function e(e,t,i,s){Object.defineProperty(e,t,{get:i,set:s,enumerable:!0,configurable:!0})}var t=globalThis.parcelRequireb792,i=t.register;i("7c5RQ",function(i,s){let a;e(i.exports,"VERSION",()=>w),e(i.exports,"PlaybackState",()=>tL),e(i.exports,"VideoFormat",()=>tC),e(i.exports,"ChromecastState",()=>tR),e(i.exports,"HttpConnectionType",()=>tD),e(i.exports,"Surface",()=>tI),e(i.exports,"Player",()=>si),e(i.exports,"VideoQuality",()=>t("99dzt").VideoQuality);var r,n,o,l,u,h,d,c,p,m,f,g,b,S,v,y,T,E=t("99dzt");let w="2.0.101";(tn=tL||(tL={})).STOPPED="stopped",tn.READY="ready",tn.PLAYING="playing",tn.PAUSED="paused",(to=tC||(tC={})).MPEG="MPEG",to.DASH="DASH_SEP",to.DASH_SEP="DASH_SEP",to.DASH_SEP_VK="DASH_SEP",to.DASH_WEBM="DASH_WEBM",to.DASH_WEBM_AV1="DASH_WEBM_AV1",to.DASH_WEBM_VK="DASH_WEBM",to.DASH_ONDEMAND="DASH_ONDEMAND",to.DASH_ONDEMAND_VK="DASH_ONDEMAND",to.DASH_LIVE="DASH_LIVE",to.DASH_LIVE_CMAF="DASH_LIVE_CMAF",to.DASH_LIVE_WEBM="DASH_LIVE_WEBM",to.HLS="HLS",to.HLS_ONDEMAND="HLS_ONDEMAND",to.HLS_JS="HLS",to.HLS_LIVE="HLS_LIVE",to.HLS_LIVE_CMAF="HLS_LIVE_CMAF",to.WEB_RTC_LIVE="WEB_RTC_LIVE",(tl=tx||(tx={})).SCREEN="SCREEN",tl.CHROMECAST="CHROMECAST",(tu=tR||(tR={})).NOT_AVAILABLE="NOT_AVAILABLE",tu.AVAILABLE="AVAILABLE",tu.CONNECTING="CONNECTING",tu.CONNECTED="CONNECTED",(th=tD||(tD={})).HTTP1="http1",th.HTTP2="http2",th.QUIC="quic",(td=tN||(tN={})).None="none",td.Requested="requested",td.Applying="applying",(tc=tI||(tI={})).NONE="none",tc.INLINE="inline",tc.FULLSCREEN="fullscreen",tc.SECOND_SCREEN="second_screen",tc.PIP="pip";var A=e=>new Promise((t,i)=>{let s=document.createElement("script");s.setAttribute("src",e),s.onload=()=>t,s.onerror=()=>i,document.body.appendChild(s)});class ${connection$=new E.ValueSubject(void 0);castState$=new E.ValueSubject(tR.NOT_AVAILABLE);errorEvent$=new E.Subject;contentId;realCastState$=new E.ValueSubject(tR.NOT_AVAILABLE);subscription=new E.Subscription;log;params;constructor(e){this.params=e,this.log=this.params.dependencies.logger.createComponentLog("ChromecastInitializer");let t="chrome"in window;if(this.log({message:`[constructor] receiverApplicationId: ${this.params.receiverApplicationId}, isDisabled: ${this.params.isDisabled}, isSupported: ${t}`}),e.isDisabled||!t)return;let i=(0,E.isNonNullable)(window.chrome?.cast),s=!!window.__onGCastApiAvailable;i?this.initializeCastApi():(window.__onGCastApiAvailable=e=>{delete window.__onGCastApiAvailable,e&&this.initializeCastApi()},s||A("https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1").catch(()=>this.errorEvent$.next({id:"ChromecastLoading",category:E.ErrorCategory.NETWORK,message:"Script loading failed!"})))}connect(){cast.framework.CastContext.getInstance()?.requestSession()}disconnect(){cast.framework.CastContext.getInstance()?.getCurrentSession()?.endSession(!0)}stopMedia(){return new Promise((e,t)=>{cast.framework.CastContext.getInstance()?.getCurrentSession()?.getMediaSession()?.stop(new chrome.cast.media.StopRequest,e,t)})}toggleConnection(){(0,E.isNonNullable)(this.connection$.getValue())?this.disconnect():this.connect()}setVolume(e){let t=this.connection$.getValue();(0,E.isNullable)(t)||(t.remotePlayer.volumeLevel=e,t.remotePlayerController.setVolumeLevel())}setMuted(e){let t=this.connection$.getValue();(0,E.isNullable)(t)||e!==t.remotePlayer.isMuted&&t.remotePlayerController.muteOrUnmute()}destroy(){this.subscription.unsubscribe()}initListeners(){let e=new cast.framework.RemotePlayer,t=new cast.framework.RemotePlayerController(e),i=cast.framework.CastContext.getInstance();this.subscription.add((0,E.fromEvent)(i,cast.framework.CastContextEventType.SESSION_STATE_CHANGED).subscribe(e=>{switch(e.sessionState){case cast.framework.SessionState.SESSION_STARTED:case cast.framework.SessionState.SESSION_STARTING:case cast.framework.SessionState.SESSION_RESUMED:this.contentId=i.getCurrentSession()?.getMediaSession()?.media.contentId;break;case cast.framework.SessionState.NO_SESSION:case cast.framework.SessionState.SESSION_ENDING:case cast.framework.SessionState.SESSION_ENDED:case cast.framework.SessionState.SESSION_START_FAILED:this.contentId=void 0;break;default:return(0,E.assertNever)(e.sessionState)}})).add((0,E.merge)((0,E.fromEvent)(i,cast.framework.CastContextEventType.CAST_STATE_CHANGED).pipe((0,E.tap)(e=>{this.log({message:`[cast.framework.RemotePlayerEventType.CAST_STATE_CHANGED]: ${JSON.stringify(e)}`})}),(0,E.map)(e=>e.castState)),(0,E.observableFrom)([i.getCastState()])).pipe((0,E.filterChanged)(),(0,E.map)(k),(0,E.tap)(e=>{this.log({message:`realCastState$: ${e}`})})).subscribe(this.realCastState$)).add(this.realCastState$.subscribe(s=>{let a=s===tR.CONNECTED,r=(0,E.isNonNullable)(this.connection$.getValue());if(a&&!r){let s=i.getCurrentSession();(0,E.assertNonNullable)(s);let a=s.getCastDevice(),r=s.getMediaSession()?.media.contentId;((0,E.isNullable)(r)||r===this.contentId)&&(this.log({message:"connection created"}),this.connection$.next({remotePlayer:e,remotePlayerController:t,session:s,castDevice:a}))}else!a&&r&&(this.log({message:"connection destroyed"}),this.connection$.next(void 0));this.castState$.next(s===tR.CONNECTED?(0,E.isNonNullable)(this.connection$.getValue())?tR.CONNECTED:tR.AVAILABLE:s)}))}initializeCastApi(){let e,t,i;try{e=cast.framework.CastContext.getInstance(),t=chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,i=chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED}catch{return}try{e.setOptions({receiverApplicationId:this.params.receiverApplicationId??t,autoJoinPolicy:i}),this.initListeners()}catch(e){this.errorEvent$.next({id:"ChromecastInitializer",category:E.ErrorCategory.EXTERNAL_API,message:"[initializeCastApi] failed",thrown:e})}}}let k=e=>{switch(e){case cast.framework.CastState.NO_DEVICES_AVAILABLE:return tR.NOT_AVAILABLE;case cast.framework.CastState.NOT_CONNECTED:return tR.AVAILABLE;case cast.framework.CastState.CONNECTING:return tR.CONNECTING;case cast.framework.CastState.CONNECTED:return tR.CONNECTED;default:return(0,E.assertNever)(e)}};(tp=tM||(tM={}))[tp.OFFSET_P=0]="OFFSET_P",tp[tp.PLAYBACK_SHIFT=1]="PLAYBACK_SHIFT",tp[tp.DASH_CMAF_OFFSET_P=2]="DASH_CMAF_OFFSET_P";var P=(e,t=0,i=tM.OFFSET_P)=>{switch(i){case tM.OFFSET_P:return e.replace("_offset_p",0===t?"":"_"+t.toFixed(0));case tM.PLAYBACK_SHIFT:{if(0===t)return e;let i=new URL(e);return i.searchParams.append("playback_shift",t.toFixed(0)),i.toString()}case tM.DASH_CMAF_OFFSET_P:{let i=new URL(e);return i.searchParams.get("offset_p")||0!==t?(i.searchParams.set("offset_p",t.toFixed(0)),i.toString()):e}default:(0,E.assertNever)(i)}return e};let L=(e,t)=>{switch(t){case tM.OFFSET_P:return NaN;case tM.PLAYBACK_SHIFT:return Number(new URL(e).searchParams.get("playback_shift"));case tM.DASH_CMAF_OFFSET_P:return Number(new URL(e).searchParams.get("offset_p")??0);default:(0,E.assertNever)(t)}};var C=(e,t,i=!1)=>{let s=e.getTransition();(i||!s||s.to===t)&&e.setState(t)};class x{state;prevState;transition;transitionStarted$=new E.Subject;transitionEnded$=new E.Subject;transitionUpdated$=new E.Subject;forceChanged$=new E.Subject;stateChangeStarted$=(0,E.merge)(this.transitionStarted$,this.transitionUpdated$);stateChangeEnded$=(0,E.merge)(this.transitionEnded$,this.forceChanged$);constructor(e){this.state=e,this.prevState=void 0}setState(e){let t=this.transition,i=this.state;this.transition=void 0,this.prevState=i,this.state=e,t?t.to===e?this.transitionEnded$.next(t):this.forceChanged$.next({from:t.from,to:e,canceledTransition:t}):this.forceChanged$.next({from:i,to:e,canceledTransition:t})}startTransitionTo(e){let t=this.transition,i=this.state;i===e||(0,E.isNonNullable)(t)&&t.to===e||(this.prevState=i,this.state=e,t?(this.transition={from:t.from,to:e,canceledTransition:t},this.transitionUpdated$.next(this.transition)):(this.transition={from:i,to:e},this.transitionStarted$.next(this.transition)))}getTransition(){return this.transition}getState(){return this.state}getPrevState(){return this.prevState}}let R=e=>{switch(e){case tC.MPEG:case tC.DASH_SEP:case tC.DASH_ONDEMAND:case tC.DASH_WEBM:case tC.DASH_WEBM_AV1:case tC.HLS:case tC.HLS_ONDEMAND:return!1;case tC.DASH_LIVE:case tC.DASH_LIVE_CMAF:case tC.HLS_LIVE:case tC.HLS_LIVE_CMAF:case tC.DASH_LIVE_WEBM:case tC.WEB_RTC_LIVE:return!0;default:return(0,E.assertNever)(e)}};(tm=tO||(tO={})).STOPPED="stopped",tm.READY="ready",tm.PLAYING="playing",tm.PAUSED="paused";class D{subscription=new E.Subscription;loadMediaTimeoutSubscription=new E.Subscription;videoState=new x(tO.STOPPED);params;log;constructor(e){this.params=e,this.log=this.params.dependencies.logger.createComponentLog("ChromecastProvider"),this.log({message:`constructor, format: ${e.format}`}),this.params.output.isLive$.next(R(e.format)),this.params.output.isAudioAvailable$.next(!0),this.handleRemoteVolumeChange({volume:this.params.connection.remotePlayer.volumeLevel,muted:this.params.connection.remotePlayer.isMuted});let t=this.params.connection.session.getMediaSession();t&&this.restoreSession(t),this.subscribe()}destroy(){this.log({message:"[destroy]"}),this.subscription.unsubscribe()}subscribe(){this.subscription.add(this.loadMediaTimeoutSubscription);let e=new E.Subscription;this.subscription.add(e),this.subscription.add((0,E.merge)(this.videoState.stateChangeStarted$.pipe((0,E.map)(e=>`stateChangeStarted$ ${JSON.stringify(e)}`)),this.videoState.stateChangeEnded$.pipe((0,E.map)(e=>`stateChangeEnded$ ${JSON.stringify(e)}`))).subscribe(e=>this.log({message:`[videoState] ${e}`})));let t=(e,t)=>this.subscription.add(e.subscribe(t));if(this.params.output.isLive$.getValue())this.params.output.position$.next(0),this.params.output.duration$.next(0);else{let t=new E.Subject;e.add(t.pipe((0,E.debounce)(500)).subscribe(()=>{this.params.output.seekedEvent$.next()}));let i=NaN;e.add((0,E.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.CURRENT_TIME_CHANGED).subscribe(e=>{this.logRemoteEvent(e);let s=e.value;this.params.output.position$.next(s),(this.params.desiredState.seekState.getState().state===tN.Applying||Math.abs(s-i)>5)&&t.next(s),i=s})),e.add((0,E.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.DURATION_CHANGED).subscribe(e=>{this.logRemoteEvent(e),this.params.output.duration$.next(e.value)}))}t((0,E.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_MEDIA_LOADED_CHANGED),t=>{this.logRemoteEvent(t),t.value?this.handleRemoteReady():(this.handleRemoteStop(),e.unsubscribe())}),t((0,E.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_PAUSED_CHANGED),e=>{this.logRemoteEvent(e),e.value?this.handleRemotePause():this.handleRemotePlay()}),t((0,E.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.PLAYER_STATE_CHANGED),e=>{this.logRemoteEvent(e);let{remotePlayer:t}=this.params.connection,i=e.value,s=this.params.output.isBuffering$.getValue(),a=i===chrome.cast.media.PlayerState.BUFFERING;switch(s!==a&&this.params.output.isBuffering$.next(a),i){case chrome.cast.media.PlayerState.IDLE:!this.params.output.isLive$.getValue()&&t.duration-t.currentTime<5&&this.params.output.endedEvent$.next(),this.handleRemoteStop(),C(this.params.desiredState.playbackState,tL.STOPPED);break;case chrome.cast.media.PlayerState.PAUSED:this.handleRemotePause();break;case chrome.cast.media.PlayerState.PLAYING:this.handleRemotePlay();break;case chrome.cast.media.PlayerState.BUFFERING:break;default:(0,E.assertNever)(i)}}),t((0,E.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.VOLUME_LEVEL_CHANGED),e=>{this.logRemoteEvent(e),this.handleRemoteVolumeChange({volume:e.value})}),t((0,E.fromEvent)(this.params.connection.remotePlayerController,cast.framework.RemotePlayerEventType.IS_MUTED_CHANGED),e=>{this.logRemoteEvent(e),this.handleRemoteVolumeChange({muted:e.value})}),t((0,E.merge)(this.params.desiredState.playbackState.stateChangeStarted$,this.params.desiredState.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,(0,E.observableFrom)(["init"])).pipe((0,E.debounce)(0)),this.syncPlayback)}restoreSession(e){this.log({message:"restoreSession"});let{remotePlayer:t}=this.params.connection;if(e.playerState!==chrome.cast.media.PlayerState.IDLE){t.isPaused?(this.videoState.setState(tO.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED)):(this.videoState.setState(tO.PLAYING),C(this.params.desiredState.playbackState,tL.PLAYING));let e=this.params.output.isLive$.getValue();this.params.output.duration$.next(e?0:t.duration),this.params.output.position$.next(e?0:t.currentTime),this.params.desiredState.seekState.setState({state:tN.None})}}prepare(){let e=this.params.format;this.log({message:`[prepare] format: ${e}`});let t=this.createMediaInfo(e),i=this.createLoadRequest(t);this.loadMedia(i)}handleRemotePause(){let e=this.videoState.getState();(this.videoState.getTransition()?.to===tO.PAUSED||e===tO.PLAYING)&&(this.videoState.setState(tO.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED))}handleRemotePlay(){let e=this.videoState.getState();(this.videoState.getTransition()?.to===tO.PLAYING||e===tO.PAUSED)&&(this.videoState.setState(tO.PLAYING),C(this.params.desiredState.playbackState,tL.PLAYING))}handleRemoteReady(){this.videoState.getTransition()?.to===tO.READY&&this.videoState.setState(tO.READY),this.params.desiredState.playbackState.getTransition()?.to===tL.READY&&C(this.params.desiredState.playbackState,tL.READY)}handleRemoteStop(){this.videoState.getState()!==tO.STOPPED&&this.videoState.setState(tO.STOPPED)}handleRemoteVolumeChange(e){let t=this.params.output.volume$.getValue(),i={volume:e.volume??t.volume,muted:e.muted??t.muted};(i.volume!==t.volume||i.muted!=i.muted)&&this.params.output.volume$.next(i)}seek(e){this.params.output.willSeekEvent$.next();let{remotePlayer:t,remotePlayerController:i}=this.params.connection;t.currentTime=e,i.seek()}stop(){let{remotePlayerController:e}=this.params.connection;e.stop()}createMediaInfo(e){let t,i,s;let a=this.params.source;switch(e){case tC.MPEG:{let r=a[e];(0,E.assertNonNullable)(r);let n=(0,E.getHighestQuality)(Object.keys(r));(0,E.assertNonNullable)(n);let o=r[n];(0,E.assertNonNullable)(o),t=o,i="video/mp4",s=chrome.cast.media.StreamType.BUFFERED;break}case tC.HLS:case tC.HLS_ONDEMAND:{let r=a[e];(0,E.assertNonNullable)(r),t=r.url,i="application/x-mpegurl",s=chrome.cast.media.StreamType.BUFFERED;break}case tC.DASH_SEP:case tC.DASH_ONDEMAND:case tC.DASH_WEBM:case tC.DASH_WEBM_AV1:{let r=a[e];(0,E.assertNonNullable)(r),t=r.url,i="application/dash+xml",s=chrome.cast.media.StreamType.BUFFERED;break}case tC.DASH_LIVE_CMAF:{let r=a[e];(0,E.assertNonNullable)(r),t=r.url,i="application/dash+xml",s=chrome.cast.media.StreamType.LIVE;break}case tC.HLS_LIVE:case tC.HLS_LIVE_CMAF:{let r=a[e];(0,E.assertNonNullable)(r),t=P(r.url),i="application/x-mpegurl",s=chrome.cast.media.StreamType.LIVE;break}case tC.DASH_LIVE:case tC.WEB_RTC_LIVE:{let e="Unsupported format for Chromecast",t=Error(e);throw this.params.output.error$.next({id:"ChromecastProvider.createMediaInfo()",category:E.ErrorCategory.VIDEO_PIPELINE,message:e,thrown:t}),t}case tC.DASH_LIVE_WEBM:throw Error("DASH_LIVE_WEBM is no longer supported");default:return(0,E.assertNever)(e)}let r=new chrome.cast.media.MediaInfo(this.params.meta.videoId??t,i);r.contentUrl=t,r.streamType=s,r.metadata=new chrome.cast.media.GenericMediaMetadata;let{title:n,subtitle:o}=this.params.meta;return(0,E.isNonNullable)(n)&&(r.metadata.title=n),(0,E.isNonNullable)(o)&&(r.metadata.subtitle=o),r}createLoadRequest(e){let t=new chrome.cast.media.LoadRequest(e);t.autoplay=!1;let i=this.params.desiredState.seekState.getState();return i.state===tN.Applying||i.state===tN.Requested?t.currentTime=this.params.output.isLive$.getValue()?0:i.position/1e3:t.currentTime=0,t}loadMedia(e){Promise.race([this.params.connection.session.loadMedia(e),new Promise((e,t)=>{this.loadMediaTimeoutSubscription.add((0,E.timeout)(7e3).subscribe(()=>t("timeout(7000)")))})]).then(()=>{this.log({message:`[loadMedia] completed, format: ${this.params.format}`}),this.params.desiredState.seekState.getState().state===tN.Applying&&this.params.output.seekedEvent$.next(),this.handleRemoteReady()},e=>{let t=`[prepare] loadMedia failed, format: ${this.params.format}, reason: ${e}`;this.log({message:t}),this.params.output.error$.next({id:"ChromecastProvider.loadMedia",category:E.ErrorCategory.VIDEO_PIPELINE,message:t,thrown:e})}).finally(()=>{this.loadMediaTimeoutSubscription.unsubscribe()})}logRemoteEvent(e){this.log({message:`[remoteEvent] ${JSON.stringify(e)}`})}syncPlayback=()=>{let e=this.videoState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${e}; videoTransition: ${JSON.stringify(t)}; desiredPlaybackState: ${i}; desiredPlaybackStateTransition: ${this.params.desiredState.playbackState.getTransition()}; seekState: ${JSON.stringify(a)};`}),i===tL.STOPPED){e!==tO.STOPPED&&(this.videoState.startTransitionTo(tO.STOPPED),this.stop());return}if(!t){if(s?.to!==tL.PAUSED&&a.state===tN.Requested&&e!==tO.STOPPED){this.seek(a.position/1e3);return}switch(i){case tL.READY:switch(e){case tO.PLAYING:case tO.PAUSED:case tO.READY:break;case tO.STOPPED:this.videoState.startTransitionTo(tO.READY),this.prepare();break;default:(0,E.assertNever)(e)}break;case tL.PLAYING:switch(e){case tO.PLAYING:break;case tO.PAUSED:case tO.READY:this.videoState.startTransitionTo(tO.PLAYING),this.params.connection.remotePlayerController.playOrPause();break;case tO.STOPPED:this.videoState.startTransitionTo(tO.READY),this.prepare();break;default:(0,E.assertNever)(e)}break;case tL.PAUSED:switch(e){case tO.PLAYING:this.videoState.startTransitionTo(tO.PAUSED),this.params.connection.remotePlayerController.playOrPause();break;case tO.PAUSED:break;case tO.READY:this.videoState.startTransitionTo(tO.PAUSED),this.videoState.setState(tO.PAUSED);break;case tO.STOPPED:this.videoState.startTransitionTo(tO.READY),this.prepare();break;default:(0,E.assertNever)(e)}break;default:(0,E.assertNever)(i)}}}}let N=e=>{e.removeAttribute("src"),e.load()},I=e=>{try{e.pause(),e.playbackRate=0,N(e),e.remove()}catch(e){console.error(e)}},M=window.WeakMap?new WeakMap:new class{attribute="data-pool-reused";get(e){return e.hasAttribute(this.attribute)}set(e,t){e.toggleAttribute(this.attribute,t)}delete(e){e.removeAttribute(this.attribute)}},O=e=>{let t=e.querySelector("video"),i=!!t;return t?N(t):(t=document.createElement("video"),e.appendChild(t)),M.set(t,i),t.setAttribute("crossorigin","anonymous"),t.setAttribute("playsinline","playsinline"),t.controls=!1,t.setAttribute("poster","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="),t},_=e=>{let t=M.get(e);M.delete(e),t?N(e):I(e)},B=(e,t,i,{equal:s=(e,t)=>e===t,changed$:a,onError:r}={})=>{let n=e.getState(),o=t(),l=(0,E.isNullable)(a),u=new E.Subscription;return a&&u.add(a.subscribe(t=>{s(t,e.getState())&&e.setState(t)},r)),s(o,n)||(i(n),l&&e.setState(n)),u.add(e.stateChangeStarted$.subscribe(t=>{i(t.to),l&&e.setState(t.to)},r)),u},V=(e,t,i)=>B(t,()=>e.loop,t=>{(0,E.isNonNullable)(t)&&(e.loop=t)},{onError:i}),F=(e,t,i,s)=>B(t,()=>({muted:e.muted,volume:e.volume}),t=>{(0,E.isNonNullable)(t)&&(e.muted=t.muted,e.volume=t.volume)},{equal:(e,t)=>e===t||e?.muted===t?.muted&&e?.volume===t?.volume,changed$:i,onError:s}),U=(e,t,i,s)=>B(t,()=>e.playbackRate,t=>{(0,E.isNonNullable)(t)&&(e.playbackRate=t)},{changed$:i,onError:s}),j=e=>["__",e.language,e.label].join("|"),H=(e,t)=>{if(e.id===t)return!0;let[i,s,a]=t.split("|");return e.language===s&&e.label===a};class q{available$=new E.Subject;current$=new E.ValueSubject(void 0);error$=new E.Subject;video;cueSettings;subscription=new E.Subscription;externalTracks=new Map;internalTracks=new Map;connect(e,t,i){this.video=e,this.cueSettings=t.textTrackCuesSettings,this.subscribe();let s=e=>{this.error$.next({id:"TextTracksManager",category:E.ErrorCategory.WTF,message:"Generic HtmlVideoTextTrackManager error",thrown:e})};this.subscription.add(this.available$.subscribe(i.availableTextTracks$)),this.subscription.add(this.current$.subscribe(i.currentTextTrack$)),this.subscription.add(this.error$.subscribe(i.error$)),this.subscription.add(B(t.internalTextTracks,()=>Object.values(this.internalTracks),e=>{(0,E.isNonNullable)(e)&&this.setInternal(e)},{equal:(e,t)=>(0,E.isNonNullable)(e)&&(0,E.isNonNullable)(t)&&e.length===t.length&&e.every(({id:e},i)=>e===t[i].id),changed$:this.available$.pipe((0,E.map)(e=>e.filter(({type:e})=>"internal"===e))),onError:s})),this.subscription.add(B(t.externalTextTracks,()=>Object.values(this.externalTracks),e=>{(0,E.isNonNullable)(e)&&this.setExternal(e)},{equal:(e,t)=>(0,E.isNonNullable)(e)&&(0,E.isNonNullable)(t)&&e.length===t.length&&e.every(({id:e},i)=>e===t[i].id),changed$:this.available$.pipe((0,E.map)(e=>e.filter(({type:e})=>"external"===e))),onError:s})),this.subscription.add(B(t.currentTextTrack,()=>{if(this.video)return;let e=this.htmlTextTracksAsArray().find(({mode:e})=>"showing"===e);return e&&this.htmlTextTrackToITextTrack(e).id},e=>this.select(e),{changed$:this.current$,onError:s})),this.subscription.add(B(t.textTrackCuesSettings,()=>({}),()=>{if(this.video)for(let e of this.htmlTextTracksAsArray())this.applyCueSettings(e.cues),this.applyCueSettings(e.activeCues)}))}subscribe(){(0,E.assertNonNullable)(this.video);let{textTracks:e}=this.video;this.subscription.add((0,E.fromEvent)(e,"addtrack").subscribe(()=>{let e=this.current$.getValue();e&&this.select(e)})),this.subscription.add((0,E.merge)((0,E.fromEvent)(e,"addtrack"),(0,E.fromEvent)(e,"removetrack"),(0,E.observableFrom)(["init"])).pipe((0,E.map)(()=>this.htmlTextTracksAsArray().map(e=>this.htmlTextTrackToITextTrack(e))),(0,E.filterChanged)((e,t)=>e.length===t.length&&e.every(({id:e},i)=>e===t[i].id))).subscribe(this.available$)),this.subscription.add((0,E.merge)((0,E.fromEvent)(e,"change"),(0,E.observableFrom)(["init"])).pipe((0,E.map)(()=>this.htmlTextTracksAsArray().find(({mode:e})=>"showing"===e)),(0,E.map)(e=>e&&this.htmlTextTrackToITextTrack(e).id),(0,E.filterChanged)()).subscribe(this.current$));let t=e=>this.applyCueSettings(e.target?.activeCues??null);this.subscription.add((0,E.fromEvent)(e,"addtrack").subscribe(e=>{e.track?.addEventListener("cuechange",t);let i=e=>{let t=e.target?.cues??null;t&&t.length&&(this.applyCueSettings(e.target?.cues??null),e.target?.removeEventListener("cuechange",i))};e.track?.addEventListener("cuechange",i)})),this.subscription.add((0,E.fromEvent)(e,"removetrack").subscribe(e=>{e.track?.removeEventListener("cuechange",t)}))}applyCueSettings(e){if(!e||!e.length)return;let t=this.cueSettings.getState();for(let i of Array.from(e))(0,E.isNonNullable)(t.align)&&(i.align=t.align),(0,E.isNonNullable)(t.position)&&(i.position=t.position),(0,E.isNonNullable)(t.size)&&(i.size=t.size),(0,E.isNonNullable)(t.line)&&(i.line=t.line)}htmlTextTracksAsArray(e=!1){(0,E.assertNonNullable)(this.video);let t=[...this.video.textTracks];return e?t:t.filter(q.isHealthyTrack)}htmlTextTrackToITextTrack(e){let{language:t,label:i}=e,s=e.id?e.id:j(e),a=this.externalTracks.has(s),r=s.includes("auto");return a?{id:s,type:"external",isAuto:r,language:t,label:i,url:this.externalTracks.get(s)?.url}:{id:s,type:"internal",isAuto:r,language:t,label:i,url:this.internalTracks.get(s)?.url}}static isHealthyTrack(e){return!("metadata"===e.kind||e.groupId||""===e.id&&""===e.label&&""===e.language)}setExternal(e){this.internalTracks.size>0&&Array.from(this.internalTracks).forEach(([,e])=>this.detach(e)),e.filter(({id:e})=>!this.externalTracks.has(e)).forEach(e=>this.attach(e)),Array.from(this.externalTracks).filter(([t])=>!e.find(e=>e.id===t)).forEach(([,e])=>this.detach(e))}setInternal(e){let t=[...this.externalTracks];e.filter(({id:e,language:i,isAuto:s})=>!this.internalTracks.has(e)&&!t.some(([,e])=>e.language===i&&e.isAuto===s)).forEach(e=>this.attach(e)),Array.from(this.internalTracks).filter(([t])=>!e.find(e=>e.id===t)).forEach(([,e])=>this.detach(e))}select(e){for(let e of((0,E.assertNonNullable)(this.video),this.htmlTextTracksAsArray(!0)))e.mode="showing";for(let t of this.htmlTextTracksAsArray(!0))((0,E.isNullable)(e)||!H(t,e))&&(t.mode="disabled")}destroy(){if(this.subscription.unsubscribe(),this.video)for(let e of Array.from(this.video.getElementsByTagName("track"))){let t=e.getAttribute("id");t&&this.externalTracks.has(t)&&this.video.removeChild(e)}this.externalTracks.clear()}attach(e){(0,E.assertNonNullable)(this.video);let t=document.createElement("track");t.setAttribute("src",e.url),t.setAttribute("id",e.id),e.label&&t.setAttribute("label",e.label),e.language&&t.setAttribute("srclang",e.language),"external"===e.type?this.externalTracks.set(e.id,e):"internal"===e.type&&this.internalTracks.set(e.id,e),this.video.appendChild(t)}detach(e){(0,E.assertNonNullable)(this.video);let t=Array.prototype.find.call(this.video.getElementsByTagName("track"),t=>t.getAttribute("id")===e.id);t&&this.video.removeChild(t),"external"===e.type?this.externalTracks.delete(e.id):"internal"===e.type&&this.internalTracks.delete(e.id)}}class Y{pausedTime=0;streamOffset=0;pauseTimestamp=0;getTotalPausedTime(){return this.pausedTime+this.getCurrentPausedTime()}getCurrentPausedTime(){return this.pauseTimestamp>0?Date.now()-this.pauseTimestamp:0}getStreamOffset(){return this.streamOffset}getTotalOffset(){return this.getTotalPausedTime()+this.streamOffset}pause(){0===this.pauseTimestamp&&(this.pauseTimestamp=Date.now())}resume(){this.pauseTimestamp>0&&(this.pausedTime+=this.getCurrentPausedTime(),this.pauseTimestamp=0)}resetTo(e,t=!1){this.streamOffset=e,this.pauseTimestamp=0,this.pausedTime=0,t&&this.pause()}}let G=e=>{let t=e;for(;!(t instanceof Document)&&!(t instanceof ShadowRoot)&&null!==t;)t=t?.parentNode;return t??void 0},Q=e=>{let t=G(e);return!!(t&&t.fullscreenElement&&t.fullscreenElement===e)},z=e=>{let t=G(e);return!!(t&&t.pictureInPictureElement&&t.pictureInPictureElement===e)},W=3;var J=(e,t,i=W)=>{let s=0,a=0;for(let r=0;r<e.length;r++){let n=e.start(r),o=e.end(r);if(n<=t&&t<=o){if(s=n,a=o,!i)return{from:s,to:a};for(let t=r-1;t>=0;t--)e.end(t)+i>=s&&(s=e.start(t));for(let t=r+1;t<e.length;t++)e.start(t)-i<=a&&(a=e.end(t))}}return{from:s,to:a}};let X=e=>{let t;let i=t=>(0,E.fromEvent)(e,t).pipe((0,E.mapTo)(void 0)),s=(0,E.merge)(...["waiting","pause","canplay","play","canplaythrough","playing","seeking","seeked","ended"].map(t=>(0,E.fromEvent)(e,t))).pipe((0,E.map)(t=>"ended"===t.type?e.readyState<2:e.readyState<3),(0,E.filterChanged)()),a=(0,E.merge)((0,E.fromEvent)(e,"progress"),(0,E.fromEvent)(e,"timeupdate")).pipe((0,E.map)(()=>J(e.buffered,e.currentTime))),r=(0,E.getCurrentBrowser)().browser===E.CurrentClientBrowser.Safari?(0,E.combine)({play:i("play").pipe((0,E.once)()),playing:i("playing")}).pipe((0,E.mapTo)(void 0)):i("playing"),n=(0,E.fromEvent)(e,"volumechange").pipe((0,E.map)(()=>({muted:e.muted,volume:e.volume}))),o=(0,E.fromEvent)(e,"ratechange").pipe((0,E.map)(()=>e.playbackRate)),l=(0,E.fromEvent)(e,"error").pipe((0,E.filter)(()=>!!(e.error||e.played.length)),(0,E.map)(()=>{let t=e.error;return{id:t?`MediaError#${t.code}`:"HtmlVideoError",category:E.ErrorCategory.VIDEO_PIPELINE,message:t?t.message:"Error event from HTML video element",thrown:e.error??void 0}})),u=(0,E.fromEvent)(e,"timeupdate").pipe((0,E.map)(()=>e.currentTime)),h=new E.Subject;u.subscribe(i=>{e.loop&&(0,E.isNonNullable)(t)&&(0,E.isNonNullable)(i)&&t>=e.duration-.3&&i<=.3&&h.next(t),t=i});let d=(0,E.fromEvent)(e,"enterpictureinpicture"),c=(0,E.fromEvent)(e,"leavepictureinpicture"),p=new E.ValueSubject(z(e));d.subscribe(()=>p.next(!0)),c.subscribe(()=>p.next(!1));let m=new E.ValueSubject(Q(e));return(0,E.fromEvent)(e,"fullscreenchange").pipe((0,E.map)(()=>Q(e))).subscribe(m),{playing$:r,pause$:i("pause").pipe((0,E.filter)(()=>!e.error)),canplay$:i("canplay"),ended$:i("ended"),looped$:h,error$:l,seeked$:i("seeked"),seeking$:i("seeking"),progress$:i("progress"),loadStart$:i("loadstart"),loadedMetadata$:i("loadedmetadata"),loadedData$:i("loadeddata"),timeUpdate$:u,durationChange$:(0,E.fromEvent)(e,"durationchange").pipe((0,E.map)(()=>e.duration)),isBuffering$:s,currentBuffer$:a,volumeState$:n,playbackRateState$:o,inPiP$:p,inFullscreen$:m}};var K=e=>{switch(e){case"mobile":return E.VideoQuality.Q_144P;case"lowest":return E.VideoQuality.Q_240P;case"low":return E.VideoQuality.Q_360P;case"sd":case"medium":return E.VideoQuality.Q_480P;case"hd":case"high":return E.VideoQuality.Q_720P;case"fullhd":case"full":return E.VideoQuality.Q_1080P;case"quadhd":case"quad":return E.VideoQuality.Q_1440P;case"ultrahd":case"ultra":return E.VideoQuality.Q_2160P}};let Z=!1,ee={},et=e=>{Z=e},ei=()=>{ee={}},es=e=>{e(ee)},ea=(e,t)=>{Z&&(ee.meta=ee.meta??{},ee.meta[e]=t)};class er{name;constructor(e){this.name=e}next(e){if(!Z)return;ee.series=ee.series??{};let t=ee.series[this.name]??[];t.push([Date.now(),e]),ee.series[this.name]=t}}(tf=t_||(t_={})).FitsContainer="FitsContainer",tf.FitsThroughput="FitsThroughput",tf.Buffer="Buffer",tf.DroppedFramesLimit="DroppedFramesLimit",tf.FitsQualityLimits="FitsQualityLimits";let en=new er("best_bitrate"),eo=(e,t,i)=>(t-i)*Math.pow(2,-10*e)+i;class el{last;history={};recordSelection(e){this.history[e.id]=(0,E.now)()}recordSwitch(e){this.last=e}clear(){this.last=void 0,this.history={}}}let eu=(e,{container:t,throughput:i,tuning:s,limits:a,reserve:r=0,forwardBufferHealth:n,playbackRate:o,current:l,history:u,droppedVideoMaxQualityLimit:h,abrLogger:d})=>{(0,E.assertNotEmptyArray)(e,'Assertion "ABR Tracks is empty array" failed');let c=s.usePixelRatio?window.devicePixelRatio??1:1,p=s.limitByContainer&&t&&t.width>0&&t.height>0&&{width:t.width*c*s.containerSizeFactor,height:t.height*c*s.containerSizeFactor},m=p&&(0,E.videoSizeToQuality)(p),f=s.considerPlaybackRate&&(0,E.isNonNullable)(o)?o:1,g=e.filter(e=>!(0,E.isInvariantQuality)(e.quality)).sort((e,t)=>(0,E.isHigher)(e.quality,t.quality)?-1:1),b=g.at(-1)?.quality,S=g.at(0)?.quality,v=(0,E.isNullable)(a)||(0,E.isNonNullable)(a.min)&&(0,E.isNonNullable)(a.max)&&(0,E.isLower)(a.max,a.min)||(0,E.isNonNullable)(a.min)&&S&&(0,E.isHigher)(a.min,S)||(0,E.isNonNullable)(a.max)&&b&&(0,E.isLower)(a.max,b),y=f*eo(n??.5,s.bitrateFactorAtEmptyBuffer,s.bitrateFactorAtFullBuffer),T={},w=g.filter(e=>!m||(0,E.isLower)(e.quality,m)?!((0,E.isNonNullable)(i)&&isFinite(i)&&(0,E.isNonNullable)(e.bitrate))||i-r>=e.bitrate*y?s.lazyQualitySwitch&&(0,E.isNonNullable)(s.minBufferToSwitchUp)&&l&&!(0,E.isInvariantQuality)(l.quality)&&(n??0)<s.minBufferToSwitchUp&&(0,E.isHigher)(e.quality,l.quality)?(T[e.quality]=t_.Buffer,!1):h&&(0,E.isHigherOrEqual)(e.quality,h)?(T[e.quality]=t_.DroppedFramesLimit,!1):!!(v||((0,E.isNullable)(a.max)||(0,E.isLowerOrEqual)(e.quality,a.max))&&((0,E.isNullable)(a.min)||(0,E.isHigherOrEqual)(e.quality,a.min)))||(T[e.quality]=t_.FitsQualityLimits,!1):(T[e.quality]=t_.FitsThroughput,!1):(T[e.quality]=t_.FitsContainer,!1))[0];w&&w.bitrate&&en.next(w.bitrate);let A=w??g[Math.ceil((g.length-1)/2)]??e[0];A.quality!==u?.last?.quality&&d({message:`
    [available tracks]
	${e.map(e=>`{ id: ${e.id}, quality: ${e.quality}, bitrate: ${e.bitrate} }`).join(`
	`)}

    [tuning]
	${Object.entries(s??{}).map(([e,t])=>`${e}: ${t}`).join(`
	`)}

    [limit params]
    containerQualityLimit: ${m},
    throughput: ${i},
    reserve: ${r},
    playbackRate: ${o},
    playbackRateFactor: ${f},
    forwardBufferHealth: ${n},
    bitrateFactor: ${y},
    minBufferToSwitchUp: ${s.minBufferToSwitchUp},
    droppedVideoMaxQualityLimit: ${h},
    limitsAreInvalid: ${v},
    maxQualityLimit: ${a?.max},
    minQualityLimit: ${a?.min},

    [limited tracks]
    ${Object.entries(T).map(([e,t])=>`${e}: ${t}`).join(`
	`)||"All tracks are available"}

    [best track] ${w?.quality}
    [selected track] ${A?.quality}
    `});let $=A&&u&&u.history[A.id]&&(0,E.now)()-u.history[A.id]<=s.trackCooldown&&(!u.last||A.id!==u.last.id);if(A?.id&&u&&!$&&u.recordSelection(A),$&&u?.last){let e=u.last;return u?.recordSwitch(e),d({message:`
    [last selected] ${e?.quality}
    `}),e}return u?.recordSwitch(A),A};var eh=e=>new URL(e).hostname;let ed=e=>{if(e instanceof DOMException&&["Failed to load because no supported source was found.","The element has no supported sources."].includes(e.message))throw e;return!(e instanceof DOMException&&(20===e.code||"AbortError"===e.name))};var ec=async e=>{let t=e.muted;try{await e.play()}catch(i){if(!ed(i))return!1;if(t)return console.warn(i),!1;e.muted=!0;try{await e.play()}catch(t){return ed(t)&&(e.muted=!1,console.warn(t)),!1}}return!0};function ep(){return(0,E.now)()}function em(e){let t=e.split("/"),i=t.slice(0,t.length-1).join("/"),s=/^([a-z]+:)?\/\//i,a=e=>s.test(e);return{resolve:(e,t,s=!1)=>{a(e)||(e.startsWith("/")||(e="/"+e),e=i+e);let r=e.indexOf("?")>-1?"&":"?";return s&&(e+=r+"lowLat=1",r="&"),t&&(e+=r+"_rnd="+Math.floor(999999999*Math.random())),e}}}function ef(e,t,i,s){let a=window.XMLHttpRequest,r,n,o,l=!1,u=0,h,d,c=!1,p="arraybuffer",m=7e3,f=2e3,g=()=>{var e;if(l)return;(0,E.assertNonNullable)(h);let t=(e=h,ep()-e);if(t<f){setTimeout(g,f-t);return}(f*=2)>m&&(f=m),n&&n.abort(),n=new a,S()},b=()=>{if(!l){if(--u>=0){g(),s&&s();return}l=!0,d&&d(),i&&i()}},S=()=>{h=ep(),(n=new a).open("get",e);let i=0,s,u=0,m=()=>((0,E.assertNonNullable)(h),Math.max(h,Math.max(s||0,u||0)));if(r&&n.addEventListener("progress",e=>{let t=ep();r.updateChunk&&e.loaded>i&&(r.updateChunk(m(),e.loaded-i),i=e.loaded,s=t)}),o&&(n.timeout=o,n.addEventListener("timeout",()=>b())),n.addEventListener("load",()=>{if(l)return;(0,E.assertNonNullable)(n);let e=n.status;if(e>=200&&e<300){if(n.response.byteLength&&r){let e=n.response.byteLength-i;e&&r.updateChunk&&r.updateChunk(m(),e)}"json"!==n.responseType||Object.values(n.response).length?(d&&d(),t(n.response)):b()}else b()}),n.addEventListener("error",()=>{b()}),c){let e=()=>{(0,E.assertNonNullable)(n),n.readyState===XMLHttpRequest.HEADERS_RECEIVED&&(u=ep(),n.removeEventListener("readystatechange",e))};n.addEventListener("readystatechange",e)}return n.responseType=p,n.send(),v},v={withBitrateReporting:e=>(r=e,v),withParallel:e=>(c=e,v),withJSONResponse:()=>(p="json",v),withRetryCount:e=>(u=e,v),withRetryInterval:(e,t)=>((0,E.isNonNullable)(e)&&(f=e),(0,E.isNonNullable)(t)&&(m=t),v),withTimeout:e=>(o=e,v),withFinally:e=>(d=e,v),send:S,abort:()=>{n&&(n.abort(),n=void 0),l=!0,d&&d()}};return v}let eg=class{intervals=[];currentRate=0;logger;constructor(e){this.logger=e}_updateRate(e){let t=.2;this.currentRate&&(e<.1*this.currentRate?t=.8:e<.5*this.currentRate?t=.5:e<.7*this.currentRate&&(t=.3)),e=Math.max(1,Math.min(e,104857600)),this.currentRate=this.currentRate?this.currentRate*(1-t)+e*t:e}_createInterval(e,t,i){return{start:e,end:t,bytes:i}}_doMergeIntervals(e,t){e.start=Math.min(t.start,e.start),e.end=Math.max(t.end,e.end),e.bytes+=t.bytes}_mergeIntervals(e,t){return e.start<=t.end&&t.start<=e.end&&(this._doMergeIntervals(e,t),!0)}_flushIntervals(){if(!this.intervals.length)return!1;let e=this.intervals[0].start,t=this.intervals[this.intervals.length-1].end-500;if(t-e>2e3){let i=0,s=0;for(;this.intervals.length>0;){let e=this.intervals[0];if(e.end<=t)i+=e.end-e.start,s+=e.bytes,this.intervals.splice(0,1);else{if(e.start>=t)break;{let a=t-e.start,r=e.end-e.start;i+=a;let n=e.bytes*a/r;s+=n,e.start=t,e.bytes-=n}}}if(s>0&&i>0){let a=8*s/(i/1e3);return this._updateRate(a),this.logger(`rate updated, new=${Math.round(a/1024)}K; average=${Math.round(this.currentRate/1024)}K bytes/ms=${Math.round(s)}/${Math.round(i)} interval=${Math.round(t-e)}`),!0}}return!1}_joinIntervals(){let e;do{e=!1;for(let t=0;t<this.intervals.length-1;++t)this._mergeIntervals(this.intervals[t],this.intervals[t+1])&&(this.intervals.splice(t+1,1),e=!0)}while(e)}addInterval(e,t,i){return this.intervals.push(this._createInterval(e,t,i)),this._joinIntervals(),this.intervals.length>100&&(this.logger(`too many intervals (${this.intervals.length}); will merge`,{type:"warn"}),this._doMergeIntervals(this.intervals[1],this.intervals[0]),this.intervals.splice(0,1)),this._flushIntervals()}getBitRate(){return this.currentRate}};class eb{pendingQueue=[];activeRequests={};completeRequests={};averageSegmentDuration=2e3;lastPrefetchStart=0;throttleTimeout=null;RETRY_COUNT;TIMEOUT;BITRATE_ESTIMATOR;MAX_PARALLEL_REQUESTS;logger;constructor(e,t,i,s,a){this.RETRY_COUNT=e,this.TIMEOUT=t,this.BITRATE_ESTIMATOR=i,this.MAX_PARALLEL_REQUESTS=s,this.logger=a}limitCompleteCount(){let e;for(;(e=Object.keys(this.completeRequests)).length>this._getParallelRequestCount()+2;){let t=e[Math.floor(Math.random()*e.length)];this.logger(`Dropping completed request for url ${t}`,{type:"warn"}),delete this.completeRequests[t]}}_sendRequest(e,t){let i=ep(),s=i=>{delete this.activeRequests[t],this.limitCompleteCount(),this.completeRequests[t]=e,this._sendPending(),e._error=1,e._errorMsg=i,e._errorCB?e._errorCB(i):(this.limitCompleteCount(),this.completeRequests[t]=e)};e._request=ef(t,s=>{e._complete=1,e._responseData=s,e._downloadTime=ep()-i,delete this.activeRequests[t],this._sendPending(),e._cb?e._cb(s,e._downloadTime):(this.limitCompleteCount(),this.completeRequests[t]=e)},()=>s("error"),()=>{e._retry=1,e._retryCB&&e._retryCB()}),e._request.withRetryCount(this.RETRY_COUNT).withTimeout(this.TIMEOUT).withBitrateReporting(this.BITRATE_ESTIMATOR).withParallel(this._getParallelRequestCount()>1).withFinally(()=>{e._finallyCB&&e._finallyCB()}),this.activeRequests[t]=e,e._request.send(),this.lastPrefetchStart=ep()}_getParallelRequestCount(){return Math.min(this.MAX_PARALLEL_REQUESTS,this.averageSegmentDuration<3e3?3:2)}_getPrefetchDelay(){return Math.max(100,Math.min(5e3,this.averageSegmentDuration/3))}_canSendPending(){let e=this._getParallelRequestCount(),t=ep();if(Object.keys(this.activeRequests).length>=e)return!1;let i=this._getPrefetchDelay()-(t-this.lastPrefetchStart);return this.throttleTimeout&&clearTimeout(this.throttleTimeout),!(i>0)||(this.throttleTimeout=window.setTimeout(()=>this._sendPending(),i),!1)}_sendPending(){for(;this._canSendPending();){let e=this.pendingQueue.pop();if(!e)return;this.activeRequests[e]||this.completeRequests[e]||(this.logger(`Submitting pending request url=${e}`),this._sendRequest({},e))}}_removeFromActive(e){delete this.completeRequests[e],delete this.activeRequests[e]}abortAll(){Object.values(this.activeRequests).forEach(e=>{e&&e._request&&e._request.abort()}),this.activeRequests={},this.pendingQueue=[],this.completeRequests={}}requestData(e,t,i,s){let a={};return a.send=()=>{let r=this.activeRequests[e]||this.completeRequests[e];if(r)r._cb=t,r._errorCB=i,r._retryCB=s,r._finallyCB=a._finallyCB,r._error||r._complete?(this._removeFromActive(e),setTimeout(()=>{r._complete?(this.logger(`Requested url already prefetched, url=${e}`),t(r._responseData,r._downloadTime)):(this.logger(`Requested url already prefetched with error, url=${e}`),i(r._errorMsg)),a._finallyCB&&a._finallyCB()},0)):this.logger(`Attached to active request, url=${e}`);else{let t=this.pendingQueue.indexOf(e);-1!==t&&this.pendingQueue.splice(t,1),this.logger(`Request not prefetched, starting new request, url=${e}${-1===t?"":"; removed pending"}`),this._sendRequest(a,e)}},a._cb=t,a._errorCB=i,a._retryCB=s,a.abort=function(){a.request&&a.request.abort()},a.withFinally=e=>(a._finallyCB=e,a),a}prefetch(e){this.activeRequests[e]||this.completeRequests[e]?this.logger(`Request already active for url=${e}`):(this.logger(`Added to pending queue; url=${e}`),this.pendingQueue.unshift(e),this._sendPending())}optimizeForSegDuration(e){this.averageSegmentDuration=e}}class eS{paused=!1;autoQuality=!0;maxAutoQuality=void 0;buffering=!0;destroyed=!1;videoPlayStarted=!1;lowLatency=!1;rep;bitrate=0;manifest=[];bitrateSwitcher;filesFetcher;sourceBuffer=0;mediaSource;currentManifestEntry;manifestRequest;manifestRefetchTimer;bufferStates=[];downloadRate;sourceJitter=-1;chunkRateEstimator;manifestUrl;urlResolver;params;constructor(e){this.params=e,this.chunkRateEstimator=new eg(this.params.logger),this._initVideo()}attachSource(e){this.manifestUrl=e,this.urlResolver=em(e),this.bitrateSwitcher=this._initBitrateSwitcher(),this._initManifest()}setAutoQualityEnabled(e){this.autoQuality=e}setMaxAutoQuality(e){this.maxAutoQuality=e}switchByName(e){let t;for(let i=0;i<this.manifest.length;++i)if((t=this.manifest[i]).name===e){this._switchToQuality(t);return}}catchUp(){this.rep&&this.rep.stop(),this.currentManifestEntry&&(this.paused=!1,this._initPlayerWith(this.currentManifestEntry),this._notifyBuffering(!0))}stop(){this.params.videoElement.pause(),this.rep&&(this.rep.stop(),this.rep=null)}pause(){this.paused=!0,this.params.videoElement.pause(),this.videoPlayStarted=!1,this._notifyBuffering(!1)}play(e){this.paused=!1;let t=this.lowLatency&&this._getBufferSizeSec()>this.sourceJitter+5;this.rep&&!t?(this.bufferStates=[],this.videoPlayStarted=!1,this.shouldPlay()?this._playVideoElement(e):this._notifyBuffering(!0)):this.catchUp()}startPlay(e,t){this.autoQuality=t,this._initPlayerWith(e)}destroy(){this.destroyed=!0,this.rep&&(this.rep.stop(),this.rep=null),this.manifestRequest&&this.manifestRequest.abort(),this.manifestRefetchTimer&&(clearTimeout(this.manifestRefetchTimer),this.manifestRefetchTimer=void 0)}reinit(e){this.manifestUrl=e,this.urlResolver=em(e),this.catchUp()}_handleNetworkError(){this.params.logger("Fatal network error"),this.params.playerCallback({name:"error",type:"network"})}_retryCallback(){this.params.playerCallback({name:"retry"})}_getBufferSizeSec(){let e=this.params.videoElement,t=0,i=e.buffered.length;return 0!==i&&(t=e.buffered.end(i-1)-Math.max(e.currentTime,e.buffered.start(0))),t}_notifyBuffering(e){this.destroyed||(this.params.logger(`buffering: ${e}`),this.params.playerCallback({name:"buffering",isBuffering:e}),this.buffering=e)}_initVideo(){let{videoElement:e,logger:t}=this.params;e.addEventListener("error",()=>{e.error&&!this.destroyed&&(t(`Video element error: ${e.error?.code}`),this.params.playerCallback({name:"error",type:"media"}))}),e.addEventListener("timeupdate",()=>{let e=this._getBufferSizeSec();!this.paused&&e<.3?this.buffering||(this.buffering=!0,window.setTimeout(()=>{!this.paused&&this.buffering&&this._notifyBuffering(!0)},(e+.1)*1e3)):this.buffering&&this.videoPlayStarted&&this._notifyBuffering(!1)}),e.addEventListener("playing",()=>{t("playing")}),e.addEventListener("stalled",()=>this._fixupStall()),e.addEventListener("waiting",()=>this._fixupStall())}_fixupStall(){let e;let{logger:t,videoElement:i}=this.params,s=i.buffered.length;0!==s&&(e=i.buffered.start(s-1),i.currentTime<e&&(t("Fixup stall"),i.currentTime=e))}_selectQuality(e){let t,i,s;let{videoElement:a}=this.params,r=a&&1.62*(window.devicePixelRatio||1)*a.offsetHeight||520;for(let a=0;a<this.manifest.length;++a)s=this.manifest[a],this.maxAutoQuality&&s.video.height>this.maxAutoQuality||(s.bitrate<e&&r>Math.min(s.video.height,s.video.width)?(!i||s.bitrate>i.bitrate)&&(i=s):t&&!(t.bitrate>s.bitrate)||(t=s));return i||t}shouldPlay(){if(this.paused)return!1;let e=this._getBufferSizeSec()-Math.max(1,this.sourceJitter);return e>3||(0,E.isNonNullable)(this.downloadRate)&&(this.downloadRate>1.5&&e>2||this.downloadRate>2&&e>1)}_setVideoSrc(e,t){let{logger:i,videoElement:s,playerCallback:a}=this.params;this.mediaSource=new window.MediaSource,i("setting video src"),s.src=URL.createObjectURL(this.mediaSource),this.mediaSource.addEventListener("sourceopen",()=>{this.mediaSource&&(this.sourceBuffer=this.mediaSource.addSourceBuffer(e.codecs),this.bufferStates=[],t())}),this.videoPlayStarted=!1,s.addEventListener("canplay",()=>{this.shouldPlay()&&(this.videoPlayStarted=!0,this._playVideoElement())});let r=()=>{!function(e,t,i){let s=(...a)=>{i.apply(null,a),e.removeEventListener(t,s)};e.addEventListener(t,s)}(s,"progress",()=>{s.buffered.length?(s.currentTime=s.buffered.start(0),a({name:"playing"})):r()})};r()}_initPlayerWith(e){this.bitrate=0,this.rep=0,this.sourceBuffer=0,this.bufferStates=[],this.filesFetcher&&this.filesFetcher.abortAll(),this.filesFetcher=new eb(3,1e4,this.bitrateSwitcher,this.params.config.maxParallelRequests,this.params.logger),this._setVideoSrc(e,()=>this._switchToQuality(e))}_representation(e){let{logger:t,videoElement:i,playerCallback:s}=this.params,a=!1,r=null,n=null,o=null,l=null,u=!1,h=()=>{let e=a&&(!u||u===this.rep);return e||t("Not running!"),e},d=(e,t,i)=>{o&&o.abort(),o=ef(this.urlResolver.resolve(e,!1),t,i,()=>this._retryCallback()).withTimeout(1e4).withBitrateReporting(this.bitrateSwitcher).withRetryCount(3).withFinally(()=>{o=null}).send()},c=(e,t,i)=>{(0,E.assertNonNullable)(this.filesFetcher),n?.abort(),n=this.filesFetcher.requestData(this.urlResolver.resolve(e,!1),t,i,()=>this._retryCallback()).withFinally(()=>{n=null}).send()},p=e=>{let s=i.playbackRate;i.playbackRate!==e&&(t(`Playback rate switch: ${s}=>${e}`),i.playbackRate=e)},m=e=>{this.lowLatency=e,t(`lowLatency changed to ${e}`),f()},f=()=>{if(this.lowLatency||this.params.config.isLiveCatchUpMode){let e=this._getBufferSizeSec();if(this.bufferStates.length<5){p(1);return}let i=ep()-1e4,s=0;for(let t=0;t<this.bufferStates.length;t++){let a=this.bufferStates[t];e=Math.min(e,a.buf),a.ts<i&&s++}this.bufferStates.splice(0,s),t(`update playback rate;  minBuffer=${e} drop=${s} jitter=${this.sourceJitter}`);let a=e-1;this.sourceJitter>=0?a-=this.sourceJitter/2:this.sourceJitter-=1,a>3?p(1.15):a>1?p(1.1):a>.3?p(1.05):p(1)}else p(1)},g=e=>{let i;let a=()=>i&&i.start?i.start.length:0,r=e=>i.start[e]/1e3,n=e=>i.dur[e]/1e3,o=e=>i.fragIndex+e,u=(e,t)=>({chunkIdx:o(e),startTS:r(e),dur:n(e),discontinuity:t}),d=()=>{let e=0;if(i&&i.dur){let t=this.lowLatency?this.params.config.lowLatencyMinBuffer:this.params.config.minBuffer,s=this.lowLatency?this.params.config.lowLatencyMinBufferSegments:this.params.config.minBufferSegments,a=t;this.sourceJitter>1&&(a+=this.sourceJitter-1);let r=i.dur.length-1;for(;r>=0&&!((a-=i.dur[r])<=0);--r);e=Math.max(e=Math.min(r,i.dur.length-1-s),0)}return u(e,!0)},c=e=>{let t=a();if(!(t<=0)){if((0,E.isNonNullable)(e)){for(let i=0;i<t;i++)if(r(i)>e)return u(i)}return d()}},p=(e,t,i)=>{l&&l.abort(),l=ef(this.urlResolver.resolve(e,!0,this.lowLatency),t,i,()=>this._retryCallback()).withTimeout(1e4).withRetryCount(3).withFinally(()=>{l=null}).withJSONResponse().send()};return{seek:(t,a)=>{p(e,e=>{if(!h())return;let r=!!(i=e).lowLatency;r!==this.lowLatency&&m(r);let n=0;for(let e=0;e<i.dur.length;++e)n+=i.dur[e];n>0&&((0,E.assertNonNullable)(this.filesFetcher),this.filesFetcher.optimizeForSegDuration(n/i.dur.length)),s({name:"index",zeroTime:i.zeroTime,shiftDuration:i.shiftDuration}),this.sourceJitter=i.hasOwnProperty("jitter")?Math.min(10,Math.max(.01,i.jitter/1e3)):1,t(c(a))},()=>this._handleNetworkError())},nextChunk:e=>{let s=a(),r=e?e.chunkIdx+1:0,n=r-i.fragIndex;if(!(s<=0)){if(!e||n<0||n-s>10)return t(`Resync: offset=${n} bChunks=${s} chunk=`+JSON.stringify(e)),d();if(!(n>=s))return u(r-i.fragIndex,!1)}}}},b=()=>{a=!1,n&&n.abort(),o&&o.abort(),l&&l.abort(),(0,E.assertNonNullable)(this.filesFetcher),this.filesFetcher.abortAll()};return u={start:t=>{let{videoElement:i,logger:s}=this.params,n=g(e.jidxUrl),o,u,p,m,S=0,v,y,T,w=()=>{v&&(clearTimeout(v),v=void 0);let e=Math.max(500,1e3*(this._getBufferSizeSec()-this.sourceJitter-5)),t=S+e,i=ep(),s=Math.min(1e4,t-i);S=i;let a=()=>{l||h()&&n.seek(()=>{h()&&(S=ep(),A(),w())})};s>0?v=window.setTimeout(()=>{this.paused?w():a()},s):a()},A=()=>{let t;for(;t=n.nextChunk(m);)m=t,C(t);let i=n.nextChunk(p);if(i){if(p&&i.discontinuity){s("Detected discontinuity; restarting playback"),this.paused?w():(b(),this._initPlayerWith(e));return}L(i)}else w()},$=(e,t)=>{let a;if(!h()||!this.sourceBuffer)return;let r=i=>{window.setTimeout(()=>{h()&&$(e,t)},i)};if(this.sourceBuffer.updating)s("Source buffer is updating; delaying appendBuffer"),r(100);else{let n=ep(),o=i.currentTime;!this.paused&&i.buffered.length>1&&y===o&&n-T>500&&(s("Stall suspected; trying to fix"),this._fixupStall()),y!==o&&(y=o,T=n);let l=this._getBufferSizeSec();if(l>30)s(`Buffered ${l} seconds; delaying appendBuffer`),r(2e3);else try{this.sourceBuffer.appendBuffer(e),this.videoPlayStarted?(this.bufferStates.push({ts:n,buf:l}),f(),this.bufferStates.length>200&&this.bufferStates.shift()):this.shouldPlay()&&(this.videoPlayStarted=!0,this._playVideoElement()),t&&t()}catch(e){if("QuotaExceededError"===e.name)s("QuotaExceededError; delaying appendBuffer"),0!==this.sourceBuffer.buffered.length&&o-(a=this.sourceBuffer.buffered.start(0))>4&&this.sourceBuffer.remove(a,o-3),r(1e3);else throw e}}},k=()=>{u&&o&&(s([`Appending chunk, sz=${u.byteLength}:`,JSON.stringify(p)]),$(u,function(){u=null,A()}))},P=t=>e.fragUrlTemplate.replace("%%id%%",t.chunkIdx),L=e=>{h()&&c(P(e),(t,i)=>{if(h()){if(i/=1e3,u=t,p=e,r=e.startTS,i){let t=Math.min(10,e.dur/i);this.downloadRate=this.downloadRate?.7*this.downloadRate+.3*t:t}k()}},()=>this._handleNetworkError())},C=e=>{h()&&((0,E.assertNonNullable)(this.filesFetcher),this.filesFetcher.prefetch(this.urlResolver.resolve(P(e),!1)))},x=t=>{h()&&(e.cachedHeader=t,$(t,()=>{o=!0,k()}))};a=!0,n.seek(e=>{if(h()){if(S=ep(),!e){w();return}m=e,!(0,E.isNullable)(t)||e.startTS>t?L(e):(p=e,A())}},t),e.cachedHeader?x(e.cachedHeader):d(e.headerUrl,x,()=>this._handleNetworkError())},stop:b,getTimestampSec:()=>r}}_switchToQuality(e){let t;let{logger:i,playerCallback:s}=this.params;e.bitrate!==this.bitrate&&(this.rep&&(t=this.rep.getTimestampSec(),(0,E.isNonNullable)(t)&&(t+=.1),this.rep.stop()),this.currentManifestEntry=e,this.rep=this._representation(e),i(`switch to quality: codecs=${e.codecs}; headerUrl=${e.headerUrl}; bitrate=${e.bitrate}`),this.bitrate=e.bitrate,(0,E.assertNonNullable)(this.bitrateSwitcher),this.bitrateSwitcher.notifySwitch(this.bitrate),this.rep.start(t),s({name:"qualitySwitch",quality:e}))}_qualityAvailable(e){return(0,E.isNonNullable)(this.manifest.find(t=>t.name===e))}_initBitrateSwitcher(){let{logger:e,playerCallback:t}=this.params,i=t=>{let i,s,a;if(this.autoQuality){if(this.currentManifestEntry&&this._qualityAvailable(this.currentManifestEntry.name)&&t<this.bitrate&&(s=this._getBufferSizeSec(),a=t/this.bitrate,s>10&&a>.8||s>15&&a>.5||s>20&&a>.3)){e(`Not switching: buffer=${Math.floor(s)}; bitrate=${this.bitrate}; newRate=${Math.floor(t)}`);return}(i=this._selectQuality(t))?this._switchToQuality(i):e(`Could not find quality by bitrate ${t}`)}},s=(e,i)=>{let s=ep();if(this.chunkRateEstimator.addInterval(e,s,i))return t({name:"bandwidth",size:i,duration:s-e,speed:this.chunkRateEstimator.getBitRate()}),!0},a=()=>{let e=this.chunkRateEstimator.getBitRate();return e?.85*e:0},r=-1/0,n,o=!0,l=()=>{let e=a();if(e&&n&&this.autoQuality){var t;if(o&&e>n&&3e4>(t=r,ep()-t))return;i(e)}o=this.autoQuality};return{updateChunk:(e,t)=>{let i=s(e,t);return i&&l(),i},notifySwitch:e=>{let t=ep();e<n&&(r=t),n=e}}}_fetchManifest(e,t,i){this.manifestRequest=ef(this.urlResolver.resolve(e,!0),t,i,()=>this._retryCallback()).withJSONResponse().withTimeout(1e4).withRetryCount(this.params.config.manifestRetryMaxCount).withRetryInterval(this.params.config.manifestRetryInterval,this.params.config.manifestRetryMaxInterval).send().withFinally(()=>{this.manifestRequest=void 0})}_playVideoElement(e){let{videoElement:t}=this.params;ec(t).then(t=>{t||e?.()})}_handleManifestUpdate(e){let{logger:t,playerCallback:i,videoElement:s}=this.params;this.manifest=(e=>{let t=[];return e?.length?(e.forEach((e,i)=>{e.video&&s.canPlayType(e.codecs).replace(/no/,"")&&window.MediaSource.isTypeSupported(e.codecs)&&(e.index=i,t.push(e))}),t.sort(function(e,t){return e.video&&t.video?t.video.height-e.video.height:t.bitrate-e.bitrate}),t):(i({name:"error",type:"empty_manifest"}),[])})(e),t(`Valid manifest entries: ${this.manifest.length}/${e.length}`),i({name:"manifest",manifest:this.manifest})}_refetchManifest(e){this.destroyed||(this.manifestRefetchTimer&&clearTimeout(this.manifestRefetchTimer),this.manifestRefetchTimer=window.setTimeout(()=>{this._fetchManifest(e,t=>{this.destroyed||(this._handleManifestUpdate(t),this._refetchManifest(e))},()=>this._refetchManifest(e))},6e4))}_initManifest(){this._fetchManifest(this.manifestUrl,e=>{this.destroyed||(this._handleManifestUpdate(e),this._refetchManifest(this.manifestUrl))},()=>this._handleNetworkError())}}class ev{onDroopedVideoFramesLimit$=new E.Subject;subscription=new E.Subscription;log;video;droppedFramesChecker;isAuto;playing=!1;tracks=[];forceChecker$=new E.Subject;isForceCheckCounter=0;prevTotalVideoFrames=0;prevDroppedVideoFrames=0;currentTimer;limitCounts={};currentQuality;maxQualityLimit;connect(e){this.log=e.logger.createComponentLog("DroppedFramesManager"),this.video=e.video,this.isAuto=e.isAuto,this.droppedFramesChecker=e.droppedFramesChecker,this.subscription.add(e.playing$.subscribe(()=>this.playing=!0)),this.subscription.add(e.pause$.subscribe(()=>this.playing=!1)),this.subscription.add(e.tracks$.subscribe(e=>this.tracks=e)),this.isEnabled&&this.subscribe()}destroy(){this.currentTimer&&window.clearTimeout(this.currentTimer),this.subscription.unsubscribe()}get droppedVideoMaxQualityLimit(){return this.maxQualityLimit}subscribe(){this.subscription.add((0,E.fromEvent)(this.video,"resize").subscribe(this.handleChangeVideoQuality));let e=(0,E.interval)(this.droppedFramesChecker.checkTime).pipe((0,E.filter)(()=>this.playing),(0,E.filter)(()=>{let e=!!this.isForceCheckCounter;return e&&(this.isForceCheckCounter-=1),!e})),t=this.forceChecker$.pipe((0,E.debounce)(this.droppedFramesChecker.checkTime)),i=(0,E.merge)(e,t);this.subscription.add(i.subscribe(this.checkDroppedFrames))}handleChangeVideoQuality=()=>{let e=this.tracks.find(({size:e})=>e?.height===this.video.videoHeight&&e?.width===this.video.videoWidth);e&&!(0,E.isInvariantQuality)(e.quality)&&this.onChangeQuality(e.quality)};onChangeQuality(e){this.currentQuality=e;let{totalVideoFrames:t,droppedVideoFrames:i}=this.video.getVideoPlaybackQuality();this.savePrevFrameCounts(t,i),this.isForceCheckCounter=this.droppedFramesChecker.tickCountAfterQualityChange,this.forceChecker$.next()}checkDroppedFrames=()=>{let{totalVideoFrames:e,droppedVideoFrames:t}=this.video.getVideoPlaybackQuality(),i=e-this.prevTotalVideoFrames,s=1-(i-(t-this.prevDroppedVideoFrames))/i;!isNaN(s)&&s>0&&this.log({message:`[dropped]. current dropped percent: ${s}, limit: ${this.droppedFramesChecker.percentLimit}`}),!isNaN(s)&&s>=this.droppedFramesChecker.percentLimit&&(0,E.isHigher)(this.currentQuality,this.droppedFramesChecker.minQualityBanLimit)&&(this.limitCounts[this.currentQuality]=(this.limitCounts[this.currentQuality]??0)+1,this.maxQualityLimit=this.getMaxQualityLimit(this.currentQuality),this.currentTimer&&window.clearTimeout(this.currentTimer),this.currentTimer=window.setTimeout(()=>this.maxQualityLimit=this.getMaxQualityLimit(),this.droppedFramesChecker.qualityUpWaitingTime),this.onDroopedVideoFramesLimitTrigger()),this.savePrevFrameCounts(e,t)};onDroopedVideoFramesLimitTrigger(){this.isAuto.getState()&&(this.log({message:`[onDroopedVideoFramesLimit]. maxQualityLimit: ${this.maxQualityLimit}`}),this.onDroopedVideoFramesLimit$.next())}getMaxQualityLimit(e){let t=Object.entries(this.limitCounts).filter(([,e])=>e>=this.droppedFramesChecker.countLimit).sort(([e],[t])=>E.isLower(e,t)?-1:1)?.[0]?.[0];return e??t}get isEnabled(){return this.droppedFramesChecker.enabled&&this.isDroppedFramesCheckerSupport}get isDroppedFramesCheckerSupport(){return!!this.video&&"function"==typeof this.video.getVideoPlaybackQuality}savePrevFrameCounts(e,t){this.prevTotalVideoFrames=e,this.prevDroppedVideoFrames=t}}(tg=tB||(tB={})).STOPPED="stopped",tg.MANIFEST_READY="manifest_ready",tg.READY="ready",tg.PLAYING="playing",tg.PAUSED="paused";let ey=[tB.PAUSED,tB.PLAYING,tB.READY],eT=[tB.PAUSED,tB.PLAYING,tB.READY];class eE{subscription=new E.Subscription;video;videoState=new x(tB.STOPPED);dash;representations$=new E.ValueSubject([]);textTracksManager=new q;droppedFramesManager=new ev;maxSeekBackTime$=new E.ValueSubject(1/0);zeroTime$=new E.ValueSubject(void 0);liveOffset=new Y;log;params;constructor(e){this.params=e,this.log=this.params.dependencies.logger.createComponentLog("DashLiveProvider");let t=t=>{e.output.error$.next({id:"DashLiveProvider",category:E.ErrorCategory.WTF,message:"DashLiveProvider internal logic error",thrown:t})};(0,E.merge)(this.videoState.stateChangeStarted$.pipe((0,E.map)(e=>({transition:e,type:"start"}))),this.videoState.stateChangeEnded$.pipe((0,E.map)(e=>({transition:e,type:"end"})))).subscribe(({transition:e,type:t})=>{this.log({message:`[videoState change] ${t}: ${JSON.stringify(e)}`})}),this.video=O(e.container),this.params.output.element$.next(this.video),this.dash=this.createLiveDashPlayer(),this.params.output.duration$.next(1/0),this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.canChangePlaybackSpeed$.next(!1),this.params.output.hostname$.next(eh(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.textTracksManager.connect(this.video,this.params.desiredState,this.params.output);let i=X(this.video);this.droppedFramesManager.connect({logger:this.params.dependencies.logger,video:this.video,droppedFramesChecker:this.params.tuning.droppedFramesChecker,isAuto:this.params.desiredState.autoVideoTrackSwitching,playing$:i.playing$,pause$:i.pause$,tracks$:this.representations$.pipe((0,E.map)(e=>e.map(({track:e})=>e)))}),this.subscription.add(i.canplay$.subscribe(()=>{this.videoState.getTransition()?.to===tB.READY&&this.videoState.setState(tB.READY)},t)).add(i.pause$.subscribe(()=>{this.videoState.setState(tB.PAUSED)},t)).add(i.playing$.subscribe(()=>{this.params.desiredState.seekState.getState().state===tN.Applying&&this.params.output.seekedEvent$.next(),this.videoState.setState(tB.PLAYING)},t)).add(i.error$.subscribe(this.params.output.error$)).add(this.maxSeekBackTime$.pipe((0,E.filterChanged)(),(0,E.map)(e=>-e/1e3)).subscribe(this.params.output.duration$)).add((0,E.combine)({zeroTime:this.zeroTime$.pipe((0,E.filter)(E.isNonNullable)),position:i.timeUpdate$}).subscribe(({zeroTime:e,position:t})=>this.params.output.liveTime$.next(e+1e3*t),t)).add(V(this.video,this.params.desiredState.isLooped,t)).add(F(this.video,this.params.desiredState.volume,i.volumeState$,t)).add(i.volumeState$.subscribe(this.params.output.volume$,t)).add(U(this.video,this.params.desiredState.playbackRate,i.playbackRateState$,t)).add(i.loadStart$.subscribe(this.params.output.firstBytesEvent$)).add(i.playing$.subscribe(this.params.output.firstFrameEvent$)).add(i.canplay$.subscribe(this.params.output.canplay$)).add(i.inPiP$.subscribe(this.params.output.inPiP$)).add(i.inFullscreen$.subscribe(this.params.output.inFullscreen$)).add(this.params.desiredState.autoVideoTrackLimits.stateChangeStarted$.subscribe(({to:{max:e}})=>{let t=e&&(0,E.videoQualityToHeight)(e);this.dash.setMaxAutoQuality(t),this.params.output.autoVideoTrackLimits$.next({max:e})})).add(this.videoState.stateChangeEnded$.subscribe(e=>{switch(e.to){case tB.STOPPED:this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.desiredState.playbackState.setState(tL.STOPPED);break;case tB.MANIFEST_READY:case tB.READY:this.params.desiredState.playbackState.getTransition()?.to===tL.READY&&this.params.desiredState.playbackState.setState(tL.READY);break;case tB.PAUSED:this.params.desiredState.playbackState.setState(tL.PAUSED);break;case tB.PLAYING:this.params.desiredState.playbackState.setState(tL.PLAYING);break;default:return(0,E.assertNever)(e.to)}},t)).add((0,E.merge)(e.desiredState.playbackState.stateChangeStarted$,e.desiredState.seekState.stateChangeEnded$,e.desiredState.videoTrack.stateChangeStarted$,e.desiredState.autoVideoTrackSwitching.stateChangeStarted$,this.videoState.stateChangeEnded$,this.droppedFramesManager.onDroopedVideoFramesLimit$,(0,E.observableFrom)(["init"])).pipe((0,E.debounce)(0)).subscribe(this.syncPlayback,t))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.droppedFramesManager.destroy(),this.dash.destroy(),this.params.output.element$.next(void 0),_(this.video)}createLiveDashPlayer(){let e=new eS({videoElement:this.video,config:{maxParallelRequests:this.params.config.maxParallelRequests,minBuffer:this.params.tuning.live.minBuffer,minBufferSegments:this.params.tuning.live.minBufferSegments,lowLatencyMinBuffer:this.params.tuning.live.lowLatencyMinBuffer,lowLatencyMinBufferSegments:this.params.tuning.live.lowLatencyMinBufferSegments,isLiveCatchUpMode:this.params.tuning.live.isLiveCatchUpMode,manifestRetryInterval:this.params.tuning.manifestRetryInterval,manifestRetryMaxInterval:this.params.tuning.manifestRetryMaxInterval,manifestRetryMaxCount:this.params.tuning.manifestRetryMaxCount},playerCallback:this._dashCb,logger:e=>{this.params.dependencies.logger.log({message:String(e),component:"LiveDashPlayer"})}});return e.pause(),e}prepare(){let e=this.representations$.getValue(),t=this.params.desiredState.videoTrack.getTransition()?.to??this.params.desiredState.videoTrack.getState(),i=this.params.desiredState.autoVideoTrackSwitching.getTransition()?.to??this.params.desiredState.autoVideoTrackSwitching.getState(),s=!i&&(0,E.isNonNullable)(t)?t:eu(e.map(({track:e})=>e),{container:{width:this.video.offsetWidth,height:this.video.offsetHeight},throughput:this.params.dependencies.throughputEstimator.throughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,limits:this.params.desiredState.autoVideoTrackLimits.getState(),droppedVideoMaxQualityLimit:this.droppedFramesManager.droppedVideoMaxQualityLimit,abrLogger:this.params.dependencies.abrLogger}),a=s?.id,r=this.params.desiredState.videoTrack.getTransition(),n=this.params.desiredState.videoTrack.getState()?.id,o=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(s&&(r||a!==n)&&this.setVideoTrack(s),o&&this.setAutoQuality(i),r||o||a!==n){let t=e.find(({track:e})=>e.id===a)?.representation;(0,E.assertNonNullable)(t,"Representations missing"),this.dash.startPlay(t,i)}}setVideoTrack(e){let t=this.representations$.getValue().find(({track:t})=>t.id===e.id)?.representation;(0,E.assertNonNullable)(t,`No such representation ${e.id}`),this.dash.switchByName(t.name),this.params.desiredState.videoTrack.setState(e)}setAutoQuality(e){this.dash.setAutoQualityEnabled(e),this.params.desiredState.autoVideoTrackSwitching.setState(e)}seek(e){this.log({message:`[seek] position: ${e}`}),this.params.output.willSeekEvent$.next();let t=this.params.desiredState.playbackState.getState(),i=this.videoState.getState(),s=t===tL.PAUSED&&i===tB.PAUSED,a=-e,r=a<=this.maxSeekBackTime$.getValue()?a:0;this.params.output.position$.next(e/1e3),this.dash.reinit(P(this.params.source.url,r)),s&&this.dash.pause(),this.liveOffset.resetTo(r,s)}_dashCb=e=>{switch(e.name){case"buffering":{let t=e.isBuffering;this.params.output.isBuffering$.next(t);break}case"error":this.params.output.error$.next({id:`DashLiveProviderInternal:${e.type}`,category:E.ErrorCategory.WTF,message:"LiveDashPlayer reported error"});break;case"manifest":{let t=e.manifest,i=[];for(let e of t){let t=e.name??e.index.toString(10),s=K(e.name)??(0,E.videoSizeToQuality)(e.video),a=e.bitrate/1e3,r={...e.video};if(!s)continue;let n={id:t,quality:s,bitrate:a,size:r};i.push({track:n,representation:e})}this.representations$.next(i),this.params.output.availableVideoTracks$.next(i.map(({track:e})=>e)),this.videoState.getTransition()?.to===tB.MANIFEST_READY&&this.videoState.setState(tB.MANIFEST_READY);break}case"qualitySwitch":{let t=e.quality,i=this.representations$.getValue().find(({representation:e})=>e===t)?.track;this.params.output.hostname$.next(new URL(t.headerUrl,this.params.source.url).hostname),(0,E.isNonNullable)(i)&&this.params.output.currentVideoTrack$.next(i);break}case"bandwidth":{let{size:t,duration:i}=e;this.params.dependencies.throughputEstimator.addRawSpeed(t,i);break}case"index":this.maxSeekBackTime$.next(e.shiftDuration||0),this.zeroTime$.next(e.zeroTime)}};syncPlayback=()=>{let e=this.videoState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.playbackState.getState(),s=this.params.desiredState.playbackState.getTransition(),a=this.params.desiredState.seekState.getState();if(this.log({message:`[syncPlayback] videoState: ${e}; videoTransition: ${JSON.stringify(t)}; desiredPlaybackState: ${i}; seekState: ${JSON.stringify(a)};`}),i===tL.STOPPED){e!==tB.STOPPED&&(this.videoState.startTransitionTo(tB.STOPPED),this.dash.destroy(),this.video.removeAttribute("src"),this.video.load(),this.videoState.setState(tB.STOPPED));return}if(t)return;let r=this.params.desiredState.videoTrack.getTransition(),n=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(eT.includes(e)&&(r||n)){this.prepare();return}if(s?.to!==tL.PAUSED&&a.state===tN.Requested&&ey.includes(e)){this.seek(a.position-this.liveOffset.getTotalPausedTime());return}switch(e){case tB.STOPPED:this.videoState.startTransitionTo(tB.MANIFEST_READY),this.dash.attachSource(P(this.params.source.url));return;case tB.MANIFEST_READY:this.videoState.startTransitionTo(tB.READY),this.prepare();break;case tB.READY:if(i===tL.PAUSED)this.videoState.setState(tB.PAUSED);else if(i===tL.PLAYING){this.videoState.startTransitionTo(tB.PLAYING);let e=s?.from;e&&e===tL.READY&&this.dash.catchUp(),this.dash.play(()=>{this.liveOffset.pause(),this.videoState.setState(tB.PAUSED)})}return;case tB.PLAYING:i===tL.PAUSED&&(this.videoState.startTransitionTo(tB.PAUSED),this.liveOffset.pause(),this.dash.pause());return;case tB.PAUSED:if(i===tL.PLAYING){if(this.videoState.startTransitionTo(tB.PLAYING),this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue())this.liveOffset.resume(),this.dash.play(()=>{this.liveOffset.pause(),this.videoState.setState(tB.PAUSED)}),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3);else{let e=this.liveOffset.getTotalOffset();e>=this.maxSeekBackTime$.getValue()&&(e=0,this.liveOffset.resetTo(e)),this.liveOffset.resume(),this.params.output.position$.next(-e/1e3),this.dash.reinit(P(this.params.source.url,e))}}return;default:return(0,E.assertNever)(e)}}}(tb=tV||(tV={})).VIDEO="video",tb.AUDIO="audio",tb.TEXT="text",(tS=tF||(tF={}))[tS.ActiveLowLatency=0]="ActiveLowLatency",tS[tS.LiveWithTargetOffset=1]="LiveWithTargetOffset",tS[tS.LiveForwardBuffering=2]="LiveForwardBuffering",tS[tS.None=3]="None",(tv=tU||(tU={})).WEBM_AS_IN_SPEC="urn:mpeg:dash:profile:webm-on-demand:2012",tv.WEBM_AS_IN_FFMPEG="urn:webm:dash:profile:webm-on-demand:2012",(ty=tj||(tj={})).BYTE_RANGE="byteRange",ty.TEMPLATE="template",(tT=tH||(tH={})).NONE="none",tT.DOWNLOADING="downloading",tT.DOWNLOADED="downloaded",tT.PARTIALLY_FED="partially_fed",tT.PARTIALLY_EJECTED="partially_ejected",tT.FED="fed",(tE=tq||(tq={})).MP4="mp4",tE.WEBM="webm",(tw=tY||(tY={}))[tw.RECTANGULAR=0]="RECTANGULAR",tw[tw.EQUIRECTANGULAR=1]="EQUIRECTANGULAR",tw[tw.CUBEMAP=2]="CUBEMAP",tw[tw.MESH=3]="MESH",(tA=tG||(tG={})).STOPPED="stopped",tA.READY="ready",tA.PLAYING="playing",tA.PAUSED="paused";var ew=(e,t)=>{let i=0;for(let s=0;s<e.length;s++){let a=1e3*e.start(s),r=1e3*e.end(s);a<=t&&t<=r&&(i=r)}return Math.max(i-t,0)};let eA=300,e$=(e,t=eA)=>new E.Observable(i=>{let{width:s,height:a}=e.getBoundingClientRect();if(i.next({width:s,height:a}),!window.ResizeObserver)return;let r=new ResizeObserver((0,E.debounceFn)(e=>{let t,s;let a=e[0];a&&(a.contentBoxSize&&a.contentBoxSize[0]?(s=a.contentBoxSize[0].blockSize,t=a.contentBoxSize[0].inlineSize):a.contentRect&&(t=a.contentRect.width,s=a.contentRect.height),(0,E.isNonNullable)(t)&&(0,E.isNonNullable)(s)&&i.next({width:t,height:s}))},t));return r.observe(e),()=>r.disconnect()});class ek{constructor(){Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}addEventListener(e,t,i){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push({callback:t,options:i})}removeEventListener(e,t){if(!(e in this.listeners))return;let i=this.listeners[e];for(let e=0,s=i.length;e<s;e++)if(i[e].callback===t){i.splice(e,1);return}}dispatchEvent(e){if(!(e.type in this.listeners))return;let t=this.listeners[e.type].slice();for(let i=0,s=t.length;i<s;i++){let s=t[i];try{s.callback.call(this,e)}catch(e){Promise.resolve().then(()=>{throw e})}s.options&&s.options.once&&this.removeEventListener(e.type,s.callback)}return!e.defaultPrevented}}class eP extends ek{constructor(){super(),this.listeners||ek.call(this),Object.defineProperty(this,"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(this,"onabort",{value:null,writable:!0,configurable:!0}),Object.defineProperty(this,"reason",{value:void 0,writable:!0,configurable:!0})}toString(){return"[object AbortSignal]"}dispatchEvent(e){"abort"===e.type&&(this.aborted=!0,"function"==typeof this.onabort&&this.onabort.call(this,e)),super.dispatchEvent(e)}}let eL=class{constructor(){Object.defineProperty(this,"signal",{value:new eP,writable:!0,configurable:!0})}abort(e){let t;try{t=new Event("abort")}catch{"u">typeof document?document.createEvent?(t=document.createEvent("Event")).initEvent("abort",!1,!1):(t=document.createEventObject()).type="abort":t={type:"abort",bubbles:!1,cancelable:!1}}let i=e;if(void 0===i){if(typeof document>"u")(i=Error("This operation was aborted")).name="AbortError";else try{i=new DOMException("signal is aborted without reason")}catch{(i=Error("This operation was aborted")).name="AbortError"}}this.signal.reason=i,this.signal.dispatchEvent(t)}toString(){return"[object AbortController]"}};function eC(e){return e.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):"function"==typeof e.Request&&!e.Request.prototype.hasOwnProperty("signal")||!e.AbortController}"u">typeof Symbol&&Symbol.toStringTag&&(eL.prototype[Symbol.toStringTag]="AbortController",eP.prototype[Symbol.toStringTag]="AbortSignal");let ex=eC({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),eR=ex?function(e){"function"==typeof e&&(e={fetch:e});let{fetch:t,Request:i=t.Request,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a=!1}=e;if(!eC({fetch:t,Request:i,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a}))return{fetch:t,Request:r};let r=i;return(r&&!r.prototype.hasOwnProperty("signal")||a)&&((r=function(e,t){let s;t&&t.signal&&(s=t.signal,delete t.signal);let a=new i(e,t);return s&&Object.defineProperty(a,"signal",{writable:!1,enumerable:!1,configurable:!0,value:s}),a}).prototype=i.prototype),{fetch:(e,i)=>{let s=r&&r.prototype.isPrototypeOf(e)?e.signal:i?i.signal:void 0;if(s){let a;try{a=new DOMException("Aborted","AbortError")}catch{(a=Error("Aborted")).name="AbortError"}if(s.aborted)return Promise.reject(a);let r=new Promise((e,t)=>{s.addEventListener("abort",()=>t(a),{once:!0})});return i&&i.signal&&delete i.signal,Promise.race([r,t(e,i)])}return t(e,i)},Request:r}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,eD=ex?eR.fetch:window.fetch;ex?eR.Request:window.Request;let eN=ex?eL:window.AbortController;var eI=(e,t)=>{for(let i=0;i<e.length;i++)if(1e3*e.start(i)<=t&&1e3*e.end(i)>t)return!0;return!1};let eM="function"!=typeof window.requestIdleCallback||"function"!=typeof window.cancelIdleCallback?(e,t={})=>{let i=t.timeout||1,s=performance.now();return window.setTimeout(()=>{e({get didTimeout(){return!t.timeout&&performance.now()-s-1>i},timeRemaining:()=>Math.max(0,1+(performance.now()-s))})},1)}:window.requestIdleCallback,eO=!1;try{eO=(0,E.getCurrentBrowser)().browser===E.CurrentClientBrowser.Safari&&16>=parseInt(navigator.userAgent.match(/Version\/(\d+)/)?.[1]??"",10)}catch(e){console.error(e)}class e_{bufferFull$=new E.Subject;error$=new E.Subject;buffer;queue=[];currentTask=null;destroyed=!1;constructor(e){this.buffer=e,this.buffer.addEventListener("updateend",this.completeTask)}async append(e,t){return(!t||!t.aborted)&&new Promise(i=>{this.queue.push({operation:"append",data:e,signal:t,callback:i}),this.pull()})}async remove(e,t,i){return(!i||!i.aborted)&&new Promise(s=>{this.queue.unshift({operation:"remove",from:e,to:t,signal:i,callback:s}),this.pull()})}async abort(e){return new Promise(t=>{let i;for(let{callback:s}of(i=eO&&e?{operation:"safariAbort",init:e,callback:t}:{operation:"abort",callback:t},this.queue))s(!1);i&&(this.queue=[i]),this.pull()})}destroy(){this.destroyed=!0,this.buffer.removeEventListener("updateend",this.completeTask),this.queue=[],this.currentTask=null;try{this.buffer.abort()}catch(e){if(!(e instanceof DOMException&&"InvalidStateError"===e.name))throw e}}completeTask=()=>{try{if(this.currentTask){let e=this.currentTask.signal?.aborted;this.currentTask.callback(!e),this.currentTask=null}this.queue.length&&this.pull()}catch(e){this.error$.next({id:"BufferTaskQueueUnknown",category:E.ErrorCategory.VIDEO_PIPELINE,message:"Buffer appending or removal failed",thrown:e})}};pull(){if(this.buffer.updating||this.currentTask||this.destroyed)return;let e=this.queue.shift();if(!e)return;if(e.signal?.aborted){e.callback(!1),this.pull();return}this.currentTask=e;let{operation:t}=this.currentTask;try{this.execute(this.currentTask)}catch(e){e instanceof DOMException&&"QuotaExceededError"===e.name&&"append"===t?this.bufferFull$.next(this.currentTask.data.byteLength):e instanceof DOMException&&"InvalidStateError"===e.name||this.error$.next({id:`BufferTaskQueue:${t}`,category:E.ErrorCategory.VIDEO_PIPELINE,message:"Buffer operation failed",thrown:e}),this.currentTask.callback(!1),this.currentTask=null}this.currentTask&&"abort"===this.currentTask.operation&&this.completeTask()}execute(e){let{operation:t}=e;switch(t){case"append":this.buffer.appendBuffer(e.data);break;case"remove":this.buffer.remove(e.from/1e3,e.to/1e3);break;case"abort":this.buffer.abort();break;case"safariAbort":this.buffer.abort(),this.buffer.appendBuffer(e.init);break;default:(0,E.assertNever)(t)}}}var eB=e=>{let t=0;for(let i=0;i<e.length;i++)t+=e.end(i)-e.start(i);return 1e3*t};class eV{source;type;size32;size64;usertype;content;children;cursor=0;get id(){return this.type}get size(){return this.size32}constructor(e){this.source=e,this.children=[];let t=this.readUint32();this.size32=t<=e.buffer.byteLength?t:NaN,this.type=this.readString(4),this.size64=0,this.usertype=0,this.content=new DataView(e.buffer,e.byteOffset+this.cursor,this.size32?this.size32-8:void 0),this.children=this.parseChildrenBoxes()}parseChildrenBoxes(){return[]}readString(e,t="ascii"){let i=new TextDecoder(t).decode(new DataView(this.source.buffer,this.source.byteOffset+this.cursor,e));return this.cursor+=e,i}readUint8(){let e=this.source.getUint8(this.cursor);return this.cursor+=1,e}readUint16(){let e=this.source.getUint16(this.cursor);return this.cursor+=2,e}readUint32(){let e=this.source.getUint32(this.cursor);return this.cursor+=4,e}readUint64(){let e=this.source.getBigInt64(this.cursor);return this.cursor+=8,e}}class eF extends eV{}class eU extends eV{version;flags;constructor(e){super(e);let t=this.readUint32();this.version=t>>>24,this.flags=16777215&t}}(t$=tQ||(tQ={}))[t$.MONOSCOPIC=0]="MONOSCOPIC",t$[t$.TOP_BOTTOM=1]="TOP_BOTTOM",t$[t$.LEFT_RIGHT=2]="LEFT_RIGHT",t$[t$.STEREO_CUSTOM=3]="STEREO_CUSTOM",t$[t$.RIGHT_LEFT=4]="RIGHT_LEFT";class ej extends eU{baseMediaDecodeTime32=0;baseMediaDecodeTime64=BigInt(0);get baseMediaDecodeTime(){return 1===this.version?this.baseMediaDecodeTime64:this.baseMediaDecodeTime32}constructor(e){super(e),1===this.version?this.baseMediaDecodeTime64=this.readUint64():this.baseMediaDecodeTime32=this.readUint32()}}let eH={ftyp:class extends eV{majorBrand;minorVersion;compatibleBrands;constructor(e){super(e),this.compatibleBrands=[],this.majorBrand=this.readString(4),this.minorVersion=this.readUint32();let t=this.size-this.cursor;for(;t;){let e=this.readString(4);this.compatibleBrands.push(e),t-=4}}},moov:class extends eV{parseChildrenBoxes(){return eQ(this.content)}},moof:class extends eV{parseChildrenBoxes(){return eQ(this.content)}},mdat:class extends eV{data;constructor(e){super(e),this.data=this.content}},sidx:class extends eU{referenceId;timescale;earliestPresentationTime32;firstOffset32;earliestPresentationTime64;firstOffset64;reserved;referenceCount;segments;get earliestPresentationTime(){return this.earliestPresentationTime32}get firstOffset(){return this.firstOffset32}constructor(e){super(e),this.segments=[],this.referenceId=this.readUint32(),this.timescale=this.readUint32(),this.earliestPresentationTime32=this.readUint32(),this.firstOffset32=this.readUint32(),this.earliestPresentationTime64=0,this.firstOffset64=0,this.referenceCount=65535&this.readUint32();for(let e=0;e<this.referenceCount;e++){let e=this.readUint32(),t=e>>>31,i=e<<1>>>1,s=this.readUint32(),a=(e=this.readUint32())>>>28,r=e<<3>>>3;this.segments.push({referenceType:t,referencedSize:i,subsegmentDuration:s,SAPType:a,SAPDeltaTime:r})}}},trak:class extends eV{parseChildrenBoxes(){return eQ(this.content)}},mdia:class extends eV{parseChildrenBoxes(){return eQ(this.content)}},mfhd:class extends eU{sequenceNumber;constructor(e){super(e),this.sequenceNumber=this.readUint32()}},tkhd:class extends eU{creationTime;modificationTime;trackId;duration;layer;alternateGroup;volume;matrix;width;height;constructor(e){super(e),this.creationTime=this.readUint32(),this.modificationTime=this.readUint32(),this.trackId=this.readUint32(),this.cursor+=4,this.duration=this.readUint32(),this.cursor+=8,this.layer=this.readUint16(),this.alternateGroup=this.readUint16(),this.cursor+=2,this.cursor+=2,this.matrix=[[this.readUint32(),this.readUint32(),this.readUint32()],[this.readUint32(),this.readUint32(),this.readUint32()],[this.readUint32(),this.readUint32(),this.readUint32()]],this.width=this.readUint32(),this.height=this.readUint32()}},traf:class extends eV{parseChildrenBoxes(){return eQ(this.content)}},tfhd:class extends eU{trackId;baseDataOffset;sampleDescriptionIndex;defaultSampleDuration;defaultSampleSize;defaultSampleFlags;constructor(e){super(e),this.trackId=this.readUint32(),1&this.flags&&(this.baseDataOffset=this.readUint64()),2&this.flags&&(this.sampleDescriptionIndex=this.readUint32()),8&this.flags&&(this.defaultSampleDuration=this.readUint32()),16&this.flags&&(this.defaultSampleSize=this.readUint32()),32&this.flags&&(this.defaultSampleFlags=this.readUint32())}},tfdt:ej,trun:class extends eU{sampleCount;dataOffset;firstSampleFlags;sampleDuration=[];sampleSize=[];sampleFlags=[];sampleCompositionTimeOffset=[];optionalFields=0;constructor(e){super(e),this.sampleCount=this.readUint32(),1&this.flags&&(this.dataOffset=this.readUint32()),4&this.flags&&(this.firstSampleFlags=this.readUint32());for(let e=0;e<this.sampleCount;e++)256&this.flags&&this.sampleDuration.push(this.readUint32()),512&this.flags&&this.sampleSize.push(this.readUint32()),1024&this.flags&&this.sampleFlags.push(this.readUint32()),2048&this.flags&&this.sampleCompositionTimeOffset.push(this.readUint32())}},minf:class extends eV{parseChildrenBoxes(){return eQ(this.content)}},sv3d:class extends eV{parseChildrenBoxes(){return eQ(this.content)}},st3d:class extends eU{stereoMode;constructor(e){switch(super(e),this.readUint8()){case 0:this.stereoMode=tQ.MONOSCOPIC;break;case 1:this.stereoMode=tQ.TOP_BOTTOM;break;case 2:this.stereoMode=tQ.LEFT_RIGHT;break;case 3:this.stereoMode=tQ.STEREO_CUSTOM;break;case 4:this.stereoMode=tQ.RIGHT_LEFT}this.cursor+=1}},prhd:class extends eU{poseYawDegrees;posePitchDegrees;poseRollDegrees;constructor(e){super(e),this.poseYawDegrees=this.readUint32(),this.posePitchDegrees=this.readUint32(),this.poseRollDegrees=this.readUint32()}},proj:class extends eV{parseChildrenBoxes(){return eQ(this.content)}},equi:class extends eU{projectionBoundsTop;projectionBoundsBottom;projectionBoundsLeft;projectionBoundsRight;constructor(e){super(e),this.projectionBoundsTop=this.readUint32(),this.projectionBoundsBottom=this.readUint32(),this.projectionBoundsLeft=this.readUint32(),this.projectionBoundsRight=this.readUint32()}},unknown:eF},eq=new class{createBox(e,t){let i=eH[e];return i?new i(t):new eF(t)}createFromView(e){let t=new TextDecoder("ascii").decode(new DataView(e.buffer,e.byteOffset+4,4));return eq.createBox(t,new DataView(e.buffer,e.byteOffset))}};function eY(e,t){let i=new Uint8Array(e.buffer),s=t.split("").map(e=>e.charCodeAt(0)),a=e.byteOffset,r=[];for(;a<i.byteLength;){if(i[a]===s[r.length]?r.push(i[a]):r.length&&(r=[],a--),4===r.length){let i=new DataView(e.buffer,a-7,4).getUint32(0);return a-7+i>e.buffer.byteLength?null:eq.createBox(t,new DataView(e.buffer,a-7))}a++}return null}function eG(e,t){let i=[],s=e.byteOffset;for(;s<e.buffer.byteLength;){let a=eY(new DataView(e.buffer,s,e.buffer.byteLength-s),t);if(a)i.push(a),s=a.source.byteOffset+a.size;else break}return i}function eQ(e){let t=[],i=0;for(;i<e.byteLength;){let s=eq.createFromView(new DataView(e.buffer,e.byteOffset+i));if(t.push(s),!s.size)break;i+=s.size}return t}let ez=new TextDecoder("ascii"),eW={validateData:e=>"ftyp"===ez.decode(new DataView(e.buffer,e.byteOffset+4,4)),parseInit:e=>{let t={is3dVideo:!1,stereoMode:0,projectionType:tY.EQUIRECTANGULAR,projectionData:{pose:{yaw:0,pitch:0,roll:0},bounds:{top:0,bottom:0,left:0,right:0}}};if(eY(e,"sv3d")){t.is3dVideo=!0;let i=eY(e,"st3d");i&&(t.stereoMode=i.stereoMode);let s=eY(e,"prhd");s&&(t.projectionData.pose.yaw=s.poseYawDegrees,t.projectionData.pose.pitch=s.posePitchDegrees,t.projectionData.pose.roll=s.poseRollDegrees);let a=eY(e,"equi");a&&(t.projectionData.bounds.top=a.projectionBoundsTop,t.projectionData.bounds.right=a.projectionBoundsRight,t.projectionData.bounds.bottom=a.projectionBoundsBottom,t.projectionData.bounds.left=a.projectionBoundsLeft)}return t},getIndexRange:()=>{},parseSegments:e=>{let t=eq.createFromView(e),i=t.earliestPresentationTime/t.timescale*1e3,s=e.byteOffset+e.byteLength+t.firstOffset;return t.segments.map(e=>{if(0!==e.referenceType)throw Error("Unsupported multilevel sidx");let a=e.subsegmentDuration/t.timescale*1e3,r={status:tH.NONE,time:{from:i,to:i+a},byte:{from:s,to:s+e.referencedSize-1}};return i+=a,s+=e.referencedSize,r})},parseFeedableSegmentChunk:e=>{let t=eG(e,"mdat"),i=eG(e,"moof");if(!(t.length&&i.length))return null;let s=i[0],a=t[t.length-1],r=s.source.byteOffset,n=a.source.byteOffset-s.source.byteOffset+a.size;return new DataView(e.buffer,r,n)},getSegmentEndTime:(e,t)=>{let i=eG(e,"traf"),s=i[i.length-1].children.find(e=>"tfhd"===e.type),a=i[i.length-1].children.find(e=>"tfdt"===e.type),r=i[i.length-1].children.find(e=>"trun"===e.type),n=0;return n=r.sampleDuration.length?r.sampleDuration.reduce((e,t)=>e+t,0):s.defaultSampleDuration*r.sampleCount,(Number(a.baseMediaDecodeTime)+n)/t*1e3}};(tk=tz||(tz={}))[tk.EBML=440786851]="EBML",tk[tk.EBMLVersion=17030]="EBMLVersion",tk[tk.EBMLReadVersion=17143]="EBMLReadVersion",tk[tk.EBMLMaxIDLength=17138]="EBMLMaxIDLength",tk[tk.EBMLMaxSizeLength=17139]="EBMLMaxSizeLength",tk[tk.DocType=17026]="DocType",tk[tk.DocTypeVersion=17031]="DocTypeVersion",tk[tk.DocTypeReadVersion=17029]="DocTypeReadVersion",tk[tk.Void=236]="Void",tk[tk.Segment=408125543]="Segment",tk[tk.SeekHead=290298740]="SeekHead",tk[tk.Seek=19899]="Seek",tk[tk.SeekID=21419]="SeekID",tk[tk.SeekPosition=21420]="SeekPosition",tk[tk.Info=357149030]="Info",tk[tk.TimestampScale=2807729]="TimestampScale",tk[tk.Duration=17545]="Duration",tk[tk.Tracks=374648427]="Tracks",tk[tk.TrackEntry=174]="TrackEntry",tk[tk.Video=224]="Video",tk[tk.Projection=30320]="Projection",tk[tk.ProjectionType=30321]="ProjectionType",tk[tk.ProjectionPrivate=30322]="ProjectionPrivate",tk[tk.Chapters=272869232]="Chapters",tk[tk.Cluster=524531317]="Cluster",tk[tk.Timestamp=231]="Timestamp",tk[tk.SilentTracks=22612]="SilentTracks",tk[tk.SilentTrackNumber=22743]="SilentTrackNumber",tk[tk.Position=167]="Position",tk[tk.PrevSize=171]="PrevSize",tk[tk.SimpleBlock=163]="SimpleBlock",tk[tk.BlockGroup=160]="BlockGroup",tk[tk.EncryptedBlock=175]="EncryptedBlock",tk[tk.Attachments=423732329]="Attachments",tk[tk.Tags=307544935]="Tags",tk[tk.Cues=475249515]="Cues",tk[tk.CuePoint=187]="CuePoint",tk[tk.CueTime=179]="CueTime",tk[tk.CueTrackPositions=183]="CueTrackPositions",tk[tk.CueTrack=247]="CueTrack",tk[tk.CueClusterPosition=241]="CueClusterPosition",tk[tk.CueRelativePosition=240]="CueRelativePosition",tk[tk.CueDuration=178]="CueDuration",tk[tk.CueBlockNumber=21368]="CueBlockNumber",tk[tk.CueCodecState=234]="CueCodecState",tk[tk.CueReference=219]="CueReference",tk[tk.CueRefTime=150]="CueRefTime",(tP=tW||(tW={})).SignedInteger="int",tP.UnsignedInteger="uint",tP.Float="float",tP.String="string",tP.UTF8="utf8",tP.Date="date",tP.Master="master",tP.Binary="binary";let eJ={[tz.EBML]:{type:tW.Master},[tz.EBMLVersion]:{type:tW.UnsignedInteger},[tz.EBMLReadVersion]:{type:tW.UnsignedInteger},[tz.EBMLMaxIDLength]:{type:tW.UnsignedInteger},[tz.EBMLMaxSizeLength]:{type:tW.UnsignedInteger},[tz.DocType]:{type:tW.String},[tz.DocTypeVersion]:{type:tW.UnsignedInteger},[tz.DocTypeReadVersion]:{type:tW.UnsignedInteger},[tz.Void]:{type:tW.Binary},[tz.Segment]:{type:tW.Master},[tz.SeekHead]:{type:tW.Master},[tz.Seek]:{type:tW.Master},[tz.SeekID]:{type:tW.Binary},[tz.SeekPosition]:{type:tW.UnsignedInteger},[tz.Info]:{type:tW.Master},[tz.TimestampScale]:{type:tW.UnsignedInteger},[tz.Duration]:{type:tW.Float},[tz.Tracks]:{type:tW.Master},[tz.TrackEntry]:{type:tW.Master},[tz.Video]:{type:tW.Master},[tz.Projection]:{type:tW.Master},[tz.ProjectionType]:{type:tW.UnsignedInteger},[tz.ProjectionPrivate]:{type:tW.Master},[tz.Chapters]:{type:tW.Master},[tz.Cluster]:{type:tW.Master},[tz.Timestamp]:{type:tW.UnsignedInteger},[tz.SilentTracks]:{type:tW.Master},[tz.SilentTrackNumber]:{type:tW.UnsignedInteger},[tz.Position]:{type:tW.UnsignedInteger},[tz.PrevSize]:{type:tW.UnsignedInteger},[tz.SimpleBlock]:{type:tW.Binary},[tz.BlockGroup]:{type:tW.Master},[tz.EncryptedBlock]:{type:tW.Binary},[tz.Attachments]:{type:tW.Master},[tz.Tags]:{type:tW.Master},[tz.Cues]:{type:tW.Master},[tz.CuePoint]:{type:tW.Master},[tz.CueTime]:{type:tW.UnsignedInteger},[tz.CueTrackPositions]:{type:tW.Master},[tz.CueTrack]:{type:tW.UnsignedInteger},[tz.CueClusterPosition]:{type:tW.UnsignedInteger},[tz.CueRelativePosition]:{type:tW.UnsignedInteger},[tz.CueDuration]:{type:tW.UnsignedInteger},[tz.CueBlockNumber]:{type:tW.UnsignedInteger},[tz.CueCodecState]:{type:tW.UnsignedInteger},[tz.CueReference]:{type:tW.Master},[tz.CueRefTime]:{type:tW.UnsignedInteger}},eX=e=>{let t;let i=e.getUint8(0),s=0;128&i?s=1:64&i?s=2:32&i?s=3:16&i&&(s=4);let a=eK(e,s),r=a in eJ,n=r?eJ[a].type:tW.Binary,o=e.getUint8(s),l=0;128&o?l=1:64&o?l=2:32&o?l=3:16&o?l=4:8&o?l=5:4&o?l=6:2&o?l=7:1&o&&(l=8);let u=new DataView(e.buffer,e.byteOffset+s+1,l-1),h=(o&255>>l)*2**((l-1)*8)+eK(u),d=s+l;return t=d+h>e.byteLength?new DataView(e.buffer,e.byteOffset+d):new DataView(e.buffer,e.byteOffset+d,h),{tag:r?a:"0x"+a.toString(16).toUpperCase(),type:n,tagHeaderSize:d,tagSize:d+h,value:t,valueSize:h}},eK=(e,t=e.byteLength)=>{switch(t){case 1:return e.getUint8(0);case 2:return e.getUint16(0);case 3:return 65536*e.getUint8(0)+e.getUint16(1);case 4:return e.getUint32(0);case 5:return 4294967296*e.getUint8(0)+e.getUint32(1);case 6:return 4294967296*e.getUint16(0)+e.getUint32(2);case 7:{let t=281474976710656*e.getUint8(0)+4294967296*e.getUint16(1)+e.getUint32(3);if(Number.isSafeInteger(t))return t}case 8:throw ReferenceError("Int64 is not supported")}return 0},eZ=(e,t)=>{switch(t){case tW.SignedInteger:return e.getInt8(0);case tW.UnsignedInteger:return eK(e);case tW.Float:return 4===e.byteLength?e.getFloat32(0):e.getFloat64(0);case tW.String:return new TextDecoder("ascii").decode(e);case tW.UTF8:return new TextDecoder("utf-8").decode(e);case tW.Date:return new Date(Date.UTC(2001,0)+e.getInt8(0)).getTime();case tW.Master:case tW.Binary:return e;default:(0,E.assertNever)(t)}},e0=(e,t)=>{let i=0;for(;i<e.byteLength;){let s=eX(new DataView(e.buffer,e.byteOffset+i));if(!t(s))return;s.type===tW.Master&&e0(s.value,t),i=s.value.byteOffset-e.byteOffset+s.valueSize}},e1=[tz.Info,tz.SeekHead,tz.Tracks,tz.TrackEntry,tz.Video,tz.Projection,tz.ProjectionType,tz.ProjectionPrivate,tz.Chapters,tz.Cluster,tz.Cues,tz.Attachments,tz.Tags],e3=[tz.Timestamp,tz.SilentTracks,tz.SilentTrackNumber,tz.Position,tz.PrevSize,tz.SimpleBlock,tz.BlockGroup,tz.EncryptedBlock],e2={validateData:e=>{let t,i,s;return e.getUint32(0)===tz.EBML&&(e0(eX(e).value,({tag:e,type:a,value:r})=>(e===tz.EBMLReadVersion?t=eZ(r,a):e===tz.DocType?i=eZ(r,a):e===tz.DocTypeReadVersion&&(s=eZ(r,a)),!0)),(void 0===t||t<=1)&&void 0!==i&&"webm"===i&&(void 0===s||s<=2))},parseInit:e=>{let t,i,s,a,r=!1,n=!1,o=!1,l,u,h=!1;return e0(e,({tag:e,type:d,value:c,valueSize:p})=>(e===tz.SeekID?u=eK(eZ(c,d)):e!==tz.SeekPosition&&(u=void 0),e===tz.Segment?(t=c.byteOffset,i=c.byteOffset+p):e===tz.Info?r=!0:e===tz.SeekHead?n=!0:e===tz.TimestampScale?s=eZ(c,d):e===tz.Duration?a=eZ(c,d):e===tz.SeekPosition&&u===tz.Cues?l=eZ(c,d):e===tz.Tracks?e0(c,({tag:e,type:t,value:i})=>e!==tz.ProjectionType||(h=1===eZ(i,t),!1)):r&&n&&e1.includes(e)&&(o=!0),!o)),(0,E.assertNonNullable)(t,"Failed to parse webm Segment start"),(0,E.assertNonNullable)(i,"Failed to parse webm Segment end"),(0,E.assertNonNullable)(a,"Failed to parse webm Segment duration"),{segmentStart:Math.round(t/1e9*(s=s??1e6)*1e3),segmentEnd:Math.round(i/1e9*s*1e3),timeScale:s,segmentDuration:Math.round(a/1e9*s*1e3),cuesSeekPosition:l,is3dVideo:h,stereoMode:0,projectionType:tY.EQUIRECTANGULAR,projectionData:{pose:{yaw:0,pitch:0,roll:0},bounds:{top:0,bottom:0,left:0,right:0}}}},getIndexRange:e=>{if((0,E.isNullable)(e.cuesSeekPosition))return;let t=e.segmentStart+e.cuesSeekPosition;return{from:t,to:t+1048576}},parseSegments:(e,t)=>{let i,s=!1,a=!1,r=e=>(0,E.isNonNullable)(e.time)&&(0,E.isNonNullable)(e.position),n=[];return e0(e,({tag:e,type:t,value:o})=>{switch(e){case tz.Cues:s=!0;break;case tz.CuePoint:i&&r(i)&&n.push(i),i={};break;case tz.CueTime:i&&(i.time=eZ(o,t));break;case tz.CueTrackPositions:break;case tz.CueClusterPosition:i&&(i.position=eZ(o,t));break;default:s&&e1.includes(e)&&(a=!0)}return!(s&&a)}),i&&r(i)&&n.push(i),n.map((e,i)=>{let{time:s,position:a}=e,r=n[i+1];return{status:tH.NONE,time:{from:s,to:r?r.time:t.segmentDuration},byte:{from:t.segmentStart+a,to:r?t.segmentStart+r.position-1:t.segmentEnd-1}}})},parseFeedableSegmentChunk:e=>{let t=0,i=!1;try{e0(e,s=>s.tag===tz.Cluster?s.tagSize<=e.byteLength?(t=s.tagSize,!1):(t+=s.tagHeaderSize,!0):!!e3.includes(s.tag)&&(t+s.tagSize<=e.byteLength&&(t+=s.tagSize,i||=[tz.SimpleBlock,tz.BlockGroup,tz.EncryptedBlock].includes(s.tag)),!0))}catch{}return t>0&&t<=e.byteLength&&i?new DataView(e.buffer,e.byteOffset,t):null}},e4=e=>{if(!e.includes("/"))return parseFloat(e);{let t=e.split("/");return parseInt(t[0])/parseInt(t[1])}},e6=e=>{if(!e.startsWith("P"))return;let t=(e,t)=>{let i=e?parseFloat(e.replace(",",".")):NaN;return(isNaN(i)?0:i)*t},i=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/.exec(e),s=i?.[1]==="-"?-1:1,a={days:t(i?.[5],s),hours:t(i?.[6],s),minutes:t(i?.[7],s),seconds:t(i?.[8],s)};return 864e5*a.days+36e5*a.hours+6e4*a.minutes+1e3*a.seconds},e5=(e,t)=>{let i=e;for(let[e,s]of(i=i.replaceAll("$$","$"),Object.entries({RepresentationID:t.representationId,Number:t.segmentNumber,Bandwidth:t.bandwidth,Time:t.segmentTime}))){let t=RegExp(`\\$${e}(?:%0(\\d+)d)?\\$`,"g");i=i.replaceAll(t,(e,t)=>(0,E.isNullable)(s)?e:(0,E.isNullable)(t)?s:s.padStart(parseInt(t,10),"0"))}return i},e8=(e,t)=>{let i;let s=new DOMParser().parseFromString(e,"application/xml"),a={video:[],audio:[],text:[]},r=s.children[0],n=r.getElementsByTagName("Period")[0],o=r.querySelector("BaseURL")?.textContent?.trim()??"",l=n.children,u="dynamic"===r.getAttribute("type"),h=r.getAttribute("availabilityStartTime"),d=h?new Date(h).getTime():void 0,c=r.getAttribute("mediaPresentationDuration"),p=n.getAttribute("duration"),m=r.getElementsByTagName("vk:Attrs")[0]?.getElementsByTagName("vk:XPlaybackDuration")[0].textContent;if(c)i=e6(c);else if(p){let e=e6(p);(0,E.isNonNullable)(e)&&(i=e)}else m&&(i=parseInt(m,10));let f=0,g=r.getAttribute("profiles")?.split(",")??[],b=g.includes(tU.WEBM_AS_IN_FFMPEG)||g.includes(tU.WEBM_AS_IN_SPEC)?tq.WEBM:tq.MP4;for(let e of l){let s=e.getAttribute("mimeType"),r=e.getAttribute("codecs"),n=e.getAttribute("contentType")??s?.split("/")[0],l=e.getAttribute("profiles")?.split(",")??[],u=e.querySelectorAll("Representation"),h=e.querySelector("SegmentTemplate");if(n===tV.TEXT){for(let i of u){let s=i.getAttribute("id")||"",r=e.getAttribute("lang"),n=e.getAttribute("label"),l=new URL((i.querySelector("BaseURL")?.textContent?.trim()??"")||o,t).toString(),u=s.includes("_auto");a[tV.TEXT].push({id:s,lang:r,label:n,isAuto:u,kind:tV.TEXT,url:l})}continue}for(let d of u){let u;let c=d.getAttribute("mimeType")??s,p=d.getAttribute("codecs")??r??"",m=d.getAttribute("contentType")??c?.split("/")[0]??n,b=e.getAttribute("profiles")?.split(",")??[],S=parseInt(d.getAttribute("width")??"",10),v=parseInt(d.getAttribute("height")??"",10),y=parseInt(d.getAttribute("bandwidth")??"",10)/1e3,T=d.getAttribute("frameRate")??"",w=d.getAttribute("quality")??void 0,A=T?e4(T):void 0,$=d.getAttribute("id")??(f++).toString(10),k="video"===m?`${v}p`:"audio"===m?`${y}Kbps`:p,P=`${$}@${k}`,L=new URL((d.querySelector("BaseURL")?.textContent?.trim()??"")||o,t).toString(),C=[...g,...l,...b],x=d.querySelector("SegmentBase"),R=d.querySelector("SegmentTemplate")??h;if(x){let[e,t]=(d.querySelector("SegmentBase Initialization")?.getAttribute("range")??"").split("-").map(e=>parseInt(e,10)),i={from:e,to:t},s=d.querySelector("SegmentBase")?.getAttribute("indexRange"),[a,r]=s?s.split("-").map(e=>parseInt(e,10)):[],n=s?{from:a,to:r}:void 0;u={type:tj.BYTE_RANGE,url:L,initRange:i,indexRange:n}}else if(R){let e={representationId:d.getAttribute("id")??void 0,bandwidth:d.getAttribute("bandwidth")??void 0},t=parseInt(R.getAttribute("timescale")??"",10),s=R.getAttribute("initialization")??"",a=R.getAttribute("media"),r=parseInt(R.getAttribute("startNumber")??"",10)??1,n=e5(s,e);if(!a)throw ReferenceError("No media attribute in SegmentTemplate");let o=R.querySelectorAll("SegmentTimeline S")??[],l=[],h=0,c="",p=0;if(o.length){let i=r,s=0;for(let r of o){let n=parseInt(r.getAttribute("d")??"",10),o=parseInt(r.getAttribute("r")??"",10)||0,u=parseInt(r.getAttribute("t")??"",10);s=Number.isFinite(u)?u:s;let d=n/t*1e3,c=s/t*1e3;for(let t=0;t<o+1;t++){let r=e5(a,{...e,segmentNumber:i.toString(10),segmentTime:(s+t*n).toString(10)}),o=(c??0)+t*d,u=o+d;i++,l.push({time:{from:o,to:u},url:r})}s+=(o+1)*n,h+=(o+1)*d}p=s/t*1e3,c=e5(a,{...e,segmentNumber:i.toString(10),segmentTime:s.toString(10)})}else if((0,E.isNonNullable)(i)){let s=parseInt(R.getAttribute("duration")??"",10)/t*1e3,r=Math.ceil(i/s),n=0;for(let t=1;t<r;t++){let i=e5(a,{...e,segmentNumber:t.toString(10),segmentTime:n.toString(10)});l.push({time:{from:n,to:n+s},url:i}),n+=s}p=n,c=e5(a,{...e,segmentNumber:r.toString(10),segmentTime:n.toString(10)})}let m={time:{from:p,to:1/0},url:c};u={type:tj.TEMPLATE,baseUrl:L,segmentTemplateUrl:a,initUrl:n,totalSegmentsDurationMs:h,segments:l,nextSegmentBeyondManifest:m,timescale:t}}else throw ReferenceError("Unknown MPD segment referencing type");if(!m||!c)continue;let D={video:tV.VIDEO,audio:tV.AUDIO,text:tV.TEXT}[m];D&&a[D].push({id:P,kind:D,segmentReference:u,profiles:C,duration:i,bitrate:y,mime:c,codecs:p,width:S,height:v,fps:A,quality:w})}}return{dynamic:u,liveAvailabilityStartTime:d,duration:i,container:b,representations:a}},e7=({id:e,width:t,height:i,bitrate:s,fps:a,quality:r})=>{let n=(r?K(r):void 0)??(0,E.videoSizeToQuality)({width:t,height:i});return n&&{id:e,quality:n,bitrate:s,size:{width:t,height:i},fps:a}},e9=({id:e,bitrate:t})=>({id:e,bitrate:t}),te=(e,t,i)=>{let s=t.indexOf(i);return e.at(Math.round(e.length*s/t.length))??e.at(-1)},tt=({id:e,lang:t,label:i,url:s,isAuto:a})=>({id:e,url:s,isAuto:a,type:"internal",language:t,label:i}),ti=e=>"url"in e,ts=e=>e.type===tj.TEMPLATE,ta=e=>e instanceof DOMException&&("AbortError"===e.name||20===e.code);class tr{onLastSegment$=new E.ValueSubject(!1);fullyBuffered$=new E.ValueSubject(!1);playingRepresentation$=new E.ValueSubject(void 0);playingRepresentationInit$=new E.ValueSubject(void 0);error$=new E.Subject;gaps=[];subscription=new E.Subscription;kind;container;containerParser;initData;parsedInitData;representations;segments;allInitsLoaded=!1;activeSegments=new Set;mediaSource;playingRepresentationId;downloadingRepresentationId;switchingToRepresentationId;sourceBuffer;downloadAbortController=new eN;destroyAbortController=new eN;getCurrentPosition;isActiveLowLatency;tuning;forwardBufferTarget;fetcher;bufferLimit=1/0;sourceBufferTaskQueue;gapDetectionIdleCallback;initLoadIdleCallback;failedDownloads=0;compatibilityMode;preloadOnly;isLive=!1;liveUpdateSegmentIndex=0;liveInitialAdditionalOffset=0;isSeekingLive=!1;index=0;constructor(e,t,i,s,{fetcher:a,tuning:r,getCurrentPosition:n,isActiveLowLatency:o,compatibilityMode:l=!1,manifest:u}){switch(this.fetcher=a,this.tuning=r,this.compatibilityMode=l,this.forwardBufferTarget=r.dash.forwardBufferTargetAuto,this.getCurrentPosition=n,this.isActiveLowLatency=o,this.isLive=!!u?.dynamic,this.container=i,i){case tq.MP4:this.containerParser=eW;break;case tq.WEBM:this.containerParser=e2;break;default:(0,E.assertNever)(i)}this.initData=new Map(s.map(e=>[e.id,null])),this.segments=new Map,this.parsedInitData=new Map,this.representations=new Map(s.map(e=>[e.id,e])),this.kind=e,this.mediaSource=t,this.sourceBuffer=null}startWith=(0,E.abortable)(this.destroyAbortController.signal,(async function*(e){let t=this.representations.get(e);(0,E.assertNonNullable)(t,`Cannot find representation ${e}`),this.playingRepresentationId=e,this.downloadingRepresentationId=e,this.sourceBuffer=this.mediaSource.addSourceBuffer(`${t.mime}; codecs="${t.codecs}"`),this.sourceBufferTaskQueue=new e_(this.sourceBuffer),this.subscription.add((0,E.fromEvent)(this.sourceBuffer,"updateend").subscribe(()=>{this.checkEjectedSegments(),this.maintain()},e=>this.error$.next({id:"SegmentEjection",category:E.ErrorCategory.WTF,message:"Error when trying to clear segments ejected by browser",thrown:e}))),this.subscription.add((0,E.fromEvent)(this.sourceBuffer,"error").subscribe(()=>this.error$.next({id:"SourceBuffer",category:E.ErrorCategory.VIDEO_PIPELINE,message:"SourceBuffer Error event fired"}))),this.subscription.add(this.sourceBufferTaskQueue.bufferFull$.subscribe(e=>{if(!this.sourceBuffer)return;let t=Math.min(this.bufferLimit,.8*eB(this.sourceBuffer.buffered));this.bufferLimit=t,this.pruneBuffer(this.getCurrentPosition(),e)})),this.subscription.add(this.sourceBufferTaskQueue.error$.subscribe(e=>this.error$.next(e))),yield this.loadInit(t,"high",!0);let i=this.initData.get(t.id),s=this.segments.get(t.id),a=this.parsedInitData.get(t.id);(0,E.assertNonNullable)(i,"No init buffer for starting representation"),(0,E.assertNonNullable)(s,"No segments for starting representation"),i instanceof ArrayBuffer&&(this.searchGaps(s,t),yield this.sourceBufferTaskQueue.append(i,this.destroyAbortController.signal),this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(a))}).bind(this));switchTo=(0,E.abortable)(this.destroyAbortController.signal,(async function*(e){if(e===this.downloadingRepresentationId||e===this.switchingToRepresentationId)return;this.switchingToRepresentationId=e;let t=this.representations.get(e);(0,E.assertNonNullable)(t,`No such representation ${e}`);let i=this.segments.get(e),s=this.initData.get(e);if((0,E.isNullable)(s)||(0,E.isNullable)(i)?yield this.loadInit(t,"high",!1):s instanceof Promise&&(yield s),i=this.segments.get(e),(0,E.assertNonNullable)(i,"No segments for starting representation"),!(s=this.initData.get(e))||!(s instanceof ArrayBuffer)||!this.sourceBuffer)return;this.switchingToRepresentationId=void 0,this.downloadingRepresentationId=e,this.abort(),yield this.sourceBufferTaskQueue.append(s,this.downloadAbortController.signal);let a=this.getCurrentPosition();(0,E.isNonNullable)(a)&&(this.isLive||(i.forEach(e=>e.status=tH.NONE),this.pruneBuffer(a,1/0,!0)),this.maintain(a))}).bind(this));abort(){for(let e of this.activeSegments)this.abortSegment(e.segment);this.activeSegments.clear(),this.downloadAbortController.abort(),this.downloadAbortController=new eN,this.abortBuffer()}maintain(e=this.getCurrentPosition()){if((0,E.isNullable)(e)||(0,E.isNullable)(this.downloadingRepresentationId)||(0,E.isNullable)(this.playingRepresentationId)||(0,E.isNullable)(this.sourceBuffer)||this.isSeekingLive)return;let t=this.representations.get(this.downloadingRepresentationId),i=this.segments.get(this.downloadingRepresentationId);if((0,E.assertNonNullable)(t,`No such representation ${this.downloadingRepresentationId}`),!i)return;let s=i.find(t=>e>=t.time.from&&e<t.time.to),a=e;if(this.playingRepresentationId!==this.downloadingRepresentationId){let t=ew(this.sourceBuffer.buffered,e),i=s?s.time.to+100:-1/0;s&&s.time.to-e<this.tuning.dash.maxSegmentDurationLeftToSelectNextSegment&&t>=s.time.to-e+100&&(a=i)}if(isFinite(this.bufferLimit)&&eB(this.sourceBuffer.buffered)>=this.bufferLimit){let t=ew(this.sourceBuffer.buffered,e),i=Math.min(this.forwardBufferTarget,this.bufferLimit)*this.tuning.dash.minSafeBufferThreshold;this.pruneBuffer(e,1/0,t<i);return}let r=[];if(!this.activeSegments.size&&(r=this.selectForwardBufferSegments(i,t.segmentReference.type,a)).length){let e="auto";if(this.tuning.dash.useFetchPriorityHints&&s){if(r.includes(s))e="high";else{let t=r.at(0);t&&t.time.from-s.time.to>=this.forwardBufferTarget/2&&(e="low")}}this.loadSegments(r,t,e)}(!this.preloadOnly&&!this.allInitsLoaded&&s&&s.status===tH.FED&&!r.length&&ew(this.sourceBuffer.buffered,e)>3e3||this.isActiveLowLatency())&&this.loadNextInit();let n=i.at(-1);n&&n.status===tH.FED&&(this.fullyBuffered$.next(!0),this.isLive||this.onLastSegment$.next(s===n))}searchGaps(e,t){this.gaps=[];let i=0,s=this.isLive?this.liveInitialAdditionalOffset:0;for(let a of e)Math.trunc(a.time.from-i)>0&&this.gaps.push({representation:t.id,from:i,to:a.time.from+s}),i=a.time.to;(0,E.isNonNullable)(t.duration)&&t.duration-i>0&&this.gaps.push({representation:t.id,from:i,to:t.duration})}getActualLiveStartingSegments(e){let t=e.segments,i=this.isActiveLowLatency()?this.tuning.dashCmafLive.lowLatency.maxTargetOffset:this.tuning.dashCmafLive.maxActiveLiveOffset,s=[],a=0,r=t.length-1;do s.unshift(t[r]),a+=t[r].time.to-t[r].time.from,r--;while(a<i&&r>=0)return this.liveInitialAdditionalOffset=a-i,this.isActiveLowLatency()?[s[0]]:s}getLiveSegmentsToLoadState(e){let t=e?.representations[this.kind].find(e=>e.id===this.downloadingRepresentationId);if(!t)return;let i=this.segments.get(t.id);if(i?.length)return{from:i[0].time.from,to:i[i.length-1].time.to}}seekLive=(0,E.abortable)(this.destroyAbortController.signal,(async function*(e){if(this.isSeekingLive=!0,!this.downloadingRepresentationId||!e)return;for(let t of this.representations.keys()){let i=e.find(e=>e.id===t);i&&this.representations.set(t,i);let s=this.representations.get(t);if(!s||!ts(s.segmentReference))return;let a=this.getActualLiveStartingSegments(s.segmentReference);this.segments.set(s.id,a)}let t=this.switchingToRepresentationId??this.downloadingRepresentationId,i=this.representations.get(t);(0,E.assertNonNullable)(i);let s=this.segments.get(t);(0,E.assertNonNullable)(s,"No segments for starting representation");let a=this.initData.get(t);if((0,E.assertNonNullable)(a,"No init buffer for starting representation"),!(a instanceof ArrayBuffer))return;let r=this.getDebugBufferState();this.liveUpdateSegmentIndex=0,this.abort(),r&&(yield this.sourceBufferTaskQueue.remove(1e3*r.from,1e3*r.to,this.destroyAbortController.signal)),this.searchGaps(s,i),yield this.sourceBufferTaskQueue.append(a,this.destroyAbortController.signal),this.isSeekingLive=!1}).bind(this));updateLive(e){for(let t of e?.representations[this.kind].values()??[]){if(!t||!ts(t.segmentReference))return;let e=t.segmentReference.segments.map(e=>({...e,status:tH.NONE,size:void 0})),i=this.segments.get(t.id)??[],s=i.at(-1)?.time.to??0,a=e?.findIndex(e=>Math.floor(s)>=Math.floor(e.time.from)&&Math.floor(s)<=Math.floor(e.time.to));if(-1===a){this.liveUpdateSegmentIndex=0;let e=this.getActualLiveStartingSegments(t.segmentReference);this.segments.set(t.id,e)}else{let s=e.slice(a+1);this.segments.set(t.id,[...i,...s])}}}updateLowLatencyLive(e){if(this.isActiveLowLatency())for(let t of this.representations.values()){let i=t.segmentReference;if(!ts(i))return;let s=Math.round(e.segment.time.to*i.timescale/1e3).toString(10),a=e5(i.segmentTemplateUrl,{segmentTime:s}),r=this.segments.get(t.id)??[],n=r.find(t=>Math.floor(t.time.from)===Math.floor(e.segment.time.from));n&&(n.time.to=e.segment.time.to),r.find(t=>Math.floor(t.time.from)===Math.floor(e.segment.time.to))||r.push({status:tH.NONE,time:{from:e.segment.time.to,to:1/0},url:a})}}findSegmentStartTime(e){let t=this.switchingToRepresentationId??this.downloadingRepresentationId??this.playingRepresentationId;if(!t)return;let i=this.segments.get(t);return i?i.find(t=>t.time.from<=e&&t.time.to>=e)?.time.from??void 0:void 0}setTarget(e){this.forwardBufferTarget=e}setPreloadOnly(e){this.preloadOnly=e}destroy(){if(this.initData.clear(),this.segments.clear(),this.parsedInitData.clear(),this.representations.clear(),this.sourceBufferTaskQueue?.destroy(),this.gapDetectionIdleCallback&&window.cancelIdleCallback&&window.cancelIdleCallback(this.gapDetectionIdleCallback),this.initLoadIdleCallback&&window.cancelIdleCallback&&window.cancelIdleCallback(this.initLoadIdleCallback),this.subscription.unsubscribe(),this.sourceBuffer){"open"===this.mediaSource.readyState&&this.abortBuffer();try{this.mediaSource.removeSourceBuffer(this.sourceBuffer)}catch(e){if(!(e instanceof DOMException&&"NotFoundError"===e.name))throw e}}this.sourceBuffer=null,this.downloadAbortController.abort(),this.destroyAbortController.abort()}selectForwardBufferSegments(e,t,i){return this.isLive?this.selectForwardBufferSegmentsLive(e,i):this.selectForwardBufferSegmentsRecord(e,t,i)}selectForwardBufferSegmentsLive(e,t){let i=e.findIndex(e=>t>=e.time.from&&t<e.time.to);return this.playingRepresentationId!==this.downloadingRepresentationId&&(this.liveUpdateSegmentIndex=i),this.liveUpdateSegmentIndex<e.length?e.slice(this.liveUpdateSegmentIndex++):[]}selectForwardBufferSegmentsRecord(e,t,i){let s=e.findIndex(({status:e,time:{from:t,to:s}},a)=>{let r=t<=i&&s>=i,n=t>i||r||0===a&&0===i,o=Math.min(this.forwardBufferTarget,this.bufferLimit),l=this.preloadOnly&&t<=i+o||s<=i+o;return(e===tH.NONE||e===tH.PARTIALLY_EJECTED&&n&&l&&this.sourceBuffer&&!eI(this.sourceBuffer.buffered,i))&&n&&l});if(-1===s)return[];if(t!==tj.BYTE_RANGE)return e.slice(s,s+1);let a=0,r=0,n=[],o=this.preloadOnly?0:this.tuning.dash.segmentRequestSize,l=this.preloadOnly?this.forwardBufferTarget:0;for(let t=s;t<e.length&&(a<=o||r<=l);t++){let i=e[t];if(a+=i.byte.to+1-i.byte.from,r+=i.time.to+1-i.time.from,i.status===tH.NONE||i.status===tH.PARTIALLY_EJECTED)n.push(i);else break}return n}async loadSegments(e,t,i="auto"){t.segmentReference.type===tj.TEMPLATE?await this.loadTemplateSegment(e[0],t,i):await this.loadByteRangeSegments(e,t,i)}async loadTemplateSegment(e,t,i="auto"){e.status=tH.DOWNLOADING;let s={segment:e,loadedBytes:0,feedingBytes:0,fedBytes:0,representationId:t.id};this.activeSegments.add(s);let{range:a,url:r,signal:n,onProgress:o,onProgressTasks:l}=this.prepareTemplateFetchSegmentParams(e,t);this.failedDownloads&&n&&(await (0,E.abortable)(n,(async function*(){let e=(0,E.getExponentialDelay)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise(t=>setTimeout(t,e))}).bind(this))(),n.aborted&&this.abortActiveSegments([e]));try{let e=await this.fetcher.fetch(r,{range:a,signal:n,onProgress:o,priority:i,isLowLatency:this.isActiveLowLatency()});if(!e)return;let u=new DataView(e);if(this.isActiveLowLatency()){let e=t.segmentReference.timescale;s.segment.time.to=this.containerParser.getSegmentEndTime(u,e)}o&&s.feedingBytes&&l?await Promise.all(l):await this.sourceBufferTaskQueue.append(u,n),s.segment.status=tH.DOWNLOADED,this.onSegmentFullyAppended(s,t.id),this.failedDownloads=0}catch(t){if(!ta(t))return;this.abortActiveSegments([e]),this.onSegmentDownloadError(t)}}async loadByteRangeSegments(e,t,i="auto"){if(!e.length)return;for(let i of e)i.status=tH.DOWNLOADING,this.activeSegments.add({segment:i,loadedBytes:0,feedingBytes:0,fedBytes:0,representationId:t.id});let{range:s,url:a,signal:r,onProgress:n}=this.prepareByteRangeFetchSegmentParams(e,t);this.failedDownloads&&r&&(await (0,E.abortable)(r,(async function*(){let e=(0,E.getExponentialDelay)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise(t=>setTimeout(t,e))}).bind(this))(),r.aborted&&this.abortActiveSegments(e));try{await this.fetcher.fetch(a,{range:s,onProgress:n,signal:r,priority:i}),this.failedDownloads=0}catch(t){if(!ta(t))return;this.abortActiveSegments(e),this.onSegmentDownloadError(t)}}prepareByteRangeFetchSegmentParams(e,t){if(ts(t.segmentReference))throw Error("Representation is not byte range type");let i=t.segmentReference.url,s={from:e.at(0).byte.from,to:e.at(-1).byte.to},{signal:a}=this.downloadAbortController,r=()=>{this.abort()};return{url:i,range:s,signal:a,onProgress:(e,i)=>{if(!a.aborted)try{this.onSomeByteRangesDataLoaded({dataView:e,loaded:i,signal:a,onSegmentAppendFailed:r,globalFrom:s?s.from:0,representationId:t.id})}catch(e){this.error$.next({id:"SegmentFeeding",category:E.ErrorCategory.VIDEO_PIPELINE,message:"Error when feeding segments",thrown:e})}}}}prepareTemplateFetchSegmentParams(e,t){if(!ts(t.segmentReference))throw Error("Representation is not template type");let i=new URL(e.url,t.segmentReference.baseUrl);this.isActiveLowLatency()&&i.searchParams.set("low-latency","yes");let s=i.toString(),{signal:a}=this.downloadAbortController,r=()=>{this.abort()},n=[],o=this.isActiveLowLatency()||this.tuning.dash.enableSubSegmentBufferFeeding&&this.liveUpdateSegmentIndex<3?(e,i)=>{if(!a.aborted)try{let s=this.onSomeTemplateDataLoaded({dataView:e,loaded:i,signal:a,onSegmentAppendFailed:r,representationId:t.id});n.push(s)}catch(e){this.error$.next({id:"SegmentFeeding",category:E.ErrorCategory.VIDEO_PIPELINE,message:"Error when feeding segments",thrown:e})}}:void 0;return{url:s,signal:a,onProgress:o,onProgressTasks:n}}abortActiveSegments(e){for(let t of this.activeSegments)e.includes(t.segment)&&this.abortSegment(t.segment)}onSegmentDownloadError(e){let t=!1,i=this.getCurrentPosition();this.sourceBuffer&&(0,E.isNonNullable)(i)&&(t=ew(this.sourceBuffer?.buffered,i)>=this.tuning.downloadBackoff.bufferThreshold),this.failedDownloads++,t||this.error$.next({id:"SegmentDownload",category:E.ErrorCategory.NETWORK,message:"Error when fetching segments",thrown:e})}async onSomeTemplateDataLoaded({dataView:e,representationId:t,loaded:i,onSegmentAppendFailed:s,signal:a}){if(!(!this.activeSegments.size||!this.representations.get(t)))for(let r of this.activeSegments){let{segment:n}=r;if(r.representationId===t){if(a.aborted){s();continue}if(r.loadedBytes=i,r.loadedBytes>r.feedingBytes){let t=new DataView(e.buffer,e.byteOffset+r.feedingBytes,r.loadedBytes-r.feedingBytes),i=this.containerParser.parseFeedableSegmentChunk(t);i?.byteLength&&(n.status=tH.PARTIALLY_FED,r.feedingBytes+=i.byteLength,await this.sourceBufferTaskQueue.append(i),r.fedBytes+=i.byteLength)}}}}onSomeByteRangesDataLoaded({dataView:e,representationId:t,globalFrom:i,loaded:s,signal:a,onSegmentAppendFailed:r}){if(!this.activeSegments.size)return;let n=this.representations.get(t);if(!n)return;let o=n.segmentReference.type,l=e.byteLength;for(let n of this.activeSegments){let{segment:u}=n,h=o===tj.BYTE_RANGE,d=h?u.byte.to-u.byte.from+1:l;if(n.representationId!==t||!(!h||u.byte.from>=i&&u.byte.to<i+e.byteLength))continue;if(a.aborted){r();continue}let c=h?u.byte.from-i:0,p=h?u.byte.to-i:e.byteLength,m=c<s,f=p<=s;if(u.status===tH.DOWNLOADING&&m&&f){u.status=tH.DOWNLOADED;let i=new DataView(e.buffer,e.byteOffset+c,d);this.sourceBufferTaskQueue.append(i,a).then(e=>e&&!a.aborted?this.onSegmentFullyAppended(n,t):r())}else if(this.tuning.dash.enableSubSegmentBufferFeeding&&m&&(n.loadedBytes=Math.min(d,s-c),n.loadedBytes>n.feedingBytes)){let i=new DataView(e.buffer,e.byteOffset+c+n.feedingBytes,n.loadedBytes-n.feedingBytes),s=n.loadedBytes===d?i:this.containerParser.parseFeedableSegmentChunk(i);s?.byteLength&&(u.status=tH.PARTIALLY_FED,n.feedingBytes+=s.byteLength,this.sourceBufferTaskQueue.append(s,a).then(e=>{if(a.aborted)r();else if(e)n.fedBytes+=s.byteLength,n.fedBytes===d&&this.onSegmentFullyAppended(n,t);else{if(n.feedingBytes<d)return;r()}}))}}}onSegmentFullyAppended(e,t){for(let i of(this.playingRepresentationId=t,this.playingRepresentation$.next(this.playingRepresentationId),this.playingRepresentationInit$.next(this.parsedInitData.get(this.playingRepresentationId)),e.segment.status=tH.FED,ti(e.segment)&&(e.segment.size=e.fedBytes),this.representations.values()))if(i.id!==t)for(let t of this.segments.get(i.id)??[])t.status===tH.FED&&t.time.from===e.segment.time.from&&t.time.to===e.segment.time.to&&(t.status=tH.NONE);this.isActiveLowLatency()&&this.updateLowLatencyLive(e),this.activeSegments.delete(e),this.detectGapsWhenIdle(t,[e.segment])}abortSegment(e){for(let t of(this.tuning.useDashAbortPartiallyFedSegment&&e.status===tH.PARTIALLY_FED||e.status===tH.PARTIALLY_EJECTED?(this.sourceBufferTaskQueue.remove(e.time.from,e.time.to).then(()=>e.status=tH.NONE),e.status=tH.PARTIALLY_EJECTED):e.status=tH.NONE,this.activeSegments.values()))if(t.segment===e){this.activeSegments.delete(t);break}}loadNextInit(){if(this.allInitsLoaded||this.initLoadIdleCallback)return;let e=null,t=!1;for(let[i,s]of this.initData.entries()){let a=s instanceof Promise;t||=a,null===s&&(e=i)}if(!e){this.allInitsLoaded=!0;return}if(t)return;let i=this.representations.get(e);i&&(this.initLoadIdleCallback=eM(()=>this.loadInit(i,"low",!1).finally(()=>this.initLoadIdleCallback=null)))}async loadInit(e,t="auto",i=!1){let s=this.tuning.dash.useFetchPriorityHints?t:"auto",a=(!i&&this.failedDownloads>0?(0,E.abortable)(this.destroyAbortController.signal,(async function*(){let e=(0,E.getExponentialDelay)(this.failedDownloads,this.tuning.downloadBackoff);yield new Promise(t=>setTimeout(t,e))}).bind(this))():Promise.resolve()).then(()=>this.fetcher.fetchRepresentation(e.segmentReference,this.containerParser,s)).then(async t=>{if(!t)return;let{init:i,dataView:s,segments:a}=t,r=s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);this.initData.set(e.id,r);let n=a;this.isLive&&ts(e.segmentReference)&&(n=this.getActualLiveStartingSegments(e.segmentReference)),this.isLive&&this.segments.has(e.id)||this.segments.set(e.id,n),i&&this.parsedInitData.set(e.id,i)}).then(()=>this.failedDownloads=0,t=>{this.initData.set(e.id,null),i&&this.error$.next({id:"LoadInits",category:E.ErrorCategory.WTF,message:"loadInit threw",thrown:t})});return this.initData.set(e.id,a),a}async pruneBuffer(e,t,i=!1){if(!this.sourceBuffer||!this.playingRepresentationId||(0,E.isNullable)(e)||this.sourceBuffer.updating)return!1;let s=0,a=1/0,r=-1/0,n=e=>{a=Math.min(a,e.time.from),r=Math.max(r,e.time.to);let t=ti(e)?e.size??0:e.byte.to-e.byte.from;s+=t};for(let i of this.segments.values())for(let a of i){if(a.time.to>=e-this.tuning.dash.bufferPruningSafeZone||s>=t)break;a.status===tH.FED&&n(a)}if(!(isFinite(a)&&isFinite(r)))for(let i of(s=0,a=1/0,r=-1/0,this.segments.values()))for(let a of i){if(a.time.from<e+Math.min(this.forwardBufferTarget,this.bufferLimit)||s>t)break;a.status===tH.FED&&n(a)}if(!(isFinite(a)&&isFinite(r)))for(let e=0;e<this.sourceBuffer.buffered.length;e++){let t=1e3*this.sourceBuffer.buffered.start(e),i=1e3*this.sourceBuffer.buffered.end(e);for(let e of this.segments.values())for(let s of e)if(s.status===tH.NONE&&Math.round(s.time.from)<=Math.round(t)&&Math.round(s.time.to)>=Math.round(i)){a=t,r=i;break}}if(!(isFinite(a)&&isFinite(r))&&i){s=0,a=1/0,r=-1/0;let t=Math.min(this.forwardBufferTarget,this.bufferLimit)*this.tuning.dash.minSafeBufferThreshold;for(let i of this.segments.values())for(let s of i)s.time.from>e+t&&s.status===tH.FED&&n(s)}return!!(isFinite(a)&&isFinite(r))&&this.sourceBufferTaskQueue.remove(a,r)}abortBuffer(){if(!this.sourceBuffer||"open"!==this.mediaSource.readyState)return;let e=this.playingRepresentationId&&this.initData.get(this.playingRepresentationId),t=e instanceof ArrayBuffer?e:void 0;this.sourceBufferTaskQueue.abort(t)}getDebugBufferState(){if(!(!this.sourceBuffer||!this.sourceBuffer.buffered.length))return{from:this.sourceBuffer.buffered.start(0),to:this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1)}}detectGaps(e,t){if(this.sourceBuffer)for(let i of t){let t={representation:e,from:i.time.from,to:i.time.to};for(let e=0;e<this.sourceBuffer.buffered.length;e++){let s=1e3*this.sourceBuffer.buffered.start(e),a=1e3*this.sourceBuffer.buffered.end(e);if(!(a<=i.time.from||s>=i.time.to)){if(s<=i.time.from&&a>=i.time.to){t=void 0;break}a>i.time.from&&a<i.time.to&&(t.from=a),s<i.time.to&&s>i.time.from&&(t.to=s)}}t&&t.to-t.from>1&&!this.gaps.some(e=>t&&e.from===t.from&&e.to===t.to)&&this.gaps.push(t)}}detectGapsWhenIdle(e,t){this.gapDetectionIdleCallback||(this.gapDetectionIdleCallback=eM(()=>{try{this.detectGaps(e,t)}catch(e){this.error$.next({id:"GapDetection",category:E.ErrorCategory.WTF,message:"detectGaps threw",thrown:e})}finally{this.gapDetectionIdleCallback=null}}))}checkEjectedSegments(){if((0,E.isNullable)(this.sourceBuffer)||(0,E.isNullable)(this.playingRepresentationId))return;let e=[];for(let t=0;t<this.sourceBuffer.buffered.length;t++){let i=Math.round(1e3*this.sourceBuffer.buffered.start(t)),s=Math.round(1e3*this.sourceBuffer.buffered.end(t));e.push({from:i,to:s})}for(let t of this.segments.values())for(let i of t){let{status:t}=i;if(t!==tH.FED&&t!==tH.PARTIALLY_EJECTED)continue;let s=Math.floor(i.time.from),a=Math.ceil(i.time.to),r=e.some(e=>e.from-1<=s&&e.to+1>=a),n=e.filter(e=>s>=e.from-1&&s<=e.to+1||a>=e.from-1&&a<=e.to+1);r||(1===n.length||this.gaps.some(e=>e.from===i.time.from||e.to===i.time.to)?i.status=tH.PARTIALLY_EJECTED:i.status=tH.NONE)}}}var tn,to,tl,tu,th,td,tc,tp,tm,tf,tg,tb,tS,tv,ty,tT,tE,tw,tA,t$,tk,tP,tL,tC,tx,tR,tD,tN,tI,tM,tO,t_,tB,tV,tF,tU,tj,tH,tq,tY,tG,tQ,tz,tW,tJ,tX=e=>{let t=new URL(e);return t.searchParams.set("quic","1"),t.toString()},tK=e=>{let t=e.get("X-Delivery-Type"),i=e.get("X-Reused");return{type:null===t?tD.HTTP1:t??void 0,reused:null===i?void 0:({1:!0,0:!1})[i]??void 0}};(r=tJ||(tJ={}))[r.HEADER=0]="HEADER",r[r.PARAM=1]="PARAM";class tZ{throughputEstimator;requestQuic;lastConnectionType$=new E.ValueSubject(void 0);lastConnectionReused$=new E.ValueSubject(void 0);lastRequestFirstBytes$=new E.ValueSubject(void 0);abortAllController=new eN;subscription=new E.Subscription;compatibilityMode;constructor({throughputEstimator:e,requestQuic:t,compatibilityMode:i=!1}){this.throughputEstimator=e,this.requestQuic=t,this.compatibilityMode=i}onHeadersReceived(e){let{type:t,reused:i}=tK(e);this.lastConnectionType$.next(t),this.lastConnectionReused$.next(i)}fetchManifest=(0,E.abortable)(this.abortAllController.signal,(async function*(e){let t=e;this.requestQuic&&(t=tX(t));let i=yield eD(t,{signal:this.abortAllController.signal}).catch(t0);return i?(this.onHeadersReceived(i.headers),i.text()):null}).bind(this));fetch=(0,E.abortable)(this.abortAllController.signal,(async function*(e,{rangeMethod:t=this.compatibilityMode?tJ.HEADER:tJ.PARAM,range:i,onProgress:s,priority:a="auto",signal:r,measureThroughput:n=!0,isLowLatency:o=!1}={}){let l=e,u=new Headers;if(i)switch(t){case tJ.HEADER:u.append("Range",`bytes=${i.from}-${i.to}`);break;case tJ.PARAM:{let e=new URL(l,location.href);e.searchParams.append("bytes",`${i.from}-${i.to}`),l=e.toString();break}default:(0,E.assertNever)(t)}this.requestQuic&&(l=tX(l));let h=this.abortAllController.signal,d;if(r){let e=new eN;if(d=(0,E.merge)((0,E.fromEvent)(this.abortAllController.signal,"abort"),(0,E.fromEvent)(r,"abort")).subscribe(()=>{try{e.abort()}catch(e){t0(e)}}),this.abortAllController.signal.aborted||r.aborted)try{e.abort()}catch(e){t0(e)}h=e.signal}let c=(0,E.now)(),p=yield eD(l,{priority:a,headers:u,signal:h}).catch(t0),m=(0,E.now)();if(!p)return d?.unsubscribe(),null;if(this.throughputEstimator?.addRawRtt(m-c),!p.ok||!p.body)return d?.unsubscribe(),Promise.reject(Error(`Fetch error ${p.status}: ${p.statusText}`));if(this.onHeadersReceived(p.headers),!s&&!n)return d?.unsubscribe(),p.arrayBuffer();let[f,g]=p.body.tee(),b=f.getReader();n&&this.throughputEstimator?.trackStream(g,o);let S=0,v=new Uint8Array(0),y=!1,T=e=>{d?.unsubscribe(),y=!0,t0(e)},w=(0,E.abortable)(h,(async function*({done:e,value:t}){if(0===S&&this.lastRequestFirstBytes$.next((0,E.now)()-c),h.aborted){d?.unsubscribe();return}if(!e&&t){let e=new Uint8Array(v.length+t.length);e.set(v),e.set(t,v.length),v=e,S+=t.byteLength,s?.(new DataView(v.buffer),S),yield b?.read().then(w,T)}}).bind(this));return yield b?.read().then(w,T),d?.unsubscribe(),y?null:v.buffer}).bind(this));async fetchRepresentation(e,t,i="auto"){let{type:s}=e;switch(s){case tj.BYTE_RANGE:return await this.fetchByteRangeRepresentation(e,t,i)??null;case tj.TEMPLATE:return await this.fetchTemplateRepresentation(e,i)??null;default:(0,E.assertNever)(s)}}destroy(){this.abortAllController.abort(),this.subscription.unsubscribe()}fetchByteRangeRepresentation=(0,E.abortable)(this.abortAllController.signal,(async function*(e,t,i){let s;if(e.type!==tj.BYTE_RANGE)return null;let{from:a,to:r}=e.initRange,n=a,o=r,l=!1,u,h;e.indexRange&&(u=e.indexRange.from,h=e.indexRange.to,(l=r+1===u)&&(n=Math.min(u,a),o=Math.max(h,r))),n=Math.min(n,0);let d=yield this.fetch(e.url,{range:{from:n,to:o},priority:i,measureThroughput:!1});if(!d)return null;let c=new DataView(d,a-n,r-n+1);if(!t.validateData(c))throw Error("Invalid media file");let p=t.parseInit(c),m=e.indexRange??t.getIndexRange(p);if(!m)throw ReferenceError("No way to load representation index");if(l)s=new DataView(d,m.from-n,m.to-m.from+1);else{let t=yield this.fetch(e.url,{range:m,priority:i,measureThroughput:!1});if(!t)return null;s=new DataView(t)}let f=t.parseSegments(s,p,m);return{init:p,dataView:new DataView(d),segments:f}}).bind(this));fetchTemplateRepresentation=(0,E.abortable)(this.abortAllController.signal,(async function*(e,t){if(e.type!==tj.TEMPLATE)return null;let i=new URL(e.initUrl,e.baseUrl).toString(),s=yield this.fetch(i,{priority:t,measureThroughput:!1});return s?{init:null,segments:e.segments.map(e=>({...e,status:tH.NONE,size:void 0})),dataView:new DataView(s)}:null}).bind(this))}let t0=e=>{if(!ta(e))throw e},t1=(e,t,i)=>i*t+(1-i)*e,t3=(e,t)=>e.reduce((e,t)=>e+t,0)/t,t2=(e,t,i,s)=>{let a=0,r=i,n=t3(e,t),o=t<s?t:s;for(let t=0;t<o;t++)e[r]>n?a++:a--,r=(e.length+r-1)%e.length;return Math.abs(a)===o};class t4{prevReported=void 0;rawSeries$;smoothedSeries$;reportedSeries$;smoothed;pastMeasures=[];takenMeasures=0;measuresCursor=0;params;smoothed$;debounced$;constructor(e){this.params=e,this.pastMeasures=Array(e.deviationDepth),this.smoothed=this.prevReported=e.initial,this.smoothed$=new E.ValueSubject(e.initial),this.debounced$=new E.ValueSubject(e.initial);let t=e.label??"value"+Math.random().toString(16).substring(2,6);this.rawSeries$=new er(`raw_${t}`),this.smoothedSeries$=new er(`smoothed_${t}`),this.reportedSeries$=new er(`reported_${t}`),this.rawSeries$.next(e.initial),this.smoothedSeries$.next(e.initial),this.reportedSeries$.next(e.initial)}next(e){let t=0,i=0;for(let e=0;e<this.pastMeasures.length;e++)void 0!==this.pastMeasures[e]&&(t+=(this.pastMeasures[e]-this.smoothed)**2,i++);this.takenMeasures=i;let s=Math.sqrt(t/=i),a=this.smoothed+this.params.deviationFactor*s,r=this.smoothed-this.params.deviationFactor*s;this.pastMeasures[this.measuresCursor]=e,this.measuresCursor=(this.measuresCursor+1)%this.pastMeasures.length,this.rawSeries$.next(e),this.updateSmoothedValue(e),this.smoothed$.next(this.smoothed),this.smoothedSeries$.next(this.smoothed),!(this.smoothed>a||this.smoothed<r)&&((0,E.isNullable)(this.prevReported)||Math.abs(this.smoothed-this.prevReported)/this.prevReported>=this.params.changeThreshold)&&(this.prevReported=this.smoothed,this.debounced$.next(this.smoothed),this.reportedSeries$.next(this.smoothed))}}class t6 extends t4{slow;fast;constructor(e){super(e),this.slow=this.fast=e.initial}updateSmoothedValue(e){this.slow=t1(this.slow,e,this.params.emaAlphaSlow),this.fast=t1(this.fast,e,this.params.emaAlphaFast);let t=this.params.fastDirection>0?Math.max:Math.min;this.smoothed=t(this.slow,this.fast)}}class t5 extends t4{emaSmoothed;constructor(e){super(e),this.emaSmoothed=e.initial}updateSmoothedValue(e){let t=t3(this.pastMeasures,this.takenMeasures);this.emaSmoothed=t1(this.emaSmoothed,e,this.params.emaAlpha);let i=t2(this.pastMeasures,this.takenMeasures,this.measuresCursor-1,this.params.basisTrendChangeCount);this.smoothed=i?this.emaSmoothed:t}}class t8 extends t4{extremumInterval;furtherValues=[];currentTopExtremumValue=0;constructor(e){super(e),this.extremumInterval=e.extremumInterval}next(e){this.currentTopExtremumValue<=e?(this.currentTopExtremumValue=e,this.furtherValues=[]):this.furtherValues.length===this.extremumInterval?(super.next(this.currentTopExtremumValue),this.currentTopExtremumValue=e,this.furtherValues=[]):this.furtherValues.push(e)}updateSmoothedValue(e){this.smoothed=this.smoothed?t1(this.smoothed,e,this.params.emaAlpha):e}}class t7{static getSmoothedValue(e,t,i){return"TwoEma"===i.type?new t6({initial:e,emaAlphaSlow:i.emaAlphaSlow,emaAlphaFast:i.emaAlphaFast,changeThreshold:i.changeThreshold,fastDirection:t,deviationDepth:i.deviationDepth,deviationFactor:i.deviationFactor,label:"throughput"}):new t5({initial:e,emaAlpha:i.emaAlpha,basisTrendChangeCount:i.basisTrendChangeCount,changeThreshold:i.changeThreshold,deviationDepth:i.deviationDepth,deviationFactor:i.deviationFactor,label:"throughput"})}static getLiveEstimatedDelaySmoothedValue(e,t){return new t8({initial:e,label:"liveEdgeDelay",...t})}}let t9=(e,t)=>{e&&e.playbackRate!==t&&(e.playbackRate=t)},ie=()=>window.ManagedMediaSource||window.MediaSource,it=()=>!!(window.ManagedMediaSource&&window.ManagedSourceBuffer?.prototype?.appendBuffer),ii=()=>window.ManagedMediaSource?new ManagedMediaSource:new MediaSource,is=["timeupdate","progress","play","seeked","stalled","waiting"];(n=m||(m={})).NONE="none",n.MANIFEST_READY="manifest_ready",n.REPRESENTATIOS_READY="representations_ready",n.RUNNING="running";let ia=class{element=null;manifestUrlString="";source=null;manifest=null;tuning;videoBufferManager;audioBufferManager;bufferManagers;throughputEstimator;subscription=new E.Subscription;representationSubscription=new E.Subscription;fetcher;state$=new x(m.NONE);currentVideoRepresentation$=new E.ValueSubject(void 0);currentVideoRepresentationInit$=new E.ValueSubject(void 0);error$=new E.Subject;lastConnectionType$=new E.ValueSubject(void 0);lastConnectionReused$=new E.ValueSubject(void 0);lastRequestFirstBytes$=new E.ValueSubject(void 0);isLive$=new E.ValueSubject(!1);liveDuration$=new E.ValueSubject(0);liveAvailabilityStartTime$=new E.ValueSubject(void 0);bufferLength$=new E.ValueSubject(0);liveLoadBufferLength$=new E.ValueSubject(0);livePositionFromPlayer$=new E.ValueSubject(0);liveEstimatedDelay;waitingEventInterval;isActiveLowLatency=!1;isUpdatingLive=!1;isJumpGapAfterSeekLive=!1;liveLastSeekOffset=0;forceEnded$=new E.Subject;gapWatchdogStarted=!1;gapWatchdogSubscription;destroyController=new eN;constructor(e){this.throughputEstimator=e.throughputEstimator,this.tuning=e.tuning,this.fetcher=new tZ({throughputEstimator:this.throughputEstimator,requestQuic:this.tuning.requestQuick,compatibilityMode:e.compatibilityMode}),this.liveEstimatedDelay=t7.getLiveEstimatedDelaySmoothedValue(0,{...e.tuning.dashCmafLive.lowLatency.delayEstimator})}initManifest=(0,E.abortable)(this.destroyController.signal,(async function*(e,t,i){this.element=e,this.manifestUrlString=P(t,i,tM.DASH_CMAF_OFFSET_P),this.state$.startTransitionTo(m.MANIFEST_READY),this.manifest=yield this.updateManifest(),this.manifest?.representations.video.length?this.state$.setState(m.MANIFEST_READY):this.error$.next({id:"NoRepresentations",category:E.ErrorCategory.PARSER,message:"No playable video representations"})}).bind(this));updateManifest=(0,E.abortable)(this.destroyController.signal,(async function*(){let e;let t=yield this.fetcher.fetchManifest(this.manifestUrlString).catch(e=>{this.manifest||this.bufferLength$.getValue()||this.error$.next({id:"LoadManifest",category:E.ErrorCategory.NETWORK,message:"Failed to load manifest",thrown:e})});if(!t)return null;try{e=e8(t??"",this.manifestUrlString)}catch(e){this.error$.next({id:"ManifestParsing",category:E.ErrorCategory.PARSER,message:"Failed to parse MPD manifest",thrown:e})}if(!e)return null;let i=({kind:e,mime:t,codecs:i})=>!!(this.element?.canPlayType?.(t)&&ie()?.isTypeSupported?.(`${t}; codecs="${i}"`)||e===tV.TEXT);return e.dynamic&&this.isLive$.getValue()!==e.dynamic&&(this.isLive$.next(e.dynamic),this.liveDuration$.getValue()!==e.duration&&this.liveDuration$.next(-1*(e.duration??0)/1e3),this.liveAvailabilityStartTime$.getValue()!==e.liveAvailabilityStartTime&&this.liveAvailabilityStartTime$.next(e.liveAvailabilityStartTime)),{...e,representations:Object.fromEntries(Object.entries(e.representations).map(([e,t])=>[e,t.filter(i)]))}}).bind(this));async seekLive(e){(0,E.assertNonNullable)(this.element);let t=this.normolizeLiveOffset(e);this.isActiveLowLatency=this.tuning.dashCmafLive.lowLatency.isActive&&0===t,this.liveLastSeekOffset=t,this.isJumpGapAfterSeekLive=!0,this.manifestUrlString=P(this.manifestUrlString,t,tM.DASH_CMAF_OFFSET_P),this.manifest=await this.updateManifest(),this.manifest&&(await this.videoBufferManager?.seekLive(this.manifest?.representations.video),await this.audioBufferManager?.seekLive(this.manifest?.representations.audio))}initRepresentations=(0,E.abortable)(this.destroyController.signal,(async function*(e,t,i){(0,E.assertNonNullable)(this.manifest),(0,E.assertNonNullable)(this.element),this.representationSubscription.unsubscribe(),this.state$.startTransitionTo(m.REPRESENTATIOS_READY);let s=e=>{this.representationSubscription.add((0,E.fromEvent)(e,"error").pipe((0,E.filter)(e=>!!this.element?.played.length)).subscribe(e=>{this.error$.next({id:"VideoSource",category:E.ErrorCategory.VIDEO_PIPELINE,message:"Unexpected video source error",thrown:e})}))};this.source=this.tuning.useManagedMediaSource?ii():new MediaSource;let a=document.createElement("source");if(s(a),a.src=URL.createObjectURL(this.source),this.element.appendChild(a),this.tuning.useManagedMediaSource&&it()){if(i){let e=document.createElement("source");s(e),e.type="application/x-mpegurl",e.src=i.url,this.element.appendChild(e)}else this.element.disableRemotePlayback=!0}this.isActiveLowLatency=this.isLive$.getValue()&&this.tuning.dashCmafLive.lowLatency.isActive;let r={fetcher:this.fetcher,tuning:this.tuning,getCurrentPosition:()=>this.element?1e3*this.element.currentTime:void 0,isActiveLowLatency:()=>this.isActiveLowLatency,manifest:this.manifest};if(this.videoBufferManager=new tr(tV.VIDEO,this.source,this.manifest.container,this.manifest.representations.video,r),this.bufferManagers=[this.videoBufferManager],(0,E.isNonNullable)(t)&&(this.audioBufferManager=new tr(tV.AUDIO,this.source,this.manifest.container,this.manifest.representations.audio,r),this.bufferManagers.push(this.audioBufferManager)),this.representationSubscription.add(this.fetcher.lastConnectionType$.subscribe(this.lastConnectionType$)),this.representationSubscription.add(this.fetcher.lastConnectionReused$.subscribe(this.lastConnectionReused$)),this.representationSubscription.add(this.fetcher.lastRequestFirstBytes$.subscribe(this.lastRequestFirstBytes$)),this.representationSubscription.add((0,E.interval)(1e3).subscribe(e=>{if(this.element?.paused){let e=L(this.manifestUrlString,tM.DASH_CMAF_OFFSET_P);this.manifestUrlString=P(this.manifestUrlString,e+1e3,tM.DASH_CMAF_OFFSET_P)}})),this.representationSubscription.add((0,E.merge)(...is.map(e=>(0,E.fromEvent)(this.element,e))).pipe((0,E.map)(e=>this.element?ew(this.element.buffered,1e3*this.element.currentTime):0),(0,E.filterChanged)(),(0,E.filter)(e=>!!e),(0,E.tap)(e=>{this.waitingEventInterval&&(window.clearInterval(this.waitingEventInterval),this.waitingEventInterval=void 0)})).subscribe(this.bufferLength$)),this.isLive$.getValue()){this.representationSubscription.add(this.bufferLength$.pipe((0,E.filter)(e=>this.isActiveLowLatency&&!!e)).subscribe(e=>this.liveEstimatedDelay.next(e))),this.representationSubscription.add(this.liveEstimatedDelay.smoothed$.subscribe(e=>{if(!this.isActiveLowLatency)return;let t=this.tuning.dashCmafLive.lowLatency.maxTargetOffset,i=this.tuning.dashCmafLive.lowLatency.maxTargetOffsetDeviation,s=this.tuning.dashCmafLive.lowLatency.playbackCatchupSpeedup,a=e-t,r=1+Math.sign(a)*s;Math.abs(a)<i?r=1:Math.abs(a)>2*i&&(r=1+Math.sign(a)*s*2),t9(this.element,r)})),this.representationSubscription.add(this.bufferLength$.subscribe(e=>{let t=0;if(e){let e=(this.element?.currentTime??0)*1e3;t=Math.min(...this.bufferManagers.map(e=>e.getLiveSegmentsToLoadState(this.manifest)?.to??0))-e}t&&this.liveLoadBufferLength$.getValue()!==t&&this.liveLoadBufferLength$.next(t)}));let e=0;this.representationSubscription.add((0,E.combine)({liveLoadBufferLength:this.liveLoadBufferLength$,bufferLength:this.bufferLength$}).subscribe(async({liveLoadBufferLength:t,bufferLength:i})=>{if((0,E.assertNonNullable)(this.element),this.isUpdatingLive)return;let s=this.element.playbackRate,a=L(this.manifestUrlString,tM.DASH_CMAF_OFFSET_P),r=Math.min(1e3*Math.abs(this.livePositionFromPlayer$.getValue()),this.tuning.dashCmafLive.normalizedTargetMinBufferSize*s),n=this.tuning.dashCmafLive.normalizedActualBufferOffset*s,o=this.tuning.dashCmafLive.normalizedLiveMinBufferSize*s,l=this.isActiveLowLatency?i:t,u=tF.None;if(this.isActiveLowLatency?u=tF.ActiveLowLatency:l<r+o&&l>=r?u=tF.LiveWithTargetOffset:0!==a&&l<r&&(u=tF.LiveForwardBuffering),isFinite(t)&&(e=t>e?t:e),u===tF.LiveForwardBuffering||u===tF.LiveWithTargetOffset){let i;let o=e-(r+n),l=this.normolizeLiveOffset(Math.trunc(a+o/s)),u=Math.abs(l-a);i=!t||u<=this.tuning.dashCmafLive.offsetCalculationError?a:l>0&&u>this.tuning.dashCmafLive.offsetCalculationError?l:0,this.manifestUrlString=P(this.manifestUrlString,i,tM.DASH_CMAF_OFFSET_P)}u!==tF.None&&u!==tF.ActiveLowLatency&&(e=0,this.updateLive())}))}let n=(0,E.merge)(...this.bufferManagers.map(e=>e.fullyBuffered$)).pipe((0,E.map)(()=>this.bufferManagers.every(e=>e.fullyBuffered$.getValue()))),o=(0,E.merge)(...this.bufferManagers.map(e=>e.onLastSegment$)).pipe((0,E.map)(()=>this.bufferManagers.some(e=>e.onLastSegment$.getValue())));this.representationSubscription.add((0,E.merge)(this.forceEnded$,(0,E.combine)({allBuffersFull:n,someBufferEnded:o}).pipe((0,E.filter)(({allBuffersFull:e,someBufferEnded:t})=>e&&t))).subscribe(()=>{if(this.source&&"open"===this.source.readyState&&Array.from(this.source.sourceBuffers).every(e=>!e.updating))try{this.source?.endOfStream()}catch(e){this.error$.next({id:"EndOfStream",category:E.ErrorCategory.VIDEO_PIPELINE,message:"Failed to end MediaSource stream",thrown:e})}})),this.representationSubscription.add((0,E.merge)(...this.bufferManagers.map(e=>e.error$)).subscribe(this.error$)),this.representationSubscription.add(this.videoBufferManager.playingRepresentation$.subscribe(this.currentVideoRepresentation$)),this.subscription.add(this.videoBufferManager.playingRepresentationInit$.subscribe(this.currentVideoRepresentationInit$)),"open"!==this.source.readyState&&(yield new Promise(e=>this.source?.addEventListener("sourceopen",e)));let l=this.manifest.duration??0,u=(e,t)=>Math.max(e,t.duration??0),h=this.manifest.representations.audio.reduce(u,l),d=this.manifest.representations.video.reduce(u,l);(h||d)&&(this.source.duration=Math.max(h,d)/1e3),this.audioBufferManager&&(0,E.isNonNullable)(t)?yield Promise.all([this.videoBufferManager.startWith(e),this.audioBufferManager.startWith(t)]):yield this.videoBufferManager.startWith(e),this.state$.setState(m.REPRESENTATIOS_READY)}).bind(this));initBuffer(){(0,E.assertNonNullable)(this.element),this.state$.setState(m.RUNNING),this.subscription.add((0,E.merge)(...is.map(e=>(0,E.fromEvent)(this.element,e)),(0,E.fromEvent)(window,"online")).subscribe(()=>this.tick(),e=>{this.error$.next({id:"DashVKPlayer",category:E.ErrorCategory.WTF,message:"Internal logic error",thrown:e})})),this.subscription.add((0,E.fromEvent)(this.element,"progress").subscribe(()=>{this.element&&2===this.element.readyState&&!this.element.seeking&&(this.element.currentTime=this.element.currentTime)})),this.subscription.add((0,E.fromEvent)(this.element,"waiting").subscribe(()=>{this.element&&2===this.element.readyState&&!this.element.seeking&&eI(this.element.buffered,1e3*this.element.currentTime)&&(this.element.currentTime=this.element.currentTime),this.waitingEventInterval&&window.clearInterval(this.waitingEventInterval),this.waitingEventInterval=window.setInterval(this.waitingEventCallback.bind(this),this.tuning.dashMaxWaitingDuration)})),this.tick()}async switchRepresentation(e,t){return({[tV.VIDEO]:this.videoBufferManager,[tV.AUDIO]:this.audioBufferManager,[tV.TEXT]:null})[e]?.switchTo(t)}seek(e,t){let i;(0,E.assertNonNullable)(this.element),(0,E.assertNonNullable)(this.videoBufferManager),i=t||1e3*this.element.duration<=this.tuning.dashSeekInSegmentDurationThreshold||Math.abs(1e3*this.element.currentTime-e)<=this.tuning.dashSeekInSegmentAlwaysSeekDelta?e:Math.max(this.videoBufferManager.findSegmentStartTime(e)??e,this.audioBufferManager?.findSegmentStartTime(e)??e),eI(this.element.buffered,i)||(this.videoBufferManager.abort(),this.audioBufferManager?.abort()),this.videoBufferManager.maintain(i),this.audioBufferManager?.maintain(i),this.element.currentTime=i/1e3}stop(){this.element?.querySelectorAll("source").forEach(e=>e.remove()),this.element=null,this.source=null,this.manifest=null,this.currentVideoRepresentation$.next(void 0),this.videoBufferManager?.destroy(),this.videoBufferManager=null,this.audioBufferManager?.destroy(),this.audioBufferManager=null,this.bufferManagers=[],this.state$.setState(m.NONE)}setBufferTarget(e){for(let t of this.bufferManagers)t.setTarget(e)}getRepresentations(){return this.manifest?.representations}setPreloadOnly(e){for(let t of this.bufferManagers)t.setPreloadOnly(e)}destroy(){this.subscription.unsubscribe(),this.representationSubscription.unsubscribe(),this.destroyController.abort(),this.fetcher.destroy(),window.clearInterval(this.waitingEventInterval),this.stop(),this.source?.readyState==="open"&&Array.from(this.source.sourceBuffers).every(e=>!e.updating)&&this.source.endOfStream(),this.source=null}async waitingEventCallback(){try{if(!this.element)return;this.isLive$.getValue()?await this.seekLive(this.liveLastSeekOffset):this.seek(1e3*this.element.currentTime,!0)}catch(e){this.error$.next({id:"WaitingEventCallback",category:E.ErrorCategory.WTF,message:"Error in seeking in waiting event callback",thrown:e})}}normolizeLiveOffset(e){return 1e3*Math.trunc(e/1e3)}tick=()=>{if(!this.element||!this.videoBufferManager)return;let e=1e3*this.element.currentTime;this.videoBufferManager.maintain(e),this.audioBufferManager?.maintain(e),(this.videoBufferManager.gaps.length||this.audioBufferManager?.gaps.length)&&!this.gapWatchdogStarted&&(this.gapWatchdogStarted=!0,this.gapWatchdogSubscription=(0,E.interval)(this.tuning.gapWatchdogInterval).subscribe(()=>this.jumpGap(),e=>{this.error$.next({id:"GapWatchdog",category:E.ErrorCategory.WTF,message:"Error handling gaps",thrown:e})}),this.subscription.add(this.gapWatchdogSubscription))};async updateLive(){this.isUpdatingLive=!0,this.manifest=await this.updateManifest(),this.manifest&&this.bufferManagers?.forEach(e=>e.updateLive(this.manifest)),this.isUpdatingLive=!1}jumpGap(){if(!this.element||!this.videoBufferManager)return;let e=this.videoBufferManager.getDebugBufferState();if(!e)return;this.isJumpGapAfterSeekLive&&!this.isActiveLowLatency&&this.element.currentTime>e.to&&(this.isJumpGapAfterSeekLive=!1,this.element.currentTime=0);let t=1e3*this.element.currentTime,i=[],s=1===this.element.readyState?this.tuning.endGapTolerance:0;for(let e of this.bufferManagers)for(let a of e.gaps)e.playingRepresentation$.getValue()===a.representation&&a.from-s<=t&&a.to+s>t&&(1e3*this.element.duration-a.to<this.tuning.endGapTolerance?i.push(1/0):i.push(a.to));if(i.length){let e=Math.max(...i);e===1/0?(this.forceEnded$.next(),this.gapWatchdogSubscription.unsubscribe(),this.gapWatchdogStarted=!1):this.element.currentTime=e/1e3}}};class ir{fov;orientation;constructor(e,t){this.fov=e,this.orientation=t}}class io{options;camera;rotating=!1;fading=!1;lastTickTS=0;lastCameraTurn;lastCameraTurnTS=0;fadeStartSpeed=null;fadeCorrection;fadeTime=0;rotationSpeed;constructor(e,t){this.camera=e,this.options=t,this.rotationSpeed={x:0,y:0,z:0},this.fadeCorrection=1/(this.options.speedFadeTime/1e3)**2}turnCamera(e=0,t=0,i=0){this.pointCameraTo(this.camera.orientation.x+e,this.camera.orientation.y+t,this.camera.orientation.z+i)}pointCameraTo(e=0,t=0,i=0){t=this.limitCameraRotationY(t);let s=e-this.camera.orientation.x,a=t-this.camera.orientation.y,r=i-this.camera.orientation.z;this.camera.orientation.x=e,this.camera.orientation.y=t,this.camera.orientation.z=i,this.lastCameraTurn={x:s,y:a,z:r},this.lastCameraTurnTS=Date.now()}setRotationSpeed(e,t,i){this.rotationSpeed.x=e??this.rotationSpeed.x,this.rotationSpeed.y=t??this.rotationSpeed.y,this.rotationSpeed.z=i??this.rotationSpeed.z}startRotation(){this.rotating=!0}stopRotation(e=!1){e?(this.setRotationSpeed(0,0,0),this.fadeStartSpeed=null):this.startFading(this.rotationSpeed.x,this.rotationSpeed.y,this.rotationSpeed.z),this.rotating=!1}onCameraRelease(){if(this.lastCameraTurn&&this.lastCameraTurnTS){let e=Date.now()-this.lastCameraTurnTS;if(e<this.options.speedFadeThreshold){let t=(1-e/this.options.speedFadeThreshold)*this.options.rotationSpeedCorrection;this.startFading(this.lastCameraTurn.x*t,this.lastCameraTurn.y*t,this.lastCameraTurn.z*t)}}}startFading(e,t,i){this.setRotationSpeed(e,t,i),this.fadeStartSpeed={...this.rotationSpeed},this.fading=!0}stopFading(){this.fadeStartSpeed=null,this.fading=!0,this.fadeTime=0}limitCameraRotationY(e){return Math.max(-this.options.maxYawAngle,Math.min(e,this.options.maxYawAngle))}tick(e){if(!this.lastTickTS){this.lastTickTS=e,this.lastCameraTurnTS=Date.now();return}let t=e-this.lastTickTS,i=t/1e3;if(this.rotating)this.turnCamera(this.rotationSpeed.x*this.options.rotationSpeedCorrection*i,this.rotationSpeed.y*this.options.rotationSpeedCorrection*i,this.rotationSpeed.z*this.options.rotationSpeedCorrection*i);else if(this.fading&&this.fadeStartSpeed){let e=-this.fadeCorrection*(this.fadeTime/1e3)**2+1;this.setRotationSpeed(this.fadeStartSpeed.x*e,this.fadeStartSpeed.y*e,this.fadeStartSpeed.z*e),e>0?this.turnCamera(this.rotationSpeed.x*this.options.rotationSpeedCorrection*i,this.rotationSpeed.y*this.options.rotationSpeedCorrection*i,this.rotationSpeed.z*this.options.rotationSpeedCorrection*i):(this.stopRotation(!0),this.stopFading()),this.fadeTime=Math.min(this.fadeTime+t,this.options.speedFadeTime)}this.lastTickTS=e}}var il=`#define GLSLIFY 1
attribute vec2 a_vertex;attribute vec2 a_texel;varying vec2 v_texel;void main(void){gl_Position=vec4(a_vertex,0.0,1.0);v_texel=a_texel;}`,iu=`#ifdef GL_ES
precision highp float;precision highp int;
#else
precision highp float;
#define GLSLIFY 1
#endif
#define PI 3.14159265358979323846264
varying vec2 v_texel;uniform sampler2D u_texture;uniform vec2 u_focus;void main(void){float lambda0=u_focus.x/360.0;float phi0=u_focus.y/180.0;float lambda=PI*2.0*(v_texel.x-0.5-lambda0);float phi=PI*(v_texel.y-0.5-phi0);float p=sqrt(lambda*lambda+phi*phi);float c=atan(p);float cos_c=cos(c);float sin_c=sin(c);float x=lambda0+atan(lambda*sin_c,p*cos(phi0)*cos_c-phi*sin(phi0)*sin_c);float y=asin(cos_c*sin(phi0)+(phi*sin_c*cos(phi0))/p);vec2 tc=vec2(mod(x/(PI*2.0)-0.5,1.0),mod(y/PI-0.5,1.0));gl_FragColor=texture2D(u_texture,tc);}`;class ih{container;sourceVideoElement;canvas;gl;params;frameWidth;frameHeight;viewportWidth;viewportHeight;videoInitialized=!1;program;videoTexture;vertexBuffer;textureMappingBuffer;camera;cameraRotationManager;videoElementDataLoadedFn;renderFn;active=!1;constructor(e,t,i){this.container=e,this.sourceVideoElement=t,this.params=i,this.canvas=this.createCanvas();let s=this.canvas.getContext("webgl");if(!s)throw Error("Could not initialize WebGL context");this.gl=s,this.container.appendChild(this.canvas),this.camera=new ir(this.params.fov,this.params.orientation),this.cameraRotationManager=new io(this.camera,{rotationSpeed:this.params.rotationSpeed,maxYawAngle:this.params.maxYawAngle,rotationSpeedCorrection:this.params.rotationSpeedCorrection,degreeToPixelCorrection:this.params.degreeToPixelCorrection,speedFadeTime:this.params.speedFadeTime,speedFadeThreshold:this.params.speedFadeThreshold}),this.updateFrameSize(),this.vertexBuffer=this.createVertexBuffer(),this.textureMappingBuffer=this.createTextureMappingBuffer(),this.updateTextureMappingBuffer(),this.program=this.createProgram(),this.videoTexture=this.createTexture(),this.gl.useProgram(this.program),this.videoElementDataLoadedFn=this.onDataLoadedHandler.bind(this),this.renderFn=this.render.bind(this)}play(){this.active||(this.videoInitialized?this.doPlay():this.sourceVideoElement.readyState>=2?(this.videoInitialized=!0,this.doPlay()):this.sourceVideoElement.addEventListener("loadeddata",this.videoElementDataLoadedFn))}stop(){this.active=!1}startCameraManualRotation(e,t){this.cameraRotationManager.setRotationSpeed(e*this.params.rotationSpeed,t*this.params.rotationSpeed,0),this.cameraRotationManager.startRotation()}stopCameraManualRotation(e=!1){this.cameraRotationManager.stopRotation(e)}turnCamera(e,t){this.cameraRotationManager.turnCamera(e,t)}pointCameraTo(e,t){this.cameraRotationManager.pointCameraTo(e,t)}pixelToDegree(e){return{x:-(this.params.degreeToPixelCorrection*this.params.fov.x*e.x)/this.viewportWidth,y:this.params.degreeToPixelCorrection*this.params.fov.y*e.y/this.viewportHeight}}getCameraRotation(){return this.camera.orientation}holdCamera(){this.cameraRotationManager.stopRotation(!0)}releaseCamera(){this.cameraRotationManager.onCameraRelease()}destroy(){this.sourceVideoElement.removeEventListener("loadeddata",this.videoElementDataLoadedFn),this.stop(),this.canvas.remove()}setViewportSize(e,t){this.viewportWidth=e,this.viewportHeight=t,this.canvas.width=this.viewportWidth,this.canvas.height=this.viewportHeight,this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}onDataLoadedHandler(){this.videoInitialized=!0,this.doPlay()}doPlay(){this.updateFrameSize(),this.vertexBuffer=this.createVertexBuffer(),this.active=!0,this.sourceVideoElement.removeEventListener("loadeddata",this.videoElementDataLoadedFn),requestAnimationFrame(this.renderFn)}render(e){this.cameraRotationManager.tick(e),this.updateTexture(),this.updateTextureMappingBuffer();let t=this.gl.getAttribLocation(this.program,"a_vertex"),i=this.gl.getAttribLocation(this.program,"a_texel"),s=this.gl.getUniformLocation(this.program,"u_texture"),a=this.gl.getUniformLocation(this.program,"u_focus");this.gl.enableVertexAttribArray(t),this.gl.enableVertexAttribArray(i),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,0,0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureMappingBuffer),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,0,0),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.videoTexture),this.gl.uniform1i(s,0),this.gl.uniform2f(a,-this.camera.orientation.x,-this.camera.orientation.y),this.gl.drawArrays(this.gl.TRIANGLE_FAN,0,4),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.disableVertexAttribArray(t),this.gl.disableVertexAttribArray(i),this.active&&requestAnimationFrame(this.renderFn)}createShader(e,t){let i=this.gl.createShader(t);if(!i)throw this.destroy(),Error(`Could not create shader (${t})`);if(this.gl.shaderSource(i,e),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS))throw this.destroy(),Error("An error occurred while compiling the shader: "+this.gl.getShaderInfoLog(i));return i}createProgram(){let e=this.gl.createProgram();if(!e)throw this.destroy(),Error("Could not create shader program");let t=this.createShader(il,this.gl.VERTEX_SHADER),i=this.createShader(iu,this.gl.FRAGMENT_SHADER);if(this.gl.attachShader(e,t),this.gl.attachShader(e,i),this.gl.linkProgram(e),!this.gl.getProgramParameter(e,this.gl.LINK_STATUS))throw this.destroy(),Error("Could not link shader program.");return e}createTexture(){let e=this.gl.createTexture();if(!e)throw this.destroy(),Error("Could not create texture");return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.bindTexture(this.gl.TEXTURE_2D,null),e}updateTexture(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.videoTexture),this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,!0),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.sourceVideoElement),this.gl.bindTexture(this.gl.TEXTURE_2D,null)}createVertexBuffer(){let e=this.gl.createBuffer();if(!e)throw this.destroy(),Error("Could not create vertex buffer");let t=1,i=1,s=this.frameHeight/(this.frameWidth/this.viewportWidth);return s>this.viewportHeight?t=this.viewportHeight/s:i=s/this.viewportHeight,this.gl.bindBuffer(this.gl.ARRAY_BUFFER,e),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-t,-i,t,-i,t,i,-t,i]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),e}createTextureMappingBuffer(){let e=this.gl.createBuffer();if(!e)throw this.destroy(),Error("Could not create texture mapping buffer");return e}calculateTexturePosition(){let e=.5-this.camera.orientation.x/360,t=.5-this.camera.orientation.y/180,i=this.camera.fov.x/360/2,s=this.camera.fov.y/180/2;return[e-i,t-s,e+i,t-s,e+i,t+s,e-i,t+s]}updateTextureMappingBuffer(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.textureMappingBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([...this.calculateTexturePosition()]),this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}updateFrameSize(){this.frameWidth=this.sourceVideoElement.videoWidth,this.frameHeight=this.sourceVideoElement.videoHeight}createCanvas(){let e=document.createElement("canvas");return e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e}}let id=()=>!!window.documentPictureInPicture?.window||!!document.pictureInPictureElement,ic=(e,t)=>new E.Observable(i=>{if(!window.IntersectionObserver)return;let s=new IntersectionObserver((e,t)=>{e.forEach(e=>i.next(e.isIntersecting||id()))},{root:null,...t});s.observe(e);let a=(0,E.fromEvent)(document,"visibilitychange").pipe((0,E.map)(e=>!document.hidden||id())).subscribe(e=>i.next(e));return()=>{s.unobserve(e),a.unsubscribe}});class ip{scene3D;subscription=new E.Subscription;videoState=new x(tG.STOPPED);video;player;params;elementSize$=new E.ValueSubject(void 0);elementVisible$=new E.ValueSubject(!0);textTracksManager=new q;droppedFramesManager=new ev;videoTracks$=new E.ValueSubject([]);audioTracks=[];audioRepresentations=new Map;videoTrackSwitchHistory=new el;textTracks=[];liveOffset;constructor(e){this.params=e,this.video=O(e.container),this.params.output.element$.next(this.video),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(eh(this.params.source.url)),this.params.output.isLive$.next(!1),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.player=new ia({throughputEstimator:this.params.dependencies.throughputEstimator,tuning:this.params.tuning,compatibilityMode:this.params.source.compatibilityMode}),this.subscribe()}getProviderSubscriptionInfo(){let{output:e,desiredState:t}=this.params,i=X(this.video),s=this.constructor.name,a=t=>{e.error$.next({id:s,category:E.ErrorCategory.WTF,message:`${s} internal logic error`,thrown:t})};return{output:e,desiredState:t,observableVideo:i,genericErrorListener:a,connect:(e,t)=>this.subscription.add(e.subscribe(t,a))}}subscribe(){let{output:e,desiredState:t,observableVideo:i,genericErrorListener:s,connect:a}=this.getProviderSubscriptionInfo();this.droppedFramesManager.connect({logger:this.params.dependencies.logger,video:this.video,droppedFramesChecker:this.params.tuning.droppedFramesChecker,isAuto:this.params.desiredState.autoVideoTrackSwitching,playing$:i.playing$,pause$:i.pause$,tracks$:this.videoTracks$.pipe((0,E.map)(e=>e.map(({track:e})=>e)))}),a(i.ended$,e.endedEvent$),a(i.looped$,e.loopedEvent$),a(i.error$,e.error$),a(i.isBuffering$,e.isBuffering$),a(i.currentBuffer$,e.currentBuffer$),a(i.playing$,e.firstFrameEvent$),a(i.canplay$,e.canplay$),a(i.inPiP$,e.inPiP$),a(i.inFullscreen$,e.inFullscreen$),a(this.player.error$,e.error$),a(this.player.lastConnectionType$,e.httpConnectionType$),a(this.player.lastConnectionReused$,e.httpConnectionReused$),a(this.player.isLive$,e.isLive$),a(this.player.lastRequestFirstBytes$.pipe((0,E.filter)(E.isNonNullable),(0,E.once)()),e.firstBytesEvent$),this.subscription.add(i.seeked$.subscribe(e.seekedEvent$,s)),this.subscription.add(V(this.video,t.isLooped,s)),this.subscription.add(F(this.video,t.volume,i.volumeState$,s)),this.subscription.add(i.volumeState$.subscribe(this.params.output.volume$,s)),this.subscription.add(U(this.video,t.playbackRate,i.playbackRateState$,s)),a(e$(this.video),this.elementSize$),a(ic(this.video,{threshold:this.params.tuning.autoTrackSelection.activeVideoAreaThreshold}),this.elementVisible$),this.subscription.add(i.playing$.subscribe(()=>{this.videoState.setState(tG.PLAYING),C(t.playbackState,tL.PLAYING),this.scene3D&&this.scene3D.play()},s)).add(i.pause$.subscribe(()=>{this.videoState.setState(tG.PAUSED),C(t.playbackState,tL.PAUSED)},s)).add(i.canplay$.subscribe(()=>{this.videoState.getState()===tG.PLAYING&&this.playIfAllowed()},s)),this.subscription.add(this.player.state$.stateChangeEnded$.subscribe(({to:e})=>{if(e===m.MANIFEST_READY){let e=[];this.audioTracks=[],this.textTracks=[];let t=this.player.getRepresentations();(0,E.assertNonNullable)(t,"Manifest not loaded or empty");let i=Array.from(t.audio).sort((e,t)=>t.bitrate-e.bitrate),s=Array.from(t.video).sort((e,t)=>t.bitrate-e.bitrate),a=Array.from(t.text);if(!this.params.tuning.isAudioDisabled)for(let e of i){let t=e9(e);t&&this.audioTracks.push({track:t,representation:e})}for(let t of s){let a=e7(t);if(a){e.push({track:a,representation:t});let r=!this.params.tuning.isAudioDisabled&&te(i,s,t);r&&this.audioRepresentations.set(t.id,r)}}for(let t of(this.videoTracks$.next(e),a)){let e=tt(t);e&&this.textTracks.push({track:e,representation:t})}this.params.output.availableVideoTracks$.next(e.map(({track:e})=>e)),this.params.output.availableAudioTracks$.next(this.audioTracks.map(({track:e})=>e)),this.params.output.isAudioAvailable$.next(!!this.audioTracks.length),this.textTracks.length>0&&this.params.desiredState.internalTextTracks.startTransitionTo(this.textTracks.map(({track:e})=>e));let r=this.selectVideoRepresentation();(0,E.assertNonNullable)(r),this.player.initRepresentations(r.id,this.audioRepresentations.get(r.id)?.id,this.params.sourceHls)}else e===m.REPRESENTATIOS_READY&&(this.videoState.setState(tG.READY),this.player.initBuffer())},s));let r=t=>e.error$.next({id:"RepresentationSwitch",category:E.ErrorCategory.WTF,message:"Switching representations threw",thrown:t});this.subscription.add((0,E.merge)(this.player.state$.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.transitionStarted$,this.params.dependencies.throughputEstimator.rttAdjustedThroughput$,t.autoVideoTrackLimits.stateChangeStarted$,this.elementSize$,this.elementVisible$,this.droppedFramesManager.onDroopedVideoFramesLimit$,(0,E.fromEvent)(this.video,"progress")).subscribe(()=>{let e=this.player.state$.getState(),i=this.player.state$.getTransition();if(e!==m.RUNNING||i||!this.videoTracks$.getValue().length)return;t.autoVideoTrackSwitching.getTransition()&&t.autoVideoTrackSwitching.setState(t.autoVideoTrackSwitching.getState());let s=this.selectVideoRepresentation(),a=this.params.desiredState.autoVideoTrackLimits.getTransition();a&&this.params.output.autoVideoTrackLimits$.next(a.to);let n=this.params.desiredState.autoVideoTrackSwitching.getState(),o=this.params.tuning.autoTrackSelection.backgroundVideoQualityLimit;if(s){let e=s.id;!this.elementVisible$.getValue()&&n&&(e=this.videoTracks$.getValue().map(e=>e.representation).sort((e,t)=>t.bitrate-e.bitrate).filter(e=>{let t=(0,E.videoSizeToQuality)(e),i=(0,E.videoSizeToQuality)(s);if(t&&i)return(0,E.isLowerOrEqual)(t,i)&&(0,E.isLowerOrEqual)(t,o)}).map(e=>e.id)[0]),this.player.switchRepresentation(tV.VIDEO,e).catch(r);let t=this.audioRepresentations.get(s.id);t&&this.player.switchRepresentation(tV.AUDIO,t.id).catch(r)}},s)),this.subscription.add(t.cameraOrientation.stateChangeEnded$.subscribe(({to:e})=>{this.scene3D&&e&&this.scene3D.pointCameraTo(e.x,e.y)})),this.subscription.add(this.elementSize$.subscribe(e=>{this.scene3D&&e&&this.scene3D.setViewportSize(e.width,e.height)})),this.subscription.add(this.player.currentVideoRepresentation$.pipe((0,E.filterChanged)(),(0,E.map)(e=>e&&this.videoTracks$.getValue().find(({representation:{id:t}})=>t===e)?.track)).subscribe(e.currentVideoTrack$,s)),this.subscription.add(this.player.currentVideoRepresentationInit$.subscribe(t=>{if(t?.is3dVideo&&this.params.tuning.spherical?.enabled)try{this.init3DScene(t),e.is3DVideo$.next(!0)}catch(t){e.warning$.next({id:"DashProvider",message:`DashProvider could not initialize 3D-scene: ${t}`})}else this.destroy3DScene(),this.params.tuning.spherical?.enabled&&e.is3DVideo$.next(!1)},s)),this.textTracksManager.connect(this.video,t,e);let n=t.playbackState.stateChangeStarted$.pipe((0,E.map)(({to:e})=>e===tL.READY),(0,E.filterChanged)());this.subscription.add((0,E.merge)(n,t.autoVideoTrackSwitching.stateChangeStarted$,this.player.state$.stateChangeEnded$).subscribe(()=>{let e=t.autoVideoTrackSwitching.getState(),i=t.playbackState.getState()===tL.READY?this.params.tuning.dash.forwardBufferTargetPreload:e?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual;this.player.setBufferTarget(i)})),this.subscription.add((0,E.merge)(n,this.player.state$.stateChangeEnded$).subscribe(()=>this.player.setPreloadOnly(t.playbackState.getState()===tL.READY)));let o=(0,E.merge)(t.playbackState.stateChangeStarted$,t.videoTrack.stateChangeStarted$,t.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,(0,E.observableFrom)(["init"])).pipe((0,E.debounce)(0));this.subscription.add(o.subscribe(this.syncPlayback,s))}selectVideoRepresentation(){let e=this.params.desiredState.autoVideoTrackSwitching.getState(),t=this.params.desiredState.videoTrack.getState()?.id,i=this.videoTracks$.getValue().find(({track:{id:e}})=>e===t)?.track,s=this.params.output.currentVideoTrack$.getValue(),a=Math.min(ew(this.video.buffered,1e3*this.video.currentTime)/Math.min(e?this.params.tuning.dash.forwardBufferTargetAuto:this.params.tuning.dash.forwardBufferTargetManual,(1e3*this.video.duration||1/0)-1e3*this.video.currentTime),1),r=Math.max(i&&!e?this.audioRepresentations.get(i.id)?.bitrate??0:0,s?this.audioRepresentations.get(s.id)?.bitrate??0:0),n=eu(this.videoTracks$.getValue().map(({track:e})=>e),{container:this.elementSize$.getValue(),throughput:this.params.dependencies.throughputEstimator.rttAdjustedThroughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,limits:this.params.desiredState.autoVideoTrackLimits.getState(),reserve:r,forwardBufferHealth:a,current:s,history:this.videoTrackSwitchHistory,playbackRate:this.video.playbackRate,droppedVideoMaxQualityLimit:this.droppedFramesManager.droppedVideoMaxQualityLimit,abrLogger:this.params.dependencies.abrLogger}),o=e?n??i:i??n;return o&&this.videoTracks$.getValue().find(({track:e})=>e===o)?.representation}prepare(e=0){this.player.initManifest(this.video,this.params.source.url,e)}syncPlayback=()=>{let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.seekState.getState();if(!this.videoState.getTransition()){if(s.state===tN.Requested&&i?.to!==tL.PAUSED&&e!==tG.STOPPED&&t!==tL.STOPPED){let e=this.liveOffset?.getTotalPausedTime()??0;this.seek(s.position-e,s.forcePrecise)}if(t===tL.STOPPED){e!==tG.STOPPED&&(this.videoState.startTransitionTo(tG.STOPPED),this.player.stop(),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(tG.STOPPED),C(this.params.desiredState.playbackState,tL.STOPPED,!0));return}switch(e){case tG.STOPPED:this.videoState.startTransitionTo(tG.READY),this.prepare();return;case tG.READY:t===tL.PAUSED?(this.videoState.setState(tG.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED)):t===tL.PLAYING?(this.videoState.startTransitionTo(tG.PLAYING),this.playIfAllowed()):i?.to===tL.READY&&C(this.params.desiredState.playbackState,tL.READY);return;case tG.PLAYING:t===tL.PAUSED?(this.videoState.startTransitionTo(tG.PAUSED),this.liveOffset?.pause(),this.video.pause()):i?.to===tL.PLAYING&&C(this.params.desiredState.playbackState,tL.PLAYING);return;case tG.PAUSED:t===tL.PLAYING?(this.videoState.startTransitionTo(tG.PLAYING),this.liveOffset?this.liveOffset.getTotalOffset()/1e3<Math.abs(this.params.output.duration$.getValue())?(this.liveOffset.resume(),this.playIfAllowed(),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3)):this.seek(0,!1):this.playIfAllowed()):i?.to===tL.PAUSED&&C(this.params.desiredState.playbackState,tL.PAUSED);return;default:return(0,E.assertNever)(e)}}};init3DScene=e=>{if(this.scene3D)return;this.scene3D=new ih(this.params.container,this.video,{fov:this.params.tuning.spherical.fov,orientation:this.params.tuning.spherical.orientation||{x:e.projectionData?.pose.yaw||0,y:e.projectionData?.pose.pitch||0,z:e.projectionData?.pose.roll||0},rotationSpeed:this.params.tuning.spherical.rotationSpeed,maxYawAngle:this.params.tuning.spherical.maxYawAngle,rotationSpeedCorrection:this.params.tuning.spherical.rotationSpeedCorrection,degreeToPixelCorrection:this.params.tuning.spherical.degreeToPixelCorrection,speedFadeTime:this.params.tuning.spherical.speedFadeTime,speedFadeThreshold:this.params.tuning.spherical.speedFadeThreshold});let t=this.elementSize$.getValue();t&&this.scene3D.setViewportSize(t.width,t.height)};destroy3DScene=()=>{this.scene3D&&(this.scene3D.destroy(),this.scene3D=void 0)};playIfAllowed(){ec(this.video).then(e=>{e||(this.liveOffset?.pause(),this.videoState.setState(tG.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED,!0))},e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:E.ErrorCategory.DOM,thrown:e}))}destroy(){this.subscription.unsubscribe(),this.droppedFramesManager.destroy(),this.destroy3DScene(),this.textTracksManager.destroy(),this.player.destroy(),this.params.output.element$.next(void 0),_(this.video)}}class im extends ip{subscribe(){super.subscribe();let{output:e,observableVideo:t,connect:i}=this.getProviderSubscriptionInfo();i(t.timeUpdate$,e.position$),i(t.durationChange$,e.duration$)}seek(e,t){this.params.output.willSeekEvent$.next(),this.player.seek(e,t)}}class ig extends ip{constructor(e){super(e),this.liveOffset=new Y}subscribe(){super.subscribe();let{output:e,observableVideo:t,connect:i}=this.getProviderSubscriptionInfo();this.params.output.position$.next(0),i(t.timeUpdate$,e.liveBufferTime$),i(this.player.liveDuration$,e.duration$),this.subscription.add(this.params.output.position$.subscribe(this.player.livePositionFromPlayer$)).add((0,E.combine)({interval:(0,E.interval)(1e3),playbackRate:t.playbackRateState$}).subscribe(({playbackRate:t})=>{if(this.videoState.getState()===tG.PLAYING&&!this.player.isActiveLowLatency){let i=e.position$.getValue()+(t-1);e.position$.next(i),this.liveOffset?.resetTo(-(1e3*i))}})).add((0,E.combine)({liveBufferTime:e.liveBufferTime$,liveAvailabilityStartTime:this.player.liveAvailabilityStartTime$}).pipe((0,E.map)(({liveBufferTime:e,liveAvailabilityStartTime:t})=>e&&t?e+t:void 0)).subscribe(e.liveTime$))}seek(e){this.params.output.willSeekEvent$.next();let t=this.params.desiredState.playbackState.getState(),i=this.videoState.getState(),s=t===tL.PAUSED&&i===tG.PAUSED,a=-e,r=Math.trunc(a/1e3<=Math.abs(this.params.output.duration$.getValue())?a:0);this.player.seekLive(r).then(()=>{this.params.output.position$.next(e/1e3),this.liveOffset?.resetTo(r,s)})}}let ib={};(o=f||(f={})).INITIALIZING="initializing",o.STOPPED="stopped",o.READY="ready",o.PLAYING="playing",o.PAUSED="paused";let iS=(e,t)=>new E.Observable(i=>{let s=(e,t)=>i.next(t);return e.on(t,s),()=>e.off(t,s)});class iv{subscription=new E.Subscription;videoState=new x(f.INITIALIZING);video;params;hls;textTracksManager=new q;trackLevels=new Map;constructor(e){this.video=O(e.container),this.params=e,this.params.output.element$.next(this.video),this.params.output.isLive$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(eh(this.params.source.url)),this.loadHlsJs()}destroy(){this.subscription.unsubscribe(),this.trackLevels.clear(),this.textTracksManager.destroy(),this.hls?.detachMedia(),this.hls?.destroy(),this.params.output.element$.next(void 0),_(this.video)}loadHlsJs(){let e=!1,i=t=>{e||this.params.output.error$.next({id:"timeout"===t?"HlsJsTimeout":"HlsJsLoadError",category:E.ErrorCategory.NETWORK,message:"Failed to load Hls.js",thrown:t}),e=!0},s=window.setTimeout(()=>i("timeout"),this.params.tuning.dynamicImportTimeout);t("eFFZp").then(t=>{e||(ib.Hls=t.default,ib.Events=t.default.Events,this.init())},i).finally(()=>{window.clearTimeout(s),e=!0})}init(){(0,E.assertNonNullable)(ib.Hls,"hls.js not loaded"),this.hls=new ib.Hls({fragLoadingMaxRetry:5,levelLoadingMaxRetry:2,manifestLoadingMaxRetry:2,fragLoadingMaxRetryTimeout:16e3,manifestLoadingMaxRetryTimeout:2e3,levelLoadingMaxRetryTimeout:2e3}),this.subscribe(),this.videoState.setState(f.STOPPED)}subscribe(){(0,E.assertNonNullable)(ib.Events,"hls.js not loaded");let{desiredState:e,output:t}=this.params,i=e=>{t.error$.next({id:"HlsJsProvider",category:E.ErrorCategory.WTF,message:"HlsJsProvider internal logic error",thrown:e})},s=X(this.video),a=(e,t)=>this.subscription.add(e.subscribe(t,i));a(s.timeUpdate$,t.position$),a(s.durationChange$,t.duration$),a(s.ended$,t.endedEvent$),a(s.looped$,t.loopedEvent$),a(s.error$,t.error$),a(s.isBuffering$,t.isBuffering$),a(s.currentBuffer$,t.currentBuffer$),a(s.loadStart$,t.firstBytesEvent$),a(s.playing$,t.firstFrameEvent$),a(s.canplay$,t.canplay$),a(s.seeked$,t.seekedEvent$),a(s.inPiP$,t.inPiP$),a(s.inFullscreen$,t.inFullscreen$),this.subscription.add(V(this.video,e.isLooped,i)),this.subscription.add(F(this.video,e.volume,s.volumeState$,i)),this.subscription.add(s.volumeState$.subscribe(this.params.output.volume$)),this.subscription.add(U(this.video,e.playbackRate,s.playbackRateState$,i)),this.subscription.add(iS(this.hls,ib.Events.ERROR).subscribe(e=>{e.fatal&&t.error$.next({id:["HlsJsFatal",e.type,e.details].join("_"),category:E.ErrorCategory.WTF,message:`HlsJs fatal ${e.type} ${e.details}, ${e.err?.message} ${e.reason}`,thrown:e.error})})),this.subscription.add(s.playing$.subscribe(()=>{this.videoState.setState(f.PLAYING),C(e.playbackState,tL.PLAYING)},i)).add(s.pause$.subscribe(()=>{this.videoState.setState(f.PAUSED),C(e.playbackState,tL.PAUSED)},i)).add(s.canplay$.subscribe(()=>{this.videoState.getTransition()?.to===f.READY&&this.videoState.setState(f.READY),this.videoState.getState()===f.PLAYING&&this.playIfAllowed()},i)),a(iS(this.hls,ib.Events.MANIFEST_PARSED).pipe((0,E.map)(({levels:e})=>e.reduce((e,t)=>{let i=t.name||t.height.toString(10),{width:s,height:a}=t,r=K(t.attrs.QUALITY??"")??(0,E.videoSizeToQuality)({width:s,height:a});if(!r)return e;let n=t.attrs["FRAME-RATE"]?parseFloat(t.attrs["FRAME-RATE"]):void 0,o={id:i.toString(),quality:r,bitrate:t.bitrate/1e3,size:{width:s,height:a},fps:n};return this.trackLevels.set(i,{track:o,level:t}),e.push(o),e},[]))),t.availableVideoTracks$),a(iS(this.hls,ib.Events.MANIFEST_PARSED),t=>{if(t.subtitleTracks.length>0){let i=[];for(let e of t.subtitleTracks){let t=e.name,s=e.attrs.URI||"",a=e.lang;i.push({id:t,url:s,language:a,type:"internal"})}e.internalTextTracks.startTransitionTo(i)}}),a(iS(this.hls,ib.Events.LEVEL_LOADING).pipe((0,E.map)(({url:e})=>eh(e))),t.hostname$),this.subscription.add(B(e.autoVideoTrackSwitching,()=>this.hls.autoLevelEnabled,e=>{this.hls.nextLevel=e?-1:this.hls.currentLevel,this.hls.loadLevel=e?-1:this.hls.loadLevel},{onError:i}));let r=e=>Array.from(this.trackLevels.values()).find(({level:t})=>t===e)?.track,n=iS(this.hls,ib.Events.LEVEL_SWITCHED).pipe((0,E.map)(({level:e})=>r(this.hls.levels[e])));n.pipe((0,E.filter)(E.isNonNullable)).subscribe(t.currentVideoTrack$,i),this.subscription.add(B(e.videoTrack,()=>r(this.hls.levels[this.hls.currentLevel]),e=>{if((0,E.isNullable)(e))return;let t=this.trackLevels.get(e.id)?.level;if(!t)return;let i=this.hls.levels.indexOf(t),s=this.hls.currentLevel,a=this.hls.levels[s];!a||t.bitrate>a.bitrate?this.hls.nextLevel=i:(this.hls.loadLevel=i,this.hls.loadLevel=i)},{changed$:n,onError:i})),a(s.progress$,()=>{this.params.dependencies.throughputEstimator.addRawThroughput(this.hls.bandwidthEstimate/1e3)}),this.textTracksManager.connect(this.video,e,t);let o=(0,E.merge)(e.playbackState.stateChangeStarted$,e.videoTrack.stateChangeStarted$,e.seekState.stateChangeEnded$,this.videoState.stateChangeEnded$,(0,E.observableFrom)(["init"])).pipe((0,E.debounce)(0));this.subscription.add(o.subscribe(this.syncPlayback,i))}syncPlayback=()=>{let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.seekState.getState();if(e!==f.INITIALIZING)switch(i?.to!==tL.PAUSED&&s.state===tN.Requested&&this.seek(s.position),t){case tL.STOPPED:switch(e){case f.STOPPED:break;case f.READY:case f.PLAYING:case f.PAUSED:this.stop();break;default:(0,E.assertNever)(e)}break;case tL.READY:switch(e){case f.STOPPED:this.prepare();break;case f.READY:case f.PLAYING:case f.PAUSED:break;default:(0,E.assertNever)(e)}break;case tL.PLAYING:switch(e){case f.PLAYING:break;case f.STOPPED:this.prepare();break;case f.READY:case f.PAUSED:this.playIfAllowed();break;default:(0,E.assertNever)(e)}break;case tL.PAUSED:switch(e){case f.PAUSED:break;case f.STOPPED:this.prepare();break;case f.READY:this.videoState.setState(f.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED);break;case f.PLAYING:this.pause();break;default:(0,E.assertNever)(e)}break;default:(0,E.assertNever)(t)}};prepare(){this.videoState.startTransitionTo(f.READY),this.hls.attachMedia(this.video),this.hls.loadSource(this.params.source.url)}async playIfAllowed(){this.videoState.startTransitionTo(f.PLAYING),await ec(this.video).catch(e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:E.ErrorCategory.DOM,thrown:e}))||(this.videoState.setState(f.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED,!0))}pause(){this.videoState.startTransitionTo(f.PAUSED),this.video.pause()}seek(e){this.params.output.willSeekEvent$.next(),this.video.currentTime=e/1e3}stop(){this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.hls.stopLoad(),this.hls.detachMedia(),this.video.removeAttribute("src"),this.video.load(),this.videoState.setState(f.STOPPED),C(this.params.desiredState.playbackState,tL.STOPPED,!0)}}let iy="X-Playback-Duration";var iT=async e=>{let t=await eD(e),i=await t.text(),s=/#EXT-X-VK-PLAYBACK-DURATION:(\d+)/m.exec(i)?.[1];return s?parseInt(s,10):t.headers.has(iy)?parseInt(t.headers.get(iy),10):void 0};let iE=e=>{let t=null;if(e.QUALITY&&(t=K(e.QUALITY)),!t&&e.RESOLUTION){let[i,s]=e.RESOLUTION.split("x").map(e=>parseInt(e,10));t=(0,E.videoSizeToQuality)({width:i,height:s})}return t??null},iw=(e,t)=>{let i=e.split(`
`),s=[],a=[];for(let e=0;e<i.length;e++){let r=i[e],n=r.match(/^#EXT-X-STREAM-INF:(.+)/),o=r.match(/^#EXT-X-MEDIA:TYPE=SUBTITLES,(.+)/);if(!(!n&&!o)){if(n){let a,r;let o=Object.fromEntries(n[1].split(",").map(e=>e.split("="))),l=o.QUALITY??`stream-${o.BANDWIDTH}`,u=iE(o);o.BANDWIDTH&&(a=parseInt(o.BANDWIDTH,10)/1e3||void 0),!a&&o["AVERAGE-BANDWIDTH"]&&(a=parseInt(o["AVERAGE-BANDWIDTH"],10)/1e3||void 0);let h=o["FRAME-RATE"]?parseFloat(o["FRAME-RATE"]):void 0;if(o.RESOLUTION){let[e,t]=o.RESOLUTION.split("x").map(e=>parseInt(e,10));e&&t&&(r={width:e,height:t})}let d=new URL(i[++e],t).toString();u&&s.push({id:l,quality:u,url:d,bandwidth:a,size:r,fps:h})}if(o){let e=Object.fromEntries(o[1].split(",").map(e=>e.split("=")).map(([e,t])=>[e,t.replace(/^"|"$/g,"")])),t=e.URI?.replace(/playlist$/,"subtitles.vtt"),i=e.LANGUAGE,s=e.NAME;t&&i&&a.push({type:"internal",id:i,label:s,language:i,url:t,isAuto:!1})}}}if(!s.length)throw Error("Empty manifest");return{qualityManifests:s,textTracks:a}},iA=e=>new Promise(t=>{setTimeout(()=>{t()},e)}),i$=0,ik=async(e,t=e,i)=>{let s=await (await eD(e)).text();i$+=1;try{let{qualityManifests:e,textTracks:i}=iw(s,t);return{qualityManifests:e,textTracks:i}}catch{if(i$<=i.manifestRetryMaxCount)return await iA((0,E.getExponentialDelay)(i$-1,{start:i.manifestRetryInterval,max:i.manifestRetryMaxInterval})),ik(e,t,i)}return{qualityManifests:[],textTracks:[]}};(l=g||(g={})).STOPPED="stopped",l.READY="ready",l.PLAYING="playing",l.CHANGING_MANIFEST="changing_manifest",l.PAUSED="paused";class iP{subscription=new E.Subscription;videoState=new x(g.STOPPED);video;params;textTracksManager=new q;masterManifest;manifests$=new E.ValueSubject([]);maxSeekBackTime$;liveOffset=new Y;manifestStartTime$=new E.ValueSubject(void 0);constructor(e){this.params=e,this.video=O(e.container),this.params.output.element$.next(this.video),this.masterManifest={id:"master",quality:E.VideoQuality.INVARIANT,url:this.params.source.url},ik(P(this.params.source.url),this.params.source.url,{manifestRetryInterval:this.params.tuning.manifestRetryInterval,manifestRetryMaxInterval:this.params.tuning.manifestRetryMaxInterval,manifestRetryMaxCount:this.params.tuning.manifestRetryMaxCount}).then(({qualityManifests:e})=>{0===e.length&&this.params.output.error$.next({id:"HlsLiveProviderInternal:empty_manifest",category:E.ErrorCategory.WTF,message:"HlsLiveProvider: there are no qualities in manifest"}),this.manifests$.next([this.masterManifest,...e])},e=>this.params.output.error$.next({id:"ExtractHlsQualities",category:E.ErrorCategory.NETWORK,message:"Error fetching manifest and extracting qualities",thrown:e})),this.params.output.isLive$.next(!0),this.params.output.canChangePlaybackSpeed$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(eh(this.params.source.url)),this.maxSeekBackTime$=new E.ValueSubject(e.source.maxSeekBackTime??1/0),this.subscribe()}selectManifest(){let{autoVideoTrackSwitching:e,videoTrack:t}=this.params.desiredState,i=e.getState(),s=t.getTransition(),a=s?.to?.id??t.getState()?.id??"master",r=this.manifests$.getValue();if(!r.length)return;let n=i?"master":a;return i&&!s&&t.startTransitionTo(this.masterManifest),r.find(e=>e.id===n)}subscribe(){let{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"HlsLiveProvider",category:E.ErrorCategory.WTF,message:"HlsLiveProvider internal logic error",thrown:t})},s=X(this.video),a=(e,t)=>this.subscription.add(e.subscribe(t,i));a(s.ended$,e.endedEvent$),a(s.error$,e.error$),a(s.isBuffering$,e.isBuffering$),a(s.currentBuffer$,e.currentBuffer$),a(s.loadedMetadata$,e.firstBytesEvent$),a(s.playing$,e.firstFrameEvent$),a(s.canplay$,e.canplay$),a(s.inPiP$,e.inPiP$),a(s.inFullscreen$,e.inFullscreen$),this.subscription.add(t.isLooped.stateChangeStarted$.subscribe(()=>t.isLooped.setState(!1),i)),this.subscription.add(F(this.video,t.volume,s.volumeState$,i)),this.subscription.add(s.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(U(this.video,t.playbackRate,s.playbackRateState$,i)),this.textTracksManager.connect(this.video,t,e),this.subscription.add(s.playing$.subscribe(()=>{this.videoState.setState(g.PLAYING),C(t.playbackState,tL.PLAYING)},i)).add(s.pause$.subscribe(()=>{this.videoState.setState(g.PAUSED),C(t.playbackState,tL.PAUSED)},i)).add(s.canplay$.subscribe(()=>{this.videoState.getTransition()?.to===g.READY&&this.videoState.setState(g.READY),this.videoState.getState()===g.PLAYING&&this.playIfAllowed()},i)),this.subscription.add(this.maxSeekBackTime$.pipe((0,E.filterChanged)(),(0,E.map)(e=>-e/1e3)).subscribe(this.params.output.duration$,i)),this.subscription.add(s.loadedMetadata$.subscribe(()=>{let e=this.params.desiredState.seekState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.videoTrack.getTransition(),s=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(i&&(0,E.isNonNullable)(i.to)){let e=i.to.id;this.params.desiredState.videoTrack.setState(i.to);let t=this.manifests$.getValue().find(t=>t.id===e);t&&(this.params.output.currentVideoTrack$.next(t),this.params.output.hostname$.next(eh(t.url)))}s&&this.params.desiredState.autoVideoTrackSwitching.setState(s.to),t&&t.from===g.CHANGING_MANIFEST&&this.videoState.setState(t.to),e&&e.state===tN.Requested&&this.seek(e.position)},i)),this.subscription.add(s.loadedData$.subscribe(()=>{let e=this.video?.getStartDate?.()?.getTime();this.manifestStartTime$.next(e||void 0)},i)),this.subscription.add((0,E.combine)({startTime:this.manifestStartTime$.pipe((0,E.filter)(E.isNonNullable)),currentTime:s.timeUpdate$}).subscribe(({startTime:e,currentTime:t})=>this.params.output.liveTime$.next(e+1e3*t),i)),this.subscription.add(this.manifests$.pipe((0,E.map)(e=>e.map(({id:e,quality:t,size:i,bandwidth:s,fps:a})=>({id:e,quality:t,size:i,fps:a,bitrate:s})))).subscribe(this.params.output.availableVideoTracks$,i));let r=(0,E.merge)(t.playbackState.stateChangeStarted$,t.seekState.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.stateChangeStarted$,t.autoVideoTrackLimits.stateChangeStarted$,this.videoState.stateChangeEnded$,this.manifests$,(0,E.observableFrom)(["init"])).pipe((0,E.debounce)(0));this.subscription.add(r.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.params.output.element$.next(void 0),_(this.video)}prepare(){let e=this.selectManifest();if((0,E.isNullable)(e))return;let t=this.params.desiredState.autoVideoTrackLimits.getTransition(),i=this.params.desiredState.autoVideoTrackLimits.getState(),s=new URL(e.url);if((t||i)&&e.id===this.masterManifest.id){let{max:e,min:a}=t?.to??i??{};for(let[t,i]of[[e,"mq"],[a,"lq"]]){let e=String(parseFloat(t||""));i&&t&&s.searchParams.set(i,e)}}let a=this.params.format===tC.HLS_LIVE_CMAF?tM.DASH_CMAF_OFFSET_P:tM.OFFSET_P,r=P(s.toString(),this.liveOffset.getTotalOffset(),a);this.video.setAttribute("src",r),this.video.load(),iT(r).then(e=>{if((0,E.isNullable)(e)){let e=this.params.source.maxSeekBackTime??this.maxSeekBackTime$.getValue();if((0,E.isNullable)(e)||!isFinite(e))try{eD(r).then(e=>e.text()).then(e=>{let t=/#EXT-X-STREAM-INF[^\n]+\n(.+)/m.exec(e)?.[1];if(t){let e=new URL(t,r).toString();iT(e).then(e=>{(0,E.isNullable)(e)||this.maxSeekBackTime$.next(e)})}})}catch{}}else this.maxSeekBackTime$.next(e)})}playIfAllowed(){ec(this.video).then(e=>{e||(this.videoState.setState(g.PAUSED),this.liveOffset.pause(),C(this.params.desiredState.playbackState,tL.PAUSED,!0))},e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:E.ErrorCategory.DOM,thrown:e}))}seek(e){this.params.output.willSeekEvent$.next();let t=-e,i=t<this.maxSeekBackTime$.getValue()?t:0;this.liveOffset.resetTo(i),this.params.output.position$.next(-i/1e3),this.params.output.seekedEvent$.next()}syncPlayback=()=>{if(!this.manifests$.getValue().length)return;let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.videoTrack.getTransition(),a=this.params.desiredState.autoVideoTrackSwitching.getTransition(),r=this.params.desiredState.autoVideoTrackLimits.getTransition();if(t===tL.STOPPED){e!==g.STOPPED&&(this.videoState.startTransitionTo(g.STOPPED),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(g.STOPPED),C(this.params.desiredState.playbackState,tL.STOPPED,!0));return}if(this.videoState.getTransition())return;let n=this.params.desiredState.seekState.getState();if(e===g.STOPPED){this.videoState.startTransitionTo(g.READY),this.prepare();return}if(s||a||r){let e=this.videoState.getState();this.videoState.setState(g.CHANGING_MANIFEST),this.videoState.startTransitionTo(e),this.prepare(),r&&this.params.output.autoVideoTrackLimits$.next(r.to),n.state===tN.None&&this.params.desiredState.seekState.setState({state:tN.Requested,position:-this.liveOffset.getTotalOffset(),forcePrecise:!0});return}if(i?.to!==tL.PAUSED&&n.state===tN.Requested){this.videoState.startTransitionTo(g.READY),this.seek(n.position-this.liveOffset.getTotalPausedTime()),this.prepare();return}switch(e){case g.READY:t===tL.READY?C(this.params.desiredState.playbackState,tL.READY):t===tL.PAUSED?(this.videoState.setState(g.PAUSED),this.liveOffset.pause(),C(this.params.desiredState.playbackState,tL.PAUSED)):t===tL.PLAYING&&(this.videoState.startTransitionTo(g.PLAYING),this.playIfAllowed());return;case g.PLAYING:t===tL.PAUSED?(this.videoState.startTransitionTo(g.PAUSED),this.liveOffset.pause(),this.video.pause()):i?.to===tL.PLAYING&&C(this.params.desiredState.playbackState,tL.PLAYING);return;case g.PAUSED:if(t===tL.PLAYING){if(this.videoState.startTransitionTo(g.PLAYING),this.liveOffset.getTotalPausedTime()<this.params.config.maxPausedTime&&this.liveOffset.getTotalOffset()<this.maxSeekBackTime$.getValue())this.liveOffset.resume(),this.playIfAllowed(),this.params.output.position$.next(-this.liveOffset.getTotalOffset()/1e3);else{let e=this.liveOffset.getTotalOffset();e>=this.maxSeekBackTime$.getValue()&&(e=0,this.liveOffset.resetTo(e)),this.liveOffset.resume(),this.params.output.position$.next(-e/1e3),this.prepare()}}else i?.to===tL.PAUSED&&(C(this.params.desiredState.playbackState,tL.PAUSED),this.liveOffset.pause());return;case g.CHANGING_MANIFEST:break;default:return(0,E.assertNever)(e)}}}(u=b||(b={})).STOPPED="stopped",u.READY="ready",u.PLAYING="playing",u.CHANGING_MANIFEST="changing_manifest",u.PAUSED="paused";class iL{subscription=new E.Subscription;videoState=new x(b.STOPPED);video;params;textTracksManager=new q;masterManifest;manifests$=new E.ValueSubject([]);constructor(e){this.params=e,this.video=O(e.container),this.params.output.element$.next(this.video),this.masterManifest={id:"master",quality:E.VideoQuality.INVARIANT,url:this.params.source.url},this.params.output.isLive$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.hostname$.next(eh(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),ik(P(this.params.source.url),this.params.source.url,{manifestRetryInterval:this.params.tuning.manifestRetryInterval,manifestRetryMaxInterval:this.params.tuning.manifestRetryMaxInterval,manifestRetryMaxCount:this.params.tuning.manifestRetryMaxCount}).then(({qualityManifests:e,textTracks:t})=>{this.manifests$.next([this.masterManifest,...e]),this.params.tuning.useNativeHLSTextTracks||this.params.desiredState.internalTextTracks.startTransitionTo(t)},e=>this.params.output.error$.next({id:"ExtractHlsQualities",category:E.ErrorCategory.NETWORK,message:"Error fetching manifest and extracting qualities",thrown:e})),this.subscribe()}selectManifest(){let{autoVideoTrackSwitching:e,videoTrack:t}=this.params.desiredState,i=e.getState(),s=t.getTransition(),a=s?.to?.id??t.getState()?.id??"master",r=this.manifests$.getValue();if(!r.length)return;let n=i?"master":a;return i&&!s&&t.startTransitionTo(this.masterManifest),r.find(e=>e.id===n)}subscribe(){let{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"HlsProvider",category:E.ErrorCategory.WTF,message:"HlsProvider internal logic error",thrown:t})},s=X(this.video),a=(e,t)=>this.subscription.add(e.subscribe(t));if(a(s.timeUpdate$,e.position$),a(s.durationChange$,e.duration$),a(s.ended$,e.endedEvent$),a(s.looped$,e.loopedEvent$),a(s.error$,e.error$),a(s.isBuffering$,e.isBuffering$),a(s.currentBuffer$,e.currentBuffer$),a(s.loadedMetadata$,e.firstBytesEvent$),a(s.playing$,e.firstFrameEvent$),a(s.canplay$,e.canplay$),a(s.seeked$,e.seekedEvent$),a(s.inPiP$,e.inPiP$),a(s.inFullscreen$,e.inFullscreen$),this.subscription.add(V(this.video,t.isLooped,i)),this.subscription.add(F(this.video,t.volume,s.volumeState$,i)),this.subscription.add(s.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(U(this.video,t.playbackRate,s.playbackRateState$,i)),this.textTracksManager.connect(this.video,t,e),this.subscription.add(s.playing$.subscribe(()=>{this.videoState.setState(b.PLAYING),C(t.playbackState,tL.PLAYING)},i)).add(s.pause$.subscribe(()=>{this.videoState.setState(b.PAUSED),C(t.playbackState,tL.PAUSED)},i)).add(s.canplay$.subscribe(()=>{this.videoState.getTransition()?.to===b.READY&&this.videoState.setState(b.READY),this.videoState.getState()===b.PLAYING&&this.playIfAllowed()},i).add(s.loadedMetadata$.subscribe(()=>{let e=this.params.desiredState.seekState.getState(),t=this.videoState.getTransition(),i=this.params.desiredState.videoTrack.getTransition(),s=this.params.desiredState.autoVideoTrackSwitching.getTransition();if(i&&(0,E.isNonNullable)(i.to)){let e=i.to.id;this.params.desiredState.videoTrack.setState(i.to);let t=this.manifests$.getValue().find(t=>t.id===e);if(t){this.params.output.currentVideoTrack$.next(t),this.params.output.hostname$.next(eh(t.url));let e=this.params.desiredState.playbackRate.getState();if(e!==this.params.output.element$.getValue()?.playbackRate){let t=this.params.output.element$.getValue();t&&(this.params.desiredState.playbackRate.setState(e),t.playbackRate=e)}}}s&&this.params.desiredState.autoVideoTrackSwitching.setState(s.to),t&&t.from===b.CHANGING_MANIFEST&&this.videoState.setState(t.to),e.state===tN.Requested&&this.seek(e.position)},i))),this.subscription.add(this.manifests$.pipe((0,E.map)(e=>e.map(({id:e,quality:t,size:i,bandwidth:s,fps:a})=>({id:e,quality:t,size:i,fps:a,bitrate:s})))).subscribe(this.params.output.availableVideoTracks$,i)),!(0,E.isIOS)()||!this.params.tuning.useNativeHLSTextTracks){let{textTracks:e}=this.video;this.subscription.add((0,E.merge)((0,E.fromEvent)(e,"addtrack"),(0,E.fromEvent)(e,"removetrack"),(0,E.fromEvent)(e,"change"),(0,E.observableFrom)(["init"])).subscribe(()=>{for(let t=0;t<e.length;t++)e[t].mode="hidden"},i))}let r=(0,E.merge)(t.playbackState.stateChangeStarted$,t.seekState.stateChangeEnded$,t.videoTrack.stateChangeStarted$,t.autoVideoTrackSwitching.stateChangeStarted$,t.autoVideoTrackLimits.stateChangeStarted$,this.videoState.stateChangeEnded$,this.manifests$,(0,E.observableFrom)(["init"])).pipe((0,E.debounce)(0));this.subscription.add(r.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.params.output.element$.next(void 0),_(this.video)}prepare(){let e=this.selectManifest();if((0,E.isNullable)(e))return;let t=this.params.desiredState.autoVideoTrackLimits.getTransition(),i=this.params.desiredState.autoVideoTrackLimits.getState(),s=new URL(e.url);if((t||i)&&e.id===this.masterManifest.id){let{max:e,min:a}=t?.to??i??{};for(let[t,i]of[[e,"mq"],[a,"lq"]]){let e=String(parseFloat(t||""));i&&t&&s.searchParams.set(i,e)}}this.video.setAttribute("src",s.toString()),this.video.load()}playIfAllowed(){ec(this.video).then(e=>{e||(this.videoState.setState(b.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED,!0))},e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:E.ErrorCategory.DOM,thrown:e}))}seek(e){this.params.output.willSeekEvent$.next(),this.video.currentTime=e/1e3}syncPlayback=()=>{if(!this.manifests$.getValue().length)return;let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition(),s=this.params.desiredState.videoTrack.getTransition(),a=this.params.desiredState.autoVideoTrackSwitching.getTransition(),r=this.params.desiredState.autoVideoTrackLimits.getTransition();if(t===tL.STOPPED){e!==b.STOPPED&&(this.videoState.startTransitionTo(b.STOPPED),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(b.STOPPED),C(this.params.desiredState.playbackState,tL.STOPPED,!0));return}if(this.videoState.getTransition())return;let n=this.params.desiredState.seekState.getState();if(e===b.STOPPED){this.videoState.startTransitionTo(b.READY),this.prepare();return}if(s||a||r){let e=this.videoState.getState();this.videoState.setState(b.CHANGING_MANIFEST),this.videoState.startTransitionTo(e);let{currentTime:t}=this.video;this.prepare(),r&&this.params.output.autoVideoTrackLimits$.next(r.to),n.state===tN.None&&this.params.desiredState.seekState.setState({state:tN.Requested,position:1e3*t,forcePrecise:!0});return}switch(i?.to!==tL.PAUSED&&n.state===tN.Requested&&this.seek(n.position),e){case b.READY:t===tL.READY?C(this.params.desiredState.playbackState,tL.READY):t===tL.PAUSED?(this.videoState.setState(b.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED)):t===tL.PLAYING&&(this.videoState.startTransitionTo(b.PLAYING),this.playIfAllowed());return;case b.PLAYING:t===tL.PAUSED?(this.videoState.startTransitionTo(b.PAUSED),this.video.pause()):i?.to===tL.PLAYING&&C(this.params.desiredState.playbackState,tL.PLAYING);return;case b.PAUSED:t===tL.PLAYING?(this.videoState.startTransitionTo(b.PLAYING),this.playIfAllowed()):i?.to===tL.PAUSED&&C(this.params.desiredState.playbackState,tL.PAUSED);return;case b.CHANGING_MANIFEST:break;default:return(0,E.assertNever)(e)}}}(h=S||(S={})).STOPPED="stopped",h.READY="ready",h.PLAYING="playing",h.PAUSED="paused";class iC{subscription=new E.Subscription;videoState=new x(S.STOPPED);video;trackUrls={};params;textTracksManager=new q;constructor(e){this.params=e,this.video=O(e.container),this.params.output.element$.next(this.video),Object.entries(this.params.source).reverse().forEach(([e,t],i)=>{let s=i.toString(10);this.trackUrls[s]={track:{quality:e,id:s},url:t}}),this.params.output.isLive$.next(!1),this.params.output.availableVideoTracks$.next(Object.values(this.trackUrls).map(({track:e})=>e)),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.desiredState.autoVideoTrackSwitching.setState(!1),this.params.output.autoVideoTrackLimitingAvailable$.next(!0),this.subscribe()}subscribe(){let{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"MpegProvider",category:E.ErrorCategory.WTF,message:"MpegProvider internal logic error",thrown:t})},s=X(this.video),a=(e,t)=>this.subscription.add(e.subscribe(t,i));a(s.timeUpdate$,e.position$),a(s.durationChange$,e.duration$),a(s.ended$,e.endedEvent$),a(s.looped$,e.loopedEvent$),a(s.error$,e.error$),a(s.isBuffering$,e.isBuffering$),a(s.currentBuffer$,e.currentBuffer$),a(s.loadedMetadata$,e.firstBytesEvent$),a(s.playing$,e.firstFrameEvent$),a(s.canplay$,e.canplay$),a(s.seeked$,e.seekedEvent$),a(s.inPiP$,e.inPiP$),a(s.inFullscreen$,e.inFullscreen$),this.subscription.add(V(this.video,t.isLooped,i)),this.subscription.add(F(this.video,t.volume,s.volumeState$,i)),this.subscription.add(s.volumeState$.subscribe(this.params.output.volume$,i)),this.subscription.add(U(this.video,t.playbackRate,s.playbackRateState$,i)),this.subscription.add(s.playing$.subscribe(()=>{this.videoState.setState(S.PLAYING),C(t.playbackState,tL.PLAYING)},i)).add(s.pause$.subscribe(()=>{this.videoState.setState(S.PAUSED),C(t.playbackState,tL.PAUSED)},i)).add(s.canplay$.subscribe(()=>{this.videoState.getTransition()?.to===S.READY&&this.videoState.setState(S.READY);let e=this.params.desiredState.videoTrack.getTransition();if(e&&(0,E.isNonNullable)(e.to)){this.params.desiredState.videoTrack.setState(e.to),this.params.output.currentVideoTrack$.next(this.trackUrls[e.to.id].track);let t=this.params.desiredState.playbackRate.getState();if(t!==this.params.output.element$.getValue()?.playbackRate){let e=this.params.output.element$.getValue();e&&(this.params.desiredState.playbackRate.setState(t),e.playbackRate=t)}}this.videoState.getState()===S.PLAYING&&this.playIfAllowed()},i)),this.textTracksManager.connect(this.video,t,e);let r=(0,E.merge)(t.playbackState.stateChangeStarted$,t.videoTrack.stateChangeStarted$,t.seekState.stateChangeEnded$,t.autoVideoTrackLimits.stateChangeStarted$,this.videoState.stateChangeEnded$,(0,E.observableFrom)(["init"])).pipe((0,E.debounce)(0));this.subscription.add(r.subscribe(this.syncPlayback,i))}destroy(){this.subscription.unsubscribe(),this.textTracksManager.destroy(),this.trackUrls={},this.params.output.element$.next(void 0),_(this.video)}prepare(){let e=this.params.desiredState.videoTrack.getState()?.id;(0,E.assertNonNullable)(e,"MpegProvider: track is not selected");let{url:t}=this.trackUrls[e];(0,E.assertNonNullable)(t,`MpegProvider: No url for ${e}`),this.params.tuning.requestQuick&&(t=tX(t)),this.video.setAttribute("src",t),this.video.load(),this.params.output.hostname$.next(eh(t))}playIfAllowed(){ec(this.video).then(e=>{e||(this.videoState.setState(S.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED,!0))},e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:E.ErrorCategory.DOM,thrown:e}))}seek(e){this.params.output.willSeekEvent$.next(),this.video.currentTime=e/1e3}syncPlayback=()=>{let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition();if(t===tL.STOPPED){e!==S.STOPPED&&(this.videoState.startTransitionTo(S.STOPPED),this.video.removeAttribute("src"),this.video.load(),this.params.output.position$.next(0),this.params.output.duration$.next(1/0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(S.STOPPED),C(this.params.desiredState.playbackState,tL.STOPPED,!0));return}if(this.videoState.getTransition())return;let s=this.params.desiredState.autoVideoTrackLimits.getTransition(),a=this.params.desiredState.videoTrack.getTransition(),r=this.params.desiredState.seekState.getState();if(s&&e!==S.READY&&!a){this.handleQualityLimitTransition(s.to.max);return}if(e===S.STOPPED){this.videoState.startTransitionTo(S.READY),this.prepare();return}if(a){let{currentTime:e}=this.video;this.prepare(),r.state===tN.None&&this.params.desiredState.seekState.setState({state:tN.Requested,position:1e3*e,forcePrecise:!0}),a.to&&this.params.desiredState.autoVideoTrackLimits.getState()?.max!==this.trackUrls[a.to.id]?.track?.quality&&this.params.output.autoVideoTrackLimits$.next({max:void 0});return}switch(i?.to!==tL.PAUSED&&r.state===tN.Requested&&this.seek(r.position),e){case S.READY:t===tL.READY?C(this.params.desiredState.playbackState,tL.READY):t===tL.PAUSED?(this.videoState.setState(S.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED)):t===tL.PLAYING&&(this.videoState.startTransitionTo(S.PLAYING),this.playIfAllowed());return;case S.PLAYING:t===tL.PAUSED?(this.videoState.startTransitionTo(S.PAUSED),this.video.pause()):i?.to===tL.PLAYING&&C(this.params.desiredState.playbackState,tL.PLAYING);return;case S.PAUSED:t===tL.PLAYING?(this.videoState.startTransitionTo(S.PLAYING),this.playIfAllowed()):i?.to===tL.PAUSED&&C(this.params.desiredState.playbackState,tL.PAUSED);return;default:return(0,E.assertNever)(e)}};handleQualityLimitTransition(e){let t,i=e;if(e&&this.params.output.currentVideoTrack$.getValue()?.quality!==e){let s=Object.values(this.trackUrls).find(t=>!E.isInvariantQuality(t.track.quality)&&E.isLowerOrEqual(t.track.quality,e))?.track,a=this.params.desiredState.videoTrack.getState()?.id,r=this.trackUrls[a??"0"]?.track;if(s&&r&&(0,E.isHigherOrEqual)(r.quality,s.quality)&&(t=s),!t){let i=Object.values(this.trackUrls).filter(t=>!(0,E.isInvariantQuality)(t.track.quality)&&(0,E.isHigher)(t.track.quality,e)),s=i.length;s&&(t=i[s-1].track)}t&&(i=t.quality)}else e||(t=eu(Object.values(this.trackUrls).map(e=>e.track),{container:{width:this.video.offsetWidth,height:this.video.offsetHeight},throughput:this.params.dependencies.throughputEstimator.throughput$.getValue(),tuning:this.params.tuning.autoTrackSelection,forwardBufferHealth:0,abrLogger:this.params.dependencies.abrLogger}));t&&(this.params.output.currentVideoTrack$.next(t),this.params.desiredState.videoTrack.startTransitionTo(t)),this.params.output.autoVideoTrackLimits$.next({max:i})}}let ix=["stun:videostun.mycdn.me:80"],iR=()=>null;class iD{options;ws=null;peerConnection=null;serverUrl="";streamKey="";stream=null;signalingType="JOIN";retryTimeout;retryCount=0;externalStartCallback=iR;externalStopCallback=iR;externalErrorCallback=iR;constructor(e,t){this.options=this.normalizeOptions(t);let i=e.split("/");this.serverUrl=i.slice(0,i.length-1).join("/"),this.streamKey=i[i.length-1]}onStart(e){try{this.externalStartCallback=e}catch(e){this.handleSystemError(e)}}onStop(e){try{this.externalStopCallback=e}catch(e){this.handleSystemError(e)}}onError(e){try{this.externalErrorCallback=e}catch(e){this.handleSystemError(e)}}connect(){this.connectWS()}disconnect(){try{this.externalStopCallback(),this.closeConnections()}catch(e){this.handleSystemError(e)}}connectWS(){this.ws||(this.ws=new WebSocket(this.serverUrl),this.ws.onopen=this.onSocketOpen.bind(this),this.ws.onmessage=this.onSocketMessage.bind(this),this.ws.onclose=this.onSocketClose.bind(this),this.ws.onerror=this.onSocketError.bind(this))}onSocketOpen(){this.handleLogin()}onSocketClose(e){try{if(!this.ws)return;this.ws=null,e.code>1e3?(this.retryCount++,this.retryCount>this.options.maxRetryNumber?this.handleNetworkError():this.scheduleRetry()):this.externalStopCallback()}catch(e){this.handleRTCError(e)}}onSocketError(e){try{this.externalErrorCallback(Error(e.toString()))}catch(e){this.handleRTCError(e)}}onSocketMessage(e){try{let t=this.parseMessage(e.data);switch(t.type){case"JOIN":case"CALL_JOIN":this.handleJoinMessage(t);break;case"UPDATE":this.handleUpdateMessage(t);break;case"STATUS":this.handleStatusMessage(t)}}catch(e){this.handleRTCError(e)}}handleJoinMessage(e){switch(e.inviteType){case"ANSWER":this.handleAnswer(e.sdp);break;case"CANDIDATE":this.handleCandidate(e.candidate)}}handleStatusMessage(e){"UNPUBLISHED"===e.status&&this.handleUnpublished()}async handleUpdateMessage(e){try{let t=await this.createOffer();this.peerConnection&&await this.peerConnection.setLocalDescription(t),this.handleAnswer(e.sdp)}catch(e){this.handleRTCError(e)}}async handleLogin(){try{this.peerConnection=new RTCPeerConnection({iceServers:[{urls:ix}]}),this.peerConnection.ontrack=this.onPeerConnectionStream.bind(this),this.peerConnection.onicecandidate=this.onPeerConnectionIceCandidate.bind(this),this.peerConnection.oniceconnectionstatechange=this.onPeerConnectionIceConnectionStateChange.bind(this);let e=await this.createOffer();await this.peerConnection.setLocalDescription(e),this.send({type:this.signalingType,inviteType:"OFFER",streamKey:this.streamKey,sdp:e.sdp,callSupport:!1})}catch(e){this.handleRTCError(e)}}async handleAnswer(e){try{this.peerConnection&&await this.peerConnection.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:e}))}catch(e){this.handleRTCError(e)}}async handleCandidate(e){if(e)try{this.peerConnection&&await this.peerConnection.addIceCandidate(e)}catch(e){this.handleRTCError(e)}}handleUnpublished(){try{this.closeConnections(),this.externalStopCallback()}catch(e){this.handleRTCError(e)}}handleSystemError(e){this.options.errorChanel&&this.options.errorChanel.next({id:"webrtc-provider-error",category:E.ErrorCategory.WTF,message:e.message})}async onPeerConnectionStream(e){let t=e.streams[0];this.stream&&this.stream.id===t.id||(this.stream=t,this.externalStartCallback(this.stream))}onPeerConnectionIceCandidate(e){e.candidate&&this.send({type:this.signalingType,inviteType:"CANDIDATE",candidate:e.candidate})}onPeerConnectionIceConnectionStateChange(){this.peerConnection&&["failed","closed"].indexOf(this.peerConnection.iceConnectionState)>-1&&(this.retryCount++,this.retryCount>this.options.maxRetryNumber?this.handleNetworkError():(this.closeConnections(),this.scheduleRetry()))}async createOffer(){if(!this.peerConnection)throw Error("Can not create offer - no peer connection instance ");let e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0,voiceActivityDetection:!1}),t=e.sdp||"";if(!/^a=rtpmap:\d+ H264\/\d+$/m.test(t))throw Error("No h264 codec support error");return e}handleRTCError(e){try{this.externalErrorCallback(e||Error("RTC connection error"))}catch(e){this.handleSystemError(e)}}handleNetworkError(){try{this.externalErrorCallback(Error("Network error"))}catch(e){this.handleSystemError(e)}}send(e){this.ws&&this.ws.send(JSON.stringify(e))}parseMessage(e){try{return JSON.parse(e)}catch{throw Error("Can not parse socket message")}}closeConnections(){let e=this.ws;e&&(this.ws=null,e.close(1e3)),this.removePeerConnection()}removePeerConnection(){let e=this.peerConnection;e&&(this.peerConnection=null,e.close(),e.ontrack=null,e.onicecandidate=null,e.oniceconnectionstatechange=null,e=null)}scheduleRetry(){this.retryTimeout=setTimeout(this.connectWS.bind(this),1e3)}normalizeOptions(e={}){let t={stunServerList:ix,maxRetryNumber:3,errorChanel:null};return e.stunServerList&&(t.stunServerList=e.stunServerList),e.maxRetryNumber&&e.maxRetryNumber>0&&(t.maxRetryNumber=e.maxRetryNumber),t}}(d=v||(v={})).STOPPED="stopped",d.READY="ready",d.PLAYING="playing",d.PAUSED="paused";class iN{subscription;params;log;video;videoState=new x(v.STOPPED);liveStreamClient;maxSeekBackTime$=new E.ValueSubject(0);constructor(e){this.subscription=new E.Subscription,this.params=e,this.log=this.params.dependencies.logger.createComponentLog("WebRTCLiveProvider"),this.video=O(e.container),this.liveStreamClient=new iD(this.params.source.url,{maxRetryNumber:this.params.tuning.webrtc.connectionRetryMaxNumber,errorChanel:this.params.output.error$}),this.liveStreamClient.onStart(this.onLiveStreamStart.bind(this)),this.liveStreamClient.onStop(this.onLiveStreamStop.bind(this)),this.liveStreamClient.onError(this.onLiveStreamError.bind(this)),this.subscribe()}destroy(){this.subscription.unsubscribe(),this.liveStreamClient.disconnect(),this.params.output.element$.next(void 0),_(this.video)}subscribe(){let{output:e,desiredState:t}=this.params,i=t=>{e.error$.next({id:"WebRTCLiveProvider",category:E.ErrorCategory.WTF,message:"WebRTCLiveProvider internal logic error",thrown:t})};(0,E.merge)(this.videoState.stateChangeStarted$.pipe((0,E.map)(e=>({transition:e,type:"start"}))),this.videoState.stateChangeEnded$.pipe((0,E.map)(e=>({transition:e,type:"end"})))).subscribe(({transition:e,type:t})=>{this.log({message:`[videoState change] ${t}: ${JSON.stringify(e)}`})});let s=X(this.video),a=(e,t)=>this.subscription.add(e.subscribe(t,i));a(s.timeUpdate$,e.liveTime$),a(s.ended$,e.endedEvent$),a(s.looped$,e.loopedEvent$),a(s.error$,e.error$),a(s.isBuffering$,e.isBuffering$),a(s.currentBuffer$,e.currentBuffer$),this.subscription.add(s.durationChange$.subscribe(t=>{e.duration$.next(t===1/0?0:t)})).add(s.canplay$.subscribe(()=>{this.videoState.getTransition()?.to===v.READY&&this.videoState.setState(v.READY)},i)).add(s.pause$.subscribe(()=>{this.videoState.setState(v.PAUSED)},i)).add(s.playing$.subscribe(()=>{this.videoState.setState(v.PLAYING)},i)).add(s.error$.subscribe(e.error$)).add(this.maxSeekBackTime$.subscribe(this.params.output.duration$)).add(F(this.video,t.volume,s.volumeState$,i)).add(s.volumeState$.subscribe(e.volume$,i)).add(this.videoState.stateChangeEnded$.subscribe(i=>{switch(i.to){case v.STOPPED:e.position$.next(0),e.duration$.next(0),t.playbackState.setState(tL.STOPPED);break;case v.READY:break;case v.PAUSED:t.playbackState.setState(tL.PAUSED);break;case v.PLAYING:t.playbackState.setState(tL.PLAYING);break;default:return(0,E.assertNever)(i.to)}},i)).add((0,E.merge)(t.playbackState.stateChangeStarted$,this.videoState.stateChangeEnded$,(0,E.observableFrom)(["init"])).pipe((0,E.debounce)(0)).subscribe(this.syncPlayback.bind(this),i)),this.subscription.add(t.isLooped.stateChangeStarted$.subscribe(()=>t.isLooped.setState(!1),i)),this.subscription.add(t.autoVideoTrackSwitching.stateChangeStarted$.subscribe(()=>t.autoVideoTrackSwitching.setState(!1),i))}onLiveStreamStart(e){this.params.output.element$.next(this.video),this.params.output.duration$.next(0),this.params.output.position$.next(0),this.params.output.isLive$.next(!0),this.params.output.canChangePlaybackSpeed$.next(!1),this.params.output.hostname$.next(eh(this.params.source.url)),this.params.output.autoVideoTrackLimitingAvailable$.next(!1),this.params.output.availableVideoTracks$.next([]),this.params.output.availableAudioTracks$.next([]),this.params.output.isAudioAvailable$.next(!0),this.params.output.currentVideoTrack$.next({id:"webrtc",quality:E.VideoQuality.INVARIANT}),this.video.srcObject=e,C(this.params.desiredState.playbackState,tL.PLAYING)}onLiveStreamStop(){this.videoState.startTransitionTo(v.STOPPED),this.syncPlayback(),this.params.output.position$.next(0),this.params.output.duration$.next(0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.params.output.endedEvent$.next()}onLiveStreamError(e){this.onLiveStreamStop(),this.params.output.error$.next({id:"WebRTC stream runtime error",category:E.ErrorCategory.EXTERNAL_API,message:e.message,thrown:e})}playIfAllowed(){ec(this.video).then(e=>{e||(this.videoState.setState(v.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED,!0))},e=>this.params.output.error$.next({id:"ForcePlay",message:"play() failed even with workarounds",category:E.ErrorCategory.DOM,thrown:e}))}prepare(){this.liveStreamClient.connect()}syncPlayback=()=>{let e=this.videoState.getState(),t=this.params.desiredState.playbackState.getState(),i=this.params.desiredState.playbackState.getTransition();if(t===tL.STOPPED){e!==v.STOPPED&&(this.videoState.startTransitionTo(v.STOPPED),this.video.pause(),this.video.srcObject=null,this.params.output.position$.next(0),this.params.output.duration$.next(0),this.params.output.currentBuffer$.next(void 0),this.params.output.hostname$.next(void 0),this.videoState.setState(v.STOPPED),C(this.params.desiredState.playbackState,tL.STOPPED,!0));return}if(this.videoState.getTransition())return;let s=this.params.desiredState.videoTrack.getTransition();if(e===v.STOPPED){this.videoState.startTransitionTo(v.READY),this.prepare();return}if(s){this.prepare();return}switch(e){case v.READY:t===tL.PAUSED?(this.videoState.setState(v.PAUSED),C(this.params.desiredState.playbackState,tL.PAUSED)):t===tL.PLAYING&&(this.videoState.startTransitionTo(v.PLAYING),this.playIfAllowed());return;case v.PLAYING:t===tL.PAUSED?(this.videoState.startTransitionTo(v.PAUSED),this.video.pause()):i?.to===tL.PLAYING&&C(this.params.desiredState.playbackState,tL.PLAYING);return;case v.PAUSED:t===tL.PLAYING?(this.videoState.startTransitionTo(v.PLAYING),this.playIfAllowed()):i?.to===tL.PAUSED&&C(this.params.desiredState.playbackState,tL.PAUSED);return;default:return(0,E.assertNever)(e)}}}class iI{iterator;current;constructor(e){this.iterator=e[Symbol.iterator](),this.next()}next(){this.current=this.iterator.next()}getValue(){if(this.current.done)throw Error("Iterable is completed");return this.current.value}isCompleted(){return!!this.current.done}}let iM=(0,E.getCurrentBrowser)().device===E.CurrentClientDevice.Android,iO=document.createElement("video"),i_='video/webm; codecs="vp09.00.10.08"',iB='video/webm; codecs="av01.0.00M.08"',iV={mms:it(),mse:!!(window.MediaSource&&window.MediaStreamTrack&&window.SourceBuffer?.prototype?.appendBuffer),hls:!!(iO.canPlayType?.("application/x-mpegurl")||iO.canPlayType?.("vnd.apple.mpegURL")),webrtc:!!window.RTCPeerConnection,ws:!!window.WebSocket},iF={mp4:!!iO.canPlayType?.("video/mp4"),webm:!!iO.canPlayType?.("video/webm"),cmaf:!0},iU={h264:!!ie()?.isTypeSupported?.('video/mp4; codecs="avc1.42000a,mp4a.40.2"'),h265:!!ie()?.isTypeSupported?.('video/mp4; codecs="hev1.1.6.L93.B0"'),vp9:!!ie()?.isTypeSupported?.(i_),av1:!!ie()?.isTypeSupported?.(iB),aac:!!ie()?.isTypeSupported?.('audio/mp4; codecs="mp4a.40.2"'),opus:!!ie()?.isTypeSupported?.('audio/webm; codecs="opus"')},ij=(iU.h264||iU.h265)&&iU.aac;(c=y||(y={})).VP9="vp9",c.AV1="av1",c.NONE="none",c.SMOOTH="smooth",c.POWER_EFFICIENT="power_efficient",(p=T||(T={})).DASH="dash",p.HLS="hls",p.MPEG="mpeg";let iH=async()=>{if(!window.navigator.mediaCapabilities)return;let e={type:"media-source",video:{contentType:"video/webm",width:1280,height:720,bitrate:1e6,framerate:30}},[t,i]=await Promise.all([window.navigator.mediaCapabilities.decodingInfo({...e,video:{...e.video,contentType:iB}}),window.navigator.mediaCapabilities.decodingInfo({...e,video:{...e.video,contentType:i_}})]);a={[tC.DASH_WEBM_AV1]:t,[tC.DASH_WEBM]:i}};try{iH()}catch(e){console.error(e)}let iq=iV.hls&&iF.mp4,iY=()=>Object.keys(iU).filter(e=>iU[e]),iG=(e,t=!1,i=!1)=>{let s=iV.mse||iV.mms&&i;return e.filter(e=>{switch(e){case tC.DASH_SEP:return s&&iF.mp4&&ij;case tC.DASH_WEBM:return s&&iF.webm&&iU.vp9&&iU.opus;case tC.DASH_WEBM_AV1:return s&&iF.webm&&iU.av1&&iU.opus;case tC.DASH_LIVE:return iV.mse&&iF.mp4&&ij;case tC.DASH_LIVE_CMAF:return s&&iF.mp4&&ij&&iF.cmaf;case tC.DASH_ONDEMAND:return s&&iF.mp4&&ij;case tC.HLS:case tC.HLS_ONDEMAND:return iq||t&&iV.mse&&iF.mp4&&ij;case tC.HLS_LIVE:case tC.HLS_LIVE_CMAF:return iq;case tC.MPEG:return iF.mp4;case tC.DASH_LIVE_WEBM:return!1;case tC.WEB_RTC_LIVE:return iV.webrtc&&iV.ws&&iU.h264&&(iF.mp4||iF.webm);default:return(0,E.assertNever)(e)}})},iQ=e=>{let t=tC.DASH_WEBM,i=tC.DASH_WEBM_AV1;switch(e){case y.VP9:break;case y.AV1:return[i,t];case y.NONE:return[];case y.SMOOTH:return a?a[i].smooth?[i,t]:a[t].smooth?[t,i]:[i,t]:[t,i];case y.POWER_EFFICIENT:return a?a[i].powerEfficient?[i,t]:a[t].powerEfficient?[t,i]:[i,t]:[t,i];default:(0,E.assertNever)(e)}return[t,i]},iz=({webmCodec:e,androidPreferredFormat:t})=>{if(iM)switch(t){case T.MPEG:return[tC.MPEG,...iQ(e),tC.DASH_SEP,tC.DASH_ONDEMAND,tC.HLS,tC.HLS_ONDEMAND];case T.HLS:return[tC.HLS,tC.HLS_ONDEMAND,...iQ(e),tC.DASH_SEP,tC.DASH_ONDEMAND,tC.MPEG];case T.DASH:}return[...iQ(e),tC.DASH_SEP,tC.DASH_ONDEMAND,tC.HLS,tC.HLS_ONDEMAND,tC.MPEG]},iW=({androidPreferredFormat:e,preferCMAF:t,preferWebRTC:i})=>{let s;let a=t?[tC.DASH_LIVE_CMAF,tC.DASH_LIVE]:[tC.DASH_LIVE,tC.DASH_LIVE_CMAF],r=t?[tC.HLS_LIVE_CMAF,tC.HLS_LIVE]:[tC.HLS_LIVE,tC.HLS_LIVE_CMAF],n=[...a,...r],o=[...r,...a];if(iM)switch(e){case T.DASH:s=n;break;case T.HLS:case T.MPEG:s=o}else s=iq?o:n;return i?[tC.WEB_RTC_LIVE,...s]:[...s,tC.WEB_RTC_LIVE]},iJ=e=>e?[tC.HLS_LIVE,tC.HLS_LIVE_CMAF,tC.DASH_LIVE_CMAF]:[tC.DASH_WEBM,tC.DASH_WEBM_AV1,tC.DASH_SEP,tC.DASH_ONDEMAND,tC.HLS,tC.HLS_ONDEMAND,tC.MPEG];var iX=e=>new E.Observable(t=>{let i=new E.Subscription,s=e.desiredPlaybackState$.stateChangeStarted$.pipe((0,E.map)(({from:e,to:t})=>`${e}-${t}`)),a=e.desiredPlaybackState$.stateChangeEnded$,r=e.providerChanged$.pipe((0,E.map)(({type:e})=>void 0!==e)),n=new E.Subject,o=0,l="unknown";return i.add(s.subscribe(t=>{o&&window.clearTimeout(o),l=t,o=window.setTimeout(()=>n.next(t),e.maxTransitionInterval)})),i.add(a.subscribe(()=>{window.clearTimeout(o),l="unknown",o=0})),i.add(r.subscribe(t=>{o&&(window.clearTimeout(o),o=0,t&&(o=window.setTimeout(()=>n.next(l),e.maxTransitionInterval)))})),i.add(n.subscribe(t)),()=>{window.clearTimeout(o),i.unsubscribe()}});let iK={chunkDuration:5e3,maxParallelRequests:5};class iZ{current$=new E.ValueSubject({type:void 0});providerError$=new E.Subject;noAvailableProvidersError$=new E.Subject;providerOutput={position$:new E.ValueSubject(0),duration$:new E.ValueSubject(1/0),volume$:new E.ValueSubject({muted:!1,volume:1}),currentVideoTrack$:new E.ValueSubject(void 0),availableVideoTracks$:new E.ValueSubject([]),availableAudioTracks$:new E.ValueSubject([]),isAudioAvailable$:new E.ValueSubject(!0),autoVideoTrackLimitingAvailable$:new E.ValueSubject(!1),autoVideoTrackLimits$:new E.ValueSubject(void 0),currentBuffer$:new E.ValueSubject(void 0),isBuffering$:new E.ValueSubject(!0),error$:new E.Subject,warning$:new E.Subject,willSeekEvent$:new E.Subject,seekedEvent$:new E.Subject,loopedEvent$:new E.Subject,endedEvent$:new E.Subject,firstBytesEvent$:new E.Subject,firstFrameEvent$:new E.Subject,canplay$:new E.Subject,isLive$:new E.ValueSubject(void 0),isLowLatency$:new E.ValueSubject(!1),canChangePlaybackSpeed$:new E.ValueSubject(!0),liveTime$:new E.ValueSubject(void 0),liveBufferTime$:new E.ValueSubject(void 0),availableTextTracks$:new E.ValueSubject([]),currentTextTrack$:new E.ValueSubject(void 0),hostname$:new E.ValueSubject(void 0),httpConnectionType$:new E.ValueSubject(void 0),httpConnectionReused$:new E.ValueSubject(void 0),inPiP$:new E.ValueSubject(!1),inFullscreen$:new E.ValueSubject(!1),element$:new E.ValueSubject(void 0),availableSources$:new E.ValueSubject(void 0),is3DVideo$:new E.ValueSubject(!1)};subscription=new E.Subscription;screenFormatsIterator;chromecastFormatsIterator;log;params;failoverIndex;constructor(e){this.params=e,this.log=this.params.dependencies.logger.createComponentLog("ProviderContainer");let t=iG([...iW(this.params.tuning),...iz(this.params.tuning)],this.params.tuning.useHlsJs,this.params.tuning.useManagedMediaSource).filter(t=>(0,E.isNonNullable)(e.sources[t])),{forceFormat:i,formatsToAvoid:s}=this.params.tuning,a=[];a=i?[i]:s.length?[...t.filter(e=>!s.includes(e)),...t.filter(e=>s.includes(e))]:t,this.log({message:`Selected formats: ${a.join(" > ")}`}),this.screenFormatsIterator=new iI(a);let r=[...iJ(!0),...iJ(!1)];this.chromecastFormatsIterator=new iI(r.filter(t=>(0,E.isNonNullable)(e.sources[t]))),this.providerOutput.availableSources$.next(e.sources)}init(){this.subscription.add(this.initProviderErrorHandling()),this.subscription.add(this.params.dependencies.chromecastInitializer.connection$.subscribe(()=>{this.reinitProvider()}))}destroy(){this.destroyProvider(),this.current$.next({type:void 0}),this.subscription.unsubscribe()}initProvider(){let e;let t=this.chooseDestination(),i=this.chooseFormat(t);if((0,E.isNullable)(i)){this.handleNoFormatsError(t);return}try{e=this.createProvider(t,i)}catch(e){this.providerError$.next({id:"ProviderNotConstructed",category:E.ErrorCategory.WTF,message:"Failed to create provider",thrown:e})}e?this.current$.next({type:i,provider:e,destination:t}):this.current$.next({type:void 0})}reinitProvider(){this.destroyProvider(),this.initProvider()}switchToNextProvider(e){this.destroyProvider(),this.failoverIndex=void 0,this.skipFormat(e),this.initProvider()}destroyProvider(){let e=this.current$.getValue().provider;if(!e)return;this.log({message:"destroyProvider"});let t=1e3*this.providerOutput.position$.getValue(),i=this.params.desiredState.seekState.getState(),s=i.state!==tN.None;if(this.params.desiredState.seekState.setState({state:tN.Requested,position:s?i.position:t,forcePrecise:!!s&&i.forcePrecise}),e.scene3D){let t=e.scene3D.getCameraRotation();this.params.desiredState.cameraOrientation.setState({x:t.x,y:t.y})}e.destroy();let a=this.providerOutput.isBuffering$;a.getValue()||a.next(!0)}createProvider(e,t){switch(this.log({message:`createProvider: ${e}:${t}`}),e){case tx.SCREEN:return this.createScreenProvider(t);case tx.CHROMECAST:return this.createChromecastProvider(t);default:return(0,E.assertNever)(e)}}createScreenProvider(e){let{sources:t,container:i,desiredState:s}=this.params,a=this.providerOutput,r={container:i,source:null,desiredState:s,output:a,dependencies:this.params.dependencies,tuning:this.params.tuning};switch(e){case tC.DASH_SEP:case tC.DASH_WEBM:case tC.DASH_WEBM_AV1:case tC.DASH_ONDEMAND:{let i=this.applyFailoverHost(t[e]),s=this.applyFailoverHost(t[tC.HLS_ONDEMAND]||t[tC.HLS]);return(0,E.assertNonNullable)(i),new im({...r,source:i,sourceHls:s})}case tC.DASH_LIVE_CMAF:{let i=this.applyFailoverHost(t[e]);return(0,E.assertNonNullable)(i),new ig({...r,source:i})}case tC.HLS:case tC.HLS_ONDEMAND:{let i=this.applyFailoverHost(t[e]);return(0,E.assertNonNullable)(i),iq||!this.params.tuning.useHlsJs?new iL({...r,source:i}):new iv({...r,source:i})}case tC.HLS_LIVE:case tC.HLS_LIVE_CMAF:{let i=this.applyFailoverHost(t[e]);return(0,E.assertNonNullable)(i),new iP({...r,source:i,config:{maxPausedTime:this.params.tuning.live.maxPausedTime},format:e})}case tC.MPEG:{let i=this.applyFailoverHost(t[e]);return(0,E.assertNonNullable)(i),new iC({...r,source:i})}case tC.DASH_LIVE:{let i=this.applyFailoverHost(t[e]);return(0,E.assertNonNullable)(i),new eE({...r,source:i,config:{...iK,maxPausedTime:this.params.tuning.live.maxPausedTime}})}case tC.WEB_RTC_LIVE:{let r=this.applyFailoverHost(t[e]);return(0,E.assertNonNullable)(r),new iN({container:i,source:r,desiredState:s,output:a,dependencies:this.params.dependencies,tuning:this.params.tuning})}case tC.DASH_LIVE_WEBM:throw Error("DASH_LIVE_WEBM is no longer supported");default:return(0,E.assertNever)(e)}}createChromecastProvider(e){let{sources:t,container:i,desiredState:s,meta:a}=this.params,r=this.providerOutput,n=this.params.dependencies.chromecastInitializer.connection$.getValue();return(0,E.assertNonNullable)(n),new D({connection:n,meta:a,container:i,source:t,format:e,desiredState:s,output:r,dependencies:this.params.dependencies,tuning:this.params.tuning})}chooseDestination(){return this.params.dependencies.chromecastInitializer.connection$.getValue()?tx.CHROMECAST:tx.SCREEN}chooseFormat(e){switch(e){case tx.SCREEN:return this.screenFormatsIterator.isCompleted()?void 0:this.screenFormatsIterator.getValue();case tx.CHROMECAST:return this.chromecastFormatsIterator.isCompleted()?void 0:this.chromecastFormatsIterator.getValue();default:return(0,E.assertNever)(e)}}skipFormat(e){switch(e){case tx.SCREEN:return this.screenFormatsIterator.next();case tx.CHROMECAST:return this.chromecastFormatsIterator.next();default:return(0,E.assertNever)(e)}}handleNoFormatsError(e){switch(e){case tx.SCREEN:this.noAvailableProvidersError$.next(this.params.tuning.forceFormat),this.current$.next({type:void 0});return;case tx.CHROMECAST:this.params.dependencies.chromecastInitializer.disconnect();return;default:return(0,E.assertNever)(e)}}applyFailoverHost(e){if(void 0===this.failoverIndex)return e;let t=this.params.failoverHosts[this.failoverIndex];if(!t)return e;let i=e=>{let i=new URL(e);return i.host=t,i.toString()};if(void 0===e)return e;if("type"in e){if("raw"===e.type)return e;if("url"===e.type)return{...e,url:i(e.url)}}return Object.fromEntries(Object.entries(e).map(([e,t])=>[e,i(t)]))}initProviderErrorHandling(){let e=new E.Subscription,t=!1,i=0;return e.add((0,E.merge)(this.providerOutput.error$,iX({desiredPlaybackState$:this.params.desiredState.playbackState,maxTransitionInterval:this.params.tuning.maxPlaybackTransitionInterval,position$:this.providerOutput.position$,providerChanged$:this.current$}).pipe((0,E.map)(e=>({id:`ProviderHangup:${e}`,category:E.ErrorCategory.WTF,message:`A ${e} transition failed to complete within reasonable time`})))).subscribe(this.providerError$)),e.add(this.current$.subscribe(()=>{t=!1;let i=this.params.desiredState.playbackState.transitionEnded$.pipe((0,E.filter)(({to:e})=>e===tL.PLAYING),(0,E.once)()).subscribe(()=>t=!0);e.add(i)})),e.add(this.providerError$.subscribe(e=>{let s=this.current$.getValue().destination;if(s===tx.CHROMECAST)this.destroyProvider(),this.params.dependencies.chromecastInitializer.stopMedia().then(()=>this.switchToNextProvider(tx.SCREEN),()=>this.params.dependencies.chromecastInitializer.disconnect());else{let a=e.category===E.ErrorCategory.NETWORK,r=this.params.failoverHosts.length>0&&(void 0===this.failoverIndex||this.failoverIndex<this.params.failoverHosts.length-1),n=i<this.params.tuning.providerErrorLimit;r&&(a&&t||!n)?(this.failoverIndex=void 0===this.failoverIndex?0:this.failoverIndex+1,this.reinitProvider()):n?(i++,this.reinitProvider()):this.switchToNextProvider(s??tx.SCREEN)}})),e}}let i0="one_video_throughput",i1="one_video_rtt",i3=window.navigator.connection,i2=()=>{let e=i3?.downlink;if((0,E.isNonNullable)(e)&&10!==e)return 1e3*e},i4=()=>{let e=i3?.rtt;if((0,E.isNonNullable)(e)&&3e3!==e)return e},i6=(e,t,i)=>{let s=8*i;return s/(s/e+t)};class i5{throughput;rtt;subscription=new E.Subscription;tuningConfig;concurrentDownloads=new Set;throughput$;rtt$;rttAdjustedThroughput$;constructor(e){this.tuningConfig=e;let t=i5.load(i0)||(e.useBrowserEstimation?i2():void 0)||5e3,i=i5.load(i1)??(e.useBrowserEstimation?i4():void 0)??0;if(this.throughput$=new E.ValueSubject(t),this.rtt$=new E.ValueSubject(i),this.rttAdjustedThroughput$=new E.ValueSubject(i6(t,i,e.rttPenaltyRequestSize)),this.throughput=t7.getSmoothedValue(t,-1,e),this.rtt=t7.getSmoothedValue(i,1,e),e.useBrowserEstimation){let e=()=>{let e=i2();e&&this.throughput.next(e);let t=i4();(0,E.isNonNullable)(t)&&this.rtt.next(t)};i3&&"onchange"in i3&&this.subscription.add((0,E.fromEvent)(i3,"change").subscribe(e)),e()}this.subscription.add(this.throughput.smoothed$.subscribe(e=>{(0,E.safeStorage).set(i0,e.toFixed(0))})),this.subscription.add(this.rtt.smoothed$.subscribe(e=>{(0,E.safeStorage).set(i1,e.toFixed(0))})),this.subscription.add(this.throughput.debounced$.subscribe(this.throughput$)),this.subscription.add(this.rtt.debounced$.subscribe(this.rtt$)),this.subscription.add((0,E.combine)({throughput:this.throughput.smoothed$,rtt:this.rtt.smoothed$}).pipe((0,E.map)(({throughput:t,rtt:i})=>i6(t,i,e.rttPenaltyRequestSize)),(0,E.filter)(t=>{let i=this.rttAdjustedThroughput$.getValue()||0;return Math.abs(t-i)/i>=e.changeThreshold})).subscribe(this.rttAdjustedThroughput$))}destroy(){this.concurrentDownloads.clear(),this.subscription.unsubscribe()}trackXHR(e){let t=0,i=(0,E.now)(),s=new E.Subscription;switch(this.subscription.add(s),this.concurrentDownloads.add(e),e.readyState){case 4:break;case 3:case 2:s.add((0,E.fromEvent)(e,"progress").pipe((0,E.once)()).subscribe(e=>{t=e.loaded,i=(0,E.now)()}));break;case 1:case 0:s.add((0,E.fromEvent)(e,"loadstart").subscribe(()=>{t=0,i=(0,E.now)()}))}s.add((0,E.fromEvent)(e,"loadend").subscribe(a=>{if(200===e.status){let e=a.loaded,s=(0,E.now)(),r=e-t,n=s-i;this.addRawSpeed(r,n,1)}this.concurrentDownloads.delete(e),s.unsubscribe()}))}trackStream(e,t=!1){let i=e.getReader();if(!i){e.cancel("Could not get reader");return}let s=0,a=(0,E.now)(),r=0,n=(0,E.now)(),o=t=>{this.concurrentDownloads.delete(e),i.releaseLock(),e.cancel(`Throughput Estimator error: ${t}`).catch(()=>{})},l=async({done:u,value:h})=>{if(u)t||this.addRawSpeed(s,(0,E.now)()-a,1),this.concurrentDownloads.delete(e);else if(h){if(t){if((0,E.now)()-n<this.tuningConfig.lowLatency.continuesByteSequenceInterval)r+=h.byteLength;else{let e=n-a;e&&this.addRawSpeed(r,e,1,t),r=h.byteLength,a=(0,E.now)()}n=(0,E.now)()}else s+=h.byteLength,(r+=h.byteLength)>=this.tuningConfig.streamMinSampleSize&&(0,E.now)()-n>=this.tuningConfig.streamMinSampleTime&&(this.addRawSpeed(r,(0,E.now)()-n,this.concurrentDownloads.size),r=0,n=(0,E.now)());await i?.read().then(l,o)}};this.concurrentDownloads.add(e),i?.read().then(l,o)}addRawSpeed(e,t,i=1,s=!1){if(i5.sanityCheck(e,t,s)){let s=8*e/t;this.throughput.next(s*i)}}addRawThroughput(e){this.throughput.next(e)}addRawRtt(e){this.rtt.next(e)}static sanityCheck(e,t,i=!1){let s=8*e/t;return!(!s||!isFinite(s)||s>1e6||s<30||i&&e<1e4||!i&&e<10240||!i&&t<=20)}static load(e){let t=(0,E.safeStorage).get(e);if((0,E.isNonNullable)(t))return parseInt(t,10)??void 0}}let i8={configName:["core"],throughputEstimator:{type:"EmaAndMa",emaAlphaSlow:.2,emaAlphaFast:.7,emaAlpha:.45,basisTrendChangeCount:10,changeThreshold:.05,useBrowserEstimation:!0,rttPenaltyRequestSize:1048576,streamMinSampleSize:10240,streamMinSampleTime:300,deviationDepth:20,deviationFactor:.5,lowLatency:{continuesByteSequenceInterval:10}},autoTrackSelection:{bitrateFactorAtEmptyBuffer:1.8,bitrateFactorAtFullBuffer:1.2,usePixelRatio:!0,limitByContainer:!0,containerSizeFactor:2,lazyQualitySwitch:!0,minBufferToSwitchUp:.4,considerPlaybackRate:!1,trackCooldown:3e3,backgroundVideoQualityLimit:E.VideoQuality.Q_4320P,activeVideoAreaThreshold:.1},droppedFramesChecker:{enabled:!1,percentLimit:.1,checkTime:1e3,countLimit:3,tickCountAfterQualityChange:5,qualityUpWaitingTime:5e3,minQualityBanLimit:E.VideoQuality.Q_480P},dash:{forwardBufferTarget:6e4,forwardBufferTargetAuto:6e4,forwardBufferTargetManual:5*6e4,forwardBufferTargetPreload:5e3,maxSegmentDurationLeftToSelectNextSegment:3e3,minSafeBufferThreshold:.5,bufferPruningSafeZone:1e3,segmentRequestSize:1048576,representationSwitchForwardBufferGap:3e3,enableSubSegmentBufferFeeding:!0,segmentTimelineTolerance:100,useFetchPriorityHints:!0},dashCmafLive:{maxActiveLiveOffset:1e4,normalizedTargetMinBufferSize:6e4,normalizedLiveMinBufferSize:5e3,normalizedActualBufferOffset:1e4,offsetCalculationError:3e3,lowLatency:{maxTargetOffset:3e3,maxTargetOffsetDeviation:500,playbackCatchupSpeedup:.05,isActive:!1,delayEstimator:{emaAlpha:.45,changeThreshold:.05,deviationDepth:20,deviationFactor:.5,extremumInterval:5}}},live:{minBuffer:3e3,minBufferSegments:3,lowLatencyMinBuffer:1e3,lowLatencyMinBufferSegments:1,isLiveCatchUpMode:!1,lowLatencyActiveLiveDelay:3e3,activeLiveDelay:5e3,maxPausedTime:5e3},downloadBackoff:{bufferThreshold:100,start:100,factor:2,max:3e3,random:.1},enableWakeLock:!0,enableTelemetryAtStart:!1,forceFormat:void 0,formatsToAvoid:[],disableChromecast:!1,chromecastReceiverId:void 0,useWebmBigRequest:!1,webmCodec:y.VP9,androidPreferredFormat:T.MPEG,preferCMAF:!1,preferWebRTC:!1,bigRequestMinInitSize:51200,bigRequestMinDataSize:1048576,stripRangeHeader:!0,flushShortLoopedBuffers:!0,insufficientBufferRuleMargin:1e4,dashSeekInSegmentDurationThreshold:18e4,dashSeekInSegmentAlwaysSeekDelta:1e4,dashMaxWaitingDuration:5e3,endGapTolerance:300,stallIgnoreThreshold:33,gapWatchdogInterval:50,requestQuick:!1,useHlsJs:!0,useDashAbortPartiallyFedSegment:!1,useNativeHLSTextTracks:!1,useManagedMediaSource:!1,isAudioDisabled:!1,autoplayOnlyInActiveTab:!0,dynamicImportTimeout:5e3,maxPlaybackTransitionInterval:2e4,providerErrorLimit:3,manifestRetryInterval:300,manifestRetryMaxInterval:1e4,manifestRetryMaxCount:10,webrtc:{connectionRetryMaxNumber:3},spherical:{enabled:!1,fov:{x:135,y:76},rotationSpeed:45,maxYawAngle:175,rotationSpeedCorrection:10,degreeToPixelCorrection:5,speedFadeTime:2e3,speedFadeThreshold:50}},i7=e=>({...(0,E.fillWithDefault)(e,i8),configName:[...e.configName??[],...i8.configName]});var i9=({seekState:e,position$:t})=>(0,E.merge)(e.stateChangeEnded$.pipe((0,E.map)(({to:e})=>e.state===tN.None?void 0:(e.position??NaN)/1e3),(0,E.filter)(E.isNonNullable)),t.pipe((0,E.filter)(()=>e.getState().state===tN.None))),se=e=>{let t="string"==typeof e.container?document.getElementById(e.container):e.container;return(0,E.assertNonNullable)(t,`Wrong container or containerId {${e.container}}`),t};let st=(e,t,i,s)=>{void 0!==e&&void 0===t.getState()&&void 0===t.getPrevState()&&i?.getValue().length===0?i.pipe((0,E.filter)(e=>e.length>0),(0,E.once)()).subscribe(i=>{i.find(s)&&t.startTransitionTo(e)}):(void 0===e||i?.getValue().find(s))&&t.startTransitionTo(e)};class si{subscription=new E.Subscription;domContainer;providerContainer;chromecastInitializer;logger=new E.Logger;abrLogger=this.logger.createComponentLog("ABR");config;tuning;throughputEstimator;isPlaybackStarted=!1;initedAt;hasLiveOffsetByPaused=new E.ValueSubject(!1);hasLiveOffsetByPausedTimer=0;desiredState={playbackState:new x(tL.STOPPED),seekState:new x({state:tN.None}),volume:new x({volume:1,muted:!1}),videoTrack:new x(void 0),autoVideoTrackSwitching:new x(!0),autoVideoTrackLimits:new x({}),isLooped:new x(!1),playbackRate:new x(1),externalTextTracks:new x([]),internalTextTracks:new x([]),currentTextTrack:new x(void 0),textTrackCuesSettings:new x({}),cameraOrientation:new x({x:0,y:0})};info={playbackState$:new E.ValueSubject(tL.STOPPED),position$:new E.ValueSubject(0),duration$:new E.ValueSubject(1/0),muted$:new E.ValueSubject(!1),volume$:new E.ValueSubject(1),availableQualities$:new E.ValueSubject([]),availableQualitiesFps$:new E.ValueSubject({}),availableAudioTracks$:new E.ValueSubject([]),isAudioAvailable$:new E.ValueSubject(!0),currentQuality$:new E.ValueSubject(void 0),isAutoQualityEnabled$:new E.ValueSubject(!0),autoQualityLimitingAvailable$:new E.ValueSubject(!1),autoQualityLimits$:new E.ValueSubject({}),currentPlaybackRate$:new E.ValueSubject(1),currentBuffer$:new E.ValueSubject({start:0,end:0}),isBuffering$:new E.ValueSubject(!0),isStalled$:new E.ValueSubject(!1),isEnded$:new E.ValueSubject(!1),isLooped$:new E.ValueSubject(!1),isLive$:new E.ValueSubject(void 0),canChangePlaybackSpeed$:new E.ValueSubject(void 0),atLiveEdge$:new E.ValueSubject(void 0),atLiveDurationEdge$:new E.ValueSubject(void 0),liveTime$:new E.ValueSubject(void 0),liveBufferTime$:new E.ValueSubject(void 0),currentFormat$:new E.ValueSubject(void 0),availableTextTracks$:new E.ValueSubject([]),currentTextTrack$:new E.ValueSubject(void 0),throughputEstimation$:new E.ValueSubject(void 0),rttEstimation$:new E.ValueSubject(void 0),videoBitrate$:new E.ValueSubject(void 0),hostname$:new E.ValueSubject(void 0),httpConnectionType$:new E.ValueSubject(void 0),httpConnectionReused$:new E.ValueSubject(void 0),surface$:new E.ValueSubject(tI.NONE),chromecastState$:new E.ValueSubject(tR.NOT_AVAILABLE),chromecastDeviceName$:new E.ValueSubject(void 0),intrinsicVideoSize$:new E.ValueSubject(void 0),availableSources$:new E.ValueSubject(void 0),is3DVideo$:new E.ValueSubject(!1)};events={inited$:new E.Subject,ready$:new E.Subject,started$:new E.Subject,playing$:new E.Subject,paused$:new E.Subject,stopped$:new E.Subject,willStart$:new E.Subject,willResume$:new E.Subject,willPause$:new E.Subject,willStop$:new E.Subject,willDestruct$:new E.Subject,watchCoverageRecord$:new E.Subject,watchCoverageLive$:new E.Subject,managedError$:new E.Subject,fatalError$:new E.Subject,ended$:new E.Subject,looped$:new E.Subject,seeked$:new E.Subject,willSeek$:new E.Subject,firstBytes$:new E.Subject,firstFrame$:new E.Subject,canplay$:new E.Subject,log$:new E.Subject};experimental={element$:new E.ValueSubject(void 0),tuningConfigName$:new E.ValueSubject([]),enableDebugTelemetry$:new E.ValueSubject(!1),dumpTelemetry:es};constructor(e={configName:[]}){if(this.initLogs(),this.tuning=i7(e),this.experimental.tuningConfigName$.next(this.tuning.configName),this.chromecastInitializer=new $({receiverApplicationId:e.chromecastReceiverId,isDisabled:e.disableChromecast,dependencies:{logger:this.logger}}),this.throughputEstimator=new i5(this.tuning.throughputEstimator),this.initChromecastSubscription(),this.initDesiredStateSubscriptions(),Proxy&&Reflect)return new Proxy(this,{get:(e,t,i)=>{let s=Reflect.get(e,t,i);return"function"!=typeof s?s:(...i)=>{try{return s.apply(e,i)}catch(r){let e=i.map(e=>JSON.stringify(e,(e,t)=>{let i=typeof t;return["number","string","boolean"].includes(i)?t:null===t?null:`<${i}>`})),s=`Player.${String(t)}`,a=`Exception calling ${s} (${e.join(", ")})`;throw this.events.fatalError$.next({id:s,category:E.ErrorCategory.WTF,message:a,thrown:r}),r}}}})}initVideo(e){return this.config=e,this.domContainer=se(e),this.chromecastInitializer.contentId=e.meta?.videoId,this.providerContainer=new iZ({sources:e.sources,meta:e.meta??{},failoverHosts:e.failoverHosts??[],container:this.domContainer,desiredState:this.desiredState,dependencies:{throughputEstimator:this.throughputEstimator,chromecastInitializer:this.chromecastInitializer,logger:this.logger,abrLogger:this.abrLogger},tuning:this.tuning}),this.initProviderContainerSubscription(this.providerContainer),this.initStartingVideoTrack(this.providerContainer),this.providerContainer.init(),this.setMuted(this.tuning.isAudioDisabled),this.initDebugTelemetry(),this.initWakeLock(),this}destroy(){window.clearTimeout(this.hasLiveOffsetByPausedTimer),this.events.willDestruct$.next(),this.stop(),this.providerContainer?.destroy(),this.throughputEstimator.destroy(),this.chromecastInitializer.destroy(),this.subscription.unsubscribe()}prepare(){let e=this.desiredState.playbackState;return e.getState()===tL.STOPPED&&e.startTransitionTo(tL.READY),this}play(){let e=()=>{let e=this.desiredState.playbackState;e.getState()!==tL.PLAYING&&e.startTransitionTo(tL.PLAYING)};return document.hidden&&this.tuning.autoplayOnlyInActiveTab&&!id()?(0,E.fromEvent)(document,"visibilitychange").pipe((0,E.once)()).subscribe(e):e(),this}pause(){let e=this.desiredState.playbackState;return e.getState()!==tL.PAUSED&&e.startTransitionTo(tL.PAUSED),this}stop(){let e=this.desiredState.playbackState;return e.getState()!==tL.STOPPED&&e.startTransitionTo(tL.STOPPED),this}seekTime(e,t=!0){let i=this.info.duration$.getValue(),s=this.info.isLive$.getValue();return e>=i&&!s&&(e=i-.1),this.events.willSeek$.next({from:this.getExactTime(),to:e}),this.desiredState.seekState.setState({state:tN.Requested,position:1e3*e,forcePrecise:t}),this}seekPercent(e){let t=this.info.duration$.getValue();return isFinite(t)&&this.seekTime(Math.abs(t)*e,!1),this}setVolume(e){let t=this.tuning.isAudioDisabled||this.desiredState.volume.getState().muted;return this.chromecastInitializer.castState$.getValue()===tR.CONNECTED?this.chromecastInitializer.setVolume(e):this.desiredState.volume.startTransitionTo({volume:e,muted:t}),this}setMuted(e){let t=this.tuning.isAudioDisabled||e;return this.chromecastInitializer.castState$.getValue()===tR.CONNECTED?this.chromecastInitializer.setMuted(t):this.desiredState.volume.startTransitionTo({volume:this.desiredState.volume.getState().volume,muted:t}),this}setQuality(e){(0,E.assertNonNullable)(this.providerContainer);let t=this.providerContainer.providerOutput.availableVideoTracks$.getValue();return void 0===this.desiredState.videoTrack.getState()&&void 0===this.desiredState.videoTrack.getPrevState()&&0===t.length?this.providerContainer.providerOutput.availableVideoTracks$.pipe((0,E.filter)(e=>e.length>0),(0,E.once)()).subscribe(t=>{this.setVideoTrackIdByQuality(t,e)}):t.length>0&&this.setVideoTrackIdByQuality(t,e),this}setAutoQuality(e){return this.desiredState.autoVideoTrackSwitching.startTransitionTo(e),this}setAutoQualityLimits(e){return this.desiredState.autoVideoTrackLimits.startTransitionTo(e),this}setPlaybackRate(e){(0,E.assertNonNullable)(this.providerContainer);let t=this.providerContainer?.providerOutput.element$.getValue();return t&&(this.desiredState.playbackRate.setState(e),t.playbackRate=e),this}setExternalTextTracks(e){return this.desiredState.externalTextTracks.startTransitionTo(e.map(e=>({type:"external",...e}))),this}selectTextTrack(e){return st(e,this.desiredState.currentTextTrack,this.providerContainer?.providerOutput.availableTextTracks$,t=>t.id===e),this}setTextTrackCueSettings(e){return this.desiredState.textTrackCuesSettings.startTransitionTo(e),this}setLooped(e){return this.desiredState.isLooped.startTransitionTo(e),this}toggleChromecast(){this.chromecastInitializer.toggleConnection()}startCameraManualRotation(e,t){let i=this.getScene3D();return i&&i.startCameraManualRotation(e,t),this}stopCameraManualRotation(e=!1){let t=this.getScene3D();return t&&t.stopCameraManualRotation(e),this}moveCameraFocusPX(e,t){let i=this.getScene3D();if(i){let s=i.getCameraRotation(),a=i.pixelToDegree({x:e,y:t});this.desiredState.cameraOrientation.setState({x:s.x+a.x,y:s.y+a.y})}return this}holdCamera(){let e=this.getScene3D();return e&&e.holdCamera(),this}releaseCamera(){let e=this.getScene3D();return e&&e.releaseCamera(),this}getExactTime(){if(!this.providerContainer)return 0;let e=this.providerContainer.providerOutput.element$.getValue();if((0,E.isNullable)(e))return this.info.position$.getValue();let t=this.desiredState.seekState.getState(),i=t.state===tN.None?void 0:t.position;return(0,E.isNonNullable)(i)?i/1e3:e.currentTime}getAllLogs(){return this.logger.getAllLogs()}getScene3D(){let e=this.providerContainer?.current$.getValue();if(e?.provider?.scene3D)return e.provider.scene3D}setIntrinsicVideoSize(...e){let t={width:e.reduce((e,{width:t})=>e||t||0,0),height:e.reduce((e,{height:t})=>e||t||0,0)};t.width&&t.height&&this.info.intrinsicVideoSize$.next({width:t.width,height:t.height})}initDesiredStateSubscriptions(){this.subscription.add((0,E.merge)(this.desiredState.playbackState.stateChangeStarted$,this.desiredState.playbackState.forceChanged$).pipe((0,E.map)(e=>e.to)).subscribe(this.info.playbackState$)).add(this.desiredState.isLooped.stateChangeEnded$.pipe((0,E.map)(e=>e.to)).subscribe(this.info.isLooped$)).add(this.desiredState.playbackRate.stateChangeEnded$.pipe((0,E.map)(e=>e.to)).subscribe(this.info.currentPlaybackRate$)).add(this.desiredState.autoVideoTrackSwitching.stateChangeEnded$.pipe((0,E.map)(e=>e.to)).subscribe(this.info.isAutoQualityEnabled$)).add(this.desiredState.autoVideoTrackLimits.stateChangeEnded$.pipe((0,E.map)(e=>e.to)).subscribe(this.info.autoQualityLimits$)),this.subscription.add(this.desiredState.playbackState.stateChangeStarted$.pipe((0,E.filter)(({from:e})=>e===tL.STOPPED),(0,E.once)()).subscribe(()=>{this.initedAt=(0,E.now)(),this.events.inited$.next()})).add(this.desiredState.playbackState.stateChangeEnded$.subscribe(e=>{switch(e.to){case tL.READY:this.events.ready$.next();break;case tL.PLAYING:this.isPlaybackStarted||this.events.started$.next(),this.isPlaybackStarted=!0,this.events.playing$.next();break;case tL.PAUSED:this.events.paused$.next();break;case tL.STOPPED:this.events.stopped$.next()}})).add(this.desiredState.playbackState.stateChangeStarted$.subscribe(e=>{switch(e.to){case tL.PAUSED:this.events.willPause$.next();break;case tL.PLAYING:this.isPlaybackStarted?this.events.willResume$.next():this.events.willStart$.next();break;case tL.STOPPED:this.events.willStop$.next()}}))}initProviderContainerSubscription(e){this.subscription.add(e.providerOutput.willSeekEvent$.subscribe(()=>{let e=this.desiredState.seekState.getState();e.state===tN.Requested?this.desiredState.seekState.setState({...e,state:tN.Applying}):this.events.managedError$.next({id:`WillSeekIn${e.state}`,category:E.ErrorCategory.WTF,message:"Received unexpeceted willSeek$"})})).add(e.providerOutput.seekedEvent$.subscribe(()=>{this.desiredState.seekState.getState().state===tN.Applying&&(this.desiredState.seekState.setState({state:tN.None}),this.events.seeked$.next())})).add(e.current$.pipe((0,E.map)(e=>e.type)).subscribe(this.info.currentFormat$)).add(e.current$.pipe((0,E.map)(e=>e.destination),(0,E.filterChanged)()).subscribe(()=>{this.isPlaybackStarted=!1})).add(e.providerOutput.availableVideoTracks$.pipe((0,E.map)(e=>e.map(({quality:e})=>e).sort((e,t)=>(0,E.isInvariantQuality)(e)?1:(0,E.isInvariantQuality)(t)?-1:(0,E.isHigher)(t,e)?1:-1))).subscribe(this.info.availableQualities$)).add(e.providerOutput.availableVideoTracks$.subscribe(e=>{let t={};for(let i of e)i.fps&&(t[i.quality]=i.fps);this.info.availableQualitiesFps$.next(t)})).add(e.providerOutput.availableAudioTracks$.subscribe(this.info.availableAudioTracks$)).add(e.providerOutput.isAudioAvailable$.subscribe(this.info.isAudioAvailable$)).add(e.providerOutput.currentVideoTrack$.subscribe(e=>{this.info.currentQuality$.next(e?.quality),this.info.videoBitrate$.next(e?.bitrate)})).add(e.providerOutput.hostname$.pipe((0,E.filterChanged)()).subscribe(this.info.hostname$)).add(e.providerOutput.httpConnectionType$.pipe((0,E.filterChanged)()).subscribe(this.info.httpConnectionType$)).add(e.providerOutput.httpConnectionReused$.pipe((0,E.filterChanged)()).subscribe(this.info.httpConnectionReused$)).add(e.providerOutput.currentTextTrack$.subscribe(this.info.currentTextTrack$)).add(e.providerOutput.availableTextTracks$.subscribe(this.info.availableTextTracks$)).add(e.providerOutput.autoVideoTrackLimitingAvailable$.subscribe(this.info.autoQualityLimitingAvailable$)).add(e.providerOutput.autoVideoTrackLimits$.subscribe(e=>{this.desiredState.autoVideoTrackLimits.setState(e??{})})).add(e.providerOutput.currentBuffer$.pipe((0,E.map)(e=>e?{start:e.from,end:e.to}:{start:0,end:0})).subscribe(this.info.currentBuffer$)).add(e.providerOutput.duration$.subscribe(this.info.duration$)).add(e.providerOutput.isBuffering$.subscribe(this.info.isBuffering$)).add(e.providerOutput.isLive$.subscribe(this.info.isLive$)).add(e.providerOutput.canChangePlaybackSpeed$.subscribe(this.info.canChangePlaybackSpeed$)).add(e.providerOutput.liveTime$.subscribe(this.info.liveTime$)).add(e.providerOutput.liveBufferTime$.subscribe(this.info.liveBufferTime$)).add((0,E.combine)({hasLiveOffsetByPaused:(0,E.merge)(this.desiredState.playbackState.stateChangeStarted$,this.desiredState.playbackState.forceChanged$).pipe((0,E.map)(e=>e.to),(0,E.filterChanged)(),(0,E.map)(e=>e===tL.PAUSED)),isLowLatency:e.providerOutput.isLowLatency$}).subscribe(({hasLiveOffsetByPaused:e,isLowLatency:t})=>{if(window.clearTimeout(this.hasLiveOffsetByPausedTimer),e){this.hasLiveOffsetByPausedTimer=window.setTimeout(()=>{this.hasLiveOffsetByPaused.next(!0)},this.getActiveLiveDelay(t));return}this.hasLiveOffsetByPaused.next(!1)})).add((0,E.combine)({atLiveEdge:(0,E.combine)({isLive:e.providerOutput.isLive$,isLowLatency:e.providerOutput.isLowLatency$,position:i9({seekState:this.desiredState.seekState,position$:e.providerOutput.position$})}).pipe((0,E.map)(({isLive:e,position:t,isLowLatency:i})=>{let s=this.getActiveLiveDelay(i);return e&&Math.abs(t)<s/1e3}),(0,E.filterChanged)(),(0,E.tap)(e=>e&&this.setPlaybackRate(1))),hasPausedTimeoutCase:this.hasLiveOffsetByPaused}).pipe((0,E.map)(({atLiveEdge:e,hasPausedTimeoutCase:t})=>e&&!t)).subscribe(this.info.atLiveEdge$)).add((0,E.combine)({isLive:e.providerOutput.isLive$,position:e.providerOutput.position$,duration:e.providerOutput.duration$}).pipe((0,E.map)(({isLive:e,position:t,duration:i})=>e&&(Math.abs(i)-Math.abs(t))*1e3<this.tuning.live.activeLiveDelay),(0,E.filterChanged)(),(0,E.tap)(e=>e&&this.setPlaybackRate(1))).subscribe(this.info.atLiveDurationEdge$)).add(e.providerOutput.volume$.pipe((0,E.map)(e=>e.muted),(0,E.filterChanged)()).subscribe(this.info.muted$)).add(e.providerOutput.volume$.pipe((0,E.map)(e=>e.volume),(0,E.filterChanged)()).subscribe(this.info.volume$)).add(i9({seekState:this.desiredState.seekState,position$:e.providerOutput.position$}).subscribe(this.info.position$)).add((0,E.merge)(e.providerOutput.endedEvent$.pipe((0,E.mapTo)(!0)),e.providerOutput.seekedEvent$.pipe((0,E.mapTo)(!1))).pipe((0,E.filterChanged)()).subscribe(this.info.isEnded$)).add(e.providerOutput.endedEvent$.subscribe(this.events.ended$)).add(e.providerOutput.loopedEvent$.subscribe(this.events.looped$)).add(e.providerError$.subscribe(this.events.managedError$)).add(e.noAvailableProvidersError$.pipe((0,E.map)(e=>({id:e?`No${e}`:"NoProviders",category:E.ErrorCategory.VIDEO_PIPELINE,message:e?`${e} was forced but failed or not available`:"No suitable providers or all providers failed"}))).subscribe(this.events.fatalError$)).add(e.providerOutput.element$.subscribe(this.experimental.element$)).add(e.providerOutput.firstBytesEvent$.pipe((0,E.once)(),(0,E.map)(e=>e??(0,E.now)()-this.initedAt)).subscribe(this.events.firstBytes$)).add(e.providerOutput.firstFrameEvent$.pipe((0,E.once)(),(0,E.map)(()=>(0,E.now)()-this.initedAt)).subscribe(this.events.firstFrame$)).add(e.providerOutput.canplay$.pipe((0,E.once)(),(0,E.map)(()=>(0,E.now)()-this.initedAt)).subscribe(this.events.canplay$)).add(this.throughputEstimator.throughput$.subscribe(this.info.throughputEstimation$)).add(this.throughputEstimator.rtt$.subscribe(this.info.rttEstimation$)).add(e.providerOutput.availableSources$.subscribe(this.info.availableSources$));let t=new E.ValueSubject(!1);this.subscription.add(e.providerOutput.seekedEvent$.subscribe(()=>t.next(!1))).add(e.providerOutput.willSeekEvent$.subscribe(()=>t.next(!0)));let i=new E.ValueSubject(!0);this.subscription.add(e.current$.subscribe(()=>i.next(!0))).add(this.desiredState.playbackState.stateChangeEnded$.pipe((0,E.filter)(({to:e})=>e===tL.PLAYING),(0,E.once)()).subscribe(()=>i.next(!1)));let s=0,a=(0,E.merge)(e.providerOutput.isBuffering$,t,i).pipe((0,E.map)(()=>{let s=e.providerOutput.isBuffering$.getValue(),a=t.getValue()||i.getValue();return s&&!a}),(0,E.filterChanged)());this.subscription.add(a.subscribe(e=>{e?s=window.setTimeout(()=>this.info.isStalled$.next(!0),this.tuning.stallIgnoreThreshold):(window.clearTimeout(s),this.info.isStalled$.next(!1))})),this.subscription.add((0,E.merge)(e.providerOutput.canplay$,e.providerOutput.firstFrameEvent$,e.providerOutput.firstBytesEvent$).subscribe(()=>{let t=e.providerOutput.element$.getValue();this.setIntrinsicVideoSize({width:t?.videoWidth,height:t?.videoHeight})})).add(e.providerOutput.currentVideoTrack$.subscribe(t=>{let i=e.providerOutput.element$.getValue();this.setIntrinsicVideoSize({width:t?.size?.width,height:t?.size?.height},{width:i?.videoWidth,height:i?.videoHeight})})).add(e.providerOutput.is3DVideo$.subscribe(this.info.is3DVideo$)),this.subscription.add((0,E.merge)(e.providerOutput.inPiP$,e.providerOutput.inFullscreen$,e.providerOutput.element$,this.chromecastInitializer.castState$).subscribe(()=>{let t;let i=e.providerOutput.inPiP$.getValue(),s=e.providerOutput.inFullscreen$.getValue(),a=e.providerOutput.element$.getValue();t=this.chromecastInitializer.castState$.getValue()===tR.CONNECTED?tI.SECOND_SCREEN:a?i?tI.PIP:s?tI.FULLSCREEN:tI.INLINE:tI.NONE,this.info.surface$.getValue()!==t&&this.info.surface$.next(t)}))}initChromecastSubscription(){this.subscription.add(this.chromecastInitializer.castState$.subscribe(this.info.chromecastState$)),this.subscription.add(this.chromecastInitializer.connection$.pipe((0,E.map)(e=>e?.castDevice.friendlyName)).subscribe(this.info.chromecastDeviceName$)),this.subscription.add(this.chromecastInitializer.errorEvent$.subscribe(this.events.managedError$))}initStartingVideoTrack(e){let t=new E.Subscription;this.subscription.add(t),this.subscription.add(e.current$.pipe((0,E.filterChanged)((e,t)=>e.provider===t.provider)).subscribe(()=>{t.unsubscribe(),t.add(e.providerOutput.availableVideoTracks$.pipe((0,E.filter)(e=>e.length>0),(0,E.once)()).subscribe(e=>{this.setStartingVideoTrack(e)}))}))}setStartingVideoTrack(e){let t;let i=this.desiredState.videoTrack.getState()?.quality;i&&((t=e.find(({quality:e})=>e===i))||this.setAutoQuality(!0)),t||(t=eu(e,{container:this.domContainer.getBoundingClientRect(),throughput:this.throughputEstimator.throughput$.getValue(),tuning:this.tuning.autoTrackSelection,limits:this.desiredState.autoVideoTrackLimits.getState(),playbackRate:this.info.currentPlaybackRate$.getValue(),forwardBufferHealth:0,abrLogger:this.abrLogger})),this.desiredState.videoTrack.startTransitionTo(t),this.info.currentQuality$.next(t.quality),this.info.videoBitrate$.next(t.bitrate)}initLogs(){this.subscription.add((0,E.merge)(this.desiredState.videoTrack.stateChangeStarted$.pipe((0,E.map)(e=>({transition:e,entity:"quality",type:"start"}))),this.desiredState.videoTrack.stateChangeEnded$.pipe((0,E.map)(e=>({transition:e,entity:"quality",type:"end"}))),this.desiredState.autoVideoTrackSwitching.stateChangeStarted$.pipe((0,E.map)(e=>({transition:e,entity:"autoQualityEnabled",type:"start"}))),this.desiredState.autoVideoTrackSwitching.stateChangeEnded$.pipe((0,E.map)(e=>({transition:e,entity:"autoQualityEnabled",type:"end"}))),this.desiredState.seekState.stateChangeStarted$.pipe((0,E.map)(e=>({transition:e,entity:"seekState",type:"start"}))),this.desiredState.seekState.stateChangeEnded$.pipe((0,E.map)(e=>({transition:e,entity:"seekState",type:"end"}))),this.desiredState.playbackState.stateChangeStarted$.pipe((0,E.map)(e=>({transition:e,entity:"playbackState",type:"start"}))),this.desiredState.playbackState.stateChangeEnded$.pipe((0,E.map)(e=>({transition:e,entity:"playbackState",type:"end"})))).pipe((0,E.map)(e=>({component:"desiredState",message:`[${e.entity} change] ${e.type}: ${JSON.stringify(e.transition)}`}))).subscribe(this.logger.log)),this.subscription.add(this.logger.log$.subscribe(this.events.log$))}initDebugTelemetry(){let e=this.providerContainer?.providerOutput;(0,E.assertNonNullable)(this.providerContainer),(0,E.assertNonNullable)(e),ei(),this.experimental.enableDebugTelemetry$.next(this.tuning.enableTelemetryAtStart),[this.experimental.enableDebugTelemetry$.subscribe(e=>et(e)),this.providerContainer.current$.subscribe(({type:e})=>ea("provider",e)),e.duration$.subscribe(e=>ea("duration",e)),e.availableVideoTracks$.pipe((0,E.filter)(e=>!!e.length),(0,E.once)()).subscribe(e=>ea("tracks",e)),this.events.fatalError$.subscribe(new er("fatalError")),this.events.managedError$.subscribe(new er("managedError")),e.position$.subscribe(new er("position")),e.currentVideoTrack$.pipe((0,E.map)(e=>e?.quality)).subscribe(new er("quality")),this.info.currentBuffer$.subscribe(new er("buffer")),e.isBuffering$.subscribe(new er("isBuffering"))].forEach(e=>this.subscription.add(e)),ea("codecs",iY())}initWakeLock(){let e;if(!window.navigator.wakeLock||!this.tuning.enableWakeLock)return;let t=()=>{e?.release(),e=void 0},i=async()=>{t(),e=await window.navigator.wakeLock.request("screen").catch(e=>{e instanceof DOMException&&"NotAllowedError"===e.name||this.events.managedError$.next({id:"WakeLock",category:E.ErrorCategory.DOM,message:String(e)})})};this.subscription.add((0,E.merge)((0,E.fromEvent)(document,"visibilitychange"),(0,E.fromEvent)(document,"fullscreenchange"),this.desiredState.playbackState.stateChangeEnded$).subscribe(()=>{let s="visible"===document.visibilityState,a=this.desiredState.playbackState.getState()===tL.PLAYING,r=!!e&&!e?.released;s&&a?r||i():t()})).add(this.events.willDestruct$.subscribe(t))}setVideoTrackIdByQuality(e,t){let i=e.find(e=>e.quality===t);i?this.desiredState.videoTrack.startTransitionTo(i):this.setAutoQuality(!0)}getActiveLiveDelay(e=!1){return e?this.tuning.live.lowLatencyActiveLiveDelay:this.tuning.live.activeLiveDelay}}}),i("99dzt",function(t,i){let s,a;e(t.exports,"VERSION",()=>r),e(t.exports,"Subscription",()=>n),e(t.exports,"assertNever",()=>o),e(t.exports,"checkNever",()=>l),e(t.exports,"noop",()=>u),e(t.exports,"Observable",()=>h),e(t.exports,"Subject",()=>d),e(t.exports,"Logger",()=>c),e(t.exports,"assertNonNullable",()=>p),e(t.exports,"isNonNullable",()=>m),e(t.exports,"isNullable",()=>f),e(t.exports,"assertNotEmptyArray",()=>g),e(t.exports,"addScript",()=>b),e(t.exports,"now",()=>S),e(t.exports,"abortable",()=>v),e(t.exports,"CurrentClientBrowser",()=>M),e(t.exports,"CurrentClientDevice",()=>O),e(t.exports,"getCurrentBrowser",()=>y),e(t.exports,"isIOS",()=>T),e(t.exports,"getIOSVersion",()=>E),e(t.exports,"isMacLike",()=>w),e(t.exports,"isMobile",()=>A),e(t.exports,"getExponentialDelay",()=>$),e(t.exports,"safeStorage",()=>j),e(t.exports,"detectEmbed",()=>H),e(t.exports,"VideoQuality",()=>B),e(t.exports,"isHigher",()=>Y),e(t.exports,"isHigherOrEqual",()=>G),e(t.exports,"isLower",()=>Q),e(t.exports,"isLowerOrEqual",()=>z),e(t.exports,"getHighestQuality",()=>W),e(t.exports,"videoSizeToQuality",()=>X),e(t.exports,"videoQualityToHeight",()=>K),e(t.exports,"isInvariantQuality",()=>Z),e(t.exports,"fillWithDefault",()=>ee),e(t.exports,"timeCodeToString",()=>et),e(t.exports,"debounceFn",()=>ei),e(t.exports,"cloneDeepWith",()=>es),e(t.exports,"ValueSubject",()=>ea),e(t.exports,"combine",()=>er),e(t.exports,"merge",()=>en),e(t.exports,"timeout",()=>eo),e(t.exports,"interval",()=>el),e(t.exports,"observableFrom",()=>eu),e(t.exports,"fromEvent",()=>eh),e(t.exports,"debounce",()=>ec),e(t.exports,"filter",()=>em),e(t.exports,"filterChanged",()=>eg),e(t.exports,"map",()=>ev),e(t.exports,"mapTo",()=>eT),e(t.exports,"once",()=>eE),e(t.exports,"tap",()=>ew),e(t.exports,"ErrorCategory",()=>V),e(t.exports,"VKNumericLanguage",()=>F),e(t.exports,"loadVKLangPack",()=>eR),e(t.exports,"InterfaceLanguage",()=>U);let r="1.0.34";class n{subscriptions=[];unsubscribe(){let e=this.subscriptions;this.subscriptions=[],e.forEach(e=>"function"==typeof e?e():e.unsubscribe())}add(e){return this.subscriptions.push(e),this}}let o=e=>{throw Error(`${e} is value of unexpected type`)},l=e=>{},u=()=>{};class h{constructor(e){e&&(this._subscribe=e)}subscribe(e,t){let i,s;i=t?"function"==typeof t?{next:t,error:u}:{next:e=>t.next(e),error:e=>t.error?.(e)}:{next:u,error:u};let a="function"==typeof e?{next:t=>{try{e(t)}catch(e){i.next(e)}},error:e=>i.next(e)}:{next:t=>e.next(t),error:t=>e.error?e.error(t):i.next(t)};try{s=this._subscribe(a)}catch(e){a.error?.(e)}return new n().add(()=>{switch(a.next=u,a.error=u,typeof s){case"function":s();return;case"object":s.unsubscribe();return;case"undefined":return;default:return o(s)}})}pipe(...e){return e.reduce((e,t)=>t(e),this)}_subscribe(e){}}class d extends h{keyCounter=0;subscribers=new Map;constructor(){super()}next(e){this.subscribers.forEach(t=>t.next(e))}error(e){this.subscribers.forEach(t=>t.error?.(e))}_subscribe(e){let t=this.keyCounter++;return this.subscribers.set(t,e),new n().add(()=>this.subscribers.delete(t))}}class c{log$=new d;logs=[];log=e=>{let t={...e,timestamp:Date.now()};this.logs.push(t),this.log$.next(t)};createCustomLog(e){return(...t)=>{let i;try{i=e(...t)}catch{i={message:"error in `createCustomLog`",component:"Logger"}}this.log(i)}}createComponentLog(e){return this.createCustomLog(t=>({component:e,...t}))}getAllLogs=()=>this.logs}function p(e,t='Assertion "value is not nullable" failed'){if(null==e)throw Error(t)}function m(e){return"u">typeof e&&null!==e}function f(e){return null==e}function g(e,t){if(!e?.length)throw Error(t)}let b=(e,t,i)=>new Promise((s,a)=>{let r;t.addEventListener("abort",()=>{l(),u.remove()});let n=()=>{l(),a()},o=()=>{l(),s()},l=()=>{r&&clearTimeout(r),u.removeEventListener("load",o),u.removeEventListener("error",n)};i&&(r=window.setTimeout(n,i));let u=document.createElement("script");u.addEventListener("load",o),u.addEventListener("error",n),u.src=e,document.head.appendChild(u)}),S="function"==typeof window.performance?.now?()=>window.performance.now():()=>Date.now(),v=(e,t)=>async(...i)=>{let s=t(...i),a=e.aborted,r;for(;!a&&!e.aborted;)try{let e=await s.next(r);a=e.done??!1,r=e.value}catch(e){await s.throw(e)}return r};(D=M||(M={})).Unknown="Unknown",D.Yandex="Yandex",D.Chrome="Chrome",D.Chromium="Chromium",D.Firefox="Firefox",D.Safari="Safari",D.Opera="Opera",D.Edge="Edge",D.Rest="Rest",(N=O||(O={})).Unknown="Unknown",N.Android="Android",N.iPhone="iPhone",N.iPad="iPad",N.iPod="iPod",N.RestMobile="RestMobile",N.Mac="Mac",N.Desktop="Desktop";let y=()=>{let{userAgent:e}=window.navigator,t=/yabrowser/i.test(e)?M.Yandex:void 0,i=/chrome|crios/i.test(e)?M.Chrome:void 0,s=/chromium/i.test(e)?M.Chromium:void 0,a=/firefox|fxios/i.test(e)?M.Firefox:void 0,r=/webkit|safari|khtml/i.test(e)?M.Safari:void 0,n=/opr\//i.test(e)?M.Opera:void 0,o=/edg/i.test(e)?M.Edge:void 0,l=/android/i.test(e)?O.Android:void 0,u=/iphone/i.test(e)?O.iPhone:void 0,h=/ipad/i.test(e)?O.iPad:void 0,d=/ipod/i.test(e)?O.iPod:void 0,c=/mac/i.test(e)?O.Mac:void 0,p=/webOS|BlackBerry|IEMobile|Opera Mini/i.test(e)?O.RestMobile:void 0;return{browser:t||a||n||o||i||s||r||M.Rest,device:l||u||h||d||p||c||O.Desktop}},T=(e=!1)=>{let t=[O.iPhone,O.iPad,O.iPod].includes(y().device);if(!e)return t;let{userAgent:i,maxTouchPoints:s}=window.navigator;return!!(t||/macintosh/i.test(i)&&s>0)},E=()=>{let{userAgent:e}=window.navigator,t=e.match(/Version\/(\d+(\.\d+)?)/i);if(!t)return null;let i=parseFloat(t[1]);return isNaN(i)?null:i},w=()=>[O.Mac,O.iPhone,O.iPad,O.iPod].includes(y().device),A=()=>/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(navigator.appVersion??navigator.userAgent)||navigator?.userAgentData?.mobile,$=(e,{start:t=0,factor:i=2,max:s=1/0,min:a=t,random:r=0}={})=>{let n=t;return n*=i**e*(1+(Math.random()*r*2-r)),n=Math.max(n=Math.min(n=Math.round(n),s),a)};(I=_||(_={}))[I.LOCAL_STORAGE=0]="LOCAL_STORAGE",I[I.SESSION_STORAGE=1]="SESSION_STORAGE",I[I.RUNTIME=2]="RUNTIME";let k=`vk-videoplayer-dummy-key-${Math.random()}`,P=()=>{if(void 0!==a)return a;try{localStorage.setItem(k,"test"),localStorage.removeItem(k),a=_.LOCAL_STORAGE}catch(e){if(e instanceof DOMException||e instanceof TypeError)try{sessionStorage.getItem(k),a=_.SESSION_STORAGE}catch(e){if(e instanceof DOMException||e instanceof TypeError)a=_.RUNTIME;else throw e}else throw e}return a===_.RUNTIME&&(s=new Map),a};var L,C,x,R,D,N,I,M,O,_,B,V,F,U,j=Object.freeze({__proto__:null,clear:()=>{let e=P();switch(e){case _.LOCAL_STORAGE:return localStorage.clear();case _.SESSION_STORAGE:return sessionStorage.clear();case _.RUNTIME:return s?.clear();default:o(e)}},get:e=>{let t=P();switch(t){case _.LOCAL_STORAGE:return localStorage.getItem(e)??void 0;case _.SESSION_STORAGE:return sessionStorage.getItem(e)??void 0;case _.RUNTIME:return s?.get(e);default:o(t)}},has:e=>{let t=P();switch(t){case _.LOCAL_STORAGE:return e in localStorage;case _.SESSION_STORAGE:return e in sessionStorage;case _.RUNTIME:return s?.has(e)??!1;default:return o(t),!1}},isPersistent:()=>P()===_.LOCAL_STORAGE,remove:e=>{let t=P();switch(t){case _.LOCAL_STORAGE:return localStorage.removeItem(e);case _.SESSION_STORAGE:return sessionStorage.removeItem(e);case _.RUNTIME:return void s?.delete(e);default:o(t)}},set:(e,t)=>{let i=P();switch(i){case _.LOCAL_STORAGE:try{localStorage.setItem(e,t)}catch(e){if(e instanceof DOMException)console.error(e);else throw e}break;case _.SESSION_STORAGE:try{sessionStorage.setItem(e,t)}catch(e){if(e instanceof DOMException)console.error(e);else throw e}break;case _.RUNTIME:return void s?.set(e,t);default:o(i)}}});let H=()=>{let e,t;try{e=window.self!==window.top}catch(t){t instanceof DOMException&&"SecurityError"===t.name?e=!0:(e=!1,console.error(t))}try{window.location.ancestorOrigins&&(t=window.location.ancestorOrigins[window.location.ancestorOrigins.length-1])}catch(e){console.error(e)}try{!t&&document.referrer&&(t=document.referrer)}catch(e){console.error(e)}return{isEmbed:e,host:t?new URL(t).hostname:void 0}};(L=B||(B={})).INVARIANT="Invariant quality",L.Q_144P="144p",L.Q_240P="240p",L.Q_360P="360p",L.Q_480P="480p",L.Q_720P="720p",L.Q_1080P="1080p",L.Q_1440P="1440p",L.Q_2160P="2160p",L.Q_4320P="4320p";let q={[B.Q_144P]:{width:256,height:144},[B.Q_240P]:{width:428,height:240},[B.Q_360P]:{width:640,height:360},[B.Q_480P]:{width:856,height:480},[B.Q_720P]:{width:1280,height:720},[B.Q_1080P]:{width:1920,height:1080},[B.Q_1440P]:{width:2560,height:1440},[B.Q_2160P]:{width:3840,height:2160},[B.Q_4320P]:{width:7680,height:4320}},Y=(e,t)=>q[e].height>q[t].height,G=(e,t)=>q[e].height>=q[t].height,Q=(e,t)=>q[e].height<q[t].height,z=(e,t)=>q[e].height<=q[t].height,W=e=>e.sort((e,t)=>e===t?0:e===B.INVARIANT?1:t===B.INVARIANT?-1:Q(e,t)?1:-1)[0],J=Object.keys(q).sort((e,t)=>Q(e,t)?-1:1),X=({width:e,height:t})=>{let i=Math.min(e,t),s=Math.max(e,t);return J.find(e=>{let t=q[e];return t.width>=s&&t.height>=i})},K=e=>q[e].height,Z=e=>e===B.INVARIANT,ee=(e,t)=>{let i={};for(let s of Object.keys(t)){let a=t[s],r=e[s];Array.isArray(a)&&Array.isArray(r)?i[s]=r:"object"==typeof a&&"object"==typeof r?i[s]=ee(r,a):i[s]=s in e?r:a}return i},et=e=>{let t="";return e>=3600&&(t+=Math.floor(e/3600)+"h",e%=3600),e>=60&&(t+=Math.floor(e/60)+"m",e%=60),e>0&&(t+=Math.floor(e)+"s"),t};function ei(e,t=0,i){let s,a,r,n,o,l,u=0,h=!1,d=!1,c=!0,p=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;function m(t){let i=s,r=a;return s=a=void 0,u=t,n=e.apply(r,i)}function f(e,t){return p?(o&&window.cancelAnimationFrame(o),window.requestAnimationFrame(e)):setTimeout(e,t)}function g(e){let i=e-l,s=e-u;return void 0===l||i>=t||i<0||d&&s>=r}function b(){let e=Date.now();if(g(e))return S(e);o=f(b,function(e){let i=e-l,s=e-u,a=t-i;return d?Math.min(a,r-s):a}(e))}function S(e){return o=void 0,c&&s?m(e):(s=a=void 0,n)}function v(...e){let i=Date.now(),r=g(i);if(s=e,a=this,l=i,r){if(void 0===o){var c;return u=c=l,o=f(b,t),h?m(c):n}if(d)return o=f(b,t),m(l)}return void 0===o&&(o=f(b,t)),n}return i&&(h=!!i.leading,d="maxWait"in i,r=i?.maxWait?Math.max(+i?.maxWait||0,t):r,c="trailing"in i?!!i.trailing:c),v.cancel=function(){void 0!==o&&function(e){if(p){window.cancelAnimationFrame(e);return}clearTimeout(e)}(o),u=0,s=l=a=o=void 0},v.flush=function(){return void 0===o?n:S(Date.now())},v.pending=function(){return void 0!==o},v}let es=(e,t)=>{if(null===e||"object"!=typeof e)return e;let i=Array.isArray(e)?[]:{};for(let s in e){if("function"==typeof t){let a=t(e[s],s,e,i);if(void 0!==a){i[s]=a;continue}}"object"==typeof e[s]?i[s]=es(e[s],t):i[s]=e[s]}return i};class ea extends d{value;constructor(e){super(),this.value=e}next(e){super.next(this.value=e)}error(e){super.error(this.value=e)}getValue(){return this.value}_subscribe(e){let t=super._subscribe(e);return e.next(this.value),t}}function er(e){return new h(t=>{let i={},s=Object.keys(e).length,a=e=>a=>{e in i||s--,i[e]=a,0===s&&t.next(i)};return Object.entries(e).reduce((e,[t,i])=>e.add(i.subscribe(a(t))),new n)})}function en(...e){return new h(t=>e.reduce((e,i)=>e.add(i.subscribe(t)),new n))}var eo=e=>new h(t=>{let i=window.setTimeout(()=>{try{t.next()}catch(e){if(t.error)t.error(e);else throw e}},e);return()=>window.clearTimeout(i)}),el=e=>new h(t=>{let i=window.setInterval(()=>t.next(),e);return()=>window.clearInterval(i)}),eu=e=>new h(t=>{e.forEach(e=>t.next(e))}),eh=(e,t)=>new h(i=>{let s=e=>i.next(e);return e.addEventListener(t,s),()=>e.removeEventListener(t,s)});let ed={leading:!1,trailing:!0};function ec(e,t=ed){return i=>new h(s=>i.subscribe(new ep(s,e,t)))}class ep{destination;time;config;lastValue;timeout;constructor(e,t,i){this.destination=e,this.time=t,this.config=i}next(e){this.lastValue=e,m(this.timeout)?window.clearTimeout(this.timeout):this.config.leading&&this.destination.next(e),this.timeout=window.setTimeout(()=>{if(this.config.trailing)try{this.destination.next(this.lastValue)}catch(e){if(this.destination.error)this.destination.error(e);else throw e}this.timeout=void 0},this.time)}error(e){this.destination.error?.(e)}}function em(e){return t=>new h(i=>t.subscribe(new ef(i,e)))}class ef{destination;predicate;constructor(e,t){this.destination=e,this.predicate=t}next(e){let t;try{t=this.predicate(e)}catch(e){throw this.error(e),e}t&&this.destination.next(e)}error(e){this.destination.error?.(e)}}function eg(e=(e,t)=>e===t){return t=>new h(i=>t.subscribe(new eS(i,e)))}let eb={};class eS{destination;predicate;lastValue=eb;constructor(e,t){this.destination=e,this.predicate=t}next(e){let t;try{t=this.lastValue===eb||!this.predicate(this.lastValue,e),this.lastValue=e}catch(e){throw this.error(e),e}t&&this.destination.next(e)}error(e){this.destination.error?.(e)}}function ev(e){return t=>new h(i=>t.subscribe(new ey(i,e)))}let ey=class{destination;mapper;constructor(e,t){this.destination=e,this.mapper=t}next(e){let t;try{t=this.mapper(e)}catch(e){throw this.error(e),e}this.destination.next(t)}error(e){this.destination.error?.(e)}};function eT(e){return ev(()=>e)}function eE(){return e=>new h(t=>{let i=!1,s=!1,a=e.subscribe(e=>{i||(i=!0,t.next(e)),s&&a.unsubscribe()},e=>{i=!0,t.error?.(e),s&&a.unsubscribe()});return s=!0,i&&a.unsubscribe(),a})}function ew(e){return t=>new h(i=>t.subscribe(new eA(i,e)))}class eA{destination;effect;constructor(e,t){this.destination=e,this.effect=t}next(e){try{this.effect(e)}catch(e){throw this.error(e),e}this.destination.next(e)}error(e){this.destination.error?.(e)}}(C=V||(V={})).NETWORK="network",C.VIDEO_PIPELINE="video_pipeline",C.EXTERNAL_API="external_api",C.PARSER="parser",C.DOM="dom",C.WTF="wtf";class e${constructor(){Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}addEventListener(e,t,i){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push({callback:t,options:i})}removeEventListener(e,t){if(!(e in this.listeners))return;let i=this.listeners[e];for(let e=0,s=i.length;e<s;e++)if(i[e].callback===t){i.splice(e,1);return}}dispatchEvent(e){if(!(e.type in this.listeners))return;let t=this.listeners[e.type].slice();for(let i=0,s=t.length;i<s;i++){let s=t[i];try{s.callback.call(this,e)}catch(e){Promise.resolve().then(()=>{throw e})}s.options&&s.options.once&&this.removeEventListener(e.type,s.callback)}return!e.defaultPrevented}}class ek extends e${constructor(){super(),this.listeners||e$.call(this),Object.defineProperty(this,"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(this,"onabort",{value:null,writable:!0,configurable:!0}),Object.defineProperty(this,"reason",{value:void 0,writable:!0,configurable:!0})}toString(){return"[object AbortSignal]"}dispatchEvent(e){"abort"===e.type&&(this.aborted=!0,"function"==typeof this.onabort&&this.onabort.call(this,e)),super.dispatchEvent(e)}}function eP(e){return e.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):"function"==typeof e.Request&&!e.Request.prototype.hasOwnProperty("signal")||!e.AbortController}"u">typeof Symbol&&Symbol.toStringTag&&((class{constructor(){Object.defineProperty(this,"signal",{value:new ek,writable:!0,configurable:!0})}abort(e){let t;try{t=new Event("abort")}catch{"u">typeof document?document.createEvent?(t=document.createEvent("Event")).initEvent("abort",!1,!1):(t=document.createEventObject()).type="abort":t={type:"abort",bubbles:!1,cancelable:!1}}let i=e;if(void 0===i){if(typeof document>"u")(i=Error("This operation was aborted")).name="AbortError";else try{i=new DOMException("signal is aborted without reason")}catch{(i=Error("This operation was aborted")).name="AbortError"}}this.signal.reason=i,this.signal.dispatchEvent(t)}toString(){return"[object AbortController]"}}).prototype[Symbol.toStringTag]="AbortController",ek.prototype[Symbol.toStringTag]="AbortSignal");let eL=eP({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),eC=eL?function(e){"function"==typeof e&&(e={fetch:e});let{fetch:t,Request:i=t.Request,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a=!1}=e;if(!eP({fetch:t,Request:i,AbortController:s,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a}))return{fetch:t,Request:r};let r=i;return(r&&!r.prototype.hasOwnProperty("signal")||a)&&((r=function(e,t){let s;t&&t.signal&&(s=t.signal,delete t.signal);let a=new i(e,t);return s&&Object.defineProperty(a,"signal",{writable:!1,enumerable:!1,configurable:!0,value:s}),a}).prototype=i.prototype),{fetch:(e,i)=>{let s=r&&r.prototype.isPrototypeOf(e)?e.signal:i?i.signal:void 0;if(s){let a;try{a=new DOMException("Aborted","AbortError")}catch{(a=Error("Aborted")).name="AbortError"}if(s.aborted)return Promise.reject(a);let r=new Promise((e,t)=>{s.addEventListener("abort",()=>t(a),{once:!0})});return i&&i.signal&&delete i.signal,Promise.race([r,t(e,i)])}return t(e,i)},Request:r}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,ex=eL?eC.fetch:window.fetch;eL?eC.Request:window.Request,(x=F||(F={})).Armenian="58",x.Azerbaijani="57",x.Belarusian="114",x.English="3",x.Kazakh="97",x.Portuguese="73",x.Russian="0",x.Spanish="4",x.Ukrainian="1",x.Uzbek="65",x.Vietnamese="75";let eR=async(e,t,i)=>{let s=new URL("https://vk.com/js/lang-pack.js");return s.searchParams.set("format","json"),s.searchParams.set("name",t),void 0!==e&&s.searchParams.set("lang",e),eD(await (await ex(s.toString())).json(),i)},eD=(e,t)=>Object.fromEntries(Object.entries(e.keys).map(([e,i])=>[e.substring(`${t}_`.length),eN(i)])),eN=e=>Array.isArray(e)?e[0]:e;(R=U||(U={})).RU="ru",R.EN="en"}),i("eFFZp",function(e,i){var s=t("Gr8vk");e.exports=s("jGXC2").then(()=>t("jcvJB"))}),i("Gr8vk",function(e,i){e.exports=function(e){return import(t("27Lyk").resolve(e))}}),i("27Lyk",function(t,i){e(t.exports,"register",()=>s,e=>s=e),e(t.exports,"resolve",()=>a,e=>a=e);var s,a,r=new Map;s=function(e,t){for(var i=0;i<t.length-1;i+=2)r.set(t[i],{baseUrl:e,path:t[i+1]})},a=function(e){var t=r.get(e);if(null==t)throw Error("Could not resolve bundle with id "+e);return new URL(t.path,t.baseUrl).toString()}});
//# sourceMappingURL=esnext.esm.ee85f12e.js.map

function t(t,e,i,r){Object.defineProperty(t,e,{get:i,set:r,enumerable:!0,configurable:!0})}var e=globalThis.parcelRequireb792,i=e.register;i("kuKaT",function(i,r){let n,s;t(i.exports,"INTERACTIVE_CLICK_ACTIONS",()=>o),t(i.exports,"CustomError",()=>to),t(i.exports,"EVENT_NAMES",()=>tM),t(i.exports,"Interactives",()=>ed);var a,o,l=e("99dzt"),h=e("aGTfi"),c=e("7c5RQ");function d(t,e=1){let i="0",r="0",n="0";return 4===t.length?(i="0x"+t[1]+t[1],r="0x"+t[2]+t[2],n="0x"+t[3]+t[3]):7===t.length&&(i="0x"+t[1]+t[2],r="0x"+t[3]+t[4],n="0x"+t[5]+t[6]),`rgba(${+i},${+r},${+n},${e})`}let p="SDK_NAME",u=()=>document.querySelector(".SDK_NAME-controls-container"),m={textColor:"#000",textSize:.4,textContent:"",roundCorners:0,borderWidth:0,borderColor:"#000",borderAlpha:1,backgroundColor:"#fff",backgroundAlpha:1,innerSizesDependOn:"self",angle:0},y={top:"flex-start",bottom:"flex-end",center:"center"},f={start:"flex-start",end:"flex-end",center:"center"},g={start:"left",end:"right",center:"center"},v=({target:t,props:e})=>{t.style.alignItems=y[e?.text?.gravityVertical]??y.center,t.style.justifyContent=f[e?.text?.gravityHorizontal]??f.center,t.style.textAlign=g[e?.text?.alignment]??g.start},b=({target:t,props:e,fallback:i,dependsOn:r})=>{t.style.color=e?.text?.color??i.textColor,t.style.fontSize=`calc(${r.height} * ${e?.text?.size??i.textSize})`,t.textContent=e?.text?.value??i.textContent},E=({target:t,props:e,fallback:i})=>{t.style.backgroundColor=d(e?.background?.color??i.backgroundColor,e?.background?.alpha??i.backgroundAlpha)},C=({target:t,props:e,fallback:i,dependsOn:r})=>{t.style.border=`calc(${r.height} * ${e?.shape?.border?.width??i.borderWidth}) solid ${d(e?.shape?.border?.color??i.borderColor,e?.shape?.border?.alpha??i.borderAlpha)}`,t.style.borderRadius=`calc(${r.height} * ${e?.shape?.roundCorners??i.roundCorners})`},w=({target:t,layoutParams:e,fallback:i})=>{t.style.transform=`rotate(${-e.angle}rad)`};class I{constructor(t){this.control=t}createView(t){let e=document.createElement("div");e.classList.add(`${p}-control-container-${this.control.id}`),t(e,this.control.layoutParams);let i=(this.control.layoutParams.innerSizesDependOn??m.innerSizesDependOn)==="self"?{height:e.style.height,width:e.style.width}:{height:"var(--interactive-content-height)",width:"var(--interactive-content-width)"};return{controlContainerEl:e,dependsOn:i}}setEvents(t,e){t&&this.control.events.forEach(i=>{"onclick"===i.type.trim().toLowerCase()&&t.addEventListener("click",t=>{t.stopPropagation(),e&&e({action:i.action,controlId:this.control.id,controlType:this.control.type})})})}getElement(){return document.querySelector(`.${p}-control-container-${this.control.id}`)}}let S=t=>{if("area"===t.type.trim().toLowerCase())return new x(t)};class x extends I{constructor(t){super(t)}createView({parent:t,layoutFn:e}){let{dependsOn:i,controlContainerEl:r}=super.createView(e),n=document.createElement("button");return n.classList.add(`${p}-${this.control.id}`),n.setAttribute("data-testid","int_area"),n.style.display="flex",n.style.width="100%",n.style.height="100%",n.style.cursor="pointer",n.type="button",E({target:n,props:this.control.props,fallback:{...m,backgroundColor:"transparent"}}),C({target:n,props:this.control.props,fallback:{...m,borderAlpha:0},dependsOn:i}),w({target:n,layoutParams:this.control.layoutParams,fallback:m}),r.append(n),t.append(r),this.controlEl=n,r}disable(){this.controlEl&&(this.controlEl.style.cursor="default")}enable(){this.controlEl&&(this.controlEl.style.cursor="pointer")}getElement(){return document.querySelector(`.${p}-${this.control.id}`)}}let T=t=>{if("button"===t.type.trim().toLowerCase())return new j(t)};class j extends I{constructor(t){super(t)}createView({parent:t,layoutFn:e}){let{dependsOn:i,controlContainerEl:r}=super.createView(e),n=document.createElement("button");n.type="button",n.classList.add(`${p}-${this.control.id}`),n.setAttribute("data-testid","int_bttn"),n.style.display="flex",n.style.width="100%",n.style.height="100%",n.style.cursor="pointer",n.style.fontFamily="inherit";let s=document.createElement("span");return s.style.display="inline-block",s.style.whiteSpace="pre",s.style.overflow="hidden",s.style.textOverflow="ellipsis",w({target:n,layoutParams:this.control.layoutParams,fallback:m}),E({target:n,props:this.control.props,fallback:m}),C({target:n,props:this.control.props,fallback:m,dependsOn:i}),v({target:n,props:this.control.props}),b({target:s,props:this.control.props,fallback:m,dependsOn:i}),n.append(s),r.append(n),t.append(r),this.controlEl=n,r}disable(){this.controlEl&&(this.controlEl.style.cursor="default")}enable(){this.controlEl&&(this.controlEl.style.cursor="pointer")}getElement(){return document.querySelector(`.${p}-${this.control.id}`)}}let R=t=>{if("text"===t.type.trim().toLowerCase())return new O(t)};class O extends I{constructor(t){super(t)}createView({parent:t,layoutFn:e}){let{dependsOn:i,controlContainerEl:r}=super.createView(e),n=document.createElement("div");n.classList.add(`${p}-${this.control.id}`),n.setAttribute("data-testid","int_text"),n.style.display="flex",n.style.width="100%",n.style.height="100%",n.style.fontFamily="inherit";let s=document.createElement("span");return s.style.whiteSpace="pre",w({target:n,layoutParams:this.control.layoutParams,fallback:m}),v({target:n,props:this.control.props}),b({target:s,props:this.control.props,fallback:m,dependsOn:i}),n.append(s),r.append(n),t.append(r),this.controlEl=n,r}disable(){}enable(){}getElement(){return document.querySelector(`.${p}-${this.control.id}`)}}class A{constructor(t){this.layout=t}}class L extends A{constructor(t){super(t)}setContainerLayout(t){t.style.position="relative"}setControlLayout(t,e){t.style.position="absolute",t.style.width=`calc(var(--interactive-content-width) * ${e.width})`,t.style.height=`calc(var(--interactive-content-height) * ${e.height})`,t.style.left=`calc(var(--interactive-content-width) * ${e.x} + ((var(--interactive-width) - var(--interactive-content-width)) / 2))`,t.style.top=`calc(var(--interactive-content-height) * ${e.y} + ((var(--interactive-height) - var(--interactive-content-height)) / 2))`}}class V{constructor(t){this.container=t,this.factories=new Map,this.#t()}addControlFactory(t,e){this.factories.set(t.trim().toLowerCase(),e),this.#t()}removeControlFactory(t){this.factories.delete(t.trim().toLowerCase()),this.#t()}#t(){this.controls=this.#e()}#e(){return this.container.controls?.reduce((t,e)=>{let i=e.type.trim().toLowerCase(),r=this.factories.get(i);return r?[...t,r(e)]:[...t]},[])}}let $=(t,e)=>{if("choice"===t.type.trim().toLowerCase())return new N(t,e)};class N extends V{constructor(t,e){super(t),this.rootElement=e??u(),this.layout=new L(this.container.layout),this.isRemoved=!1,this.isDisabled=!1,this.addControlFactory("button",T),this.addControlFactory("text",R),this.addControlFactory("area",S)}createView(t){let e=document.createElement("div");return e.classList.add(`${p}-${this.container.id}`),this.layout.setContainerLayout(e),this.controls.forEach(i=>{let r=i.createView({parent:e,layoutFn:this.layout.setControlLayout});i.setEvents(r,t)}),this.rootElement.append(e),this.isRemoved=!1,e}hide(){let t=this.getElement();t&&(t.style.visibility="hidden")}show(){let t=this.getElement();t&&(t.style.visibility="visible")}enable(){let t=this.getElement();t&&(this.controls.forEach(t=>t.enable()),t.style.opacity=1,this.isDisabled=!1)}disable(){let t=this.getElement();t&&(this.controls.forEach(t=>t.disable()),t.style.opacity=.4,this.isDisabled=!0)}removeView(){this.isRemoved||(this.getElement()?.remove(),this.isRemoved=!0)}getElement(){return this.rootElement.querySelector(`.${p}-${this.container.id}`)}}function P(t,e){let i;return(...r)=>{clearTimeout(i),i=setTimeout(()=>t(...r),e)}}let k=(t,e)=>Object.prototype.toString.call(t)===`[object ${e}]`,B=t=>k(t,"Object"),M=t=>k(t,"String"),_=t=>k(t,"Array"),F=t=>k(t,"Number"),D=t=>k(t,"Function"),U=t=>F(t)&&!isNaN(t),H=t=>B(t)&&0===Object.keys(t).length,z=t=>_(t)&&!t.length,W=(t,e)=>M(t)&&(e?t.trim():t).length,G=window.navigator.userAgent.toLowerCase();/mobi/i.test(G),G.indexOf("android");class q{constructor(t){this.init(t)}init({root:t,onOpenPreviewClick:e,onError:i,lang:r,visitedChapters:n=[]}){this.isHidden=!0,this.currentManifestId=void 0,this.currentChapterId=void 0,this.visitedChapterIds=new Set(n),this.onOpenPreviewClick=e,this.onError=i,this.lang=r??"ru",this.zoom=.7,this.isReady=!1,this.lastZoomInfo=void 0,this.ngEditorSize=void 0,this.ngEditor=void 0,this.graphWrapperElement=function(t){let e=document.createElement("div");return e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.height="100%",e.style.width="100%",e.style.display="none",t.append(e),e}(t),this.resizeObserver=new ResizeObserver(P(this.onResize,250)),this.resizeObserver.observe(this.graphWrapperElement)}onResize=t=>{!this.isReady||t[0].contentRect.width&&t[0].contentRect.height&&(this.lastZoomInfo&&this.ngEditor.zoomTo(this.getNextPoint()),this.ngEditorSize={width:t[0].contentRect.width,height:t[0].contentRect.height})};getNextPoint(t=this.ngEditorSize){return[-((this.lastZoomInfo.x-t.width/2)/this.lastZoomInfo.value*1),-((this.lastZoomInfo.y-t.height/2)/this.lastZoomInfo.value*1)]}handleChapterChange=t=>{if(this.isReady){if(this.isHidden||this.hide(),!t?.id){this.onError?.("Id is not found"),console.error("Id is not found");return}this.visitedChapterIds.add(t.id),this.ngEditor.selectChapter(t.id),this.ngEditor.setVisitedChapters(Array.from(this.visitedChapterIds)),this.currentChapterId=t.id,this.lastZoomInfo=void 0}};handleManifestChange=async(t,i=[])=>{if(!F(t.graph.edit.chapters[0].x)){this.isReady=!1,this.onError?.("Can't show graph"),console.error("Can't show graph");return}if(this.lastZoomInfo=void 0,!this.ngEditor){let t;try{t=await (0,l.loadVKLangPack)(this.lang,"video_interactive","videoint")}catch{console.log("Unable to load graph language pack")}let{GraphEditor:i}=await e("8Axf4");this.ngEditor=new i(this.graphWrapperElement,{mode:"read",lang:this.lang,translation:t}),this.ngEditor.on("control",({name:t,chapterId:e})=>{"openPreview"===t&&this.onOpenPreviewClick(e)}),this.ngEditor.on("zoomEnd",t=>{this.lastZoomInfo={...t}})}this.visitedChapterIds=new Set(i),t.metadata.id!==this.currentManifestId?(this.ngEditor.update(t),this.currentManifestId=t.metadata.id):this.ngEditor.setVisitedChapters(Array.from(this.visitedChapterIds)),this.isReady=!0};setVisitedChapters(t){this.visitedChapterIds=new Set([...this.visitedChapterIds,...t]),this.ngEditor.setVisitedChapters(Array.from(this.visitedChapterIds))}updateVideosInfo(t){this.ngEditor.updateVideosInfo(t)}show(){this.ngEditor&&this.isReady&&(this.graphWrapperElement.style.display="block",this.lastZoomInfo||this.ngEditor.focusChapter(this.currentChapterId),this.isHidden=!1)}hide(){this.graphWrapperElement.style.display="none",this.isHidden=!0}destroy(){this.hide(),this.resizeObserver.disconnect(),this.ngEditor?.setVisitedChapters([]),this.onOpenPreviewClick=void 0,this.ngEditor?.dispose(),this.graphWrapperElement.remove(),this.isReady=!1}}let Q=(t="",e="")=>{t=t.split("."),e=e.split(".");let i=0;for(let r=0;r<Math.max(t.length,e.length)&&!i;r++)i=t[r]>e[r]?1:t[r]<e[r]?-1:0;return i},Z={default:"setNextBranch",random:"setRandomBranch",weightlessRandom:"setWeightlessRandomBranch",max:"setMaxWeightBranch",min:"setMinWeightBranch"},K={type:"onSuspense",action:{type:"continuePlayback",args:{shouldOpenNow:!0,isDetachContainer:!0}}},Y=(t=[])=>({edit:{chapters:t},view:{}}),X={type:"onSuspense",action:{type:"expect",args:{shouldOpenNow:!0,isDetachContainer:!0}}},J=[{version:"3.0",migrate:t=>{let e=[];for(let i of t.chapters){let t;let r=[];for(let{isDefault:e,...n}of i.branches)e&&(t=n.id),r.push(n);let n=[],s=[];for(let{fallbackStrategy:e,...r}of i.containers){let i=!!r.endTime,a=[K];switch(e){case"await":i?a=[]:n=[];break;case"default":{let e={type:"onSuspense",action:{type:Z.default,args:{branchId:t,shouldOpenNow:!i,isDetachContainer:!0}}};i?a=[e]:n=[e];break}case"random":case"weightlessRandom":case"max":case"min":{let t={type:"onSuspense",action:{type:Z[e],args:{}}};i?a=[t]:n=[t]}}for(let t of r.controls)s.push({...r,controls:[{...t}],id:(0,h.default)(),events:a})}e.push({...i,containers:s,events:n,branches:r})}return t.metadata.version="3.1",t.metadata.updated=new Date().toISOString(),{...t,chapters:e}}},{version:"3.1",migrate:t=>{if(!t.media){let{media:e,...i}=t.metadata;return{...t,metadata:{...i,version:"3.2"},media:e}}return t}},{version:"3.2",migrate:t=>{let e=[],i=[];for(let r of t.chapters){let{id:t,x:n,y:s,...a}=r,o=a.containers.map(t=>({...t,controls:t.controls.map(({subtype:t,type:e,...i})=>({...i,type:t??e})),events:t.events?.length?t.events:[X]}));e.push({id:t,...a,containers:o,events:a.events?.length?a.events:[X]}),i.push({id:t,x:n,y:s})}return{...t,chapters:e,graph:Y(i),metadata:{...t.metadata,version:"3.3"}}}}],tt=t=>J.reduce((t,e)=>Q(t.metadata.version,e.version)?t:e.migrate(t),t),te=Object.freeze({Button:"Button",Area:"Area",Text:"Text"}),ti=Object.freeze({openURI:"openURI",setNextBranch:"setNextBranch",setWeightlessRandomBranch:"setWeightlessRandomBranch",setRandomBranch:"setRandomBranch",setMaxWeightBranch:"setMaxWeightBranch",setMinWeightBranch:"setMinWeightBranch",setDefaultBranch:"setDefaultBranch",continuePlayback:"continuePlayback",expect:"expect"});(a=o||(o={})).GO_NEXT_BUTTON="GO_NEXT_BUTTON",a.GO_NEXT_AREA="GO_NEXT_AREA",a.WATCH_AGAIN="WATCH_AGAIN",a.OPEN_GRAPH="OPEN_GRAPH",a.CLOSE_GRAPH="CLOSE_GRAPH";let tr={metadata:"Object",chapters:"Array"},tn=t=>{let e=Q(t,"3.0.0");return -1!==e&&(0===e||1!==Q(t,"3.3.0"))},ts=t=>{if(!B(t))return!1;for(let e in tr)if(!t[e]||!k(t[e],tr[e]))return!1;return tn(t.metadata.version)},ta=t=>t.type===te.Text;class to{constructor(t,e,...i){this.severity=t,this.category=e,this.data=i}toString(){return`SDK_NAME ERROR ${JSON.stringify(this,null,"  ")}`}static Severity={RECOVERABLE:1,CRITICAL:2};static Category={VIDEO:0,INTERACTIVES:1,GRAPH:2,MANIFEST:3,LOADERS:4,HISTORY:5,SEAMLESS:6}}class tl{listeners={};addListener(t,e){return this.listeners[t]=this.listeners[t]||[],this.listeners[t].push(e),this}on(t,e){return this.addListener(t,e)}once(t,e){this.listeners[t]=this.listeners[t]||[];let i=()=>{e(),this.off(t,i)};return this.listeners[t].push(i),this}off(t,e){return this.removeListener(t,e)}reset(){this.listeners={}}removeListener(t,e){let i=this.listeners[t];if(!i)return this;for(let t=i.length;t>0;t--)if(i[t]===e){i.splice(t,1);break}return this}emit(t,...e){let i=this.listeners[t];return!!i&&(i.forEach(t=>{t(...e)}),!0)}listenerCount(t){return(this.listeners[t]||[]).length}rawListeners(t){return this.listeners[t]}}class th{constructor(t){this.raf,this.fn,this.fns=[],this.addFn(t)}addFn=(t,e=!1)=>{D(t)&&(this.fns.push(t),e&&this.updateFn())};removeFn=(t,e=!1)=>{this.fns=this.fns.filter(e=>e!==t),e&&this.updateFn()};updateFn=()=>{this.fn=()=>{this.fns.forEach(t=>t()),this.raf&&this.forceRequestAnimation()}};forceRequestAnimation=()=>{this.fn&&(this.raf=requestAnimationFrame(this.fn))};requestAnimation=()=>{this.raf||this.forceRequestAnimation()};cancelAnimation=()=>{cancelAnimationFrame(this.raf),this.raf=void 0};release(){this.cancelAnimation(),this.fn=void 0,this.fns=[]}}class tc{loaders;constructor(t){this.loaders={chapterLoaders:t?.chapterLoaders??[],manifestLoaders:t?.manifestLoaders??[]}}async exec(t,e){return(function(...t){return async function(e){let i=[...t];for(;i.length>0;)e=await i.shift()(e);return e}})(...this.loaders[t])(e)}}function td(t,e,i){return t?{...t,[e]:t[e]?[i,...t[e]]:[i]}:{[e]:[i]}}class tp{constructor(){Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}addEventListener(t,e,i){t in this.listeners||(this.listeners[t]=[]),this.listeners[t].push({callback:e,options:i})}removeEventListener(t,e){if(!(t in this.listeners))return;let i=this.listeners[t];for(let t=0,r=i.length;t<r;t++)if(i[t].callback===e){i.splice(t,1);return}}dispatchEvent(t){if(!(t.type in this.listeners))return;let i=this.listeners[t.type].slice();for(let r=0,n=i.length;r<n;r++){let n=i[r];try{n.callback.call(this,t)}catch(t){Promise.resolve().then(function(){return e("8Axf4")}).then(e=>{throw t})}n.options&&n.options.once&&this.removeEventListener(t.type,n.callback)}return!t.defaultPrevented}}class tu extends tp{constructor(){super(),this.listeners||tp.call(this),Object.defineProperty(this,"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(this,"onabort",{value:null,writable:!0,configurable:!0}),Object.defineProperty(this,"reason",{value:void 0,writable:!0,configurable:!0})}toString(){return"[object AbortSignal]"}dispatchEvent(t){"abort"===t.type&&(this.aborted=!0,"function"==typeof this.onabort&&this.onabort.call(this,t)),super.dispatchEvent(t)}}function tm(t){return t.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):"function"==typeof t.Request&&!t.Request.prototype.hasOwnProperty("signal")||!t.AbortController}"u">typeof Symbol&&Symbol.toStringTag&&((class{constructor(){Object.defineProperty(this,"signal",{value:new tu,writable:!0,configurable:!0})}abort(t){let e;try{e=new Event("abort")}catch{"u">typeof document?document.createEvent?(e=document.createEvent("Event")).initEvent("abort",!1,!1):(e=document.createEventObject()).type="abort":e={type:"abort",bubbles:!1,cancelable:!1}}let i=t;if(void 0===i){if(typeof document>"u")(i=Error("This operation was aborted")).name="AbortError";else try{i=new DOMException("signal is aborted without reason")}catch{(i=Error("This operation was aborted")).name="AbortError"}}this.signal.reason=i,this.signal.dispatchEvent(e)}toString(){return"[object AbortController]"}}).prototype[Symbol.toStringTag]="AbortController",tu.prototype[Symbol.toStringTag]="AbortSignal");let ty=tm({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}),tf=ty?function(t){"function"==typeof t&&(t={fetch:t});let{fetch:e,Request:i=e.Request,AbortController:r,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:n=!1}=t;if(!tm({fetch:e,Request:i,AbortController:r,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:n}))return{fetch:e,Request:s};let s=i;return(s&&!s.prototype.hasOwnProperty("signal")||n)&&((s=function(t,e){let r;e&&e.signal&&(r=e.signal,delete e.signal);let n=new i(t,e);return r&&Object.defineProperty(n,"signal",{writable:!1,enumerable:!1,configurable:!0,value:r}),n}).prototype=i.prototype),{fetch:(t,i)=>{let r=s&&s.prototype.isPrototypeOf(t)?t.signal:i?i.signal:void 0;if(r){let n;try{n=new DOMException("Aborted","AbortError")}catch{(n=Error("Aborted")).name="AbortError"}if(r.aborted)return Promise.reject(n);let s=new Promise((t,e)=>{r.addEventListener("abort",()=>e(n),{once:!0})});return i&&i.signal&&delete i.signal,Promise.race([s,e(t,i)])}return e(t,i)},Request:s}}({fetch:window.fetch,Request:window.Request,AbortController:window.AbortController}):void 0,tg=ty?tf.fetch:window.fetch;ty?tf.Request:window.Request;let tv=async t=>{try{let i,r;if(B(t))i=t;else{if(!M(t))return{};r=new URL(t).href;let e=await tg(r);if(!e.ok)return{};i=await e.json()}if(!ts(i))return{};let n=i.metadata.media;if(M(n)&&!i.media)try{let t;r?t=new URL(n,r).href:r=t=new URL(n).href;let e=await tg(t);if(!e.ok)throw Error();i.metadata.media=await e.json()}catch{var e;return(e=i.metadata.version,Q(e,"3.2.0")>=0)?{manifest:i}:{}}return{manifest:i,manifestURL:r}}catch{return{}}};async function tb(t){var e;let{manifest:i,manifestURL:r}=await tv(t),n=tt(i);return n.media={...e=n.media,videos:e.videos.map(t=>({...t,variants:t.variants.map(t=>{let e=function(t,e){try{return new URL(t,e).href}catch{return""}}(t.url,r);return{...t,url:e||t.url}})}))},delete n.metadata.media,n}function tE(t,e){return t.find(t=>t.id===e)}function tC(t,e){return t.edit?.chapters?t.edit.chapters.find(t=>t.id===e):t.view?.chapters?t.view.chapters.find(t=>t.id===e):void 0}function tw(t,e){return t.videos.find(t=>t.id===e)}let tI=Object.freeze({nothing:0,beforeInteractive:1,interactive:2,afterInteractive:3,end:4,removed:5,destroyed:6}),tS=t=>_(t)&&!z(t),tx=t=>"end"===t.order,tT=t=>_(t.containers)&&!z(t.containers)&&tx(t),tj=(t,e)=>tS(e.controls)&&1e3*t<(e.startTime??0),tR=(t,e)=>{let i=1e3*t;return tS(e.controls)&&i>=(e.startTime??0)&&i<=(e.endTime??1/0)},tO=t=>t.some(t=>"expect"===t.action.type),tA=t=>t.find(t=>"expect"===t.action.type),tL=t=>t?.length===1,tV=t=>tL(t)&&ta(t[0]),t$=({fn:t,type:e=1},...i)=>(...r)=>e?t(...r,...i):t({...r[e],...i[e]}),tN=(t=[])=>t.reduce((t,e,i)=>{if(tS((e?.controls??[]).filter(t=>!ta(t)))){let r=[e.startTime??0,e.endTime??1/0],n=e.id;if(i){let e=[],i=-1/0,s=1/0,a=[],o=[];for(let l=0;l<t.length;l++){let h=t[l];if(o.push(...h.subjects),h.range[0]<s&&(s=h.range[0]),h.range[1]>i&&(i=h.range[1]),h.range[0]<=r[0]&&h.range[1]>=r[1])return t[l].subjects.push(n),t;r[0]>=h.range[0]&&r[0]<=h.range[1]&&(e.push(l),a=a.concat(h.subjects),r[0]=h.range[0]),r[1]>=h.range[0]&&r[1]<=h.range[1]&&(e.push(l),a=a.concat(h.subjects),r[1]=h.range[1])}if(o.push(n),r[0]<=s&&r[1]>=i)return[{subjects:o,range:r}];e.length&&e.reverse().forEach(e=>{t.splice(e,1)}),t.push({subjects:a.concat([n]),range:r})}else t.push({subjects:[n],range:r})}return t},[]).sort((t,e)=>t.range[0]-e.range[0]),tP=(t,e)=>!tO(t.events)&&e.some(({container:e})=>e.container.id!==t.id&&tO(e.container.events)&&e.container.endTime===t.endTime&&!e.isRemoved);class tk extends tc{constructor(t,e){super(t),this.onError=e,this.prevChapter$=new l.ValueSubject(null),this.release()}release(){return this.manifest=null,this.chapter=null,this.media=null,this.graph=null,this.prevChapter$.next(null),this}async setManifest(t){this.release();let e=await this.exec("manifestLoaders",{actions:{addErrorMessage:td},result:null,errors:null,source:t});e.errors&&this.errorHandler(e.errors);let i=await tb(e.result??t);return this.manifest=i,this}async setInitial(){return this.setNext()}async setNext(t=this.manifest.metadata.initChapterId){this.prevChapter$.next(this.chapter);let e=await this.exec("chapterLoaders",function t({actions:e,errors:i,chapterId:r,...n}){if(r){let s=e.getManifest(),a=e.getChapter(s.chapters,r);if(a){let r=e.getMedia(s.media,a.videoId),o=e.getGraph(s.graph,a.id);return r?{...n,actions:e,errors:i,result:{chapter:a,media:r,graph:o}}:{...n,errors:td(i,t.name,"Could not find media"),actions:e}}}return{...n,errors:td(i,t.name,"Could not find chapter"),actions:e}}({actions:{getManifest:()=>this.manifest,getCurrent:this.getCurrent,getGraph:tC,getChapter:tE,getMedia:tw,getByBranches:this.getByBranches.bind(this),addErrorMessage:td},result:null,errors:null,chapterId:t}));return e.errors&&this.errorHandler(e.errors),this.chapter=e.result.chapter,this.media=e.result.media,this.graph=e.result.graph,this}errorHandler(t){this.onError(t),console.error("Something went wrong with loaders",{errors:t})}getInitial(){return this.getByChapterId(this.manifest.metadata.initChapterId)||null}getByChapterId(t=this.manifest.metadata.initChapterId){let e=tE(this.manifest.chapters,t);if(e){let t=tw(this.manifest.media,e.videoId),i=tC(this.manifest.graph,e.id);if(t)return{chapter:e,media:t,graph:i}}return null}getBranches(t=this.chapter.id){if(t===this.chapter.id)return this.getByBranches(this.chapter.branches);{let e=tE(this.manifest.chapters,t);return this.getByBranches(e?.branches)}}getByBranches(t=[]){return t.reduce((t,e)=>{let i=this.getByChapterId(e.chapterId);return i&&t.push(i),t},[])}getCurrent(){return{chapter:this.chapter,media:this.media,graph:this.graph}}isInitialChapter(){return this.chapter.id===this.manifest.metadata.initChapterId}isEndChapter(){return tx(this.chapter)}}let tB=t=>{let e=t.variants.find(t=>t.payload?.type==="vk");if(e&&"payload"in e){let[t,i]=e.payload.id.split("_");return[t,i]}return[]},tM={graph:"graph",interactives:"interactives",chapterChanged:"chapter-changed",playerChanged:"player-changed",manifestChanged:"manifest-changed",errors:"errors",eachTick:"eachTick",historyInited:"history-inited",historyDestroyed:"history-destroyed"},t_={visibility:"visibility",watchAgainClicked:"watchAgainClicked"},tF={actionChoiceCanceled:"action-choice-canceled",actionChoice:"action-choice",actionExecution:"action-execution",visibility:"visibility",containerRemoved:"container-removed",rangeEnded:"range-ended"};function tD(t,e=[]){let i={},r,n=!e.length;for(let s of t.variants)if(!r&&"cover"in s&&(r=s.cover),"url"in s)switch(s.type.toLowerCase()){case"mp4":(n||e.includes("mp4"))&&(i.MPEG={...i.MPEG,[s.standard??"Invariant quality"]:s.url});break;case"mpeg":(n||e.includes("mpeg"))&&(i.MPEG={...i.MPEG,[s.standard??"Invariant quality"]:s.url});break;case"hls":(n||e.includes("hls"))&&(i={...i,HLS:{type:"url",url:s.url}});break;case"dash":(n||e.includes("dash"))&&(i={...i,DASH_SEP:{compatibilityMode:!0,type:"url",url:s.url}})}return{sources:i,thumbUrl:r,title:t.title??""}}let tU=(t,e)=>{let i=t.info.currentQuality$.getValue(),r=t.info.availableQualities$.getValue();i!==e&&r.includes(e)&&(t.setQuality(e),t.setAutoQuality(!1))},tH={activePlayerChanged:"sc-active-player-changed",initiated:"sc-initiated",playerCreated:"sc-player-created"},tz=3e3,tW=(n=[],s=null,{setPlayer:t=>{s=t},setContainers:t=>{n=t},deleteContainer:t=>{n=n.filter(e=>e.id!==t)},getNextInteractiveTime:(t=tz)=>{if(!n.length||null===s)return null;let e=-1,i=!1,r=Math.round(1e3*s.info.position$.getValue());for(let s of n){let n=s.startTime-t;if(n<=r&&(r<=s.endTime||null===s.endTime)){i=!0;break}r<n&&(e=-1===e?n:Math.min(e,n))}return i||-1===e?null:e}});class tG{constructor({player:t,container:e,branches:i,selectBranches:r,interactiveEvents:n,globalEventEmitter:s,ignoreContainerEvent:a,permanentTextControls:o,disabledControls$:h}){this.container=e,this.branches=i,this.selectBranches=r,this.subscription=new l.Subscription,this.player=t,this.interactiveEvents=n,this.ignoreContainerEvent=a,this.isPermanentText=o&&tV(e.container.controls),this.disabledControls$=h,this.globalEventEmitter=s,this.gameState=tI.nothing,this.isSelectedControlEvent=!1,this.isSelectedContainerEvent=!1,this.registerEvents()}registerEvents(){this.subscription.add(this.player.events.playing$.subscribe(this.show)).add(this.player.events.paused$.subscribe(this.hide)).add(this.player.events.ended$.subscribe(this.onEndOfVideo)),this.subscription.add(this.disabledControls$.subscribe(t=>{t?this.container.disable?.():this.container.enable?.()}))}hide=()=>{setTimeout(()=>{this.gameState!==tI.end&&(tO(this.container.container.events)&&this.gameState===tI.afterInteractive||this.selectBranches.state.isExpect||(this.gameState!==tI.interactive&&this.container.hide?.(),this.globalEventEmitter.emit(tM.interactives,{subjectId:this.container.container.id,subjectName:"container",type:tF.visibility,visibility:!1})))})};show=()=>{if(this.gameState===tI.interactive&&!this.isSelectedControlEvent){if(this.container.getElement())this.container.show?.(),this.globalEventEmitter.emit(tM.interactives,{subjectId:this.container.container.id,subjectName:"container",type:tF.visibility,visibility:!0,isFirst:!1});else{let t=t$({fn:this.selectBranches.onControlEvent,type:0},{isDisabled:()=>this.container.isDisabled,branches:this.branches,containerId:this.container.container.id,onDetachContainer:()=>{this.removeView(),this.globalEventEmitter.emit(tM.interactives,{subjectId:this.container.container.id,subjectName:"container",type:tF.visibility,visibility:!1})},onEvent:(t,e)=>{this.isSelectedControlEvent=!0,!1!==t&&(this.removeView(),this.globalEventEmitter.emit(tM.interactives,{subjectId:this.container.container.id,subjectName:"container",type:tF.visibility,visibility:!1})),(this.gameState===tI.end||this.gameState===tI.afterInteractive||this.selectBranches.state.isExpect)&&(this.selectBranches.stopExpect(),e(),this.removeView(),this.globalEventEmitter.emit(tM.interactives,{subjectId:this.container.container.id,subjectName:"container",type:tF.visibility,visibility:!1})),tW.deleteContainer(this.container.container.id)},isEOV:()=>this.gameState===tI.end});this.container.createView(t),this.globalEventEmitter.emit(tM.interactives,{subjectId:this.container.container.id,subjectName:"container",type:tF.visibility,visibility:!0,isFirst:!0}),this.disabledControls$.getValue()&&this.container.disable?.()}}};selectContainerEvent(t=!1){this.interactiveEvents.containersEventsCallState.setCalled({timestamp:t?1/0:this.container.container.endTime,id:this.container.container.id}),this.isSelectedControlEvent||this.isSelectedContainerEvent||(this.isSelectedContainerEvent=!0,this.ignoreContainerEvent()||this.selectBranches.setManifestContainerEvents({container:this.container.container,branches:this.branches,isEOV:t}),t||this.interactiveEvents.exec(this.container.container.endTime))}onStartTime(){this.show()}onEndTime(){this.selectContainerEvent(!1);let t=tO(this.container.container.events)||this.ignoreContainerEvent();(this.isSelectedControlEvent||!t)&&this.removeView()}onBeforeStartTime(){this.container.hide?.(),this.globalEventEmitter.emit(tM.interactives,{subjectId:this.container.container.id,subjectName:"container",type:tF.visibility,visibility:!1})}onEndOfVideo=()=>{this.gameState=tI.end,this.selectContainerEvent(!0)};whilePlaying=()=>{if(this.player.experimental.element$.getValue()?.readyState<1||[tI.destroyed,tI.removed].includes(this.gameState)&&!this.isPermanentText)return;let t=this.player.getExactTime();if(tj(t,this.container.container))this.gameState!==tI.beforeInteractive&&(this.gameState=tI.beforeInteractive,this.onBeforeStartTime());else if(tR(t,this.container.container))this.gameState!==tI.interactive&&(this.gameState=tI.interactive,this.onStartTime());else if(this.gameState!==tI.afterInteractive){let t=this.gameState;this.gameState=tI.afterInteractive,t===tI.interactive&&this.onEndTime()}else this.gameState!==tI.destroyed&&this.removeView();let e=tR(t,this.container.container),i=this.container.container.startTime?[this.container.container.startTime,this.container.container.endTime??1/0]:[];this.container.onProgress?.(t,e),this.globalEventEmitter.emit(tM.eachTick,{subjectId:this.container.container.id,subjectName:"container",range:i,currentTime:t,isInteractiveTime:e})};reset(){this.isSelectedControlEvent=!1,this.isSelectedContainerEvent=!1,this.gameState=tI.beforeInteractive}removeView(){this.container.removeView(),this.globalEventEmitter.emit(tM.interactives,{subjectId:this.container.container.id,subjectName:"container",type:tF.containerRemoved,visibility:!1}),this.gameState=tI.removed}destroy(){this.reset(),this.removeView(),this.gameState=tI.destroyed,this.subscription.unsubscribe(),this.branches=[],this.interactiveEvents.containersEventsCallState.setCalled({timestamp:this.container.container.endTime??1/0,id:this.container.container.id}),tW.deleteContainer(this.container.container.id)}}function tq(){let t={};return{map:t,remove:function({timestamp:e,priority:i,initiator:r}){if(U(e)){if(!t[e])return!1;if(W(i,!0)){if(!t[e][i])return!1;if(W(r,!0)){if(!t[e][i][r])return!1;if(delete t[e][i][r],!H(t[e][i]))return!0}if(delete t[e][i],!H(t[e]))return!0}return delete t[e]}},add:function({timestamp:e,priority:i,initiator:r,...n}){t[e]?.[i]?.[r]?t[e][i][r].push({...n}):t[e]?.[i]?t[e][i]={...t[e][i],[r]:[{...n}]}:t[e]?t[e]={...t[e],[i]:{[r]:[{...n}]}}:t[e]={[i]:{[r]:[{...n}]}}},removeAll:function(){for(let e in t)Object.prototype.hasOwnProperty.call(t,e)&&delete t[e];return!0},get:function({timestamp:e,priority:i,initiator:r}){if(U(e)){let n=t[e]??null;if(n&&W(i,!0)){let t={},e=n[i];return e&&(t={...t,...e}),(t=H(t)?null:t)&&W(r,!0)?t[r]??null:t}return n}return null},getLte:function(e){let i={};for(let r in t)+r<=e&&(i[r]=t[r]);return i},getGte:function(e){let i={};for(let r in t)+r>=e&&(i[r]=t[r]);return i}}}let tQ=[ti.expect,ti.setNextBranch],tZ=1/0;function tK(t){let e,i=t,r,n=function(){let t=new Map;return{setCalled:({timestamp:e,id:i})=>{let r=t.get(e);r&&void 0!==r[i]&&(r[i]=!0)},setData:(e=[])=>{for(let i of e){let e=i.endTime??tZ,r=t.get(e)??{};t.set(e,{...r,[i.id]:!1})}},resetCalled:e=>{let i=t.get(e);if(i)for(let t in i)i[t]=!1},isReady:e=>{let i=t.get(e);return!i||!Object.values(i).some(t=>!t)},release:()=>t.clear()}}(),s=new tq,a=(t=[])=>{for(let e of t)if(e.action(),tQ.includes(e.actionType))break},o=(t=1/0)=>[...tY(s.get({timestamp:t,priority:"control"})??{}),...tY(s.get({timestamp:t,priority:"container"})??{}),...tY(s.get({timestamp:t,priority:"chapter"})??{})],l=t=>{n.isReady(t)&&a(o(t))},h=()=>{r&&(e?.unsubscribe(),r=void 0)},c=()=>{r||(r=()=>setTimeout(()=>{l(1/0)}),e=i.events.ended$.subscribe(r))},d=()=>{n.release(),s.removeAll()};return{setPlayer:t=>{h(),i=t},add:t=>{s.add.call(void 0,t),c()},remove:t=>{"container"===t.priority&&n.resetCalled(t.timestamp),s.remove(t)},exec:l,execEndOfVideo:()=>{a([...tY(s.get({timestamp:1/0,priority:"chapter"})??{})])},listen:c,unlisten:h,release:()=>{h(),d()},containersEventsCallState:n,getPreparedToExecActions:o}}function tY(t){return Object.values(t).flat().sort(t=>t.actionType===ti.expect?-1:1)}let tX=(t,e)=>{let i,r;let{height:n,width:s}=e.info.intrinsicVideoSize$.getValue()||{};if(!(n&&s))return{videoContentHeight:0,videoContentWidth:0};let{clientHeight:a,clientWidth:o}=e.experimental.element$.value||{};if(!(a&&o))return{videoContentHeight:0,videoContentWidth:0};let l=n/s,h=a/o;return h>l?(r=o,i=o*l):(r=h<l?a/l:o,i=a),{videoContentWidth:r,videoContentHeight:i}};class tJ{constructor(){this.map={}}push(t,e){t in this.map?this.map[t].push(e):this.map[t]=[e]}get(t){let e=this.map[t];return e?e.slice():null}getAll(){let t=[];for(let e in this.map)t.push(...this.map[e]);return t}remove(t,e){t in this.map&&(this.map[t]=this.map[t].filter(t=>t!==e),0===this.map[t].length&&delete this.map[t])}clear(){this.map={}}size(){return Object.keys(this.map).length}keys(){return Object.keys(this.map)}}let t0=t=>Math.floor(Math.random()*t),t1=t=>{let e=t.length,i=1/0,r=null;for(;e--;)t[e].weight<i&&(i=t[e].weight,r=t[e]);return r},t3=t=>{let e=t.length,i=-1/0,r=null;for(;e--;)t[e].weight>i&&(i=t[e].weight,r=t[e]);return r},t2=t=>{let e=t0(t.length);return t[e]},t5=t=>{let e=0;for(let i=0;i<t.length;++i)e+=t[i].weight??1;let i=Math.random()*e;e=0;for(let r=0;r<t.length-1;++r)if((e+=t[r].weight??1)>=i)return t[r];return t[t.length-1]},t4=Object.freeze({shouldOpenNow:!0,isDetachContainer:!0}),t8=(t,e=!1)=>({...t,args:e?{...t.args,...t4}:{...t4,...t.args}}),t6=({globalEventEmitter:t,player:e,interactiveEvents:i,removeControllers:r})=>{let n={isExpect:!1},s=({action:e,container:{id:n,endTime:s},branches:a=[],isEOV:o=!1,autoSelected:l=!1})=>{let p=t8(e,o),u={timestamp:!p.args.shouldOpenNow||o?1/0:s,priority:"container",initiator:n,actionType:p.type},m=t.emit.bind(t,tM.interactives,{subjectId:n,subjectName:"container",type:tF.actionChoice,actionType:p.type,payload:p.args});switch(p.type.trim().toLowerCase()){case ti.setNextBranch.trim().toLowerCase():{let t=a.find(t=>t.id===p.args.branchId);if(!t)return;m(),i.add({...u,action:c.bind(null,{subjectId:n,subjectName:"container",action:p,payload:{chapterId:t.chapterId,autoSelect:l}})}),r?.();return}case ti.setMaxWeightBranch.trim().toLowerCase():case ti.setMinWeightBranch.trim().toLowerCase():case ti.setRandomBranch.trim().toLowerCase():case ti.setWeightlessRandomBranch.trim().toLowerCase():return;case ti.continuePlayback.trim().toLowerCase():m(),i.add({...u,action:h.bind(null,{subjectId:n,subjectName:"container",action:p})});return;case ti.openURI.trim().toLowerCase():m(),i.add({...u,action:d.bind(null,{subjectId:n,subjectName:"container",action:p,payload:{URI:e.args.uri}})}),r?.();return;default:console.error("Unexpected container event"),t.emit(tM.errors,new to(to.Severity.RECOVERABLE,to.Category.INTERACTIVES,{message:"Unexpected container event"}));return}},a=({chapterId:e,action:i,branches:r=[]})=>{let n=t.emit.bind(t,tM.interactives,{subjectId:e,subjectName:"chapter",type:tF.actionChoice,actionType:i.type,payload:i.args});switch(i.type.trim().toLowerCase()){case ti.setNextBranch.trim().toLowerCase():{let t=r.find(t=>t.id===i.args.branchId);return t?.chapterId?(n(),c.bind(null,{subjectId:e,subjectName:"chapter",action:i,payload:{chapterId:t.chapterId,autoSelect:!0}})):void 0}case ti.setWeightlessRandomBranch.trim().toLowerCase():{let t=t2(r);return t?.chapterId?(n(),c.bind(null,{subjectId:e,subjectName:"chapter",action:i,payload:{chapterId:t.chapterId,autoSelect:!0}})):void 0}case ti.setRandomBranch.trim().toLowerCase():{let t=t5(r);return t?.chapterId?(n(),c.bind(null,{subjectId:e,subjectName:"chapter",action:i,payload:{chapterId:t.chapterId,autoSelect:!0}})):void 0}case ti.setMaxWeightBranch.trim().toLowerCase():{let t=t3(r);return t?.chapterId?(n(),c.bind(null,{subjectId:e,subjectName:"chapter",action:i,payload:{chapterId:t.chapterId,autoSelect:!0}})):void 0}case ti.setMinWeightBranch.trim().toLowerCase():{let t=t1(r);return t?.chapterId?(n(),c.bind(null,{subjectId:e,subjectName:"chapter",action:i,payload:{chapterId:t.chapterId,autoSelect:!0}})):void 0}case ti.continuePlayback.trim().toLowerCase():return n(),h.bind(null,{subjectId:e,subjectName:"chapter",action:i});case ti.openURI.trim().toLowerCase():return n(),d.bind(null,{subjectId:e,subjectName:"chapter",action:i,payload:{URI:i.args.uri}});default:console.error("Unexpected chapter event"),t.emit(tM.errors,new to(to.Severity.RECOVERABLE,to.Category.INTERACTIVES,{message:"Unexpected chapter event"}));return}},o=({subjectId:i,subjectName:r,action:n})=>{e.pause(),t.emit(tM.interactives,{subjectId:i,subjectName:r,type:tF.actionExecution,actionType:n?.type??ti.expect})},l=({subjectId:r,subjectName:n})=>{e.info.isEnded$.getValue()?i.execEndOfVideo():e.play(),t.emit(tM.interactives,{subjectId:r,subjectName:n,type:tF.actionExecution,actionType:"after-expect"})},h=({subjectId:e,subjectName:i,subjectType:r,action:n})=>{t.emit(tM.interactives,{subjectId:e,subjectName:i,subjectType:r,type:tF.actionExecution,actionType:n.type})},c=({subjectId:e,subjectName:i,subjectType:r,action:n,payload:s})=>{s.behaviour="change-chapter",t.emit(tM.interactives,{subjectId:e,subjectName:i,subjectType:r,type:tF.actionExecution,actionType:n.type,payload:s})},d=({subjectId:e,subjectName:i,subjectType:r,action:n,payload:s})=>{if(!s.URI)return;let a=window.open(s.URI,"_blank","noopener,noreferrer");a&&(a.opener=null),t.emit(tM.interactives,{subjectId:e,subjectName:i,subjectType:r,type:tF.actionExecution,actionType:n.type})};return{onControlEvent:({action:e,controlType:n,controlId:s,containerId:a,branches:o=[],onEvent:p,isEOV:u=()=>!1,isDisabled:m=()=>!1})=>{let y=t8(e,u()),f={timestamp:1/0,priority:"control",initiator:s,actionType:y.type},g=m(),v=t.emit.bind(t,tM.interactives,{subjectId:s,subjectType:n,subjectName:"control",type:g?tF.actionChoiceCanceled:tF.actionChoice,actionType:e.type,payload:{containerId:a,...y.args}});if(g){v();return}switch(y.type.trim().toLowerCase()){case ti.setNextBranch.trim().toLowerCase():{let t=o.find(t=>t.id===y.args.branchId);if(!t)return;p(y.args.isDetachContainer,l.bind(null,{subjectId:s,subjectName:"control"})),v(),y.args.shouldOpenNow?c({subjectId:s,subjectName:"control",subjectType:n,action:y,payload:{chapterId:t.chapterId,autoSelect:!1}}):(i.add({...f,action:c.bind(null,{subjectId:s,subjectName:"control",subjectType:n,action:y,payload:{chapterId:t.chapterId,autoSelect:!1}})}),r?.());return}case ti.continuePlayback.trim().toLowerCase():p(y.args.isDetachContainer,l.bind(null,{subjectId:s,subjectName:"control"})),v(),y.args.shouldOpenNow?h({subjectId:s,subjectName:"control",subjectType:n,action:e}):i.add({...f,action:h.bind(null,{subjectId:s,subjectName:"control",subjectType:n,action:e})});return;case ti.openURI.trim().toLowerCase():p(y.args.isDetachContainer,l.bind(null,{subjectId:s,subjectName:"control"})),v(),y.args.shouldOpenNow?d({subjectId:s,subjectName:"control",subjectType:n,action:y,payload:{URI:e.args.uri}}):(i.add({...f,action:d.bind(null,{subjectId:s,subjectName:"control",subjectType:n,action:y,payload:{URI:e.args.uri}})}),r?.());return;default:console.error("Unexpected control event"),t.emit(tM.errors,new to(to.Severity.RECOVERABLE,to.Category.INTERACTIVES,{message:"Unexpected control event"}));return}},onContainerEvent:s,onChapterEvent:a,onExpectEvent:o,expectEventHandler:l,setManifestChapterEvents:function(e){let r=tA(e.events);if(r){if(tx(e))return;t.emit(tM.interactives,{subjectId:e.id,subjectName:"chapter",type:tF.actionChoice,actionType:r.action.type,payload:r.action.args}),i.add({timestamp:1/0,priority:"chapter",initiator:e.id,actionType:ti.expect,action:o.bind(null,{subjectId:e.id,subjectName:"chapter"})})}else e.events.forEach(t=>{let r=a({chapterId:e.id,action:t.action,branches:e.branches});r&&i.add({timestamp:1/0,priority:"chapter",initiator:e.id,actionType:t.action.type,action:r})})},setManifestContainerEvents:function({container:e,branches:r,isEOV:a=!1}){let l=tA(e.events);if(l){let r=t8(l.action,a);t.emit(tM.interactives,{subjectId:e.id,subjectName:"container",type:tF.actionChoice,actionType:r.type,payload:r.args}),i.add({timestamp:a?1/0:e.endTime,priority:"container",initiator:e.id,actionType:ti.expect,action:o.bind(null,{subjectId:e.id,subjectName:"container"})}),n.isExpect=!0}else for(let t of e.events)s({action:t.action,container:e,branches:r,isEOV:a})},stopExpect:()=>{n.isExpect&&(n.isExpect=!1)},state:n}},t9=(t,e)=>{let i={};return t.map(t=>{if(!i[t]){let r=e.chapters.find(e=>e.id===t);if(!r)return null;let n=e.media.videos.find(t=>r.videoId===t.id);if(!n)return null;i[t]=ee(n)}return i[t]}).filter(Boolean)},t7=t=>{for(let e of t.variants)if(et(e)&&"payload"in e)return e.payload.id},et=t=>"custom"===t.type&&"payload"in t&&"vk"===t.payload.type,ee=t=>{let e=t7(t);if(!e)return null;let i=e.split("_").pop();return i?parseInt(i,10):null},ei=(t,e)=>{for(let i of t.media.videos)if(e===ee(i)){for(let e of t.chapters)if(e.videoId===i.id)return e.id;return}},er=(t,e)=>t.reduce((t,i)=>{let r=ei(e,i);return r?[...t,r]:t},[]);class en{state={history$:new l.ValueSubject([]),hasPrevChapter$:new l.ValueSubject(!1),prevChapter$:new l.ValueSubject(null),isInitialChapter$:new l.ValueSubject(!1)};#t=null;#e;#i=!1;#r=null;#n=null;#s=null;#a=null;#o=null;#l=new l.Subscription;constructor({globalEventEmitter:t,videoId:e,interactiveController:i,historyApi:r,historyParams:n}){this.#s=e,this.#o=t,this.#a=i,this.#t=r,this.#e={maxLength:n?.maxLength||100},this.state?.history$&&this.#l&&this.#l?.add(this.state?.history$.subscribe(t=>{this.state?.prevChapter$.next(t.at(-2)||null),this.state?.hasPrevChapter$.next(t.length>1),this.state?.isInitialChapter$.next(this.getInitialChapterId()===this.#r?.metadata?.initChapterId)}))}async setManifest(t){this.#a&&this.#o&&(this.#r=t,await this.getProjectHistory(),await this.#a.setChapter({chapterId:this.getInitialChapterId(),pushToHistory:!1}),this.#i||(this.#i=!0,this.#o.emit(tM.historyInited,{initChapterId:this.getInitialChapterId()})))}get inited(){return this.#i}async updateHistory(t,e=!0){if(!this.#r)return;let i=this.#r,r=t.length-this.#e.maxLength,n=r>0?t.slice(r):t,s=t9(n,i);if(this.#n=s,this?.state?.history$.next(n),!(!e||!this.#t||!this.#s))try{await this.#t.save(this.#s,s)}catch{this.#o?.emit(tM.errors,new to(to.Severity.RECOVERABLE,to.Category.HISTORY,"Unable to save interactive history"))}}async goBack(){if(!this.state||!this.#a)return this.#o?.emit(tM.errors,new to(to.Severity.RECOVERABLE,to.Category.HISTORY,"Cannot go back because HistoryController has not been initialized"));let t=this.state.history$.getValue().slice(0,-1),e=t.pop();this.state.history$.next(t),await this.#a.setChapter({chapterId:e})}async getProjectHistory(){if(!this.#r||!this.#s)return;let t=this.#r,e=[this.getInitialVideoId()];if(this.#t)try{let t=await this.#t.get(this.#s);t.length&&(e=t)}catch{this.#o?.emit(tM.errors,new to(to.Severity.RECOVERABLE,to.Category.HISTORY,"Error while trying to fetch data"))}let i=er(e,t);this?.state?.history$.next(i)}getInitialChapterId(){return this.state?.history$.getValue()?.at(-1)||this.#r?.metadata.initChapterId}getInitialVideoId(){return this.#r?t9([this.getInitialChapterId()],this.#r).pop():null}destroy(){this.state=null,this.#s=null,this.#t=null,this.#a=null,this.#l?.unsubscribe(),this.#l=null,this.#i=!1,this.#o?.emit(tM.historyDestroyed),this.#o=null}}class es{constructor(t,e,i,r){this.target=t,this.type=e,this.listener=i,this.options=es.#t(t,r),this.target.addEventListener(e,i,this.options)}unlisten(){this.target.removeEventListener(this.type,this.listener,this.options),this.target=null,this.listener=null,this.options=!1}static #t(t,e){if(void 0===e)return!1;if("boolean"==typeof e)return e;{let i=new Set(["passive","capture"]),r=Object.keys(e).filter(t=>!i.has(t));return 0===r.length&&console.warn("Unsupported flag(s) to addEventListener: "+r.join(",")),es.#i(t)?e:e.capture||!1}}static #e=void 0;static #i(t){let e=es.#e;if(void 0===e){e=!1;try{let i={},r={get:()=>(e=!0,!1)};Object.defineProperty(i,"passive",r),Object.defineProperty(i,"capture",r);let n=()=>{};t.addEventListener("test",n,i),t.removeEventListener("test",n,i)}catch{e=!1}es.#e=e}return e||!1}}class ea{constructor(){this.bindingMap=new tJ}release(){this.removeAll(),this.bindingMap=null}listen(t,e,i,r){if(!this.bindingMap)return;let n=new es(t,e,i,r);this.bindingMap.push(e,n)}listenOnce(t,e,i,r){let n=r=>{this.unlisten(t,e,n),i(r)};this.listen(t,e,n,r)}unlisten(t,e,i){if(this.bindingMap)for(let r of this.bindingMap.get(e)||[])r.target!==t||i!==r.listener&&i||(r.unlisten(),this.bindingMap.remove(e,r))}removeAll(){if(this.bindingMap){for(let t of this.bindingMap.getAll())t.unlisten();this.bindingMap.clear()}}}class eo{rootElement;canvasImgSrc;_prevSizeId=0;constructor(){this.rootElement=document.createElement("canvas")}clear(){this.rootElement.getContext("2d")?.clearRect(0,0,this.rootElement.width,this.rootElement.height)}isImageDrawn(){let t=this.rootElement.getContext("2d")?.getImageData(0,0,this.rootElement.width,this.rootElement.height);if(!t)return!1;let e=t.data,i=e.length;for(let t=3;t<i;t+=40)if(0!==e[t])return!0;return!1}destroy(){this.rootElement.remove()}show(){this.rootElement.style.visibility="visible"}hide(){this.rootElement.style.visibility="hidden"}setCanvasImageSource(t){this.canvasImgSrc=t}draw(){this.canvasImgSrc&&this.rootElement.getContext("2d")?.drawImage(this.canvasImgSrc,0,0,this.rootElement.width,this.rootElement.height)}async updateCanvasDimensions(t,e=!1){let i;let r=t.width+t.height;this._prevSizeId!==r&&(e&&(i=await this.save()),this.rootElement.width=t.width,this.rootElement.height=t.height,e&&i&&this.restore(i),this._prevSizeId=r)}async save(){let t=this.rootElement.toDataURL("image/jpeg",1),e=new Image;return e.crossOrigin="anonymous",e.src=t,await e.decode(),e}restore(t){this.rootElement&&this.rootElement.getContext("2d")?.drawImage(t,0,0,this.rootElement.width,this.rootElement.height)}}class el{lastFrameCanvas;endOffsetMs;currentChapter;currentVideoDurationMs=1/0;rootElement;_containerTimeFrameShouldReceived=!1;_endTimeFrameReceived=!1;_shouldCallSkip=!1;_callbacks;constructor({parentElement:t,endOffsetMs:e=250,onError:i}){this.rootElement=document.createElement("div"),this.rootElement.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: var(--interactive-width);
      height: var(--interactive-height);
      background-color: var(--black);
      visibility: hidden;
    `,this.lastFrameCanvas=new eo,this.endOffsetMs=e,this._callbacks={onError:i},this.lastFrameCanvas.rootElement.style.cssText=`
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    `,this.rootElement.prepend(this.lastFrameCanvas.rootElement),t.prepend(this.rootElement)}destroy(){this.hide(),this.reset(),this._callbacks=void 0,this.lastFrameCanvas.destroy(),this.rootElement.remove()}setVideoDuration(t){this.currentVideoDurationMs=t}setVideoElement(t){this.lastFrameCanvas.setCanvasImageSource(t)}setCurrentChapter(t){this.currentChapter=t}show(){this.rootElement.style.visibility="visible"}hide(){this.rootElement.style.visibility="hidden"}async updateCanvasDimensions(t=!1){this._containerTimeFrameShouldReceived||this._endTimeFrameReceived||(t=!1);let e=getComputedStyle(this.rootElement),i={width:parseInt(e.getPropertyValue("--interactive-content-width"),10),height:parseInt(e.getPropertyValue("--interactive-content-height"),10)};try{this.lastFrameCanvas.updateCanvasDimensions(i,t)}catch(t){this._onError(t)}}draw(){!this._containerTimeFrameShouldReceived&&(this._containerTimeFrameShouldReceived||this._endTimeFrameReceived)||this.lastFrameCanvas.draw()}isChapterEndTime(t){return this.currentVideoDurationMs&&t>=this.currentVideoDurationMs-this.endOffsetMs}isContainerTime(t){if(this.currentChapter)return this.currentChapter.containers.some(e=>e.controls?.length&&t>=(e.startTime??0)&&t<=Math.min(e.endTime??1/0,this.currentVideoDurationMs-this.endOffsetMs))}onEachTick=t=>{let e=t??1e3*this.lastFrameCanvas.canvasImgSrc.currentTime,i=this.isChapterEndTime(e);if(this.isContainerTime(e))this._endTimeFrameReceived=!1,this._containerTimeFrameShouldReceived=!0,this._shouldCallSkip=!0;else if(i)this._containerTimeFrameShouldReceived=!1,this._shouldCallSkip=!1,this._endTimeFrameReceived||(this.draw(),this._endTimeFrameReceived=!0,this.show());else{if(this._shouldCallSkip){this._shouldCallSkip=!1;return}this.reset()}};onSeek=()=>{this.onEachTick(),this._containerTimeFrameShouldReceived||this._endTimeFrameReceived||(this.hide(),this.lastFrameCanvas.clear())};reset(){this._endTimeFrameReceived=!1,this._containerTimeFrameShouldReceived=!1,this._shouldCallSkip=!1}_onError(t){this._callbacks?.onError?.(t)}}let eh=Object.freeze({parentElement:null,fullscreenTargetElement:null,lang:"ru",loaders:{},graph:!1,historyApi:null,historyParams:null,projectInfo:{},initSeamless:!1,lastFrame:!1,permanentTextControls:!0}),ec=Object.freeze({created:0,initiated:1,ready:2,destroyed:3});class ed{#t=null;#e=null;#i=null;#r=null;#n=null;#s=null;#a=null;#o=null;#l=null;#h=new l.ValueSubject(!1);#c=new Set;#d=null;#p=null;#u=null;#m=null;state={prevChapter$:new l.ValueSubject(null),isInitialChapter$:new l.ValueSubject(!1),isEndChapter$:new l.ValueSubject(!1),isInteractiveExpectation$:new l.ValueSubject(!1),calledByInteractive$:new l.ValueSubject(!1),lastChapterChangeWasInitiatedByInteractive$:new l.ValueSubject(!1),disabledControls$:new l.ValueSubject(!1)};constructor(t){this.options={...eh,...t},this.#e=[],this.factories=new Map([["choice",$]]),this.rootElement=function(){let t=document.createElement("div");return t.style.cssText=`
    position: absolute;
    top: 0;
    left: 0;
  `,t}(),this.options.parentElement.append(this.rootElement),this.#m=new tl,this.#n=new l.Subscription,this.#i=new ea,this.#r=new en({interactiveController:this,globalEventEmitter:this.#m,videoId:this.options.projectInfo?.videoId,historyApi:this.options.historyApi,params:this.options.historyParams}),this.options.lastFrame&&(this.#u=new el({parentElement:this.options.parentElement,interactivesRootElement:this.rootElement,onError:t=>this.#m.emit(tM.errors,new to(to.Severity.RECOVERABLE,to.Category.SEAMLESS,t))})),this.#i.listen(this.rootElement,"mousedown",t=>t.stopPropagation()),this.#i.listen(this.rootElement,"mouseup",t=>t.stopPropagation()),this.#l=new tk(this.options.loaders,t=>this.#m.emit(tM.errors,new to(to.Severity.RECOVERABLE,to.Category.MANIFEST,t))),this.#s=tK(this.options.player),this.#a=new th,this.#o=t6({player:this.options.player,interactiveEvents:this.#s,globalEventEmitter:this.#m,removeControllers:this.#y}),this.#t=function(t){let e=()=>{},i=new ResizeObserver(t=>{r(t),e=r.bind(null,t)}),r=P(e=>{let{fns:i=[]}=t();for(let r of(function(e){let{parentElement:i,player:r}=t();if(i&&r){let{videoContentWidth:t,videoContentHeight:n}=tX(i,r);i.style.setProperty("--interactive-content-width",`${t}px`),i.style.setProperty("--interactive-content-height",`${n}px`),i.style.setProperty("--interactive-width",`${e[0].contentRect.width}px`),i.style.setProperty("--interactive-height",`${e[0].contentRect.height}px`)}}(e),i))r()},250);return{resizeObserver:i,calc:()=>{e()},release:function(){e=void 0,i.disconnect(),function(){let{parentElement:e}=t();e.removeAttribute("style")}()}}}(()=>({player:this.options?.player,parentElement:this.options.parentElement,fns:this.options.lastFrame?[()=>{this.#u.updateCanvasDimensions(!0)}]:[]})),this.options.graph&&(this.#d=new q({root:this.options.parentElement,lang:this.options.lang,onOpenPreviewClick:t=>{this.setChapter({chapterId:t}),this.#m.emit(tM.graph,{type:t_.watchAgainClicked,chapterId:t})},onError:t=>this.#m.emit(tM.errors,new to(to.Severity.RECOVERABLE,to.Category.LOADERS,{message:t}))})),this.#f(this.options.initSeamless),this.isFirstChapterFetched=!1,this.appState=ec.created}emitPlayerChanged=t=>{setTimeout(()=>{this.#m.emit(tM.playerChanged,t)})};#f(t=!1){this.#m.on(tM.historyInited,async({initChapterId:e,videosInfo:i=[]})=>{t&&await this.#g({initialChapter:e,videosInfo:i})}),this.#m.on(tM.interactives,async t=>{if(t.type===tF.actionExecution){if(this.state.calledByInteractive$.next(!0),this.state.lastChapterChangeWasInitiatedByInteractive$.next(!0),t.payload?.behaviour==="change-chapter"){let{chapterId:e}=t.payload;this.setChapter({chapterId:e})}if(t.payload?.behaviour==="change-manifest"){let{manifestURL:e}=t.payload;this.setManifest(e)}let e="action-execution"===t.type;e&&"expect"===t.actionType?this.state.isInteractiveExpectation$.next(!0):e&&"after-expect"===t.actionType&&this.state.isInteractiveExpectation$.next(!1)}}),this.#m.on(tM.manifestChanged,()=>{this.state.calledByInteractive$.next(!1),this.state.lastChapterChangeWasInitiatedByInteractive$.next(!1)})}async #g({source:t,videosInfo:e=[]}){this.#p=function(t){let e,i;let r=function(){let t=new Map;function e(e,i){let r=t.get(e);if(r){if(i)return r[i]?.player.destroy(),r[i]?.container.remove(),r[i]?.subscription.unsubscribe(),delete r[i],Object.keys(r).length||t.delete(e),!0;for(let t of Object.values(r))t.player.destroy(),t.container.remove();return t.delete(e),!0}throw Error("Can't remove. Not find.")}return{createPlayer:function({listId:e=Math.random().toString(),itemId:i=Math.random().toString(),...r}){let n=t.get(e),s={...r};return n?n[i]=s:t.set(e,{[i]:s}),{listId:e,itemId:i,...r}},removePlayer:e,map:t,removeAll:function(){for(let i of t)e(i[0])}}}(),n=new tl,s={},a=!1,o=null,h=!1,d;function p(t,l,c){if(!o)throw Error("need to set interactive controller");let d=(r.map.get(t)??{})[l];if(d){let p=(s={chapterId:c,listId:t,itemId:l,...d}).player;i=p.info.currentQuality$.subscribe(t=>{if(!(!t||!p.info.position$.getValue()))for(let i of(e=t,r.map))Object.values(i[1]).forEach(({player:e})=>{p.info.isAutoQualityEnabled$.getValue()||tU(e,t)})}),d.container.remove(),a=!1,o.setPlayer(d.player),h||(o.init(),h=!0),n.emit(tH.activePlayerChanged,{player:s.player,config:s.config});return}throw Error("Can't set. Not find.")}async function u(t,e,i){if(!o)throw Error("need to set interactive controller");if(!H(s)&&t===s.itemId&&i>=0&&!a){let t=o.getChapterBranches();a=!0;let e=new Set;for(let i of t)e.has(i.media.id)||(await y({media:i.media,chapterId:i.chapter.id,setAsActive:!1,title:i.chapter.label}),e.add(i.media.id))}}async function m({chapter:{id:t},media:e}){if(H(s))return;i?.unsubscribe();let n=s.player.info.muted$.getValue(),a=s.player.info.currentQuality$.getValue(),o=s.player.info.isAutoQualityEnabled$.getValue(),l=s.player.info.volume$.getValue(),h=s.player.info.currentPlaybackRate$.getValue(),c=!o,d=!1;for(let i of r.map)if(i[0]===e.id){let e=Object.keys(i[1]);for(let o of e)o===s.itemId?(e.length<2||(d=!0),r.removePlayer(i[0],o)):(d=!0,p(i[0],o,t),c?tU(s.player,a):s.player.setAutoQuality(!0),s.player.setVolume(l),s.player.setMuted(n),s.player.setPlaybackRate(h))}else r.removePlayer(i[0]);d||(await y({media:e,chapterId:t,setAsActive:!0,playbackRate:h}),c?tU(s.player,a):s.player.setAutoQuality(!0),s.player.setVolume(l),s.player.setMuted(n))}async function y({media:t,chapterId:i,prefetch:a=!0,setAsActive:h=!0,autoplay:m=!1,preferredExt:y,title:f,playbackRate:g}){let v;let b=Math.random().toString(),E=document.createElement("div");d.append(E);let C=s?.player?.info.isAutoQualityEnabled$.getValue();if(o?.options?.vkVideoLoader){let e=tB(t);e.length&&(v=await o.options.vkVideoLoader(...e))}let w={container:E,...v?.videos?.[0]||{sources:tD(t,y).sources},title:f},I=new c.Player;I.initVideo(w);let S=E.lastChild,x=new l.Subscription;x.add(I.info.position$.subscribe(function(t){u(b,I.info.duration$.getValue(),t)})).add(I.events.canplay$.subscribe(function(){C||tU(I,e),g&&I.setPlaybackRate(g)})),S&&(E.style.display="none",E.classList.add(i));let T=r.createPlayer({listId:t.id,itemId:b,player:I,container:E,sources:tD(t,y).sources,config:w,subscription:x});return h&&p(t.id,T.itemId,i),m&&T.player.play(),a&&!m&&T.player.prepare(),n.emit(tH.playerCreated,T.player),{player:T.player,config:T.config}}function f(){o?.off(tM.chapterChanged,m),r.removeAll(),s={},h=!1,a=!1}async function g({container:t}){if(!o)throw Error("need to set interactive controller");f(),d=t;let{media:e,chapter:i}=o.getCurrentChapter();if(e){o.on(tM.chapterChanged,m);let{player:r,config:s}=await y({media:e,chapterId:i.id,title:i.label});return n.emit(tH.initiated,{container:t,media:e,chapterId:i.id}),{player:r,config:s}}console.error("not found")}return t&&(o=t),{...r,on:n.on.bind(n),off:n.off.bind(n),init:g,setInteractiveController:function(t){o=t},createPlayer:y,removeAll:function(){f(),o=null},getActivePlayer:function(){return s}}}(this);let i=document.createElement("div");this.#p.on(tH.activePlayerChanged,this.emitPlayerChanged);let{player:r,config:n}=await this.#p.init({source:t,initialChapter:this.#r.getInitialChapterId(),container:i});return this.updateGraphVideosInfo(e),{player:r,config:n}}getStatEvents(){return{click$:new l.Observable(t=>{this.#m.on(tM.graph,({type:e,visibility:i})=>{"visibility"===e&&t.next(i?o.OPEN_GRAPH:o.CLOSE_GRAPH),"watchAgainClicked"===e&&t.next(o.WATCH_AGAIN)}),this.#m.on(tM.interactives,({type:e,subjectName:i,subjectType:r})=>{"action-choice"!==e||"control"!==i||("Button"===r&&t.next(o.GO_NEXT_BUTTON),"Area"===r&&t.next(o.GO_NEXT_AREA))})}),nextMovie$:new l.Observable(t=>{this.#m.on(tM.playerChanged,({config:e})=>{e?.unitedVideoId&&t.next(e.unitedVideoId)})})}}setPlayer(t){this.#v(),this.options.player=t,tW.setPlayer(this.options.player),this.#s?this.#s.setPlayer(this.options.player):this.#s=tK(this.options.player),this.#o=t6({player:this.options.player,interactiveEvents:this.#s,globalEventEmitter:this.#m,removeControllers:()=>this.#y(!1)}),this.appState===ec.initiated&&(this.#b(),this.#E(this.#l.chapter))}async setManifest(t){this.#v(),this.isFirstChapterFetched=!1;let e=await this.#l.setManifest(t);return this.#d&&await this.#d.handleManifestChange(e.manifest),await this.#r.setManifest(e.manifest),this.#m.emit(tM.manifestChanged,{manifest:e.manifest}),this.#E(this.#l.chapter),e.manifest}setVisitedChapters(t){Array.isArray(t)&&this.#d?.setVisitedChapters(t)}updateGraphVideosInfo(t){Array.isArray(t)&&this.#d?.updateVideosInfo(t)}async setChapter({chapterId:t,pushToHistory:e=!0}={}){this.#v(),this.#u&&this.isFirstChapterFetched&&(this.#u.draw(),this.#u.show()),(0,l.getCurrentBrowser)().browser===l.CurrentClientBrowser.Safari&&await function(t=0){return new Promise(e=>{setTimeout(()=>{e(0)},t)})}(35);let{chapter:i,media:r,graph:n}=await (t?this.#l.setNext(t):this.#l.setInitial());return e&&this.#C(i.id),this.state.isInitialChapter$.next(this.#l.isInitialChapter()),this.state.isEndChapter$.next(this.#l.isEndChapter()),this.#d&&this.#d.handleChapterChange(n),this.#u?.setCurrentChapter(this.getCurrentChapter().chapter),this.#m.emit(tM.chapterChanged,{chapter:i,media:r,graph:n}),this.#E(this.#l.chapter),this.#c=new Set,this.isFirstChapterFetched=!0,{chapter:i,media:r,graph:n}}toggleGraphView(t=!0){this.#d&&(t?(this.#d.show(),this.#h.next(!1)):(this.#d.hide(),this.#w()),this.#m.emit(tM.graph,{type:t_.visibility,visibility:t}))}init(){this.#l.chapter&&this.options.parentElement&&this.options.player&&this.options.fullscreenTargetElement&&this.appState===ec.created&&(this.#t.resizeObserver.observe(this.options.fullscreenTargetElement),this.#b(),this.appState=ec.initiated,this.#E(this.#l.chapter))}#v(){this.appState===ec.ready&&(this.#y(),this.#e=[],this.#a.release(),this.#s?.release(),this.appState=ec.initiated,this.#h.next(!1))}#I=()=>{this.#a.fns.forEach(t=>t());let t=1e3*this.options.player.info.position$.getValue();for(let e of(this.#l.chapter.containers||[]).filter(e=>e.startTime>=Math.floor(t))){for(let t of(this.#s.remove({timestamp:1/0,priority:"container",initiator:e.id}),e.controls))this.#s.remove({timestamp:1/0,priority:"control",initiator:t.id});this.#e.find(t=>t.container.container.id===e.id).reset()}};#S=()=>{this.#t.calc(),this.#a.requestAnimation()};#x(t){(!this.#d||this.#d.isHidden)&&this.#w();let e=1e3*t,i=this.getInteractiveRanges().findLast(({range:t})=>e>=t[1]);if(i){let t=i.range.join("-");this.#c.has(t)||(this.#c.add(t),this.#m.emit(tM.interactives,{type:tF.rangeEnded,payload:i,visibility:!0}))}}deadEndCheck(){return!(this.#s?.getPreparedToExecActions()??[]).some(t=>t.actionType===ti.setNextBranch)}allControlsAreRemoved(){return!this.#e.some(t=>!t.container.isRemoved)}#b(){this.#n.unsubscribe(),this.#n.add(this.options.player.events.started$.pipe((0,l.once)()).subscribe(this.#S)).add(this.options.player.events.playing$.subscribe(this.#a.requestAnimation)).add(this.options.player.events.willPause$.subscribe(this.#a.cancelAnimation)).add(this.options.player.info.position$.subscribe(this.#x.bind(this))).add(this.#l.prevChapter$.subscribe(t=>this.state.prevChapter$.next(t))),this.options.lastFrame&&this.#n.add(this.options.player.info.duration$.subscribe(t=>{this.#u.setVideoDuration(1e3*t)})).add(this.options.player.experimental.element$.subscribe(t=>{t&&this.#u.setVideoElement(t)})).add(this.options.player.events.firstFrame$.subscribe(()=>{this.#u.reset(),setTimeout(()=>{this.#u.hide(),this.#u.lastFrameCanvas.clear()},50)})).add(this.options.player.events.seeked$.subscribe(this.#u.onSeek))}#y=(t=!0)=>{this.#e.forEach(e=>{!t&&e.isPermanentText||(this.#a.removeFn(e.whilePlaying),e.destroy())})};#E(t){this.#l.chapter&&this.appState===ec.initiated&&(this.#o.setManifestChapterEvents(t),this.#e=this.#T(t),this.#s.containersEventsCallState.setData(t.containers),tW.setContainers(this.#e.map(t=>t.container.container).filter(t=>!tV(t.controls))),this.options.lastFrame&&this.#a.addFn(()=>{this.#u.onEachTick(1e3*this.options.player.info.position$.getValue())},!0),this.appState=ec.ready)}#T(t){return t?.containers?.reduce((t,e)=>{let i=e.type.trim().toLowerCase(),r=this.factories.get(i);if(r){let i=new tG({player:this.options.player,container:r(e,this.rootElement),branches:this.#l.chapter.branches,selectBranches:this.#o,interactiveEvents:this.#s,globalEventEmitter:this.#m,ignoreContainerEvent:()=>tP(e,this.#e),permanentTextControls:this.options.permanentTextControls,disabledControls$:this.state.disabledControls$});return this.#a.addFn(i.whilePlaying,!0),[...t,i]}return[...t]},[])??[]}#w(){if(this.state.isInteractiveExpectation$.getValue()){this.#h.next(!1);return}let t=this.#h.getValue(),e=!!tW.getNextInteractiveTime();(e&&!t||!e&&t)&&this.#h.next(!t)}#j(){this.state.calledByInteractive$.getValue()?this.state.calledByInteractive$.next(!1):this.state.lastChapterChangeWasInitiatedByInteractive$.next(!1)}#C(t){if(this.#j(),!this.#r.inited)return;let e=this.state.lastChapterChangeWasInitiatedByInteractive$.getValue(),i=this.state.prevChapter$.getValue(),r=(i&&tx(i)&&tT(i))??!1,n=this.#l.manifest.metadata.initChapterId===t,s=this.#r.state.history$.getValue();if(n||r&&e){this.#r.updateHistory([t]);return}s.at(-1)!==t&&this.#r.updateHistory([...s,t])}playPrevChapter(){this.#r?.goBack()}setDisabledControls(t){this.state.disabledControls$.next(t)}isSupport(t=this.#l.manifest){return tn(t.metadata.version)}getInitialVideoInfo(){return{videoId:this.#r.getInitialVideoId(),chapterId:this.#r.getInitialChapterId()}}getHistoryState(){return this.#r.state}getIsSeekable(){return this.#h}getInteractiveRanges(){return tN(this.#l.chapter?.containers)}getNextInteractiveStartTime(t){return tW.getNextInteractiveTime(t)}getChapterBranches(t){return this.#l.getBranches(t)}getCurrentChapter(){return this.#l.getCurrent()}getCurrentManifest(){return this.#l.manifest}addFactory(t,e){this.factories.set(t.trim().toLowerCase(),e)}removeFactory(t){this.factories.delete(t.trim().toLowerCase())}on(...t){return this.#m.on(...t),this}off(...t){return this.#m.off(...t),this}once(...t){return this.#m.once(...t),this}destroy(){this.#y(),this.#e=void 0,this.state=void 0,this.#d?.destroy(),this.#d=void 0,this.#t.release(),this.#t=void 0,this.#o=void 0,this.#a.release(),this.#a=void 0,this.#s.release(),this.#s=void 0,this.#l.release(),this.#o=void 0,this.#i.release(),this.#i=void 0,this.#n.unsubscribe(),this.#n=void 0,this.#m.reset(),this.#m=void 0,this.#u?.destroy(),this.#u=void 0,this.rootElement.remove(),this.rootElement=void 0,this.#r.destroy(),this.#r=void 0,this.factories=void 0,this.options=void 0,this.isFirstChapterFetched=!1,this.appState=ec.destroyed}}}),i("aGTfi",function(i,r){t(i.exports,"default",()=>o);var n=e("800yO"),s=e("dgVsc"),a=e("3ZkBl"),o=function(t,e,i){if(n.default.randomUUID&&!e&&!t)return(0,n.default).randomUUID();let r=(t=t||{}).random||(t.rng||(0,s.default))();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,e){i=i||0;for(let t=0;t<16;++t)e[i+t]=r[t];return e}return(0,a.unsafeStringify)(r)}}),i("800yO",function(e,i){t(e.exports,"default",()=>r);var r={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)}}),i("dgVsc",function(e,i){let r;t(e.exports,"default",()=>s);let n=new Uint8Array(16);function s(){if(!r&&!(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(n)}}),i("3ZkBl",function(i,r){t(i.exports,"unsafeStringify",()=>s),e("iIK7u");let n=[];for(let t=0;t<256;++t)n.push((t+256).toString(16).slice(1));function s(t,e=0){return n[t[e+0]]+n[t[e+1]]+n[t[e+2]]+n[t[e+3]]+"-"+n[t[e+4]]+n[t[e+5]]+"-"+n[t[e+6]]+n[t[e+7]]+"-"+n[t[e+8]]+n[t[e+9]]+"-"+n[t[e+10]]+n[t[e+11]]+n[t[e+12]]+n[t[e+13]]+n[t[e+14]]+n[t[e+15]]}}),i("iIK7u",function(i,r){t(i.exports,"default",()=>s);var n=e("c803M"),s=function(t){return"string"==typeof t&&(0,n.default).test(t)}}),i("c803M",function(e,i){t(e.exports,"default",()=>r);var r=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i}),i("8Axf4",function(t,i){var r=e("Gr8vk");t.exports=r("kxdap").then(()=>e("cwlwz"))});
//# sourceMappingURL=esnext.esm.7a9a6159.js.map
